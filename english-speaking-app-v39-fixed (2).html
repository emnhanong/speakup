<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, viewport-fit=cover">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="theme-color" content="#0d9488">
<title>SpeakUp ‚Äî English Learning</title>
<link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,wght@0,600;0,700;0,900;1,600&family=Plus+Jakarta+Sans:ital,wght@0,400;0,500;0,600;0,700;1,400&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<!-- Firebase v10 compat -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<style>
:root {
  --bg:        #f5f3ef;
  --bg2:       #edeae4;
  --surface:   #ffffff;
  --surface2:  #f9f7f4;
  --border:    #e2ddd7;
  --border2:   #cdc7bf;
  --ink:       #1c1917;
  --ink2:      #44403c;
  --ink3:      #78716c;
  --ink4:      #a8a29e;
  --teal:      #0d9488;
  --teal-light:#ccfbf1;
  --teal-mid:  #5eead4;
  --amber:     #d97706;
  --amber-light:#fef3c7;
  --rose:      #e11d48;
  --rose-light:#ffe4e6;
  --violet:    #7c3aed;
  --violet-light:#ede9fe;
  --radius:    14px;
  --radius-sm: 8px;
  --shadow-sm: 0 1px 4px rgba(0,0,0,0.06),0 2px 8px rgba(0,0,0,0.04);
  --shadow:    0 4px 16px rgba(0,0,0,0.08),0 1px 4px rgba(0,0,0,0.04);
  --shadow-lg: 0 8px 32px rgba(0,0,0,0.12),0 2px 8px rgba(0,0,0,0.06);
  --font-d:'Fraunces',Georgia,serif;
  --font-b:'Plus Jakarta Sans',system-ui,sans-serif;
  --mob-nav:64px;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html{scroll-behavior:smooth;}
body{background:var(--bg);color:var(--ink);font-family:var(--font-b);font-size:15px;line-height:1.6;min-height:100vh;-webkit-font-smoothing:antialiased;}

/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
.app{display:flex;min-height:100vh;}

/* SIDEBAR */
.sidebar{width:248px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:200;box-shadow:var(--shadow-sm);}
.sidebar-top{padding:20px 16px 16px;border-bottom:1px solid var(--border);}
.logo{display:flex;align-items:center;gap:10px;}
.logo-icon{width:34px;height:34px;border-radius:10px;background:var(--teal);display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;}
.logo-text{font-family:var(--font-d);font-weight:700;font-size:20px;color:var(--ink);letter-spacing:-0.3px;}
.sidebar-stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:7px;padding:12px 14px;border-bottom:1px solid var(--border);}
.s-stat{text-align:center;padding:7px 4px;background:var(--bg);border-radius:var(--radius-sm);border:1px solid var(--border);}
.s-stat-val{font-family:var(--font-d);font-weight:700;font-size:16px;color:var(--teal);display:block;}
.s-stat-lbl{font-size:10px;color:var(--ink4);margin-top:1px;font-weight:500;}
.nav{flex:1;padding:10px;display:flex;flex-direction:column;gap:2px;overflow-y:auto;}
.nav-lbl{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--ink4);padding:8px 8px 4px;margin-top:4px;}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:var(--radius-sm);cursor:pointer;transition:all .15s;font-size:14px;font-weight:500;color:var(--ink3);border:1px solid transparent;user-select:none;}
.nav-item:hover{background:var(--bg);color:var(--ink);}
.nav-item.active{background:var(--teal-light);color:var(--teal);border-color:rgba(13,148,136,.2);font-weight:600;}
.nav-item .ni{font-size:17px;width:20px;text-align:center;flex-shrink:0;}

/* MOBILE NAV */
/* ‚îÄ‚îÄ WRITING MODULE ‚îÄ‚îÄ */
.wr-setup-card{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius);padding:22px 24px;margin-bottom:18px;box-shadow:var(--shadow-sm);}
.wr-hero{background:linear-gradient(135deg,#7c3aed 0%,#0d9488 100%);border-radius:var(--radius);padding:22px 26px;color:#fff;margin-bottom:20px;position:relative;overflow:hidden;}
.wr-hero::after{content:'‚úçÔ∏è';position:absolute;right:22px;top:50%;transform:translateY(-50%);font-size:52px;opacity:.18;}
.wr-hero h2{font-family:var(--font-d);font-size:21px;font-weight:700;margin-bottom:3px;}
.wr-hero p{font-size:13px;opacity:.85;}

/* Progress bar */
.wr-topbar{display:flex;align-items:center;gap:12px;margin-bottom:20px;padding:12px 16px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);box-shadow:var(--shadow-sm);}
.wr-pbar-wrap{flex:1;height:8px;background:var(--bg2);border-radius:4px;overflow:hidden;}
.wr-pbar-fill{height:100%;background:linear-gradient(90deg,var(--violet),var(--teal));border-radius:4px;transition:width .5s cubic-bezier(.4,0,.2,1);}
.wr-counter{font-size:12px;font-weight:700;color:var(--ink3);white-space:nowrap;}
.wr-score-badge{display:flex;align-items:center;gap:5px;background:var(--teal-light);color:var(--teal);border-radius:20px;padding:4px 12px;font-size:12px;font-weight:700;border:1px solid rgba(13,148,136,.2);}

/* Sentence card */
.wr-sentence-card{background:var(--surface);border:2px solid var(--border);border-radius:16px;padding:22px 22px 18px;margin-bottom:14px;box-shadow:var(--shadow);animation:qzIn .25s ease;}
.wr-sentence-type{display:inline-flex;align-items:center;gap:6px;background:var(--violet-light);color:var(--violet);border-radius:20px;padding:4px 12px;font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:.07em;margin-bottom:12px;}
.wr-vi-sentence{font-size:19px;font-weight:700;color:var(--ink);line-height:1.5;margin-bottom:6px;font-family:var(--font-d);}
.wr-hint{font-size:12px;color:var(--ink4);font-style:italic;margin-bottom:16px;}
.wr-vocab-chips{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:16px;}
.wr-vocab-chip{background:var(--teal-light);color:var(--teal);border:1px solid rgba(13,148,136,.25);border-radius:20px;padding:3px 10px;font-size:12px;font-weight:600;}

/* Input area */
.wr-input-wrap{position:relative;}
.wr-input{width:100%;background:var(--surface2);border:2px solid var(--border2);border-radius:12px;padding:14px 16px;font-size:16px;color:var(--ink);font-family:var(--font-b);outline:none;transition:all .2s;resize:none;min-height:56px;line-height:1.5;}
.wr-input:focus{border-color:var(--violet);box-shadow:0 0 0 4px rgba(124,58,237,.1);background:var(--surface);}
.wr-input.evaluated{background:var(--surface);pointer-events:none;}
.wr-submit-row{display:flex;align-items:center;gap:10px;margin-top:10px;flex-wrap:wrap;}

/* Evaluation result */
.wr-eval{border-radius:14px;padding:16px 18px;margin-top:14px;animation:fadeUp .3s ease;}
.wr-eval.ok{background:linear-gradient(135deg,#d1fae5,#ccfbf1);border:2px solid #6ee7b7;}
.wr-eval.warn{background:linear-gradient(135deg,#fef3c7,#fde68a44);border:2px solid #fcd34d;}
.wr-eval.err{background:linear-gradient(135deg,#ffe4e6,#fce7f3);border:2px solid #fda4af;}
.wr-eval-header{display:flex;align-items:center;gap:10px;margin-bottom:10px;}
.wr-eval-icon{font-size:22px;flex-shrink:0;}
.wr-eval-verdict{font-weight:800;font-size:15px;}
.wr-eval.ok .wr-eval-verdict{color:#065f46;}
.wr-eval.warn .wr-eval-verdict{color:#92400e;}
.wr-eval.err .wr-eval-verdict{color:#9f1239;}
.wr-eval-score{margin-left:auto;font-family:var(--font-d);font-size:22px;font-weight:900;}
.wr-eval.ok .wr-eval-score{color:#059669;}
.wr-eval.warn .wr-eval-score{color:#d97706;}
.wr-eval.err .wr-eval-score{color:var(--rose);}
.wr-eval-comment{font-size:14px;line-height:1.6;color:var(--ink2);margin-bottom:10px;}
.wr-eval-correction{background:rgba(255,255,255,.7);border-radius:10px;padding:12px 14px;border-left:4px solid var(--teal);}
.wr-eval-correction-lbl{font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:.07em;color:var(--ink4);margin-bottom:4px;}
.wr-eval-correction-text{font-size:15px;font-weight:700;color:var(--teal);line-height:1.5;}
.wr-eval-explain{font-size:12px;color:var(--ink3);margin-top:6px;line-height:1.5;font-style:italic;}

/* Flashcard Prev/Next nav buttons */
.fc-prev-btn:disabled,.fc-next-btn:disabled{opacity:.35;cursor:not-allowed;pointer-events:none;}
.fc-prev-btn:not(:disabled):hover,.fc-next-btn:not(:disabled):hover{border-color:var(--teal);color:var(--teal);background:var(--teal-light);}

/* Skeleton loading */
.wr-skel{height:14px;background:linear-gradient(90deg,var(--bg2) 25%,var(--border) 50%,var(--bg2) 75%);background-size:200%;border-radius:7px;animation:shimmer 1.3s ease infinite;margin-bottom:8px;}

/* Results screen */
.wr-result-wrap{text-align:center;padding:24px 16px;}
.wr-result-emoji{font-size:56px;margin-bottom:10px;display:block;}
.wr-result-title{font-family:var(--font-d);font-size:26px;font-weight:900;color:var(--ink);margin-bottom:6px;}
.wr-result-sub{font-size:14px;color:var(--ink3);margin-bottom:24px;}
.wr-result-stats{display:flex;justify-content:center;gap:20px;margin-bottom:24px;flex-wrap:wrap;}
.wr-result-stat{text-align:center;}
.wr-result-stat-val{font-family:var(--font-d);font-size:28px;font-weight:900;display:block;}
.wr-result-stat-lbl{font-size:12px;color:var(--ink3);margin-top:2px;}
.wr-review-list{text-align:left;margin-bottom:20px;}
.wr-review-item{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius-sm);padding:12px 14px;margin-bottom:8px;}
.wr-review-vi{font-size:13px;color:var(--ink4);margin-bottom:4px;}
.wr-review-user{font-size:14px;color:var(--rose);margin-bottom:3px;font-style:italic;}
.wr-review-correct{font-size:14px;color:var(--teal);font-weight:600;}

@keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.imp-hist-item{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius);padding:14px 16px;margin-bottom:10px;transition:box-shadow .15s;}
.imp-hist-item:hover{box-shadow:var(--shadow);}
.imp-hist-header{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px;flex-wrap:wrap;}
.imp-hist-title{font-family:var(--font-d);font-weight:700;font-size:15px;color:var(--ink);}
.imp-hist-meta{font-size:11px;color:var(--ink4);display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
.imp-hist-body{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:8px;}
.imp-hist-chip{background:var(--teal-light);color:var(--teal);border-radius:20px;padding:3px 9px;font-size:12px;font-weight:600;cursor:pointer;border:1px solid rgba(13,148,136,.2);}
.imp-hist-chip:hover{background:var(--teal);color:#fff;}
.imp-hist-actions{display:flex;gap:7px;flex-wrap:wrap;}
/* Import topic selector */
.imp-topic-row{display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap;margin-bottom:14px;padding:12px 14px;background:var(--teal-light);border:1.5px solid rgba(13,148,136,.25);border-radius:var(--radius-sm);}
.imp-topic-label{font-size:13px;font-weight:700;color:var(--teal);margin-bottom:4px;}

/* ‚îÄ‚îÄ MOBILE NAV ‚Äî scrollable, always fixed ‚îÄ‚îÄ */
.mob-nav{
  display:none;
  position:fixed;bottom:0;left:0;right:0;
  height:var(--mob-nav);
  background:rgba(255,255,255,0.98);
  /* backdrop-filter removed: t·∫°o stacking context ph√° z-index ordering */
  border-top:1px solid var(--border);
  z-index:500;
  overflow-x:auto;overflow-y:hidden;
  -webkit-overflow-scrolling:touch;
  scrollbar-width:none;
  box-shadow:0 -2px 20px rgba(0,0,0,.09);
  padding-bottom:env(safe-area-inset-bottom);
  align-items:stretch;flex-wrap:nowrap;
}
.mob-nav::-webkit-scrollbar{display:none;}
.mob-item{
  flex:0 0 auto;min-width:62px;max-width:80px;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:2px;cursor:pointer;transition:color .15s,border-color .15s;
  padding:5px 6px 4px;color:var(--ink4);font-size:10px;font-weight:600;
  border-top:2.5px solid transparent;user-select:none;
  -webkit-tap-highlight-color:transparent;
  white-space:nowrap;
}
.mob-item:active{opacity:.7;}
.mob-item.active{color:var(--teal);border-top-color:var(--teal);}
.mob-item .mi{font-size:20px;line-height:1;display:block;transition:transform .2s cubic-bezier(.34,1.56,.64,1);}
.mob-item.active .mi{transform:scale(1.18);}
.mob-item-label{font-size:9px;font-weight:700;letter-spacing:.01em;text-align:center;}


.main{margin-left:248px;flex:1;min-height:100vh;}
.page-wrap{max-width:860px;margin:0 auto;padding:32px 28px;}

/* PANELS */
.panel{display:none;}.panel.active{display:block;}

/* HEADERS */
.page-header{margin-bottom:24px;}
.page-title{font-family:var(--font-d);font-weight:700;font-size:26px;line-height:1.2;color:var(--ink);letter-spacing:-.4px;}
.page-title em{color:var(--teal);font-style:normal;}
.page-sub{color:var(--ink3);font-size:14px;margin-top:4px;}

/* CARDS */
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:var(--shadow-sm);}
.card+.card{margin-top:14px;}

/* BUTTONS */
.btn{display:inline-flex;align-items:center;gap:7px;padding:10px 18px;border-radius:var(--radius-sm);border:none;cursor:pointer;font-family:var(--font-b);font-size:14px;font-weight:600;transition:all .15s;user-select:none;white-space:nowrap;}
.btn:active{transform:scale(.97);}
.btn-primary{background:var(--teal);color:#fff;}
.btn-primary:hover{background:#0f766e;}
.btn-outline{background:transparent;color:var(--ink2);border:1.5px solid var(--border2);}
.btn-outline:hover{border-color:var(--teal);color:var(--teal);background:var(--teal-light);}
.btn-ghost{background:transparent;color:var(--ink3);}
.btn-ghost:hover{background:var(--bg);}
.btn-sm{padding:7px 13px;font-size:13px;border-radius:6px;}
.btn-full{width:100%;justify-content:center;}

/* BADGE */
.badge{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:20px;font-size:11px;font-weight:700;}
.badge-teal{background:var(--teal-light);color:var(--teal);}
.badge-amber{background:var(--amber-light);color:var(--amber);}

/* ‚îÄ‚îÄ HOME ‚îÄ‚îÄ */
.home-hero{background:linear-gradient(135deg,#0d9488 0%,#0891b2 100%);border-radius:var(--radius);padding:24px 28px;color:#fff;margin-bottom:20px;position:relative;overflow:hidden;}
.home-hero::after{content:'üó£Ô∏è';position:absolute;right:24px;top:50%;transform:translateY(-50%);font-size:56px;opacity:.2;}
.home-hero h2{font-family:var(--font-d);font-size:22px;font-weight:700;margin-bottom:4px;}
.home-hero p{font-size:14px;opacity:.85;}
.home-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:20px;}
.hcard{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius);padding:16px;cursor:pointer;transition:all .15s;display:flex;align-items:flex-start;gap:12px;}
.hcard:hover{border-color:var(--teal);box-shadow:var(--shadow);transform:translateY(-1px);}
.hcard:active{transform:scale(.98);}
.hcard-icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;}
.hci-t{background:var(--teal-light);}
.hci-v{background:var(--violet-light);}
.hci-a{background:var(--amber-light);}

/* ‚îÄ‚îÄ HOME v2 ‚Äî mobile-first components ‚îÄ‚îÄ */
.home-page-wrap{padding-top:10px;}

/* Stats strip */
.home-stats-strip{
  display:flex;align-items:center;
  background:var(--surface);border:1.5px solid var(--border);
  border-radius:16px;padding:0;margin-bottom:14px;
  box-shadow:var(--shadow-sm);overflow:hidden;
}
.hss-item{
  flex:1;display:flex;flex-direction:column;align-items:center;
  padding:14px 8px;gap:2px;
}
.hss-val{
  font-family:var(--font-d);font-weight:800;font-size:20px;
  color:var(--teal);line-height:1;
}
.hss-lbl{font-size:10px;color:var(--ink4);font-weight:600;text-align:center;margin-top:2px;}
.hss-sep{width:1px;background:var(--border);align-self:stretch;margin:10px 0;}

/* Week calendar */
.home-week-wrap{
  background:var(--surface);border:1.5px solid var(--border);
  border-radius:16px;padding:14px 16px;margin-bottom:14px;
  box-shadow:var(--shadow-sm);
}
.home-section-lbl{
  font-size:11px;font-weight:800;text-transform:uppercase;
  letter-spacing:.08em;color:var(--ink4);margin-bottom:10px;
}
.week-row{display:flex;justify-content:space-between;gap:4px;}
.wday{display:flex;flex-direction:column;align-items:center;gap:4px;flex:1;}
.wday-lbl{font-size:10px;color:var(--ink4);font-weight:600;}
.wday-dot{
  width:32px;height:32px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-size:11px;font-weight:700;background:var(--bg2);
  color:var(--ink4);border:2px solid transparent;
}
.wday-dot.today{background:var(--teal);color:#fff;border-color:var(--teal);font-size:14px;}
.wday-dot.done{background:var(--teal-light);color:var(--teal);border-color:rgba(13,148,136,.3);}

/* Skill cards */
.home-skill-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;}
.home-skill-card{
  border-radius:16px;padding:16px 14px;cursor:pointer;
  position:relative;overflow:hidden;
  transition:transform .18s cubic-bezier(.34,1.56,.64,1),box-shadow .18s;
  -webkit-tap-highlight-color:transparent;
}
.home-skill-card:active{transform:scale(.95)!important;}
.hsk-listen{background:linear-gradient(135deg,#0c4a6e,#0891b2);box-shadow:0 4px 16px rgba(8,145,178,.3);}
.hsk-speak{background:linear-gradient(135deg,#3b0764,#7c3aed);box-shadow:0 4px 16px rgba(124,58,237,.3);}
.hsk-bg-emoji{
  position:absolute;right:-8px;top:-8px;font-size:60px;opacity:.12;
  pointer-events:none;line-height:1;
}
.hsk-icon{font-size:26px;margin-bottom:8px;line-height:1;}
.hsk-name{font-family:var(--font-d);font-size:15px;font-weight:900;color:#fff;margin-bottom:3px;line-height:1.2;}
.hsk-sub{font-size:10.5px;color:rgba(255,255,255,.75);margin-bottom:10px;line-height:1.4;}
.hsk-chips{display:flex;gap:4px;flex-wrap:wrap;}
.hsk-chip{
  background:rgba(255,255,255,.18);border:1px solid rgba(255,255,255,.25);
  border-radius:20px;padding:2px 7px;font-size:9.5px;font-weight:700;color:#fff;
}

/* Mini skill icons */
.home-mini-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:14px;}
.home-mini-card{
  background:var(--surface);border:1.5px solid var(--border);
  border-radius:14px;padding:14px 6px 12px;
  cursor:pointer;display:flex;flex-direction:column;
  align-items:center;gap:7px;
  transition:all .15s;-webkit-tap-highlight-color:transparent;
  box-shadow:var(--shadow-sm);
}
.home-mini-card:hover{border-color:var(--teal);background:var(--surface2);}
.home-mini-card:active{transform:scale(.94);background:var(--bg2);}
.hmc-icon{
  width:40px;height:40px;border-radius:12px;
  display:flex;align-items:center;justify-content:center;font-size:20px;
}
.hmc-label{font-size:11px;font-weight:700;color:var(--ink2);text-align:center;line-height:1.2;}

/* Continue learning card */
.home-continue-card{
  background:var(--surface);border:2px solid var(--teal);
  border-radius:16px;padding:14px 16px;
  display:flex;align-items:center;gap:12px;
  box-shadow:0 2px 12px rgba(13,148,136,.12);
  margin-bottom:14px;
}
.home-continue-emoji{font-size:28px;flex-shrink:0;}
.home-continue-info{flex:1;min-width:0;}
.home-continue-tag{font-size:10px;font-weight:700;color:var(--teal);text-transform:uppercase;letter-spacing:.06em;margin-bottom:2px;}
.home-continue-title{font-family:var(--font-d);font-weight:800;font-size:15px;color:var(--ink);margin-bottom:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.home-continue-pbar{height:5px;background:var(--bg2);border-radius:3px;overflow:hidden;margin-bottom:3px;}
.home-continue-pfill{height:100%;background:linear-gradient(90deg,var(--teal),var(--teal-mid));border-radius:3px;transition:width .5s;}
.home-continue-meta{font-size:11px;color:var(--ink4);}
.home-continue-btns{display:flex;flex-direction:column;gap:6px;flex-shrink:0;}
.hci-r{background:var(--rose-light);}
.hcard-title{font-weight:700;font-size:14px;margin-bottom:2px;}
.hcard-sub{font-size:12px;color:var(--ink3);line-height:1.4;}

/* ‚îÄ‚îÄ TOPICS ‚îÄ‚îÄ */
.topics-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px;}
.topic-card{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius);padding:18px;cursor:pointer;transition:all .15s;position:relative;overflow:hidden;}
.topic-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--teal),#0891b2);transform:scaleX(0);transform-origin:left;transition:transform .25s;}
.topic-card:hover{border-color:var(--teal);box-shadow:var(--shadow);}
.topic-card:hover::before{transform:scaleX(1);}
.topic-card:active{transform:scale(.99);}
.topic-name{font-family:var(--font-d);font-weight:700;font-size:17px;margin-bottom:6px;}
.topic-meta{display:flex;gap:10px;font-size:12px;color:var(--ink3);margin-bottom:10px;}
.topic-pbar{height:5px;background:var(--bg2);border-radius:3px;overflow:hidden;margin-bottom:12px;}
.topic-pbar-fill{height:100%;background:linear-gradient(90deg,var(--teal),var(--teal-mid));border-radius:3px;transition:width .5s;}
.topic-actions{display:flex;gap:8px;flex-wrap:wrap;}

/* ‚îÄ‚îÄ STUDY ‚îÄ‚îÄ */
.study-top{display:flex;align-items:center;gap:12px;padding:12px 0;margin-bottom:16px;}
.pbar-wrap{flex:1;height:6px;background:var(--bg2);border-radius:3px;overflow:hidden;}
.pbar-fill{height:100%;background:linear-gradient(90deg,var(--teal),var(--teal-mid));border-radius:3px;transition:width .4s;}
.plbl{font-size:12px;color:var(--ink3);white-space:nowrap;font-weight:600;}

/* TABS */
.tabs{display:flex;background:var(--bg2);border-radius:var(--radius-sm);padding:4px;margin-bottom:20px;border:1px solid var(--border);overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;}
.tabs::-webkit-scrollbar{display:none;}
.tab-btn{flex:1;min-width:max-content;padding:8px 14px;border-radius:6px;border:none;cursor:pointer;font-family:var(--font-b);font-size:13px;font-weight:600;background:transparent;color:var(--ink3);transition:all .15s;white-space:nowrap;}
.tab-btn.active{background:var(--surface);color:var(--teal);box-shadow:var(--shadow-sm);}

/* FLASHCARD ‚Äî single card, no flip */
.fc-card{max-width:540px;margin:0 auto;background:var(--surface);border:1.5px solid var(--border);border-radius:18px;box-shadow:var(--shadow-lg);overflow:hidden;}
.fc-card-img{width:100%;height:200px;object-fit:cover;display:block;background:var(--bg2);}
.fc-card-img-placeholder{width:100%;height:200px;background:linear-gradient(135deg,var(--bg2),var(--bg));display:flex;align-items:center;justify-content:center;font-size:48px;color:var(--ink4);}
.fc-card-body{padding:22px 24px 20px;}
.fc-word{font-family:var(--font-d);font-size:clamp(28px,6vw,40px);font-weight:900;color:var(--ink);margin-bottom:4px;letter-spacing:-.5px;}
.fc-ipa{font-size:15px;color:var(--ink3);margin-bottom:14px;font-style:italic;}
.fc-divider{height:1px;background:var(--border);margin:14px 0;}
.fc-meaning{font-size:17px;line-height:1.55;color:var(--teal);font-weight:700;margin-bottom:8px;}
.fc-example{font-size:13px;color:var(--ink2);font-style:italic;line-height:1.7;padding:10px 12px;background:var(--surface2);border-radius:8px;border-left:3px solid var(--teal);}
.fc-example strong{color:var(--teal);font-style:normal;font-weight:700;}
.fc-card-footer{padding:14px 24px 20px;display:flex;flex-wrap:wrap;gap:8px;align-items:center;border-top:1px solid var(--border);background:var(--surface2);}
.rating-sec{margin-top:20px;}
.rating-title{text-align:center;font-size:13px;color:var(--ink3);margin-bottom:12px;font-weight:500;}
.rating-row{display:flex;gap:10px;justify-content:center;}
.rate-btn{padding:10px 22px;border-radius:var(--radius-sm);border:1.5px solid;cursor:pointer;font-family:var(--font-b);font-size:14px;font-weight:600;transition:all .15s;}
.rate-btn:active{transform:scale(.96);}
.rb-hard{border-color:#fecdd3;background:var(--rose-light);color:var(--rose);}
.rb-ok{border-color:#fde68a;background:var(--amber-light);color:var(--amber);}
.rb-easy{border-color:#a7f3d0;background:var(--teal-light);color:var(--teal);}

/* AUDIO */
.audio-chip{display:inline-flex;align-items:center;gap:6px;background:var(--bg);border:1.5px solid var(--border2);color:var(--teal);border-radius:20px;padding:6px 14px;cursor:pointer;font-size:13px;font-weight:600;transition:all .15s;}
.audio-chip:hover{background:var(--teal-light);border-color:var(--teal);}
.audio-chip:active{transform:scale(.96);}
.audio-chip.playing{animation:apulse 1s ease infinite;}
@keyframes apulse{0%,100%{box-shadow:0 0 0 0 rgba(13,148,136,.25);}50%{box-shadow:0 0 0 8px rgba(13,148,136,0);}}

/* DIALOGUE */
.dlg-wrap{max-width:580px;margin:0 auto;}
.dlg-msg{display:flex;gap:10px;margin-bottom:14px;animation:fadeUp .3s ease;}
.dlg-msg.right{flex-direction:row-reverse;}
@keyframes fadeUp{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.dlg-av{width:36px;height:36px;border-radius:50%;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:16px;border:2px solid var(--border);background:var(--bg);}
.dlg-bubble{background:var(--surface);border:1.5px solid var(--border);border-radius:14px;padding:11px 15px;max-width:78%;box-shadow:var(--shadow-sm);}
.dlg-msg.right .dlg-bubble{background:var(--teal-light);border-color:rgba(13,148,136,.2);}
.dlg-speaker{font-size:10px;font-weight:700;color:var(--ink4);text-transform:uppercase;letter-spacing:.06em;margin-bottom:3px;}
.dlg-text{font-size:14px;line-height:1.65;}
.dlg-text .hl{background:rgba(13,148,136,.12);color:var(--teal);border-radius:3px;padding:0 3px;font-weight:700;}
/* DIALOGUE PER-WORD NAV */
.dlg-word-header{background:linear-gradient(135deg,var(--teal-light),rgba(8,145,178,.08));border:1.5px solid rgba(13,148,136,.25);border-radius:var(--radius);padding:16px 18px;margin-bottom:16px;}
.dlg-word-title{font-family:var(--font-d);font-size:22px;font-weight:900;color:var(--teal);letter-spacing:-.3px;}
.dlg-word-ipa{font-size:13px;color:var(--ink3);font-style:italic;margin:2px 0 6px;}
.dlg-word-meaning{font-size:14px;font-weight:700;color:var(--ink);display:flex;align-items:center;gap:6px;}
.dlg-word-example{font-size:12px;color:var(--ink3);font-style:italic;margin-top:6px;padding:6px 10px;background:rgba(13,148,136,.07);border-radius:6px;border-left:3px solid var(--teal);}
.dlg-nav-bar{display:flex;align-items:center;gap:8px;margin-bottom:16px;flex-wrap:wrap;}
.dlg-nav-dots{display:flex;gap:5px;flex:1;flex-wrap:wrap;align-items:center;}
.dlg-dot{width:10px;height:10px;border-radius:50%;border:2px solid var(--border2);background:var(--bg);cursor:pointer;transition:all .2s;flex-shrink:0;}
.dlg-dot.seen{background:var(--teal-mid);border-color:var(--teal);}
.dlg-dot.active{background:var(--teal);border-color:var(--teal);transform:scale(1.35);}
.dlg-loading{display:flex;flex-direction:column;gap:10px;padding:8px 0;}
.dlg-loading-line{height:13px;background:linear-gradient(90deg,var(--bg2) 25%,var(--border) 50%,var(--bg2) 75%);background-size:200% 100%;border-radius:7px;animation:shimmer 1.4s ease infinite;}
@keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}

/* ‚îÄ‚îÄ QUIZ ‚Äì Duolingo/Quizlet style ‚îÄ‚îÄ */
/* Progress bar */
.qz-topbar{display:flex;align-items:center;gap:14px;margin-bottom:24px;}
.qz-close{color:var(--ink4);font-size:20px;cursor:pointer;transition:color .15s;flex-shrink:0;}
.qz-close:hover{color:var(--rose);}
.qz-pbar-wrap{flex:1;height:10px;background:var(--bg2);border-radius:5px;overflow:hidden;}
.qz-pbar-fill{height:100%;border-radius:5px;background:linear-gradient(90deg,var(--teal),#0ea5e9);transition:width .5s cubic-bezier(.4,0,.2,1);}
.qz-lives{display:flex;gap:4px;align-items:center;}
.qz-heart{font-size:18px;line-height:1;transition:transform .3s,opacity .3s;}
.qz-heart.lost{opacity:.25;transform:scale(.8);}
/* Question card */
.qz-card{background:var(--surface);border:2px solid var(--border);border-radius:18px;padding:24px 22px;margin-bottom:16px;animation:qzIn .25s ease;}
@keyframes qzIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.qz-type-label{font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:.1em;color:var(--ink4);margin-bottom:14px;display:flex;align-items:center;gap:6px;}
.qz-word-hero{font-family:var(--font-d);font-size:32px;font-weight:900;color:var(--ink);margin-bottom:4px;letter-spacing:-.5px;}
.qz-word-ipa{font-size:14px;color:var(--ink3);font-style:italic;margin-bottom:16px;}
.qz-question{font-size:16px;font-weight:600;color:var(--ink2);margin-bottom:18px;line-height:1.5;}
.qz-sentence{font-size:16px;color:var(--ink);line-height:1.8;margin-bottom:16px;padding:12px 16px;background:var(--surface2);border-radius:10px;border:1px solid var(--border);}
.qz-blank{display:inline-block;min-width:80px;border-bottom:3px solid var(--teal);color:var(--teal);font-weight:800;text-align:center;padding:0 4px;}
/* Multiple choice */
.opts{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:4px;}
.opt{background:var(--surface);border:2px solid var(--border);border-radius:14px;padding:14px 16px;cursor:pointer;text-align:left;font-family:var(--font-b);font-size:14px;font-weight:500;color:var(--ink);transition:all .18s;display:flex;align-items:center;gap:10px;position:relative;overflow:hidden;}
.opt-letter{width:26px;height:26px;border-radius:7px;border:2px solid var(--border2);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:800;color:var(--ink3);flex-shrink:0;transition:all .18s;}
.opt:hover:not(.disabled){border-color:var(--teal);background:var(--teal-light);transform:translateY(-1px);box-shadow:0 4px 12px rgba(13,148,136,.12);}
.opt:hover:not(.disabled) .opt-letter{border-color:var(--teal);color:var(--teal);}
.opt.correct{border-color:#10b981!important;background:#d1fae5!important;color:#065f46!important;font-weight:700;}
.opt.correct .opt-letter{background:#10b981;border-color:#10b981;color:#fff;}
.opt.wrong{border-color:var(--rose)!important;background:var(--rose-light)!important;color:var(--rose)!important;font-weight:700;}
.opt.wrong .opt-letter{background:var(--rose);border-color:var(--rose);color:#fff;}
.opt.disabled{pointer-events:none;}
/* Fill blank */
.fill-inp{width:100%;background:var(--surface);border:2px solid var(--border2);border-radius:12px;padding:14px 18px;font-size:20px;color:var(--ink);font-family:var(--font-b);outline:none;transition:all .2s;letter-spacing:.5px;text-align:center;}
.fill-inp:focus{border-color:var(--teal);box-shadow:0 0 0 4px rgba(13,148,136,.1);}
.fill-inp.correct{border-color:#10b981;background:#d1fae5;color:#065f46;}
.fill-inp.wrong{border-color:var(--rose);background:var(--rose-light);color:var(--rose);}
/* Word chips (sentence builder) */
.chips-area{display:flex;flex-wrap:wrap;gap:8px;min-height:58px;padding:12px;border-radius:12px;border:2px dashed var(--border2);background:var(--surface2);transition:border-color .2s;margin-bottom:12px;}
.chips-area.target{background:#f0fdf9;border-color:rgba(13,148,136,.3);}
.chip{background:var(--surface);border:2px solid var(--border2);border-radius:10px;padding:8px 14px;font-size:14px;font-weight:600;cursor:pointer;transition:all .15s;user-select:none;box-shadow:0 2px 0 var(--border2);}
.chip:hover{border-color:var(--teal);color:var(--teal);background:var(--teal-light);transform:translateY(-1px);}
.chip.placed{background:var(--teal-light);border-color:var(--teal);color:var(--teal);box-shadow:0 2px 0 rgba(13,148,136,.3);}
.chip.source{opacity:.2;pointer-events:none;box-shadow:none;}
/* Match pairs */
.match-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.match-col{display:flex;flex-direction:column;gap:8px;}
.match-item{padding:12px 14px;border-radius:12px;border:2px solid var(--border);background:var(--surface);cursor:pointer;font-size:14px;font-weight:500;transition:all .18s;user-select:none;text-align:center;min-height:48px;display:flex;align-items:center;justify-content:center;}
.match-item:hover:not(.disabled){border-color:var(--teal);background:var(--teal-light);color:var(--teal);}
.match-item.selected{border-color:var(--violet);background:var(--violet-light);color:var(--violet);font-weight:700;transform:scale(1.02);}
.match-item.matched{border-color:#10b981;background:#d1fae5;color:#065f46;pointer-events:none;opacity:.8;}
.match-item.wrong-flash{animation:shake .4s ease;}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-7px)}75%{transform:translateX(7px)}}
/* Feedback bar */
.qz-feedback{border-radius:14px;padding:16px 20px;margin-top:12px;display:flex;align-items:center;gap:12px;animation:qzIn .2s ease;}
.qz-feedback.ok{background:#d1fae5;border:2px solid #6ee7b7;}
.qz-feedback.err{background:#fee2e2;border:2px solid #fca5a5;align-items:flex-start;}
.qz-feedback-icon{font-size:30px;flex-shrink:0;}
.qz-feedback-msg{flex:1;}
.qz-feedback-title{font-family:var(--font-d);font-weight:800;font-size:16px;}
.qz-feedback-title.ok{color:#065f46;}.qz-feedback-title.err{color:#9f1239;}
.qz-feedback-sub{font-size:13px;color:var(--ink3);margin-top:2px;}
/* Result */
.qz-result{text-align:center;padding:28px 16px;}
.qz-result-emoji{font-size:64px;margin-bottom:12px;display:block;}
.qz-result-title{font-family:var(--font-d);font-size:26px;font-weight:900;margin-bottom:4px;}
.qz-score-circle{width:110px;height:110px;border-radius:50%;margin:16px auto;display:flex;align-items:center;justify-content:center;flex-direction:column;border:6px solid var(--teal);background:var(--teal-light);}
.qz-score-num{font-family:var(--font-d);font-size:30px;font-weight:900;color:var(--teal);line-height:1;}
.qz-score-lbl{font-size:11px;color:var(--ink3);font-weight:700;}
.qz-stat-row{display:flex;gap:10px;justify-content:center;margin:16px 0;flex-wrap:wrap;}
.qz-stat{background:var(--surface);border:1.5px solid var(--border);border-radius:12px;padding:12px 18px;text-align:center;min-width:75px;}
.qz-stat-val{font-family:var(--font-d);font-size:22px;font-weight:900;display:block;}
.qz-stat-lbl{font-size:11px;color:var(--ink3);font-weight:600;margin-top:2px;}
.qz-review{margin-top:20px;text-align:left;max-height:260px;overflow-y:auto;border-radius:12px;border:1.5px solid var(--border);}
.qz-review-item{display:flex;gap:12px;padding:10px 14px;border-bottom:1px solid var(--border);align-items:flex-start;}
.qz-review-item:last-child{border-bottom:none;}
.qz-review-word{font-weight:800;color:var(--rose);min-width:90px;font-size:14px;}
.qz-review-right{font-size:13px;color:var(--ink2);}
@media(max-width:480px){.opts{grid-template-columns:1fr;}.match-grid{grid-template-columns:1fr;}.qz-word-hero{font-size:26px;}}

/* RESULT */
.result{text-align:center;padding:40px 16px;}
.result-score{font-family:var(--font-d);font-size:72px;font-weight:900;line-height:1;color:var(--teal);margin-bottom:4px;}
.result-lbl{font-size:13px;color:var(--ink3);margin-bottom:20px;}
.result-msg{font-family:var(--font-d);font-size:22px;font-weight:700;margin-bottom:6px;}
.result-sub{color:var(--ink3);font-size:14px;margin-bottom:28px;}
.xp-pill{display:inline-flex;align-items:center;gap:6px;background:var(--amber-light);border:1.5px solid #fde68a;color:var(--amber);border-radius:20px;padding:8px 18px;font-weight:700;font-size:15px;margin-bottom:24px;}

/* SPEAKING */
.speak-word-big{font-family:var(--font-d);font-size:28px;font-weight:900;color:var(--ink);margin-bottom:4px;}
.speak-ex{font-size:14px;color:var(--ink2);font-style:italic;line-height:1.7;padding:10px 14px;background:var(--teal-light);border-radius:6px;border-left:3px solid var(--teal);margin-bottom:14px;}
.rec-zone{display:flex;flex-direction:column;align-items:center;gap:16px;padding:28px;background:var(--surface2);border-radius:var(--radius);border:1.5px dashed var(--border2);margin-bottom:14px;}
.rec-ring{width:72px;height:72px;border-radius:50%;background:var(--rose-light);border:2.5px solid #fecdd3;display:flex;align-items:center;justify-content:center;font-size:30px;cursor:pointer;transition:all .2s;}
.rec-ring:hover{background:#fce7e7;border-color:var(--rose);}
.rec-ring.recording{border-color:var(--rose);animation:rpulse 1.1s ease infinite;}
@keyframes rpulse{0%,100%{box-shadow:0 0 0 0 rgba(225,29,72,.3);}50%{box-shadow:0 0 0 18px rgba(225,29,72,0);}}
.waveform{display:flex;align-items:center;gap:4px;height:36px;}
.wb{width:4px;border-radius:2px;background:var(--teal);animation:wv .8s ease-in-out infinite;}
.wb:nth-child(2){animation-delay:.1s}.wb:nth-child(3){animation-delay:.2s}.wb:nth-child(4){animation-delay:.3s}.wb:nth-child(5){animation-delay:.15s}.wb:nth-child(6){animation-delay:.05s}
@keyframes wv{0%,100%{height:6px;opacity:.4}50%{height:28px;opacity:1}}
@keyframes spin{to{transform:rotate(360deg)}}
.transcript-box{width:100%;background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius-sm);padding:14px;font-size:14px;line-height:1.7;min-height:56px;}

/* VOCAB TABLE */
.search-bar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:16px;}
.search-inp{flex:1;min-width:160px;background:var(--surface);border:1.5px solid var(--border2);border-radius:var(--radius-sm);padding:9px 14px;font-size:14px;color:var(--ink);font-family:var(--font-b);outline:none;transition:border-color .15s;}
.search-inp:focus{border-color:var(--teal);}
.sel-inp{background:var(--surface);border:1.5px solid var(--border2);border-radius:var(--radius-sm);padding:9px 12px;font-size:14px;color:var(--ink);font-family:var(--font-b);outline:none;cursor:pointer;}
.tbl-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch;width:100%;}
.vtbl{width:100%;border-collapse:collapse;min-width:780px;table-layout:auto;}
.vtbl th{text-align:left;padding:10px 14px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:var(--ink3);border-bottom:2px solid var(--border);white-space:nowrap;}
.vtbl td{padding:12px 14px;font-size:14px;border-bottom:1px solid var(--bg2);vertical-align:middle;}
.vtbl td.td-word{min-width:120px;white-space:nowrap;}
.vtbl td.td-ipa{min-width:110px;white-space:nowrap;}
.vtbl td.td-meaning{min-width:160px;}
.vtbl td.td-example{min-width:200px;}
.vtbl td.td-topic{min-width:160px;}
.vtbl td.td-actions{min-width:100px;white-space:nowrap;}
.vtbl tr:hover td{background:var(--surface2);}
.vt-word{font-family:var(--font-d);font-weight:700;font-size:16px;color:var(--teal);}
.vt-ipa{color:var(--ink3);font-style:italic;font-size:13px;}
.star-btn{background:none;border:none;cursor:pointer;font-size:18px;color:var(--ink4);transition:all .15s;padding:4px;}
.star-btn.starred{color:var(--amber);}
.star-btn:hover{transform:scale(1.25);}

/* IMPORT */
.drop-zone{border:2px dashed var(--border2);border-radius:var(--radius);padding:44px 24px;text-align:center;cursor:pointer;transition:all .2s;background:var(--surface);}
.drop-zone:hover,.drop-zone.drag{border-color:var(--teal);background:var(--teal-light);}
.drop-zone:active{transform:scale(.99);}
.dz-icon{font-size:44px;margin-bottom:14px;}
.dz-title{font-family:var(--font-d);font-size:18px;font-weight:700;margin-bottom:6px;}
.dz-sub{color:var(--ink3);font-size:13px;line-height:1.6;}
.info-box{display:flex;gap:12px;align-items:flex-start;flex-wrap:wrap;background:#f0fdf9;border:1.5px solid rgba(13,148,136,.2);border-radius:var(--radius-sm);padding:14px 16px;margin-bottom:14px;}
.info-box p{font-size:13px;color:var(--ink2);flex:1;line-height:1.6;}

/* PROGRESS */
.stats-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px;}
.stat-tile{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius);padding:18px 14px;text-align:center;box-shadow:var(--shadow-sm);}
.stat-tile-icon{font-size:26px;margin-bottom:8px;}
.stat-tile-val{font-family:var(--font-d);font-size:26px;font-weight:900;color:var(--teal);margin-bottom:2px;}
.stat-tile-lbl{font-size:12px;color:var(--ink3);font-weight:600;}
.ach-grid{display:flex;flex-wrap:wrap;gap:10px;}
.ach-item{display:flex;align-items:center;gap:10px;background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius-sm);padding:12px 16px;box-shadow:var(--shadow-sm);}
.ach-icon{font-size:28px;}
.ach-name{font-weight:700;font-size:13px;}.ach-desc{font-size:11px;color:var(--ink3);}

/* WEEK */
.week-row{display:flex;gap:6px;}
.wday{flex:1;text-align:center;}
.wday-lbl{font-size:10px;font-weight:700;color:var(--ink4);margin-bottom:5px;text-transform:uppercase;}
.wday-dot{width:34px;height:34px;border-radius:50%;margin:0 auto;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;background:var(--bg2);color:var(--ink4);border:1.5px solid var(--border);}
.wday-dot.today{background:var(--teal);color:#fff;border-color:var(--teal);font-size:15px;}

/* MODAL */
.modal-overlay{display:none;position:fixed;inset:0;z-index:300;background:rgba(0,0,0,.4);backdrop-filter:blur(4px);align-items:center;justify-content:center;padding:16px;}
.modal-overlay.show{display:flex;}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:28px;width:100%;max-width:480px;box-shadow:var(--shadow-lg);animation:mIn .25s ease;max-height:90vh;overflow-y:auto;}
@keyframes mIn{from{opacity:0;transform:scale(.96) translateY(8px)}to{opacity:1;transform:scale(1) translateY(0)}}
.modal-title{font-family:var(--font-d);font-weight:700;font-size:20px;margin-bottom:4px;}
.modal-sub{color:var(--ink3);font-size:13px;margin-bottom:20px;}
.fg{margin-bottom:14px;}
.flbl{display:block;font-size:12px;font-weight:700;color:var(--ink2);text-transform:uppercase;letter-spacing:.06em;margin-bottom:5px;}
.finp{width:100%;background:var(--surface2);border:1.5px solid var(--border2);border-radius:var(--radius-sm);padding:10px 13px;font-size:14px;color:var(--ink);font-family:var(--font-b);outline:none;transition:border-color .15s;}
.finp:focus{border-color:var(--teal);background:#fff;}
.modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:20px;}

/* TOAST */
.toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);z-index:9400;background:var(--ink);color:#fff;border-radius:20px;padding:11px 22px;font-size:14px;font-weight:600;display:flex;align-items:center;gap:8px;box-shadow:var(--shadow-lg);animation:tIn .3s ease;white-space:nowrap;max-width:90vw;}
@keyframes tIn{from{opacity:0;transform:translateX(-50%) translateY(12px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
.toast.success{background:#065f46;}.toast.error{background:#9f1239;}

/* EMPTY */
.empty-state{text-align:center;padding:52px 20px;}
.empty-icon{font-size:52px;margin-bottom:14px;}
.empty-title{font-family:var(--font-d);font-size:20px;font-weight:700;margin-bottom:6px;}
.empty-sub{color:var(--ink3);font-size:14px;margin-bottom:22px;}

/* ‚îÄ‚îÄ VOCAB TABLE SELECTION ‚îÄ‚îÄ */
tr.row-selected td{background:rgba(13,148,136,.06)!important;}
tr.row-selected{outline:none;}
.vtbl th:first-child{padding-left:12px;}
.vtbl td:first-child{padding-left:12px;}

/* ‚îÄ‚îÄ PAGINATION ‚îÄ‚îÄ */
.pagination{display:flex;align-items:center;justify-content:center;gap:4px;padding:14px 0 4px;flex-wrap:wrap;}
.pg-btn{min-width:34px;height:34px;padding:0 10px;border-radius:var(--radius-sm);border:1.5px solid var(--border2);background:var(--surface);color:var(--ink2);font-size:13px;font-weight:600;cursor:pointer;transition:all .15s;display:flex;align-items:center;justify-content:center;}
.pg-btn:hover{border-color:var(--teal);color:var(--teal);background:var(--teal-light);}
.pg-btn.active{background:var(--teal);color:#fff;border-color:var(--teal);}
.pg-btn:disabled{opacity:.35;cursor:not-allowed;pointer-events:none;}
.pg-info{font-size:13px;color:var(--ink3);font-weight:500;padding:0 8px;}

/* ‚îÄ‚îÄ TOPIC INLINE EDIT ‚îÄ‚îÄ */
.topic-badge-btn{background:var(--teal-light);border:1.5px solid rgba(13,148,136,.2);color:var(--teal);border-radius:20px;padding:3px 9px;font-size:11px;font-weight:700;cursor:pointer;transition:all .15s;display:inline-flex;align-items:center;gap:4px;}
.topic-badge-btn:hover{background:var(--teal);color:#fff;}
.topic-select-inline{background:var(--surface);border:1.5px solid var(--teal);border-radius:var(--radius-sm);padding:4px 8px;font-size:12px;color:var(--ink);font-family:var(--font-b);outline:none;cursor:pointer;max-width:160px;}

/* ‚îÄ‚îÄ WORD IMAGE ‚îÄ‚îÄ */
.fc-img-wrap{width:100%;max-width:200px;margin:8px auto 0;border-radius:10px;overflow:hidden;border:1.5px solid var(--border);background:var(--bg2);aspect-ratio:1;display:flex;align-items:center;justify-content:center;}
.fc-img-wrap img{width:100%;height:100%;object-fit:cover;display:block;}
.fc-img-placeholder{font-size:36px;color:var(--ink4);}

/* Scrollbar */
::-webkit-scrollbar{width:5px;height:5px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px;}

/* ‚îÄ‚îÄ ROADMAP PANEL ‚îÄ‚îÄ */
.rdp-header{background:linear-gradient(135deg,#7c3aed 0%,#0d9488 100%);border-radius:var(--radius);padding:22px 24px;color:#fff;margin-bottom:18px;position:relative;overflow:hidden;}
.rdp-header::after{content:'üóìÔ∏è';position:absolute;right:20px;top:50%;transform:translateY(-50%);font-size:48px;opacity:.2;}
.rdp-header h2{font-family:var(--font-d);font-size:20px;font-weight:700;margin-bottom:4px;}
.rdp-header p{font-size:13px;opacity:.85;}
.rdp-day-card{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius);padding:16px 18px;margin-bottom:10px;cursor:pointer;transition:all .15s;position:relative;}
.rdp-day-card:hover{border-color:var(--teal);box-shadow:var(--shadow);}
.rdp-day-card.today-card{border-color:var(--teal);background:linear-gradient(135deg,rgba(13,148,136,.04),rgba(8,145,178,.04));}
.rdp-day-card.completed{border-color:#a7f3d0;background:rgba(13,148,136,.03);}
.rdp-day-card.missed{border-color:#fecdd3;background:rgba(225,29,72,.02);}
.rdp-day-badge{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:20px;font-size:10px;font-weight:700;margin-bottom:6px;}
.rdp-badge-today{background:var(--teal-light);color:var(--teal);}
.rdp-badge-done{background:#d1fae5;color:#065f46;}
.rdp-badge-miss{background:var(--rose-light);color:var(--rose);}
.rdp-badge-future{background:var(--bg2);color:var(--ink4);}
.rdp-day-title{font-family:var(--font-d);font-weight:700;font-size:15px;margin-bottom:4px;display:flex;align-items:center;gap:8px;}
.rdp-day-meta{font-size:12px;color:var(--ink3);display:flex;gap:12px;flex-wrap:wrap;}
.rdp-words-preview{display:flex;flex-wrap:wrap;gap:5px;margin-top:8px;}
.rdp-word-chip{background:var(--teal-light);border:1px solid rgba(13,148,136,.2);color:var(--teal);border-radius:20px;padding:2px 9px;font-size:11px;font-weight:600;}
.rdp-word-chip.learned{background:#d1fae5;border-color:#a7f3d0;color:#065f46;}
.rdp-word-chip.missed-chip{background:var(--rose-light);border-color:#fecdd3;color:var(--rose);}
.rdp-prog-bar{height:4px;background:var(--bg2);border-radius:2px;margin-top:8px;overflow:hidden;}
.rdp-prog-fill{height:100%;background:linear-gradient(90deg,var(--teal),var(--teal-mid));border-radius:2px;transition:width .4s;}
/* Stats dashboard */
.rdp-stat-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:18px;}
.rdp-stat-tile{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius-sm);padding:14px 10px;text-align:center;}
.rdp-stat-val{font-family:var(--font-d);font-size:22px;font-weight:900;color:var(--teal);display:block;}
.rdp-stat-lbl{font-size:11px;color:var(--ink3);font-weight:600;margin-top:2px;}
.rdp-tabs{display:flex;background:var(--bg2);border-radius:var(--radius-sm);padding:4px;margin-bottom:16px;border:1px solid var(--border);}
.rdp-tab{flex:1;padding:7px 12px;border-radius:6px;border:none;cursor:pointer;font-family:var(--font-b);font-size:13px;font-weight:600;background:transparent;color:var(--ink3);transition:all .15s;text-align:center;}
.rdp-tab.active{background:var(--surface);color:var(--violet);box-shadow:var(--shadow-sm);}
/* Chart bars */
.chart-bar-wrap{display:flex;align-items:flex-end;gap:6px;height:100px;padding:8px 0 0;}
.chart-bar-col{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;}
.chart-bar{width:100%;border-radius:4px 4px 0 0;background:var(--teal-light);border:1.5px solid rgba(13,148,136,.2);transition:height .4s;min-height:4px;}
.chart-bar.filled{background:linear-gradient(180deg,var(--teal-mid),var(--teal));border-color:var(--teal);}
.chart-lbl{font-size:10px;color:var(--ink4);font-weight:600;white-space:nowrap;}
.chart-val{font-size:10px;font-weight:700;color:var(--ink3);}
/* Quiz 10 words session */
.q10-progress{display:flex;gap:4px;margin-bottom:14px;flex-wrap:wrap;}
.q10-dot{width:22px;height:22px;border-radius:50%;border:2px solid var(--border2);background:var(--bg);display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:var(--ink4);transition:all .2s;}
.q10-dot.active{border-color:var(--teal);background:var(--teal-light);color:var(--teal);}
.q10-dot.correct{border-color:var(--teal);background:var(--teal);color:#fff;}
.q10-dot.wrong{border-color:var(--rose);background:var(--rose);color:#fff;}
/* Auto-fetch banner */
.fetch-banner{background:linear-gradient(135deg,var(--violet-light),var(--teal-light));border:1.5px solid rgba(124,58,237,.2);border-radius:var(--radius);padding:16px 20px;margin-bottom:16px;}
.fetch-banner h3{font-family:var(--font-d);font-size:15px;font-weight:700;margin-bottom:4px;color:var(--violet);}
.fetch-banner p{font-size:13px;color:var(--ink2);line-height:1.5;}

/* ‚îÄ‚îÄ TOPIC DETAIL PANEL ‚îÄ‚îÄ */
.topic-detail-header{display:flex;align-items:flex-start;gap:14px;margin-bottom:20px;flex-wrap:wrap;}
.topic-detail-name{font-family:var(--font-d);font-size:22px;font-weight:800;color:var(--ink);flex:1;min-width:0;word-break:break-word;}
.topic-detail-meta{font-size:13px;color:var(--ink3);margin-top:3px;}
.topic-actions-bar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;padding:12px 0;border-bottom:1px solid var(--border);margin-bottom:16px;}

/* Inline table action buttons */
.act-btn{display:inline-flex;align-items:center;justify-content:center;width:30px;height:30px;border-radius:6px;border:none;cursor:pointer;font-size:14px;transition:all .15s;background:transparent;}
.act-btn:active{transform:scale(.9);}
.act-edit{color:var(--teal);}
.act-edit:hover{background:var(--teal-light);}
.act-del{color:var(--rose);}
.act-del:hover{background:var(--rose-light);}
.act-star{color:var(--ink4);}
.act-star.on{color:var(--amber);}
.act-star:hover{background:var(--amber-light);}

/* Confirm dialog */
.confirm-overlay{display:none;position:fixed;inset:0;z-index:400;background:rgba(0,0,0,.45);backdrop-filter:blur(3px);align-items:center;justify-content:center;padding:16px;}
.confirm-overlay.show{display:flex;}
.confirm-box{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:28px 24px;max-width:380px;width:100%;box-shadow:var(--shadow-lg);animation:mIn .2s ease;text-align:center;}
.confirm-icon{font-size:36px;margin-bottom:12px;}
.confirm-title{font-family:var(--font-d);font-size:18px;font-weight:700;margin-bottom:6px;}
.confirm-msg{font-size:14px;color:var(--ink3);margin-bottom:22px;line-height:1.5;}
.confirm-actions{display:flex;gap:10px;justify-content:center;}

/* Topic card edit/delete overlay */
.topic-card-toolbar{display:flex;gap:6px;margin-top:12px;padding-top:10px;border-top:1px solid var(--border);}

/* Vocab search row on topic detail */
.detail-search-row{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;}

/* Empty within table */
.tbl-empty{text-align:center;padding:32px 16px;color:var(--ink3);font-size:14px;}

/* Action buttons in table */
.act-btn{display:inline-flex;align-items:center;justify-content:center;width:30px;height:30px;border-radius:6px;border:none;cursor:pointer;font-size:15px;transition:all .15s;background:transparent;}
.act-btn:active{transform:scale(.9);}
.act-edit{color:var(--teal);}.act-edit:hover{background:var(--teal-light);}
.act-del{color:var(--rose);}.act-del:hover{background:var(--rose-light);}

/* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
/* ‚îÄ‚îÄ VOCAB MOBILE CARD ‚îÄ‚îÄ */
.vocab-card-list{display:none;flex-direction:column;gap:10px;}
.vocab-card-item{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius);padding:14px 16px;position:relative;}
.vocab-card-word{font-family:var(--font-d);font-size:18px;font-weight:800;color:var(--teal);margin-bottom:2px;}
.vocab-card-ipa{font-size:12px;color:var(--ink3);font-style:italic;margin-bottom:6px;}
.vocab-card-meaning{font-size:14px;font-weight:600;color:var(--ink);margin-bottom:4px;}
.vocab-card-example{font-size:12px;color:var(--ink3);font-style:italic;line-height:1.5;margin-bottom:8px;padding:6px 10px;background:var(--surface2);border-radius:6px;border-left:2px solid var(--teal);}
.vocab-card-footer{display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap;}
.vocab-card-topic{font-size:11px;font-weight:700;color:var(--teal);background:var(--teal-light);padding:3px 8px;border-radius:10px;}
.vocab-card-actions{display:flex;gap:6px;align-items:center;}
/* Topic detail mobile */
.td-action-bar{display:flex;gap:8px;flex-wrap:wrap;}
.td-word-card{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius);padding:12px 14px;display:flex;align-items:center;gap:10px;}
.td-word-card-info{flex:1;min-width:0;}

@media(max-width:767px){
  :root{--mob-nav:58px;}
  .sidebar{display:none;}
  /* mob-nav is always fixed ‚Äî show via flex */
  .mob-nav{display:flex!important;}
  .main{margin-left:0;}

  /* ‚îÄ‚îÄ Safe area & spacing ‚Äî ƒë·ªß ch·ªó cho nav c·ªë ƒë·ªãnh ‚îÄ‚îÄ */
  .page-wrap{
    padding:12px 14px calc(var(--mob-nav) + env(safe-area-inset-bottom) + 20px);
    max-width:100%;
  }

  /* ‚îÄ‚îÄ Typography scale ‚îÄ‚îÄ */
  .page-title{font-size:21px;letter-spacing:-.3px;}
  .page-sub{font-size:13px;}
  .page-header{margin-bottom:16px;}

  /* ‚îÄ‚îÄ Home hero ‚îÄ‚îÄ */
  .home-hero{
    padding:16px 18px;margin-bottom:12px;border-radius:16px;
  }
  .home-hero h2{font-size:18px;line-height:1.3;}
  .home-hero p{font-size:12.5px;}
  .home-hero::after{font-size:40px;right:14px;top:50%;transform:translateY(-50%);}

  /* ‚îÄ‚îÄ Home grid ‚Äî 2 cols on mobile ‚îÄ‚îÄ */
  .home-grid{grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px;}
  .hcard{padding:12px 10px;gap:8px;border-radius:12px;min-height:72px;}
  .hcard-icon{width:36px;height:36px;font-size:18px;border-radius:9px;flex-shrink:0;}
  .hcard-title{font-size:13px;line-height:1.3;}
  .hcard-sub{font-size:11px;display:none;}/* hide sub on mobile for clean look */

  /* ‚îÄ‚îÄ Topics grid ‚îÄ‚îÄ */
  .topics-grid{grid-template-columns:1fr 1fr;gap:10px;}
  .topic-card{padding:14px 12px;border-radius:14px;}
  .topic-name{font-size:14px;}
  .topic-count{font-size:11px;}

  /* ‚îÄ‚îÄ Study area ‚îÄ‚îÄ */
  .tabs{
    padding:3px;gap:0;
    overflow-x:auto;-webkit-overflow-scrolling:touch;
    scrollbar-width:none;flex-wrap:nowrap;
  }
  .tabs::-webkit-scrollbar{display:none;}
  .tab-btn{
    padding:8px 12px;font-size:12.5px;
    min-width:max-content;flex:0 0 auto;border-radius:7px;
  }

  /* ‚îÄ‚îÄ Flashcard ‚îÄ‚îÄ */
  .fc-card{border-radius:16px;}
  .fc-card-body{padding:20px 16px 16px;}
  .fc-word{font-size:clamp(24px,8vw,38px);}
  .fc-card-footer{
    padding:14px 16px 18px;
    flex-direction:column;gap:8px;
  }
  .rating-row{gap:6px;width:100%;}
  .rate-btn{
    flex:1;padding:12px 8px;font-size:13px;
    text-align:center;justify-content:center;
    min-height:48px;/* comfortable touch target */
    border-radius:12px;
  }

  /* ‚îÄ‚îÄ Quiz ‚îÄ‚îÄ */
  .opts{grid-template-columns:1fr;}
  .opt{padding:14px 16px;font-size:14px;min-height:52px;border-radius:12px;}
  .quiz-q{font-size:16px;line-height:1.5;}
  .quiz-meta{gap:8px;padding:8px 10px;border-radius:10px;}

  /* ‚îÄ‚îÄ Speaking ‚îÄ‚îÄ */
  .speak-word-big{font-size:24px;}
  .rec-ring{width:70px;height:70px;font-size:28px;}
  .rec-zone{padding:22px 16px;gap:14px;}

  /* ‚îÄ‚îÄ Roadmap ‚îÄ‚îÄ */
  .rdp-day-card{padding:12px 14px;border-radius:14px;}
  .rdp-stat-grid{grid-template-columns:repeat(2,1fr);gap:8px;}

  /* ‚îÄ‚îÄ Stats ‚îÄ‚îÄ */
  .stats-grid{grid-template-columns:repeat(2,1fr);gap:8px;}
  .stat-tile{padding:14px 10px;border-radius:12px;}
  .stat-tile-val{font-size:24px;}

  /* ‚îÄ‚îÄ Cards ‚îÄ‚îÄ */
  .card{padding:14px;border-radius:14px;}

  /* ‚îÄ‚îÄ Buttons ‚Äî larger touch targets ‚îÄ‚îÄ */
  .btn{font-size:14px;padding:11px 16px;border-radius:10px;min-height:44px;}
  .btn-sm{padding:8px 14px;font-size:13px;min-height:38px;border-radius:8px;}

  /* ‚îÄ‚îÄ Modals ‚îÄ‚îÄ */
  .modal{
    padding:22px 18px 24px;border-radius:20px 20px 0 0;
    position:fixed;bottom:0;left:0;right:0;
    max-height:90vh;overflow-y:auto;
    margin:0;width:100%;
    box-shadow:0 -8px 40px rgba(0,0,0,.18);
  }
  .modal-overlay{align-items:flex-end;}
  .modal-title{font-size:18px;}

  /* ‚îÄ‚îÄ Table ‚Üí hidden, show card view ‚îÄ‚îÄ */
  .tbl-wrap{display:none;}
  .vocab-card-list{display:flex;}

  /* ‚îÄ‚îÄ Vocab cards ‚îÄ‚îÄ */
  .vocab-card{padding:14px;border-radius:14px;}
  .vocab-card-word{font-size:17px;}
  .vocab-card-meaning{font-size:13px;}

  /* ‚îÄ‚îÄ Chips ‚îÄ‚îÄ */
  .chip{padding:5px 12px;font-size:12px;border-radius:20px;}

  /* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
  .toast{
    bottom:calc(var(--mob-nav) + env(safe-area-inset-bottom) + 8px);
    font-size:13px;padding:10px 20px;border-radius:24px;
    max-width:calc(100vw - 32px);text-align:center;
  }

  /* ‚îÄ‚îÄ Progress chips ‚îÄ‚îÄ */
  .ach-item{padding:10px 12px;border-radius:12px;}

  /* ‚îÄ‚îÄ Mobile nav labels ‚îÄ‚îÄ */
  .mob-item{font-size:9.5px;}
  .mob-item .mi{font-size:20px;}

  /* ‚îÄ‚îÄ Writing module ‚îÄ‚îÄ */
  .wr-setup-card{padding:16px;border-radius:14px;}
  .wr-hero{padding:18px 20px;border-radius:14px;}
  .wr-hero h2{font-size:18px;}
  .wr-sentence-card{padding:18px 16px 16px;border-radius:16px;}
  .wr-vi-sentence{font-size:17px;}
  .wr-input{font-size:15px;padding:13px 15px;}
  .wr-submit-row{gap:8px;}

  /* ‚îÄ‚îÄ Listening module ‚îÄ‚îÄ */
  .lt-mode-tabs{grid-template-columns:repeat(2,1fr);gap:8px;}
  .lt-mode-tab{padding:12px 6px;border-radius:12px;}

  /* ‚îÄ‚îÄ Speaking Pro module ‚îÄ‚îÄ */
  .sp-mode-tabs{grid-template-columns:repeat(2,1fr);}
  .sp-mode-tab{padding:11px 4px;}
  .sp-rec-btn{width:80px;height:80px;font-size:32px;}
  .sp-rp-bubble{max-width:88%;}
  .sp-rp-chat{max-height:calc(100vh - 380px);}

  /* ‚îÄ‚îÄ Stress syllables ‚îÄ‚îÄ */
  .sp-stress-syllables{gap:4px;}
  .sp-phoneme-row{gap:5px;}
  .sp-phoneme{min-width:38px;padding:6px 8px;}

  /* ‚îÄ‚îÄ Search bar ‚îÄ‚îÄ */
  .search-bar{flex-direction:column;gap:8px;}
  .search-bar .sel-inp,.search-bar .search-inp{width:100%;}

  /* ‚îÄ‚îÄ Topic detail header ‚îÄ‚îÄ */
  .topic-detail-mobile-header{display:flex;flex-direction:column;gap:10px;}
  .topic-detail-mobile-actions{display:flex;gap:8px;flex-wrap:wrap;}

  /* ‚îÄ‚îÄ Week calendar dots ‚îÄ‚îÄ */
  .wday-dot{width:32px;height:32px;font-size:11px;border-radius:50%;}

  /* ‚îÄ‚îÄ Sidebar stats (hidden on mobile) ‚îÄ‚îÄ */
  .s-stat-val{font-size:14px;}

  /* ‚îÄ‚îÄ Study top nav ‚îÄ‚îÄ */
  .study-top{padding:8px 0;gap:8px;}

  /* ‚îÄ‚îÄ Dialogue bubbles ‚îÄ‚îÄ */
  .dlg-bubble{max-width:88%;}
  .dlg-text{font-size:13.5px;}

  /* ‚îÄ‚îÄ Roadmap quiz word builder ‚îÄ‚îÄ */
  .rdp-builder-chips{flex-wrap:wrap;gap:6px;}

  /* ‚îÄ‚îÄ Form inputs ‚îÄ‚îÄ */
  .finp, input[type=text], input[type=password], input[type=email], textarea, select{
    font-size:16px !important;/* prevent iOS zoom */
    min-height:44px;
  }
  select{min-height:44px;}

  /* ‚îÄ‚îÄ Config modal ‚îÄ‚îÄ */
  .fb-modal{padding:20px 16px;border-radius:20px 20px 0 0;}

  /* ‚îÄ‚îÄ Inline pull-to-refresh visual cue ‚îÄ‚îÄ */
  .page-wrap{overscroll-behavior-y:contain;}

  /* ‚îÄ‚îÄ Quick action FAB area (extra bottom padding fix) ‚îÄ‚îÄ */
  .qz-actions, .fc-card-footer, .sp-rec-area{
    padding-bottom:max(16px, env(safe-area-inset-bottom));
  }
}

/* ‚îÄ‚îÄ Extra small phones (‚â§390px) ‚îÄ‚îÄ */
@media(max-width:390px){
  .home-grid{grid-template-columns:1fr 1fr;}
  .topics-grid{grid-template-columns:1fr;}
  .rate-btn{font-size:12px;padding:11px 6px;}
  .opts{grid-template-columns:1fr;}
  .stats-grid{grid-template-columns:repeat(2,1fr);}
  .tabs{flex-wrap:nowrap;overflow-x:auto;}
  .tab-btn{flex-shrink:0;font-size:11.5px;}
  .hcard{flex-direction:row;}
  .hcard-sub{display:none;}
  .fc-word{font-size:clamp(20px,7vw,30px);}
  .page-title{font-size:19px;}
  .lt-mode-tabs{grid-template-columns:repeat(2,1fr);}
  .mob-item .mi{font-size:19px;}
  .mob-item{font-size:9px;}
}
@media(min-width:768px){
  /* Hide mobile-only home components on desktop */
  .home-stats-strip{display:none;}
  .home-week-wrap{display:none;}
  .home-continue-card{max-width:600px;}
  /* Show legacy desktop today-stats section */
  #home-quick-stats{display:block!important;}
}
@media(min-width:768px) and (max-width:1024px){
  .sidebar{width:210px;}
  .main{margin-left:210px;}
  .page-wrap{padding:22px 18px;}
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   AUTH & SYNC STYLES ‚Äî SpeakUp v41
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.sidebar{padding-bottom:0 !important;}

/* ‚îÄ‚îÄ Sidebar auth zone ‚îÄ‚îÄ */
.auth-zone{border-top:1px solid var(--border);padding:12px 14px 14px;background:var(--surface2);}
.auth-tagline{font-size:10px;color:var(--ink4);font-weight:700;text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px;text-align:center;}
.btn-open-login{display:flex;align-items:center;justify-content:center;gap:7px;width:100%;padding:10px 14px;background:var(--teal);color:#fff;border:none;border-radius:var(--radius-sm);cursor:pointer;font-family:var(--font-b);font-size:13px;font-weight:700;transition:all .15s;}
.btn-open-login:hover{background:#0f766e;}

/* ‚îÄ‚îÄ Desktop sidebar Firebase section ‚îÄ‚îÄ */
.sb-fb-section{
  border-top:1px solid var(--border);
  background:var(--surface2);
  padding:10px 14px 12px;
  flex-shrink:0;
}
.sb-fb-header{
  display:flex;align-items:center;justify-content:space-between;
  cursor:pointer;padding:2px 0 6px;
  -webkit-tap-highlight-color:transparent;
  user-select:none;
}
.sb-fb-header-left{display:flex;align-items:center;gap:7px;}
.sb-fb-icon{font-size:14px;line-height:1;}
.sb-fb-title{font-size:11px;font-weight:800;color:var(--ink2);letter-spacing:.01em;}
.sb-fb-status-dot{
  width:7px;height:7px;border-radius:50%;flex-shrink:0;
  background:var(--ink4);transition:background .3s;
}
.sb-fb-status-dot.connected{background:#22c55e;}
.sb-fb-status-dot.disconnected{background:var(--rose);}
.sb-fb-chevron{font-size:10px;color:var(--ink4);transition:transform .22s;line-height:1;}
.sb-fb-chevron.open{transform:rotate(180deg);}
.sb-fb-body{
  display:none;padding-top:8px;
}
.sb-fb-body.open{display:block;}
.sb-fb-connected-card{
  display:flex;align-items:center;gap:7px;
  background:var(--teal-light);border:1.5px solid rgba(13,148,136,.25);
  border-radius:8px;padding:8px 10px;margin-bottom:10px;
}
.sb-fb-connected-icon{font-size:14px;}
.sb-fb-connected-info{flex:1;min-width:0;}
.sb-fb-connected-label{font-size:10px;font-weight:700;color:var(--teal);text-transform:uppercase;letter-spacing:.04em;}
.sb-fb-connected-proj{font-size:11px;font-weight:700;color:var(--ink);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:1px;}
.sb-fb-disconnected-card{
  background:var(--rose-light);border:1.5px solid #fecdd3;
  border-radius:8px;padding:8px 10px;margin-bottom:10px;
  font-size:11px;color:#9f1239;font-weight:600;
  display:flex;align-items:center;gap:6px;
}
.sb-fb-field{margin-bottom:7px;}
.sb-fb-field label{
  display:block;font-size:9.5px;font-weight:700;color:var(--ink4);
  text-transform:uppercase;letter-spacing:.05em;margin-bottom:3px;
}
.sb-fb-field input{
  width:100%;padding:7px 9px;border:1.5px solid var(--border2);
  border-radius:6px;font-size:11.5px;font-family:var(--font-b);
  color:var(--ink);background:var(--surface);outline:none;
  transition:border-color .15s;box-sizing:border-box;
}
.sb-fb-field input:focus{border-color:var(--teal);box-shadow:0 0 0 2px rgba(13,148,136,.1);}
.sb-fb-field input.err-inp{border-color:var(--rose);}
.sb-fb-err{font-size:11px;color:var(--rose);font-weight:600;margin-bottom:6px;display:none;padding:6px 8px;background:var(--rose-light);border-radius:6px;}
.sb-fb-btn-row{display:flex;gap:5px;margin-top:8px;}
.sb-fb-btn{
  flex:1;padding:7px 6px;border-radius:6px;font-size:11px;
  font-weight:700;font-family:var(--font-b);cursor:pointer;
  border:none;transition:all .15s;text-align:center;
}
.sb-fb-btn.primary{background:var(--teal);color:#fff;}
.sb-fb-btn.primary:hover{background:#0f766e;}
.sb-fb-btn.outline{background:transparent;border:1.5px solid var(--border2);color:var(--ink3);}
.sb-fb-btn.outline:hover{border-color:var(--teal);color:var(--teal);}
.sb-fb-btn.danger{background:var(--rose-light);color:var(--rose);border:1.5px solid #fecdd3;}
.sb-fb-btn.danger:hover{background:var(--rose);color:#fff;}
.sb-fb-paste-hint{font-size:10px;color:var(--ink4);text-align:center;margin-top:6px;line-height:1.4;}
.sb-fb-section-divider{height:1px;background:var(--border);margin:0 -14px 10px;}

/* ‚îÄ‚îÄ User card (logged in) ‚îÄ‚îÄ */
.auth-user-card{display:flex;align-items:center;gap:8px;padding:8px 10px;background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius-sm);margin-bottom:8px;}
.auth-avatar-ph{width:32px;height:32px;border-radius:50%;background:var(--teal);display:flex;align-items:center;justify-content:center;color:#fff;font-size:14px;font-weight:800;flex-shrink:0;}
.auth-avatar-ph.admin-av{background:linear-gradient(135deg,var(--violet),#9333ea);}
.auth-info{flex:1;min-width:0;}
.auth-uname{font-size:12px;font-weight:800;color:var(--ink);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.auth-role-badge{display:inline-flex;align-items:center;gap:3px;font-size:10px;font-weight:700;padding:1px 7px;border-radius:10px;margin-top:2px;}
.auth-role-badge.admin{background:linear-gradient(90deg,var(--violet-light),#ede9fe);color:var(--violet);}
.auth-role-badge.user{background:var(--teal-light);color:var(--teal);}

/* ‚îÄ‚îÄ Sync badge ‚îÄ‚îÄ */
.sync-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:7px;}
.sync-badge{display:inline-flex;align-items:center;gap:5px;font-size:10px;font-weight:700;padding:3px 8px;border-radius:20px;}
.sync-badge.ok{background:var(--teal-light);color:var(--teal);}
.sync-badge.busy{background:var(--amber-light);color:var(--amber);}
.sync-badge.err{background:var(--rose-light);color:var(--rose);}
.sync-badge.offline{background:var(--bg2);color:var(--ink3);}
.spin{display:inline-block;width:9px;height:9px;border:2px solid rgba(217,119,6,.3);border-top-color:var(--amber);border-radius:50%;animation:_spin .7s linear infinite;}
@keyframes _spin{to{transform:rotate(360deg)}}
.btn-signout{width:100%;padding:7px;background:transparent;border:1.5px solid var(--border);border-radius:var(--radius-sm);cursor:pointer;font-size:11px;font-weight:600;color:var(--ink4);font-family:var(--font-b);transition:all .15s;}
.btn-signout:hover{border-color:var(--rose);color:var(--rose);}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MOBILE ACCOUNT DRAWER ‚Äî bottom sheet
   Hi·ªán khi b·∫•m tab "T√†i kho·∫£n" tr√™n mobile nav
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.mob-account-overlay{
  display:none;position:fixed;inset:0;z-index:9500;
  background:rgba(0,0,0,.45);backdrop-filter:blur(3px);
  -webkit-backdrop-filter:blur(3px);
  animation:fadeIn .2s ease;
  /* z-index 9500: cao h∆°n t·∫•t c·∫£ (login-wall:8000, fb-modal:9000) */
}
.mob-account-overlay.open{display:flex;align-items:flex-end;}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}

.mob-account-sheet{
  width:100%;background:var(--surface);
  border-radius:22px 22px 0 0;
  padding:0 0 calc(env(safe-area-inset-bottom) + 8px);
  box-shadow:0 -8px 40px rgba(0,0,0,.2);
  animation:sheetUp .28s cubic-bezier(.4,0,.2,1);
  max-height:92dvh;overflow-y:auto;overflow-x:hidden;
  -webkit-overflow-scrolling:touch;
  position:relative;
  z-index:9501;
  /* z-index cao h∆°n overlay (9500) ƒë·ªÉ sheet lu√¥n n·ªïi tr√™n backdrop */
}
@keyframes sheetUp{from{transform:translateY(100%);opacity:.5}to{transform:translateY(0);opacity:1}}

/* Prevent background scroll when sheet open */
html.mob-sheet-open body{
  /* Kh√¥ng d√πng overflow:hidden ‚Äî ph√° v·ª° fixed elements tr√™n iOS */
  /* Ch·ªâ d√πng touch-action ƒë·ªÉ block scroll ·ªü background */
}

/* Handle bar */
.mob-sheet-handle{
  width:40px;height:4px;background:var(--border2);
  border-radius:2px;margin:12px auto 0;
}

/* Sheet header */
.mob-sheet-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:14px 20px 10px;border-bottom:1px solid var(--border);
}
.mob-sheet-title{
  font-family:var(--font-d);font-size:17px;font-weight:800;color:var(--ink);
}
.mob-sheet-close{
  width:32px;height:32px;border-radius:50%;background:var(--bg2);
  border:none;cursor:pointer;font-size:16px;
  display:flex;align-items:center;justify-content:center;
  color:var(--ink3);transition:all .15s;
  -webkit-tap-highlight-color:transparent;
}
.mob-sheet-close:active{background:var(--border);transform:scale(.9);}

/* ‚îÄ‚îÄ LOGGED OUT state ‚îÄ‚îÄ */
.mob-auth-loggedout{padding:20px 20px 16px;}
.mob-auth-brand{
  display:flex;align-items:center;gap:10px;margin-bottom:16px;
}
.mob-auth-brand-icon{
  width:42px;height:42px;background:var(--teal);border-radius:12px;
  display:flex;align-items:center;justify-content:center;font-size:22px;
}
.mob-auth-brand-text{font-family:var(--font-d);font-size:19px;font-weight:900;color:var(--ink);}
.mob-auth-tagline{font-size:13px;color:var(--ink3);margin-bottom:20px;line-height:1.5;}

.mob-login-tabs{
  display:flex;background:var(--bg2);border-radius:10px;
  padding:3px;margin-bottom:16px;gap:3px;
}
.mob-login-tab{
  flex:1;padding:9px;border-radius:8px;border:none;
  cursor:pointer;font-family:var(--font-b);font-size:13px;font-weight:700;
  background:transparent;color:var(--ink3);transition:all .18s;
  -webkit-tap-highlight-color:transparent;
}
.mob-login-tab.active{background:var(--surface);color:var(--teal);box-shadow:var(--shadow-sm);}

.mob-login-field{margin-bottom:12px;position:relative;}
.mob-login-field label{
  display:block;font-size:11px;font-weight:700;color:var(--ink3);
  margin-bottom:5px;text-transform:uppercase;letter-spacing:.05em;
}
.mob-login-field input{
  width:100%;padding:13px 15px;border:1.5px solid var(--border2);
  border-radius:12px;font-size:16px;font-family:var(--font-b);
  color:var(--ink);background:var(--surface2);outline:none;
  transition:all .18s;box-sizing:border-box;
  -webkit-appearance:none;
}
.mob-login-field input:focus{
  border-color:var(--teal);box-shadow:0 0 0 3px rgba(13,148,136,.12);
  background:var(--surface);
}
.mob-login-field input.err{border-color:var(--rose);}
.mob-pw-toggle{
  position:absolute;right:14px;bottom:13px;
  cursor:pointer;font-size:18px;color:var(--ink4);
  -webkit-tap-highlight-color:transparent;
}

.mob-login-err{
  background:var(--rose-light);border:1.5px solid #fecdd3;
  border-radius:10px;padding:10px 13px;font-size:13px;
  color:#9f1239;font-weight:600;margin-bottom:12px;display:none;
}
.mob-login-ok{
  background:var(--teal-light);border:1.5px solid rgba(13,148,136,.3);
  border-radius:10px;padding:10px 13px;font-size:13px;
  color:var(--teal);font-weight:600;margin-bottom:12px;display:none;
}
.mob-btn-submit{
  width:100%;padding:14px;border:none;border-radius:12px;
  background:var(--teal);color:#fff;font-family:var(--font-b);
  font-size:15px;font-weight:800;cursor:pointer;
  display:flex;align-items:center;justify-content:center;gap:8px;
  transition:all .15s;margin-bottom:10px;
  -webkit-tap-highlight-color:transparent;
}
.mob-btn-submit:active{transform:scale(.97);background:#0f766e;}
.mob-btn-submit:disabled{opacity:.6;cursor:not-allowed;}
.mob-btn-submit.admin-btn{background:linear-gradient(135deg,var(--violet),#7c3aed);}

.mob-login-footer{text-align:center;font-size:12px;color:var(--ink4);margin-bottom:4px;}

/* ‚îÄ‚îÄ Firebase config section inside drawer ‚îÄ‚îÄ */
.mob-fb-section{
  margin:0 20px 16px;padding:14px 16px;
  background:linear-gradient(135deg,#fff7ed,#fef3c7);
  border:1.5px solid #fde68a;border-radius:14px;
}
.mob-fb-toggle{
  display:flex;align-items:center;justify-content:space-between;
  cursor:pointer;-webkit-tap-highlight-color:transparent;
}
.mob-fb-toggle-left{display:flex;align-items:center;gap:8px;}
.mob-fb-toggle-icon{font-size:18px;}
.mob-fb-toggle-title{font-size:13px;font-weight:700;color:#92400e;}
.mob-fb-toggle-sub{font-size:11px;color:#b45309;margin-top:1px;}
.mob-fb-toggle-arrow{font-size:14px;color:#b45309;transition:transform .2s;}
.mob-fb-toggle-arrow.open{transform:rotate(180deg);}
.mob-fb-body{display:none;margin-top:14px;}
.mob-fb-body.open{display:block;}
.mob-fb-status{
  display:flex;align-items:center;gap:6px;padding:8px 12px;
  border-radius:8px;font-size:12px;font-weight:700;margin-bottom:12px;
}
.mob-fb-status.connected{background:var(--teal-light);color:var(--teal);}
.mob-fb-status.disconnected{background:var(--rose-light);color:var(--rose);}
.mob-fb-field{margin-bottom:8px;}
.mob-fb-field label{font-size:10px;font-weight:700;color:#92400e;display:block;margin-bottom:3px;text-transform:uppercase;letter-spacing:.04em;}
.mob-fb-field input{
  width:100%;padding:10px 12px;border:1.5px solid #fde68a;
  border-radius:9px;font-size:13px;font-family:var(--font-b);
  color:var(--ink);background:#fffbeb;outline:none;
  transition:border-color .15s;box-sizing:border-box;
  -webkit-appearance:none;
}
.mob-fb-field input:focus{border-color:#f59e0b;box-shadow:0 0 0 3px rgba(245,158,11,.1);}
.mob-fb-actions{display:flex;gap:8px;margin-top:12px;}
.mob-fb-btn{
  flex:1;padding:10px;border:none;border-radius:9px;
  font-family:var(--font-b);font-size:12px;font-weight:700;
  cursor:pointer;transition:all .15s;
  -webkit-tap-highlight-color:transparent;
}
.mob-fb-btn.primary{background:var(--teal);color:#fff;}
.mob-fb-btn.primary:active{background:#0f766e;}
.mob-fb-btn.outline{background:transparent;border:1.5px solid #fde68a;color:#92400e;}
.mob-fb-btn.danger{background:var(--rose-light);color:var(--rose);border:1.5px solid #fecdd3;}
.mob-fb-paste-hint{font-size:11px;color:#92400e;text-align:center;margin-top:8px;opacity:.8;}

/* ‚îÄ‚îÄ LOGGED IN state ‚îÄ‚îÄ */
.mob-auth-loggedin{padding:20px 20px 16px;}
.mob-user-card{
  display:flex;align-items:center;gap:12px;
  background:var(--surface2);border:1.5px solid var(--border);
  border-radius:14px;padding:14px 16px;margin-bottom:14px;
}
.mob-user-avatar{
  width:46px;height:46px;border-radius:50%;
  background:var(--teal);display:flex;align-items:center;
  justify-content:center;color:#fff;font-size:20px;font-weight:800;
  flex-shrink:0;
}
.mob-user-avatar.admin{background:linear-gradient(135deg,var(--violet),#7c3aed);}
.mob-user-name{font-family:var(--font-d);font-weight:800;font-size:16px;color:var(--ink);}
.mob-user-role{margin-top:4px;}
.mob-sync-row{
  display:flex;align-items:center;justify-content:space-between;
  padding:12px 16px;background:var(--surface2);border:1.5px solid var(--border);
  border-radius:12px;margin-bottom:12px;
}
.mob-sync-label{font-size:13px;font-weight:600;color:var(--ink2);}
.mob-sync-right{display:flex;align-items:center;gap:8px;}
.mob-sync-btn{
  background:none;border:1.5px solid var(--border);border-radius:8px;
  padding:6px 10px;cursor:pointer;font-size:13px;
  color:var(--ink3);transition:all .15s;font-family:var(--font-b);
  -webkit-tap-highlight-color:transparent;
}
.mob-sync-btn:active{background:var(--bg2);}
.mob-stat-row{
  display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:14px;
}
.mob-stat-box{
  background:var(--surface2);border:1.5px solid var(--border);
  border-radius:12px;padding:12px 8px;text-align:center;
}
.mob-stat-box-val{
  font-family:var(--font-d);font-weight:800;font-size:20px;
  color:var(--teal);line-height:1;
}
.mob-stat-box-lbl{font-size:10px;color:var(--ink4);margin-top:3px;font-weight:600;}
.mob-signout-btn{
  width:100%;padding:13px;background:transparent;
  border:1.5px solid var(--border);border-radius:12px;
  cursor:pointer;font-size:14px;font-weight:700;
  color:var(--ink3);font-family:var(--font-b);
  display:flex;align-items:center;justify-content:center;gap:8px;
  transition:all .18s;-webkit-tap-highlight-color:transparent;
}
.mob-signout-btn:active{border-color:var(--rose);color:var(--rose);background:var(--rose-light);}

/* Mob nav account badge */
.mob-item-badge{
  position:absolute;top:6px;right:calc(50% - 18px);
  width:8px;height:8px;border-radius:50%;
  background:var(--teal);border:2px solid var(--surface);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   LOGIN FULLSCREEN OVERLAY
   (hi·ªán khi ch∆∞a ƒëƒÉng nh·∫≠p ‚Äî b·ªãt h·∫øt UI)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.login-wall{display:none;position:fixed;inset:0;z-index:8000;background:linear-gradient(135deg,#0d9488 0%,#0891b2 50%,#7c3aed 100%);align-items:center;justify-content:center;padding:16px;overflow-y:auto;}
.login-wall.show{display:flex;}
/* Mobile: login wall chi·∫øm to√†n m√†n h√¨nh, scroll ƒë∆∞·ª£c */
@media(max-width:767px){
  .login-wall{align-items:flex-start;padding:env(safe-area-inset-top,20px) 16px 80px;}
  .login-box{margin-top:20px;max-width:100%;}
}
.login-box{background:var(--surface);border-radius:18px;padding:32px 28px 26px;width:100%;max-width:380px;box-shadow:0 24px 64px rgba(0,0,0,.25);position:relative;overflow:hidden;}
.login-box::before{content:'üó£Ô∏è';position:absolute;right:-8px;top:-12px;font-size:90px;opacity:.06;}
.login-logo{display:flex;align-items:center;gap:10px;margin-bottom:6px;}
.login-logo-icon{width:38px;height:38px;background:var(--teal);border-radius:11px;display:flex;align-items:center;justify-content:center;font-size:20px;}
.login-logo-text{font-family:var(--font-d);font-size:22px;font-weight:900;color:var(--ink);}
.login-tagline{font-size:13px;color:var(--ink3);margin-bottom:22px;}

/* Tabs login/register */
.login-tabs{display:flex;background:var(--bg2);border-radius:8px;padding:3px;margin-bottom:18px;border:1px solid var(--border);}
.login-tab{flex:1;padding:8px;border-radius:6px;border:none;cursor:pointer;font-family:var(--font-b);font-size:13px;font-weight:600;background:transparent;color:var(--ink3);transition:all .15s;}
.login-tab.active{background:var(--surface);color:var(--teal);box-shadow:var(--shadow-sm);}

/* Fields */
.login-field{margin-bottom:12px;position:relative;}
.login-field label{display:block;font-size:11px;font-weight:700;color:var(--ink3);margin-bottom:4px;text-transform:uppercase;letter-spacing:.05em;}
.login-field input{width:100%;padding:11px 14px;border:1.5px solid var(--border2);border-radius:var(--radius-sm);font-size:14px;font-family:var(--font-b);color:var(--ink);background:var(--surface2);outline:none;transition:all .2s;}
.login-field input:focus{border-color:var(--teal);box-shadow:0 0 0 3px rgba(13,148,136,.12);background:var(--surface);}
.login-field input.err{border-color:var(--rose);box-shadow:0 0 0 3px rgba(225,29,72,.08);}
.login-field .pw-toggle{position:absolute;right:12px;bottom:11px;cursor:pointer;font-size:16px;color:var(--ink4);user-select:none;}
.login-field .pw-toggle:hover{color:var(--ink2);}

.login-err{background:var(--rose-light);border:1.5px solid #fecdd3;border-radius:var(--radius-sm);padding:9px 12px;font-size:12px;color:#9f1239;font-weight:600;margin-bottom:12px;display:none;}
.login-ok{background:var(--teal-light);border:1.5px solid rgba(13,148,136,.3);border-radius:var(--radius-sm);padding:9px 12px;font-size:12px;color:var(--teal);font-weight:600;margin-bottom:12px;display:none;}

.btn-login-submit{width:100%;padding:13px;border:none;border-radius:var(--radius-sm);background:var(--teal);color:#fff;font-family:var(--font-b);font-size:15px;font-weight:800;cursor:pointer;transition:all .15s;display:flex;align-items:center;justify-content:center;gap:8px;}
.btn-login-submit:hover{background:#0f766e;}
.btn-login-submit:active{transform:scale(.98);}
.btn-login-submit:disabled{opacity:.6;cursor:not-allowed;}
.btn-login-submit.admin-btn{background:linear-gradient(135deg,var(--violet),#7c3aed);}
.btn-login-submit.admin-btn:hover{background:linear-gradient(135deg,#6d28d9,#7c3aed);}

.login-footer{text-align:center;margin-top:14px;font-size:12px;color:var(--ink4);}

/* Firebase config modal (minimal, ch·ªâ khi c·∫ßn) */
.fb-modal-overlay{display:none;position:fixed;inset:0;z-index:9000;background:rgba(0,0,0,.5);backdrop-filter:blur(4px);align-items:center;justify-content:center;padding:16px;}
.fb-modal-overlay.open{display:flex;}
.fb-modal{background:var(--surface);border-radius:var(--radius);padding:22px;width:100%;max-width:420px;box-shadow:var(--shadow-lg);max-height:92vh;overflow-y:auto;}
.fb-modal-title{font-family:var(--font-d);font-weight:800;font-size:17px;color:var(--ink);margin-bottom:4px;}
.fb-modal-sub{font-size:12px;color:var(--ink3);margin-bottom:16px;line-height:1.5;}
.fb-field{margin-bottom:10px;}
.fb-field label{display:block;font-size:11px;font-weight:700;color:var(--ink3);margin-bottom:3px;text-transform:uppercase;letter-spacing:.05em;}
.fb-field input{width:100%;padding:9px 12px;border:1.5px solid var(--border2);border-radius:var(--radius-sm);font-size:13px;font-family:var(--font-b);color:var(--ink);background:var(--surface2);outline:none;transition:border-color .15s;}
.fb-field input:focus{border-color:var(--teal);box-shadow:0 0 0 3px rgba(13,148,136,.1);}
.fb-field input.err-inp{border-color:var(--rose);}
.fb-modal-actions{display:flex;gap:8px;margin-top:14px;}
.fb-err-msg{font-size:12px;color:var(--rose);margin-top:4px;font-weight:600;}
.fb-info-box{background:var(--amber-light);border:1.5px solid #fde68a;border-radius:var(--radius-sm);padding:10px 12px;font-size:12px;color:#78350f;margin-bottom:14px;line-height:1.7;}
.fb-info-box a{color:#92400e;font-weight:700;}
.fb-steps{counter-reset:fb-step;list-style:none;padding:0;margin-top:6px;}
.fb-steps li{counter-increment:fb-step;display:flex;gap:8px;margin-bottom:8px;font-size:12px;line-height:1.5;color:var(--ink2);}
.fb-steps li::before{content:counter(fb-step);display:flex;align-items:center;justify-content:center;min-width:20px;height:20px;background:var(--teal);color:#fff;border-radius:50%;font-size:10px;font-weight:800;flex-shrink:0;margin-top:1px;}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   LISTENING MODULE ‚Äî v45 REDESIGN
   M√†u ch·ªß ƒë·∫°o: Cyan-Teal gradient
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.lt-mode-tabs{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:20px;}
.lt-mode-tab{background:var(--surface);border:2px solid var(--border);border-radius:12px;padding:13px 6px;cursor:pointer;transition:all .2s;text-align:center;user-select:none;}
.lt-mode-tab:hover{border-color:#0891b2;background:#ecfeff;transform:translateY(-2px);box-shadow:0 4px 12px rgba(8,145,178,.12);}
.lt-mode-tab.active{border-color:#0891b2;background:linear-gradient(135deg,#ecfeff,#cffafe);box-shadow:0 4px 16px rgba(8,145,178,.2);}
.lt-mode-tab-icon{font-size:22px;margin-bottom:5px;}
.lt-mode-tab-label{font-size:11px;font-weight:800;color:var(--ink2);line-height:1.3;}
.lt-mode-tab.active .lt-mode-tab-label{color:#0891b2;}
.lt-setup-card{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius);padding:20px 22px;margin-bottom:18px;box-shadow:var(--shadow-sm);}
.lt-topbar{display:flex;align-items:center;gap:12px;margin-bottom:18px;padding:12px 16px;background:var(--surface);border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow-sm);}
.lt-pbar-wrap{flex:1;height:8px;background:var(--bg2);border-radius:4px;overflow:hidden;}
.lt-pbar-fill{height:100%;background:linear-gradient(90deg,#0891b2,#0d9488);border-radius:4px;transition:width .5s cubic-bezier(.4,0,.2,1);}
.lt-score-badge{display:flex;align-items:center;gap:5px;background:linear-gradient(135deg,#ecfeff,#cffafe);color:#0891b2;border-radius:20px;padding:4px 12px;font-size:12px;font-weight:700;border:1.5px solid rgba(8,145,178,.25);}

/* Audio player card */
.lt-audio-card{background:var(--surface);border:2px solid var(--border);border-radius:16px;padding:22px;margin-bottom:14px;box-shadow:var(--shadow);animation:qzIn .25s ease;}
.lt-audio-player{display:flex;align-items:center;gap:14px;background:linear-gradient(135deg,#ecfeff,#ccfbf1);border:2px solid rgba(8,145,178,.25);border-radius:14px;padding:16px 20px;margin-bottom:18px;}
.lt-play-btn{width:52px;height:52px;border-radius:50%;background:linear-gradient(135deg,#0891b2,var(--teal));border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:22px;color:#fff;flex-shrink:0;box-shadow:0 4px 12px rgba(8,145,178,.35);transition:all .15s;}
.lt-play-btn:hover{transform:scale(1.07);box-shadow:0 6px 18px rgba(8,145,178,.45);}
.lt-play-btn:active{transform:scale(.95);}
.lt-play-btn.playing{background:linear-gradient(135deg,var(--amber),#f59e0b);}
.lt-audio-info{flex:1;min-width:0;}
.lt-audio-label{font-size:12px;font-weight:700;color:var(--ink4);text-transform:uppercase;letter-spacing:.07em;margin-bottom:4px;}
.lt-audio-wave{display:flex;align-items:center;gap:3px;height:28px;}
.lt-wave-bar{width:4px;border-radius:2px;background:var(--teal);transition:height .1s;}
.lt-wave-bar.active{animation:waveAnim .6s ease infinite alternate;}
.lt-wave-bar:nth-child(1){animation-delay:0s;height:8px;}
.lt-wave-bar:nth-child(2){animation-delay:.1s;height:14px;}
.lt-wave-bar:nth-child(3){animation-delay:.2s;height:20px;}
.lt-wave-bar:nth-child(4){animation-delay:.3s;height:12px;}
.lt-wave-bar:nth-child(5){animation-delay:.15s;height:18px;}
.lt-wave-bar:nth-child(6){animation-delay:.25s;height:10px;}
.lt-wave-bar:nth-child(7){animation-delay:.05s;height:16px;}
@keyframes waveAnim{from{height:4px}to{height:22px}}
@keyframes shake{0%,100%{transform:translateX(0)}20%{transform:translateX(-6px)}40%{transform:translateX(6px)}60%{transform:translateX(-4px)}80%{transform:translateX(4px)}}
.lt-speed-row{display:flex;gap:6px;margin-top:10px;}
.lt-speed-btn{padding:4px 10px;border-radius:20px;border:1.5px solid var(--border2);background:transparent;cursor:pointer;font-size:12px;font-weight:700;color:var(--ink3);transition:all .15s;}
.lt-speed-btn.active{background:var(--teal);color:#fff;border-color:var(--teal);}
.lt-speed-btn:hover:not(.active){border-color:var(--teal);color:var(--teal);}

/* Fill blank exercise */
.lt-fill-sentence{font-size:18px;font-weight:600;color:var(--ink);line-height:1.8;margin-bottom:18px;}
.lt-fill-input{display:inline-block;border:none;border-bottom:3px solid var(--teal);background:transparent;font-size:18px;font-weight:700;color:var(--teal);text-align:center;min-width:120px;max-width:200px;outline:none;font-family:var(--font-b);padding:0 4px;}
.lt-fill-input.correct{color:#059669;border-bottom-color:#059669;}
.lt-fill-input.wrong{color:var(--rose);border-bottom-color:var(--rose);}

/* MC options */
.lt-opts{display:flex;flex-direction:column;gap:10px;margin-bottom:18px;}
.lt-opt{display:flex;align-items:center;gap:12px;padding:14px 16px;border:2px solid var(--border);border-radius:12px;cursor:pointer;transition:all .2s;background:var(--surface);}
.lt-opt:hover{border-color:var(--teal);background:var(--teal-light);}
.lt-opt.correct{background:linear-gradient(135deg,#d1fae5,#ccfbf1);border-color:#6ee7b7;pointer-events:none;}
.lt-opt.wrong{background:linear-gradient(135deg,#ffe4e6,#fce7f3);border-color:#fda4af;pointer-events:none;}
.lt-opt-letter{width:30px;height:30px;border-radius:8px;background:var(--bg2);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:13px;flex-shrink:0;color:var(--ink3);}
.lt-opt.correct .lt-opt-letter{background:#059669;color:#fff;}
.lt-opt.wrong .lt-opt-letter{background:var(--rose);color:#fff;}
.lt-opt-text{font-size:15px;font-weight:600;color:var(--ink);}

/* Dialogue listening */
.lt-dlg-line{display:flex;gap:12px;margin-bottom:14px;align-items:flex-start;}
.lt-dlg-avatar{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:15px;font-weight:800;flex-shrink:0;margin-top:2px;}
.lt-dlg-avatar.a{background:var(--teal-light);color:var(--teal);}
.lt-dlg-avatar.b{background:var(--violet-light);color:var(--violet);}
.lt-dlg-bubble{flex:1;background:var(--surface2);border:1.5px solid var(--border);border-radius:12px;padding:12px 14px;}
.lt-dlg-bubble.a{border-top-left-radius:4px;}
.lt-dlg-bubble.b{border-top-right-radius:4px;}
.lt-dlg-text{font-size:15px;color:var(--ink);margin-bottom:4px;line-height:1.6;}
.lt-dlg-vi{font-size:12px;color:var(--ink4);font-style:italic;}
.lt-dlg-play{background:none;border:none;cursor:pointer;font-size:16px;color:var(--ink4);padding:0;margin-left:6px;transition:all .15s;}
.lt-dlg-play:hover{color:var(--teal);transform:scale(1.2);}

/* Dictation */
.lt-dict-target{font-size:15px;color:var(--ink3);font-style:italic;line-height:1.7;padding:12px 14px;background:var(--surface2);border-radius:10px;border-left:4px solid var(--teal);margin-bottom:14px;display:none;}
.lt-dict-input{width:100%;min-height:80px;padding:14px;border:2px solid var(--border2);border-radius:12px;font-size:16px;font-family:var(--font-b);color:var(--ink);background:var(--surface2);outline:none;resize:none;transition:all .2s;}
.lt-dict-input:focus{border-color:var(--teal);box-shadow:0 0 0 4px rgba(13,148,136,.1);background:var(--surface);}

/* Result feedback */
.lt-feedback{border-radius:14px;padding:14px 18px;margin-top:14px;animation:fadeUp .3s ease;display:flex;align-items:flex-start;gap:12px;}
.lt-feedback.ok{background:linear-gradient(135deg,#d1fae5,#ccfbf1);border:2px solid #6ee7b7;}
.lt-feedback.err{background:linear-gradient(135deg,#ffe4e6,#fce7f3);border:2px solid #fda4af;}
.lt-fb-icon{font-size:24px;flex-shrink:0;}
.lt-fb-msg{flex:1;}
.lt-fb-title{font-weight:800;font-size:15px;margin-bottom:4px;}
.lt-feedback.ok .lt-fb-title{color:#065f46;}
.lt-feedback.err .lt-fb-title{color:#9f1239;}
.lt-fb-correct{font-size:14px;color:var(--teal);font-weight:700;}

/* Results screen */
.lt-result{text-align:center;padding:24px 16px;}
.lt-result-emoji{font-size:60px;display:block;margin-bottom:12px;}
.lt-result-title{font-family:var(--font-d);font-size:26px;font-weight:900;color:var(--ink);margin-bottom:6px;}
.lt-result-sub{font-size:14px;color:var(--ink3);margin-bottom:24px;}
.lt-result-stats{display:flex;justify-content:center;gap:20px;flex-wrap:wrap;margin-bottom:24px;}
.lt-result-stat{text-align:center;}
.lt-result-stat-val{font-family:var(--font-d);font-size:32px;font-weight:900;display:block;}
.lt-result-stat-lbl{font-size:12px;color:var(--ink3);}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SPEAKING PRO MODULE ‚Äî v45 REDESIGN
   M√†u ch·ªß ƒë·∫°o: Violet ‚Üí Teal gradient
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.sp-mode-tabs{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:20px;}
.sp-mode-tab{background:var(--surface);border:2px solid var(--border);border-radius:12px;padding:13px 6px;cursor:pointer;transition:all .2s;text-align:center;user-select:none;}
.sp-mode-tab:hover{border-color:var(--violet);background:var(--violet-light);transform:translateY(-2px);box-shadow:0 4px 12px rgba(124,58,237,.12);}
.sp-mode-tab.active{border-color:var(--violet);background:linear-gradient(135deg,var(--violet-light),#f5f3ff);box-shadow:0 4px 16px rgba(124,58,237,.18);}
.sp-mode-tab-icon{font-size:22px;margin-bottom:5px;}
.sp-mode-tab-label{font-size:11px;font-weight:800;color:var(--ink2);line-height:1.3;}
.sp-mode-tab.active .sp-mode-tab-label{color:var(--violet);}

/* Shadowing card */
.sp-shadow-card{background:var(--surface);border:2px solid var(--border);border-radius:16px;padding:22px;margin-bottom:14px;box-shadow:var(--shadow);animation:qzIn .25s ease;}
.sp-shadow-text{font-size:22px;font-weight:700;color:var(--ink);line-height:1.6;font-family:var(--font-d);margin-bottom:8px;}
.sp-shadow-ipa{font-size:14px;color:var(--ink3);font-style:italic;margin-bottom:16px;}
.sp-shadow-vi{font-size:14px;color:var(--ink4);margin-bottom:20px;padding:10px 14px;background:var(--bg);border-radius:8px;border-left:3px solid var(--violet);}

/* Pronunciation difficulty badges */
.sp-diff-row{display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap;}
.sp-diff-badge{display:inline-flex;align-items:center;gap:5px;padding:5px 12px;border-radius:20px;font-size:12px;font-weight:700;border:2px solid;cursor:pointer;transition:all .15s;}
.sp-diff-badge.easy{background:#d1fae5;border-color:#6ee7b7;color:#065f46;}
.sp-diff-badge.medium{background:var(--amber-light);border-color:#fde68a;color:#78350f;}
.sp-diff-badge.hard{background:var(--rose-light);border-color:#fecdd3;color:#9f1239;}
.sp-diff-badge.active{transform:scale(1.08);box-shadow:0 2px 8px rgba(0,0,0,.12);}

/* Pitch/stress indicator */
.sp-stress-wrap{background:linear-gradient(135deg,var(--violet-light),#f5f3ff);border:2px solid rgba(124,58,237,.2);border-radius:12px;padding:14px 16px;margin-bottom:16px;}
.sp-stress-title{font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:.07em;color:var(--violet);margin-bottom:10px;}
.sp-stress-syllables{display:flex;gap:6px;align-items:flex-end;flex-wrap:wrap;}
.sp-syl{display:flex;flex-direction:column;align-items:center;gap:3px;}
.sp-syl-bar{width:28px;border-radius:4px 4px 0 0;background:var(--violet);opacity:.3;transition:height .3s;}
.sp-syl-bar.stressed{opacity:1;background:linear-gradient(180deg,var(--violet),#9333ea);}
.sp-syl-text{font-size:13px;font-weight:800;color:var(--ink2);}
.sp-syl-text.stressed{color:var(--violet);}

/* Recording button - redesigned */
.sp-rec-area{text-align:center;padding:16px 0;}
.sp-rec-btn{width:76px;height:76px;border-radius:50%;border:none;cursor:pointer;font-size:30px;display:inline-flex;align-items:center;justify-content:center;transition:all .2s;box-shadow:0 6px 20px rgba(0,0,0,.12);}
.sp-rec-btn.idle{background:linear-gradient(135deg,var(--violet),#9333ea);}
.sp-rec-btn.recording{background:linear-gradient(135deg,var(--rose),#e11d48);animation:recPulse 1.2s ease infinite;}
.sp-rec-btn:hover{transform:scale(1.06);}
.sp-rec-btn:active{transform:scale(.94);}
@keyframes recPulse{0%,100%{box-shadow:0 0 0 0 rgba(225,29,72,.4)}50%{box-shadow:0 0 0 14px rgba(225,29,72,0)}}
.sp-rec-status{font-size:13px;color:var(--ink3);font-weight:600;margin-top:10px;}
.sp-rec-hint{font-size:11px;color:var(--ink4);margin-top:4px;}

/* Score ring */
.sp-score-ring{position:relative;width:96px;height:96px;margin:0 auto 16px;}
.sp-score-ring svg{transform:rotate(-90deg);}
.sp-score-ring-val{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-family:var(--font-d);font-size:26px;font-weight:900;}

/* Phoneme breakdown - enhanced */
.sp-phoneme-row{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:14px;}
.sp-phoneme{display:flex;flex-direction:column;align-items:center;gap:3px;padding:8px 12px;border-radius:10px;border:2px solid;min-width:48px;}
.sp-phoneme.good{background:linear-gradient(135deg,#d1fae5,#ccfbf1);border-color:#6ee7b7;}
.sp-phoneme.ok{background:linear-gradient(135deg,#fef3c7,#fde68a33);border-color:#fde68a;}
.sp-phoneme.bad{background:linear-gradient(135deg,#ffe4e6,#fce7f3);border-color:#fda4af;}
.sp-phoneme-sym{font-family:var(--font-d);font-size:17px;font-weight:800;}
.sp-phoneme.good .sp-phoneme-sym{color:#059669;}
.sp-phoneme.ok .sp-phoneme-sym{color:var(--amber);}
.sp-phoneme.bad .sp-phoneme-sym{color:var(--rose);}
.sp-phoneme-pct{font-size:10px;font-weight:700;color:var(--ink3);}

/* Roleplay chat redesign */
.sp-rp-chat{display:flex;flex-direction:column;gap:12px;margin-bottom:16px;max-height:380px;overflow-y:auto;padding:4px 2px;scrollbar-width:thin;}
.sp-rp-msg{display:flex;gap:10px;align-items:flex-end;}
.sp-rp-msg.user{flex-direction:row-reverse;}
.sp-rp-bubble{max-width:78%;padding:12px 15px;border-radius:18px;font-size:14px;line-height:1.6;}
.sp-rp-bubble.ai{background:var(--surface2);border:1.5px solid var(--border);border-bottom-left-radius:4px;color:var(--ink);}
.sp-rp-bubble.user{background:linear-gradient(135deg,var(--violet),#9333ea);color:#fff;border-bottom-right-radius:4px;}
.sp-rp-avatar{width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;}
.sp-rp-avatar.ai{background:linear-gradient(135deg,var(--violet-light),#f5f3ff);}
.sp-rp-avatar.user{background:linear-gradient(135deg,var(--teal-light),#ccfbf1);}
.sp-rp-score-chip{display:inline-flex;align-items:center;gap:4px;font-size:11px;font-weight:700;padding:2px 8px;border-radius:20px;margin-top:5px;}
.sp-rp-score-chip.good{background:linear-gradient(135deg,#d1fae5,#ccfbf1);color:#059669;}
.sp-rp-score-chip.ok{background:var(--amber-light);color:var(--amber);}
.sp-rp-score-chip.bad{background:var(--rose-light);color:var(--rose);}

/* Read Aloud word highlighting */
.sp-ra-text{font-size:19px;line-height:2;color:var(--ink);margin-bottom:20px;padding:20px 22px;background:var(--surface2);border-radius:14px;border:1.5px solid var(--border);}
.sp-ra-word{display:inline;cursor:default;border-radius:4px;padding:1px 3px;transition:all .25s;}
.sp-ra-word.current{background:var(--amber-light);color:var(--amber);font-weight:700;box-shadow:0 0 0 2px var(--amber);}
.sp-ra-word.done-good{background:linear-gradient(135deg,#d1fae5,#ccfbf1);color:#059669;font-weight:600;}
.sp-ra-word.done-bad{background:linear-gradient(135deg,#ffe4e6,#fce7f3);color:var(--rose);font-weight:600;}
.sp-ra-word.done-ok{background:var(--amber-light);color:var(--amber);font-weight:600;}

/* Transcript */
.sp-transcript{background:var(--bg);border:1.5px solid var(--border);border-radius:10px;padding:12px 14px;font-size:14px;color:var(--ink4);min-height:44px;font-style:italic;margin-top:12px;transition:all .2s;}
.sp-transcript.has-text{color:var(--ink);font-style:normal;background:var(--surface2);border-color:var(--violet);}

/* Progress topbar */
.sp-topbar{display:flex;align-items:center;gap:12px;margin-bottom:18px;padding:12px 16px;background:var(--surface);border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow-sm);}
.sp-pbar-wrap{flex:1;height:8px;background:var(--bg2);border-radius:4px;overflow:hidden;}
.sp-pbar-fill{height:100%;background:linear-gradient(90deg,var(--violet),var(--teal));border-radius:4px;transition:width .5s;}

/* Tip box */
.sp-tip{background:linear-gradient(135deg,#fefce8,#fef3c7);border:1.5px solid #fde68a;border-radius:10px;padding:10px 14px;font-size:13px;color:#78350f;display:flex;gap:8px;align-items:flex-start;margin-bottom:14px;}
.sp-tip-icon{font-size:16px;flex-shrink:0;margin-top:1px;}

/* Setup card */
.sp-setup-card{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius);padding:20px 22px;margin-bottom:18px;box-shadow:var(--shadow-sm);}
.sp-mode-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;margin-bottom:20px;}
.sp-mode-card{background:var(--surface);border:2px solid var(--border);border-radius:14px;padding:18px 14px;cursor:pointer;transition:all .2s;text-align:center;}
.sp-mode-card:hover{border-color:var(--violet);background:var(--violet-light);transform:translateY(-2px);box-shadow:var(--shadow);}
.sp-mode-card:active{transform:scale(.98);}
.sp-mode-icon{font-size:34px;margin-bottom:8px;}
.sp-mode-title{font-weight:800;font-size:14px;color:var(--ink);margin-bottom:3px;}
.sp-mode-sub{font-size:11px;color:var(--ink3);line-height:1.4;}
/* ‚îÄ‚îÄ Mobile responsive for new modules ‚îÄ‚îÄ */
@media(max-width:640px){
  .lt-mode-tabs{grid-template-columns:repeat(2,1fr);}
  .sp-mode-tabs{grid-template-columns:repeat(2,1fr);}
  .lt-mode-tab,.sp-mode-tab{padding:10px 4px;border-radius:11px;}
  .sp-phoneme-row{gap:5px;}
  .sp-phoneme{min-width:38px;padding:6px 8px;}
  .sp-rp-bubble{max-width:90%;}
  .sp-stress-syllables{gap:4px;}
  /* Writing module */
  .wr-eval{padding:14px 16px;}
  .wr-setup-card{padding:16px;}
  /* Roadmap quiz */
  .rdp-qz-topbar{flex-wrap:wrap;gap:6px;}
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MOBILE POLISH ‚Äî Applied to ALL mobile
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
@media(max-width:767px){
  /* ‚îÄ‚îÄ Smooth momentum scrolling everywhere ‚îÄ‚îÄ */
  .page-wrap, .sp-rp-chat, .nav, .tabs {
    -webkit-overflow-scrolling:touch;
  }

  /* ‚îÄ‚îÄ Home page: compact padding ‚îÄ‚îÄ */
  .home-page-wrap{padding-top:8px;padding-left:12px;padding-right:12px;}

  /* ‚îÄ‚îÄ Stats strip responsive ‚îÄ‚îÄ */
  .home-stats-strip{margin-bottom:12px;}
  .hss-val{font-size:17px;}
  .hss-item{padding:12px 4px;}
  .hss-lbl{font-size:9.5px;}

  /* ‚îÄ‚îÄ Week wrap compact ‚îÄ‚îÄ */
  .home-week-wrap{padding:12px 14px;margin-bottom:12px;}
  .home-section-lbl{margin-bottom:8px;font-size:10.5px;}
  .wday-lbl{font-size:9px;}
  .wday-dot{width:30px;height:30px;font-size:10px;}
  .wday-dot.today{font-size:13px;}

  /* ‚îÄ‚îÄ Skill cards compact ‚îÄ‚îÄ */
  .home-skill-grid{gap:8px;margin-bottom:8px;}
  .home-skill-card{padding:14px 12px;border-radius:14px;}
  .hsk-icon{font-size:22px;margin-bottom:6px;}
  .hsk-name{font-size:14px;}
  .hsk-sub{font-size:10px;margin-bottom:8px;}
  .hsk-bg-emoji{font-size:52px;}

  /* ‚îÄ‚îÄ Mini grid compact ‚îÄ‚îÄ */
  .home-mini-grid{gap:7px;margin-bottom:12px;}
  .home-mini-card{padding:12px 4px 10px;border-radius:12px;}
  .hmc-icon{width:36px;height:36px;border-radius:10px;font-size:18px;}
  .hmc-label{font-size:10.5px;}

  /* ‚îÄ‚îÄ Continue card compact ‚îÄ‚îÄ */
  .home-continue-card{padding:12px 14px;gap:10px;border-radius:14px;margin-bottom:12px;}
  .home-continue-emoji{font-size:24px;}
  .home-continue-title{font-size:14px;}
  .home-continue-btns .btn{font-size:11.5px;padding:7px 10px;}

  /* ‚îÄ‚îÄ Login wall ‚Äî full screen on mobile ‚îÄ‚îÄ */
  .login-wall{padding:0;}
  .login-box{
    border-radius:0;max-width:100%;height:100%;
    overflow-y:auto;padding:40px 24px 40px;
    display:flex;flex-direction:column;justify-content:center;
    box-shadow:none;
  }
  /* or bottom-sheet style on taller screens */
  @supports(height:100dvh){
    .login-box{
      min-height:100dvh;border-radius:0;
    }
  }

  /* ‚îÄ‚îÄ Home skill cards ‚Äî full bleed feel ‚îÄ‚îÄ */
  #panel-home .page-wrap > div[style*="grid"]{
    margin-left:-14px;margin-right:-14px;
    padding-left:14px;padding-right:14px;
  }

  /* ‚îÄ‚îÄ Improve tap targets for all interactive elements ‚îÄ‚îÄ */
  button, .btn, .nav-item, .rate-btn, .opt,
  .mob-item, .tab-btn, .hcard, .topic-card,
  .lt-mode-tab, .sp-mode-tab{
    min-height:44px;
  }

  /* ‚îÄ‚îÄ Scrollable tabs indicator (fade edge) ‚îÄ‚îÄ */
  .tabs{
    position:relative;
  }

  /* ‚îÄ‚îÄ Vocab card list on mobile ‚îÄ‚îÄ */
  .vocab-card-list{
    display:flex;flex-direction:column;gap:10px;
  }

  /* ‚îÄ‚îÄ Progress ring center ‚îÄ‚îÄ */
  .sp-score-ring{margin:8px auto 14px;}

  /* ‚îÄ‚îÄ Modal overlay alignment (bottom sheet) ‚îÄ‚îÄ */
  .modal-overlay{
    align-items:flex-end;
    padding:0;
  }
  .modal{
    margin:0;
    border-radius:20px 20px 0 0;
    padding:22px 20px calc(22px + env(safe-area-inset-bottom));
    animation:slideUp .25s cubic-bezier(.4,0,.2,1);
  }
  @keyframes slideUp{
    from{transform:translateY(30px);opacity:0;}
    to{transform:translateY(0);opacity:1;}
  }

  /* ‚îÄ‚îÄ Flashcard swipe feel ‚îÄ‚îÄ */
  .fc-card{
    touch-action:pan-y;
    user-select:none;
  }

  /* ‚îÄ‚îÄ Writing input ‚Äî larger on mobile ‚îÄ‚îÄ */
  .wr-input{
    font-size:16px;
    line-height:1.6;
    min-height:64px;
  }

  /* ‚îÄ‚îÄ Roadmap day cards ‚îÄ‚îÄ */
  .rdp-day-card{
    border-radius:16px;
    margin-bottom:10px;
  }

  /* ‚îÄ‚îÄ Quiz answer options ‚Äî full width feel ‚îÄ‚îÄ */
  .opt{
    border-radius:14px;
    font-size:14.5px;
    line-height:1.5;
  }

  /* ‚îÄ‚îÄ Speaking Pro ‚Äî center mic ‚îÄ‚îÄ */
  .sp-rec-area{
    display:flex;
    flex-direction:column;
    align-items:center;
    padding:20px 0;
  }

  /* ‚îÄ‚îÄ Prevent horizontal scroll ‚îÄ‚îÄ */
  /* CRITICAL: overflow-x:hidden on body breaks position:fixed touch events on iOS Safari!
     Only apply to .main/.page-wrap, never to body or html */
  .main, .page-wrap{
    max-width:100vw;
    overflow-x:clip;
  }

  /* ‚îÄ‚îÄ Horizontal scroll only for tables ‚îÄ‚îÄ */
  .tbl-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch;}

  /* ‚îÄ‚îÄ Bottom safe area for FABs ‚îÄ‚îÄ */
  .btn-fab{
    bottom:calc(var(--mob-nav) + env(safe-area-inset-bottom) + 16px);
  }

  /* ‚îÄ‚îÄ Improve roadmap stats grid readability ‚îÄ‚îÄ */
  .rdp-stat-grid .s-stat{
    padding:10px 6px;
  }
  .rdp-stat-grid .s-stat-val{
    font-size:18px;
  }

  /* ‚îÄ‚îÄ Home weekly calendar dots ‚îÄ‚îÄ */
  .week-row{
    display:flex;justify-content:space-between;gap:4px;
  }
  .wday-dot{
    flex:1;max-width:38px;
    aspect-ratio:1;
    display:flex;align-items:center;justify-content:center;
    border-radius:50%;font-size:10px;font-weight:700;
  }

  /* ‚îÄ‚îÄ Listening dialogue ‚îÄ‚îÄ */
  .lt-dlg-line{
    padding:8px 12px;font-size:13.5px;
  }

  /* ‚îÄ‚îÄ Better IPA display ‚îÄ‚îÄ */
  .fc-ipa, .sp-shadow-ipa{
    font-size:13px;letter-spacing:.03em;
  }

  /* ‚îÄ‚îÄ Roadmap tab buttons ‚îÄ‚îÄ */
  .rdp-tab{
    font-size:12px;padding:8px 10px;
  }

  /* ‚îÄ‚îÄ Ensure config modal slides up ‚îÄ‚îÄ */
  .fb-modal-overlay.open{align-items:flex-end;padding:0;}
  .fb-modal{
    border-radius:20px 20px 0 0;
    padding:22px 18px calc(20px + env(safe-area-inset-bottom));
    max-height:85vh;
  }
}
</style>
</head>
<body>
<div class="app">

<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="sidebar-top">
    <div class="logo">
      <div class="logo-icon">üó£Ô∏è</div>
      <span class="logo-text">SpeakUp</span>
    </div>
  </div>
  <div class="sidebar-stats">
    <div class="s-stat"><span class="s-stat-val" id="stat-streak">0</span><div class="s-stat-lbl">üî• Streak</div></div>
    <div class="s-stat"><span class="s-stat-val" id="stat-xp">0</span><div class="s-stat-lbl">‚ö° XP</div></div>
    <div class="s-stat"><span class="s-stat-val" id="stat-words">0</span><div class="s-stat-lbl">üìñ H·ªçc</div></div>
  </div>
  <nav class="nav">
    <div class="nav-lbl">Menu ch√≠nh</div>
    <div class="nav-item active" onclick="showPanel('home')"><span class="ni">üè†</span>T·ªïng quan</div>
    <div class="nav-item" onclick="showPanel('roadmap')"><span class="ni">üóìÔ∏è</span>L·ªô tr√¨nh h·ªçc</div>
    <div class="nav-item" onclick="showPanel('import')"><span class="ni">üì•</span>Import t·ª´ v·ª±ng</div>
    <div class="nav-item" onclick="showPanel('topics')"><span class="ni">üìö</span>Ch·ªß ƒë·ªÅ</div>
    <div class="nav-item" onclick="showPanel('vocab-list')"><span class="ni">üìù</span>Danh s√°ch t·ª´</div>
    <div class="nav-item" onclick="showPanel('writing')"><span class="ni">‚úçÔ∏è</span>Writing</div>
    <div class="nav-item" onclick="showPanel('listening')"><span class="ni">üéß</span>Listening</div>
    <div class="nav-item" onclick="showPanel('speaking-pro')"><span class="ni">üé§</span>Speaking Pro</div>
    <div class="nav-item" onclick="showPanel('progress')"><span class="ni">üìä</span>Ti·∫øn ƒë·ªô</div>
  </nav>

  <!-- ‚ïê‚ïê AUTH ZONE (sidebar bottom) ‚ïê‚ïê -->
  <div class="auth-zone" id="auth-zone">
    <!-- LOGGED OUT -->
    <div id="ui-logged-out">
      <div class="auth-tagline">‚òÅÔ∏è T√†i kho·∫£n & ƒê·ªìng b·ªô</div>
      <button class="btn-open-login" onclick="showLoginWall()">üîê ƒêƒÉng nh·∫≠p / ƒêƒÉng k√Ω</button>
    </div>
    <!-- LOGGED IN -->
    <div id="ui-logged-in" style="display:none">
      <div class="auth-user-card">
        <div class="auth-avatar-ph" id="auth-av-ph">üë§</div>
        <div class="auth-info">
          <div class="auth-uname" id="auth-uname-lbl">‚Äî</div>
          <div id="auth-role-el"></div>
        </div>
      </div>
      <div class="sync-row">
        <div class="sync-badge ok" id="sync-badge">‚úÖ ƒê√£ l∆∞u</div>
        <div style="display:flex;align-items:center;gap:4px;">
          <button onclick="fbManualSync().then(()=>{if(typeof updateMobSyncBadge==='function')updateMobSyncBadge();})" title="Sync ngay" style="background:none;border:none;cursor:pointer;font-size:15px;color:var(--ink4);" title="ƒê·ªìng b·ªô ngay">üîÑ</button>
          <button onclick="diagnoseSyncIssue&&diagnoseSyncIssue()" title="Ch·∫©n ƒëo√°n ƒë·ªìng b·ªô" style="background:none;border:none;cursor:pointer;font-size:13px;color:var(--ink4);">üîç</button>
        </div>
      </div>
      <button class="btn-signout" onclick="appSignOut()">ƒêƒÉng xu·∫•t</button>
    </div>
  </div>

  <!-- ‚ïê‚ïê FIREBASE CONFIG SECTION (sidebar, desktop) ‚ïê‚ïê -->
  <div class="sb-fb-section" id="sb-fb-section">
    <!-- Collapsible header -->
    <div class="sb-fb-header" onclick="toggleSbFb()">
      <div class="sb-fb-header-left">
        <span class="sb-fb-icon">üî•</span>
        <span class="sb-fb-title">Firebase</span>
        <span class="sb-fb-status-dot disconnected" id="sb-fb-dot"></span>
      </div>
      <span class="sb-fb-chevron" id="sb-fb-chevron">‚ñº</span>
    </div>

    <!-- Collapsible body -->
    <div class="sb-fb-body" id="sb-fb-body">
      <!-- Status card (connected / disconnected) -->
      <div id="sb-fb-connected-card" class="sb-fb-connected-card" style="display:none">
        <span class="sb-fb-connected-icon">üü¢</span>
        <div class="sb-fb-connected-info">
          <div class="sb-fb-connected-label">ƒê√£ k·∫øt n·ªëi</div>
          <div class="sb-fb-connected-proj" id="sb-fb-proj-name">‚Äî</div>
        </div>
        <button onclick="sbFbDisconnect()" title="X√≥a config" style="background:none;border:none;cursor:pointer;font-size:14px;padding:2px;" title="Ng·∫Øt k·∫øt n·ªëi">üóë</button>
      </div>
      <div id="sb-fb-disconnected-card" class="sb-fb-disconnected-card">
        <span>üî¥</span> Ch∆∞a k·∫øt n·ªëi Firebase
      </div>

      <!-- Input fields -->
      <div id="sb-fb-fields">
        <div class="sb-fb-field">
          <label>API Key <span style="color:var(--rose)">*</span></label>
          <input id="sb-cfg-apiKey" placeholder="AIzaSy..." autocomplete="off">
        </div>
        <div class="sb-fb-field">
          <label>Auth Domain <span style="color:var(--rose)">*</span></label>
          <input id="sb-cfg-authDomain" placeholder="app.firebaseapp.com" autocomplete="off">
        </div>
        <div class="sb-fb-field">
          <label>Project ID <span style="color:var(--rose)">*</span></label>
          <input id="sb-cfg-projectId" placeholder="your-project-id" autocomplete="off">
        </div>
        <div class="sb-fb-field">
          <label>Storage Bucket</label>
          <input id="sb-cfg-storageBucket" placeholder="app.appspot.com" autocomplete="off">
        </div>
        <div class="sb-fb-field">
          <label>Messaging Sender ID</label>
          <input id="sb-cfg-messagingSenderId" placeholder="123456789012" autocomplete="off">
        </div>
        <div class="sb-fb-field">
          <label>App ID</label>
          <input id="sb-cfg-appId" placeholder="1:123:web:abc..." autocomplete="off">
        </div>
        <div class="sb-fb-err" id="sb-fb-err"></div>
        <div class="sb-fb-btn-row">
          <button class="sb-fb-btn outline" onclick="sbFbPaste()" title="D√°n JSON config t·ª´ clipboard">üìã D√°n JSON</button>
          <button class="sb-fb-btn primary" onclick="sbFbSave()">üíæ K·∫øt n·ªëi</button>
        </div>
        <div class="sb-fb-btn-row" style="margin-top:4px">
          <button class="sb-fb-btn danger" onclick="sbFbDisconnect()">üóë X√≥a config</button>
        </div>
        <div class="sb-fb-paste-hint">üí° D√°n to√†n b·ªô firebaseConfig JSON ƒë·ªÉ ƒëi·ªÅn nhanh</div>
        <button onclick="showFirestoreRulesGuide()" style="width:100%;margin-top:7px;padding:7px 8px;background:var(--amber-light);border:1.5px solid #fde68a;border-radius:6px;font-size:10.5px;font-weight:700;color:#92400e;cursor:pointer;font-family:var(--font-b);text-align:center;">
          üìã C·∫•u h√¨nh Firestore Rules
        </button>
        <button onclick="diagnoseSyncIssue()" style="width:100%;margin-top:5px;padding:7px 8px;background:var(--violet-light);border:1.5px solid rgba(124,58,237,.25);border-radius:6px;font-size:10.5px;font-weight:700;color:var(--violet);cursor:pointer;font-family:var(--font-b);text-align:center;">
          üîç Ch·∫©n ƒëo√°n l·ªói ƒë·ªìng b·ªô
        </button>
      </div>
    </div>
  </div>
</aside>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     LOGIN WALL ‚Äî che to√†n b·ªô app khi ch∆∞a login
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="login-wall" id="login-wall">
  <div class="login-box">
    <div class="login-logo">
      <div class="login-logo-icon">üó£Ô∏è</div>
      <div class="login-logo-text">SpeakUp</div>
    </div>
    <div class="login-tagline">Luy·ªán ti·∫øng Anh m·ªói ng√†y ‚Äî d·ªØ li·ªáu l∆∞u theo t√†i kho·∫£n c·ªßa b·∫°n.</div>

    <div class="login-tabs">
      <button class="login-tab active" id="ltab-login" onclick="switchLoginTab('login')">ƒêƒÉng nh·∫≠p</button>
      <button class="login-tab" id="ltab-register" onclick="switchLoginTab('register')">ƒêƒÉng k√Ω</button>
    </div>

    <!-- ‚îÄ‚îÄ TAB: ƒêƒÇNG NH·∫¨P ‚îÄ‚îÄ -->
    <div id="ltab-login-panel">
      <div class="login-field">
        <label>T√™n ƒëƒÉng nh·∫≠p</label>
        <input id="li-username" type="text" placeholder="admin ho·∫∑c t√™n c·ªßa b·∫°n" autocomplete="username"
          onkeydown="if(event.key==='Enter')document.getElementById('li-pass').focus()">
      </div>
      <div class="login-field">
        <label>M·∫≠t kh·∫©u</label>
        <input id="li-pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"
          onkeydown="if(event.key==='Enter')appLogin()">
        <span class="pw-toggle" onclick="togglePw('li-pass',this)">üëÅ</span>
      </div>
      <div class="login-err" id="li-err"></div>
      <button class="btn-login-submit" id="li-btn" onclick="appLogin()">
        üîê ƒêƒÉng nh·∫≠p
      </button>
      <div class="login-footer">
        Ch∆∞a c√≥ t√†i kho·∫£n? <a href="#" onclick="switchLoginTab('register');return false" style="color:var(--teal);font-weight:700">ƒêƒÉng k√Ω ngay ‚Üí</a>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ TAB: ƒêƒÇNG K√ù ‚îÄ‚îÄ -->
    <div id="ltab-register-panel" style="display:none">
      <div class="login-field">
        <label>T√™n hi·ªÉn th·ªã</label>
        <input id="rg-displayname" type="text" placeholder="Nguy·ªÖn VƒÉn A"
          onkeydown="if(event.key==='Enter')document.getElementById('rg-username').focus()">
      </div>
      <div class="login-field">
        <label>T√™n ƒëƒÉng nh·∫≠p <span style="color:var(--rose)">*</span></label>
        <input id="rg-username" type="text" placeholder="vd: hoanganh123 (kh√¥ng d·∫•u, kh√¥ng kho·∫£ng tr·∫Øng)"
          oninput="validateUsernameInput(this)"
          onkeydown="if(event.key==='Enter')document.getElementById('rg-pass').focus()">
        <div id="rg-un-hint" style="font-size:11px;color:var(--ink4);margin-top:3px"></div>
      </div>
      <div class="login-field">
        <label>M·∫≠t kh·∫©u <span style="color:var(--rose)">*</span> (‚â•6 k√Ω t·ª±)</label>
        <input id="rg-pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
          onkeydown="if(event.key==='Enter')document.getElementById('rg-pass2').focus()">
        <span class="pw-toggle" onclick="togglePw('rg-pass',this)">üëÅ</span>
      </div>
      <div class="login-field">
        <label>X√°c nh·∫≠n m·∫≠t kh·∫©u <span style="color:var(--rose)">*</span></label>
        <input id="rg-pass2" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
          onkeydown="if(event.key==='Enter')appRegister()">
        <span class="pw-toggle" onclick="togglePw('rg-pass2',this)">üëÅ</span>
      </div>
      <div class="login-err" id="rg-err"></div>
      <div class="login-ok"  id="rg-ok"></div>
      <button class="btn-login-submit" id="rg-btn" onclick="appRegister()">
        üöÄ T·∫°o t√†i kho·∫£n
      </button>
      <div class="login-footer">
        ƒê√£ c√≥ t√†i kho·∫£n? <a href="#" onclick="switchLoginTab('login');return false" style="color:var(--teal);font-weight:700">‚Üê ƒêƒÉng nh·∫≠p</a>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ Firebase config link ‚îÄ‚îÄ -->
    <div style="text-align:center;margin-top:14px;padding-top:12px;border-top:1px solid var(--border)">
      <button onclick="toggleLoginWallFb()" style="background:none;border:none;cursor:pointer;font-size:12px;color:var(--ink4);font-family:var(--font-b);display:flex;align-items:center;gap:6px;margin:0 auto;">
        üî• <span id="login-fb-btn-text">C·∫•u h√¨nh Firebase (tu·ª≥ ch·ªçn)</span>
      </button>
      <div id="login-fb-panel" style="display:none;margin-top:14px;text-align:left;background:linear-gradient(135deg,#fff7ed,#fef3c7);border:1.5px solid #fde68a;border-radius:12px;padding:14px;">
        <div style="font-size:12px;font-weight:700;color:#92400e;margin-bottom:8px;">üî• K·∫øt n·ªëi Firebase Cloud</div>
        <div style="font-size:11px;color:#b45309;margin-bottom:10px;line-height:1.5;">Nh·∫≠p config ƒë·ªÉ ƒë·ªìng b·ªô d·ªØ li·ªáu tr√™n nhi·ªÅu thi·∫øt b·ªã. Kh√¥ng b·∫Øt bu·ªôc ‚Äî ·ª©ng d·ª•ng ch·∫°y offline ho√†n to√†n.</div>
        <div style="margin-bottom:6px"><label style="font-size:10px;font-weight:700;color:#92400e;display:block;margin-bottom:3px;text-transform:uppercase">API Key *</label><input id="lw-cfg-apiKey" placeholder="AIzaSy..." style="width:100%;padding:9px 11px;border:1.5px solid #fde68a;border-radius:8px;font-size:13px;font-family:var(--font-b);background:#fffbeb;outline:none;box-sizing:border-box;-webkit-appearance:none"></div>
        <div style="margin-bottom:6px"><label style="font-size:10px;font-weight:700;color:#92400e;display:block;margin-bottom:3px;text-transform:uppercase">Auth Domain *</label><input id="lw-cfg-authDomain" placeholder="app.firebaseapp.com" style="width:100%;padding:9px 11px;border:1.5px solid #fde68a;border-radius:8px;font-size:13px;font-family:var(--font-b);background:#fffbeb;outline:none;box-sizing:border-box;-webkit-appearance:none"></div>
        <div style="margin-bottom:6px"><label style="font-size:10px;font-weight:700;color:#92400e;display:block;margin-bottom:3px;text-transform:uppercase">Project ID *</label><input id="lw-cfg-projectId" placeholder="your-project-id" style="width:100%;padding:9px 11px;border:1.5px solid #fde68a;border-radius:8px;font-size:13px;font-family:var(--font-b);background:#fffbeb;outline:none;box-sizing:border-box;-webkit-appearance:none"></div>
        <div style="margin-bottom:6px"><label style="font-size:10px;font-weight:700;color:#92400e;display:block;margin-bottom:3px;text-transform:uppercase">Storage Bucket</label><input id="lw-cfg-storageBucket" placeholder="app.appspot.com" style="width:100%;padding:9px 11px;border:1.5px solid #fde68a;border-radius:8px;font-size:13px;font-family:var(--font-b);background:#fffbeb;outline:none;box-sizing:border-box;-webkit-appearance:none"></div>
        <div style="margin-bottom:6px"><label style="font-size:10px;font-weight:700;color:#92400e;display:block;margin-bottom:3px;text-transform:uppercase">Messaging Sender ID</label><input id="lw-cfg-messagingSenderId" placeholder="123456789012" style="width:100%;padding:9px 11px;border:1.5px solid #fde68a;border-radius:8px;font-size:13px;font-family:var(--font-b);background:#fffbeb;outline:none;box-sizing:border-box;-webkit-appearance:none"></div>
        <div style="margin-bottom:10px"><label style="font-size:10px;font-weight:700;color:#92400e;display:block;margin-bottom:3px;text-transform:uppercase">App ID</label><input id="lw-cfg-appId" placeholder="1:123:web:abc..." style="width:100%;padding:9px 11px;border:1.5px solid #fde68a;border-radius:8px;font-size:13px;font-family:var(--font-b);background:#fffbeb;outline:none;box-sizing:border-box;-webkit-appearance:none"></div>
        <div id="lw-cfg-err" style="font-size:12px;color:var(--rose);margin-bottom:8px;font-weight:600;display:none"></div>
        <div style="display:flex;gap:8px">
          <button onclick="lwPasteFbConfig()" style="flex:1;padding:9px;background:transparent;border:1.5px solid #fde68a;border-radius:8px;font-size:12px;font-weight:700;color:#92400e;cursor:pointer;font-family:var(--font-b);-webkit-tap-highlight-color:transparent">üìã D√°n JSON</button>
          <button onclick="lwSaveFbConfig()" style="flex:2;padding:9px;background:var(--teal);border:none;border-radius:8px;font-size:12px;font-weight:700;color:#fff;cursor:pointer;font-family:var(--font-b);-webkit-tap-highlight-color:transparent">üíæ L∆∞u & K·∫øt n·ªëi</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     FIREBASE CONFIG MODAL
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="fb-modal-overlay" id="modal-config">
  <div class="fb-modal">
    <div class="fb-modal-title">üî• C·∫•u h√¨nh Firebase</div>
    <div class="fb-modal-sub">D√°n config t·ª´ Firebase Console c·ªßa b·∫°n ƒë·ªÉ k·∫øt n·ªëi database.</div>
    <div class="fb-info-box">
      <strong>üìã H∆∞·ªõng d·∫´n nhanh (~3 ph√∫t):</strong>
      <ol class="fb-steps">
        <li>V√†o <a href="https://console.firebase.google.com" target="_blank">console.firebase.google.com</a> ‚Üí <strong>Add project</strong></li>
        <li><strong>Authentication</strong> ‚Üí Sign-in method ‚Üí b·∫≠t <strong>Email/Password</strong></li>
        <li><strong>Firestore Database</strong> ‚Üí Create database ‚Üí Production mode</li>
        <li>Project Settings ‚öôÔ∏è ‚Üí Add app (Web) ‚Üí Copy <code>firebaseConfig</code></li>
      </ol>
    </div>
    <div class="fb-field"><label>API Key *</label><input id="cfg-apiKey" placeholder="AIzaSy..."></div>
    <div class="fb-field"><label>Auth Domain *</label><input id="cfg-authDomain" placeholder="your-app.firebaseapp.com"></div>
    <div class="fb-field"><label>Project ID *</label><input id="cfg-projectId" placeholder="your-app-123"></div>
    <div class="fb-field"><label>Storage Bucket</label><input id="cfg-storageBucket" placeholder="your-app.appspot.com"></div>
    <div class="fb-field"><label>Messaging Sender ID</label><input id="cfg-messagingSenderId" placeholder="123456789012"></div>
    <div class="fb-field"><label>App ID</label><input id="cfg-appId" placeholder="1:123:web:abc..."></div>
    <div id="cfg-err" class="fb-err-msg" style="display:none"></div>
    <div class="fb-modal-actions">
      <button class="btn btn-outline" style="flex:1" onclick="closeConfigModal()">H·ªßy</button>
      <button class="btn btn-primary" style="flex:2" onclick="saveAndConnectFirebase()">üíæ L∆∞u & K·∫øt n·ªëi</button>
    </div>
    <div style="display:flex;justify-content:space-between;margin-top:10px">
      <button onclick="pasteFbConfig()" style="background:none;border:none;cursor:pointer;font-size:11px;color:var(--teal);font-family:var(--font-b)">üìã D√°n JSON config</button>
      <button onclick="clearFbConfig()" style="background:none;border:none;cursor:pointer;font-size:11px;color:var(--rose);font-family:var(--font-b)">üóë X√≥a config</button>
    </div>
  </div>
</div>

<!-- MOBILE NAV -->
<nav class="mob-nav" id="mob-nav">
  <div class="mob-item active" data-panel="home" onclick="showPanel('home')">
    <span class="mi">üè†</span><span class="mob-item-label">Trang ch·ªß</span>
  </div>
  <div class="mob-item" data-panel="roadmap" onclick="showPanel('roadmap')">
    <span class="mi">üóìÔ∏è</span><span class="mob-item-label">L·ªô tr√¨nh</span>
  </div>
  <div class="mob-item" data-panel="topics" onclick="showPanel('topics')">
    <span class="mi">üìö</span><span class="mob-item-label">Ch·ªß ƒë·ªÅ</span>
  </div>
  <div class="mob-item" data-panel="listening" onclick="showPanel('listening')">
    <span class="mi">üéß</span><span class="mob-item-label">Listening</span>
  </div>
  <div class="mob-item" data-panel="speaking-pro" onclick="showPanel('speaking-pro')">
    <span class="mi">üé§</span><span class="mob-item-label">Speaking</span>
  </div>
  <div class="mob-item" data-panel="writing" onclick="showPanel('writing')">
    <span class="mi">‚úçÔ∏è</span><span class="mob-item-label">Writing</span>
  </div>
  <div class="mob-item" data-panel="vocab-list" onclick="showPanel('vocab-list')">
    <span class="mi">üìù</span><span class="mob-item-label">T·ª´ v·ª±ng</span>
  </div>
  <div class="mob-item" data-panel="progress" onclick="showPanel('progress')">
    <span class="mi">üìä</span><span class="mob-item-label">Ti·∫øn ƒë·ªô</span>
  </div>
  <div class="mob-item" data-panel="__account__" onclick="if(typeof openMobAccount==='function'){openMobAccount();}else{document.getElementById('mob-account-overlay').classList.add('open');document.body.style.overflow='hidden';}" id="mob-nav-account" style="position:relative;flex-shrink:0;">
    <span class="mi" id="mob-nav-account-icon">üë§</span>
    <span class="mob-item-label" id="mob-nav-account-lbl">T√†i kho·∫£n</span>
    <span class="mob-item-badge" id="mob-account-badge" style="display:none"></span>
  </div>
</nav>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     MOBILE ACCOUNT DRAWER ‚Äî bottom sheet
     Hi·ªán khi b·∫•m "T√†i kho·∫£n" tr√™n mobile nav
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="mob-account-overlay" id="mob-account-overlay" onclick="closeMobAccount(event)">
  <div class="mob-account-sheet" id="mob-account-sheet" onclick="event.stopPropagation()">
    <div class="mob-sheet-handle"></div>
    <div class="mob-sheet-header">
      <div class="mob-sheet-title">üë§ T√†i kho·∫£n</div>
      <button class="mob-sheet-close" onclick="closeMobAccount()">‚úï</button>
    </div>

    <!-- ‚îÄ‚îÄ LOGGED OUT ‚îÄ‚îÄ -->
    <div id="mob-ui-loggedout">
      <div class="mob-auth-loggedout">
        <div class="mob-auth-brand">
          <div class="mob-auth-brand-icon">üó£Ô∏è</div>
          <div class="mob-auth-brand-text">SpeakUp</div>
        </div>
        <div class="mob-auth-tagline">ƒêƒÉng nh·∫≠p ƒë·ªÉ l∆∞u ti·∫øn ƒë·ªô v√† ƒë·ªìng b·ªô d·ªØ li·ªáu tr√™n m·ªçi thi·∫øt b·ªã.</div>

        <!-- Login / Register tabs -->
        <div class="mob-login-tabs">
          <button class="mob-login-tab active" id="mob-ltab-login" onclick="switchMobLoginTab('login')">ƒêƒÉng nh·∫≠p</button>
          <button class="mob-login-tab" id="mob-ltab-register" onclick="switchMobLoginTab('register')">ƒêƒÉng k√Ω</button>
        </div>

        <!-- TAB: ƒêƒÇNG NH·∫¨P -->
        <div id="mob-login-panel">
          <div class="mob-login-field">
            <label>T√™n ƒëƒÉng nh·∫≠p</label>
            <input id="mob-li-username" type="text" placeholder="admin ho·∫∑c t√™n c·ªßa b·∫°n"
              autocomplete="username" inputmode="text"
              onkeydown="if(event.key==='Enter')document.getElementById('mob-li-pass').focus()">
          </div>
          <div class="mob-login-field">
            <label>M·∫≠t kh·∫©u</label>
            <input id="mob-li-pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
              autocomplete="current-password"
              onkeydown="if(event.key==='Enter')mobLogin()">
            <span class="mob-pw-toggle" onclick="togglePw('mob-li-pass',this)">üëÅ</span>
          </div>
          <div class="mob-login-err" id="mob-li-err"></div>
          <button class="mob-btn-submit" id="mob-li-btn" onclick="mobLogin()">üîê ƒêƒÉng nh·∫≠p</button>
          <div class="mob-login-footer">
            Ch∆∞a c√≥ t√†i kho·∫£n?
            <a href="#" onclick="switchMobLoginTab('register');return false" style="color:var(--teal);font-weight:700">ƒêƒÉng k√Ω ngay ‚Üí</a>
          </div>
        </div>

        <!-- TAB: ƒêƒÇNG K√ù -->
        <div id="mob-register-panel" style="display:none">
          <div class="mob-login-field">
            <label>T√™n hi·ªÉn th·ªã</label>
            <input id="mob-rg-displayname" type="text" placeholder="Nguy·ªÖn VƒÉn A"
              onkeydown="if(event.key==='Enter')document.getElementById('mob-rg-username').focus()">
          </div>
          <div class="mob-login-field">
            <label>T√™n ƒëƒÉng nh·∫≠p <span style="color:var(--rose)">*</span></label>
            <input id="mob-rg-username" type="text" placeholder="vd: hoanganh123 (kh√¥ng d·∫•u)"
              oninput="validateUsernameInput(this)"
              onkeydown="if(event.key==='Enter')document.getElementById('mob-rg-pass').focus()">
            <div id="mob-rg-un-hint" style="font-size:11px;color:var(--ink4);margin-top:3px"></div>
          </div>
          <div class="mob-login-field">
            <label>M·∫≠t kh·∫©u <span style="color:var(--rose)">*</span> (‚â•6 k√Ω t·ª±)</label>
            <input id="mob-rg-pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
              onkeydown="if(event.key==='Enter')document.getElementById('mob-rg-pass2').focus()">
            <span class="mob-pw-toggle" onclick="togglePw('mob-rg-pass',this)">üëÅ</span>
          </div>
          <div class="mob-login-field">
            <label>X√°c nh·∫≠n m·∫≠t kh·∫©u <span style="color:var(--rose)">*</span></label>
            <input id="mob-rg-pass2" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
              onkeydown="if(event.key==='Enter')mobRegister()">
            <span class="mob-pw-toggle" onclick="togglePw('mob-rg-pass2',this)">üëÅ</span>
          </div>
          <div class="mob-login-err" id="mob-rg-err"></div>
          <div class="mob-login-ok" id="mob-rg-ok"></div>
          <button class="mob-btn-submit" id="mob-rg-btn" onclick="mobRegister()">üöÄ T·∫°o t√†i kho·∫£n</button>
          <div class="mob-login-footer">
            ƒê√£ c√≥ t√†i kho·∫£n?
            <a href="#" onclick="switchMobLoginTab('login');return false" style="color:var(--teal);font-weight:700">‚Üê ƒêƒÉng nh·∫≠p</a>
          </div>
        </div>
      </div>

      <!-- Firebase config collapsible -->
      <div class="mob-fb-section">
        <div class="mob-fb-toggle" onclick="toggleMobFb()">
          <div class="mob-fb-toggle-left">
            <span class="mob-fb-toggle-icon">üî•</span>
            <div>
              <div class="mob-fb-toggle-title">T√≠ch h·ª£p Firebase</div>
              <div class="mob-fb-toggle-sub">K·∫øt n·ªëi cloud database</div>
            </div>
          </div>
          <span class="mob-fb-toggle-arrow" id="mob-fb-arrow">‚ñº</span>
        </div>
        <div class="mob-fb-body" id="mob-fb-body">
          <div class="mob-fb-status disconnected" id="mob-fb-status">üî¥ Ch∆∞a k·∫øt n·ªëi Firebase</div>
          <div class="mob-fb-field"><label>API Key *</label><input id="mob-cfg-apiKey" placeholder="AIzaSy..."></div>
          <div class="mob-fb-field"><label>Auth Domain *</label><input id="mob-cfg-authDomain" placeholder="your-app.firebaseapp.com"></div>
          <div class="mob-fb-field"><label>Project ID *</label><input id="mob-cfg-projectId" placeholder="your-app-123"></div>
          <div class="mob-fb-field"><label>Storage Bucket</label><input id="mob-cfg-storageBucket" placeholder="your-app.appspot.com"></div>
          <div class="mob-fb-field"><label>Messaging Sender ID</label><input id="mob-cfg-messagingSenderId" placeholder="123456789012"></div>
          <div class="mob-fb-field"><label>App ID</label><input id="mob-cfg-appId" placeholder="1:123:web:abc..."></div>
          <div id="mob-cfg-err" style="font-size:12px;color:var(--rose);margin-top:4px;font-weight:600;display:none"></div>
          <div class="mob-fb-actions">
            <button class="mob-fb-btn outline" onclick="mobPasteFbConfig()">üìã D√°n JSON</button>
            <button class="mob-fb-btn primary" onclick="mobSaveFirebase()">üíæ L∆∞u & K·∫øt n·ªëi</button>
          </div>
          <div class="mob-fb-actions" style="margin-top:6px">
            <button class="mob-fb-btn danger" onclick="mobClearFbConfig()">üóë X√≥a config</button>
          </div>
          <div class="mob-fb-paste-hint">üí° D√°n to√†n b·ªô firebaseConfig JSON ƒë·ªÉ ƒëi·ªÅn nhanh</div>
        <button onclick="showFirestoreRulesGuide()" style="width:100%;margin-top:8px;padding:9px;background:var(--amber-light);border:1.5px solid #fde68a;border-radius:9px;font-size:12px;font-weight:700;color:#92400e;cursor:pointer;font-family:var(--font-b);">
          üìã H∆∞·ªõng d·∫´n c·∫•u h√¨nh Firestore Rules
        </button>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ LOGGED IN ‚îÄ‚îÄ -->
    <div id="mob-ui-loggedin" style="display:none">
      <div class="mob-auth-loggedin">
        <!-- User card -->
        <div class="mob-user-card">
          <div class="mob-user-avatar" id="mob-user-avatar">üë§</div>
          <div>
            <div class="mob-user-name" id="mob-user-name">‚Äî</div>
            <div class="mob-user-role" id="mob-user-role"></div>
          </div>
        </div>

        <!-- Stats -->
        <div class="mob-stat-row">
          <div class="mob-stat-box">
            <div class="mob-stat-box-val" id="mob-stat-streak">0</div>
            <div class="mob-stat-box-lbl">üî• Streak</div>
          </div>
          <div class="mob-stat-box">
            <div class="mob-stat-box-val" id="mob-stat-xp">0</div>
            <div class="mob-stat-box-lbl">‚ö° XP</div>
          </div>
          <div class="mob-stat-box">
            <div class="mob-stat-box-val" id="mob-stat-words">0</div>
            <div class="mob-stat-box-lbl">üìñ T·ª´</div>
          </div>
        </div>

        <!-- Sync row ‚Äî improved -->
        <div style="background:var(--surface2);border:1.5px solid var(--border);border-radius:14px;padding:14px 16px;margin-bottom:12px;">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
            <div style="font-size:13px;font-weight:700;color:var(--ink2);">‚òÅÔ∏è ƒê·ªìng b·ªô d·ªØ li·ªáu</div>
            <div class="sync-badge ok" id="mob-sync-badge">‚úÖ ƒê√£ l∆∞u</div>
          </div>
          <div style="font-size:12px;color:var(--ink3);margin-bottom:10px;" id="mob-sync-info">
            üìñ <strong id="mob-sync-word-count">0</strong> t·ª´ v·ª±ng ¬∑ <span id="mob-sync-fb-info">Ki·ªÉm tra k·∫øt n·ªëi...</span>
          </div>
          <div style="display:flex;gap:6px;flex-wrap:wrap;">
            <button onclick="fbManualSync().then(()=>{ if(typeof updateMobSyncBadge==='function')updateMobSyncBadge(); const wc=document.getElementById('mob-sync-word-count');if(wc)wc.textContent=S.vocab.length; })" style="flex:1;min-width:120px;padding:10px 8px;background:var(--teal);color:#fff;border:none;border-radius:10px;font-size:13px;font-weight:700;cursor:pointer;font-family:var(--font-b);-webkit-tap-highlight-color:transparent;">
              üì• L·∫•y data t·ª´ cloud
            </button>
            <button onclick="if(confirm('‚¨ÜÔ∏è Upload d·ªØ li·ªáu t·ª´ thi·∫øt b·ªã N√ÄY l√™n cloud?\nCloud s·∫Ω b·ªã ghi ƒë√® b·ªüi d·ªØ li·ªáu local ('+S.vocab.length+' t·ª´).\nCh·ªâ d√πng khi b·∫°n mu·ªën ƒë·∫©y data t·ª´ desktop l√™n!')) fbPushLocalToCloud().then(()=>{ if(typeof updateMobSyncBadge==='function')updateMobSyncBadge(); })" style="flex:1;min-width:120px;padding:10px 8px;background:var(--violet-light);border:1.5px solid rgba(124,58,237,.25);border-radius:10px;font-size:13px;font-weight:700;color:var(--violet);cursor:pointer;font-family:var(--font-b);-webkit-tap-highlight-color:transparent;">
              ‚¨ÜÔ∏è ƒê·∫©y local l√™n
            </button>
          </div>
          <button onclick="diagnoseSyncIssue&&diagnoseSyncIssue()" style="width:100%;margin-top:8px;padding:8px;background:transparent;border:1.5px solid var(--border);border-radius:8px;font-size:11px;font-weight:600;color:var(--ink4);cursor:pointer;font-family:var(--font-b);">
            üîç Ch·∫©n ƒëo√°n l·ªói ƒë·ªìng b·ªô
          </button>
        </div>

        <!-- Firebase status in logged-in -->
        <div class="mob-fb-section" style="margin:0 0 14px">
          <div class="mob-fb-toggle" onclick="toggleMobFb()">
            <div class="mob-fb-toggle-left">
              <span class="mob-fb-toggle-icon">üî•</span>
              <div>
                <div class="mob-fb-toggle-title">Firebase</div>
                <div class="mob-fb-toggle-sub" id="mob-fb-status-loggedin">ƒêang ki·ªÉm tra...</div>
              </div>
            </div>
            <span class="mob-fb-toggle-arrow" id="mob-fb-arrow2">‚ñº</span>
          </div>
          <div class="mob-fb-body" id="mob-fb-body2">
            <div class="mob-fb-status" id="mob-fb-status2" style="margin-bottom:8px">üî¥ Ch∆∞a k·∫øt n·ªëi</div>
            <div class="mob-fb-actions">
              <button class="mob-fb-btn outline" onclick="toggleMobFbEditForm()">‚öôÔ∏è Ch·ªânh s·ª≠a config</button>
              <button class="mob-fb-btn danger" onclick="mobClearFbConfig()">üóë X√≥a</button>
            </div>
            <div id="mob-fb-edit-form" style="display:none;margin-top:12px;">
              <div class="mob-fb-field"><label>API Key *</label><input id="mob-cfg2-apiKey" placeholder="AIzaSy..."></div>
              <div class="mob-fb-field"><label>Auth Domain *</label><input id="mob-cfg2-authDomain" placeholder="app.firebaseapp.com"></div>
              <div class="mob-fb-field"><label>Project ID *</label><input id="mob-cfg2-projectId" placeholder="your-project-id"></div>
              <div class="mob-fb-field"><label>Storage Bucket</label><input id="mob-cfg2-storageBucket" placeholder="app.appspot.com"></div>
              <div class="mob-fb-field"><label>Messaging Sender ID</label><input id="mob-cfg2-messagingSenderId" placeholder="123456789012"></div>
              <div class="mob-fb-field"><label>App ID</label><input id="mob-cfg2-appId" placeholder="1:123:web:abc..."></div>
              <div id="mob-cfg2-err" style="font-size:12px;color:var(--rose);margin-top:4px;font-weight:600;display:none"></div>
              <div class="mob-fb-actions" style="margin-top:8px">
                <button class="mob-fb-btn outline" onclick="mobPasteFbConfig2()">üìã D√°n JSON</button>
                <button class="mob-fb-btn primary" onclick="mobSaveFirebase2()">üíæ L∆∞u & K·∫øt n·ªëi</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Sign out -->
        <button class="mob-signout-btn" onclick="mobSignOut()">
          üö™ ƒêƒÉng xu·∫•t
        </button>
      </div>
    </div>

  </div>
</div>

<main class="main">
<div id="px-banner" style="display:none;align-items:center;gap:10px;flex-wrap:wrap;background:#fef3c7;border-bottom:2px solid #fde68a;padding:10px 20px;font-size:13px;color:#92400e;position:sticky;top:0;z-index:100">
  <span>üîë</span>
  <div style="flex:1;min-width:200px">
    <strong>Ch∆∞a c√≥ Pexels API key</strong> ‚Äî Flashcard s·∫Ω kh√¥ng hi·ªÉn th·ªã ·∫£nh.
    L·∫•y key mi·ªÖn ph√≠ trong 30 gi√¢y t·∫°i <a href="https://www.pexels.com/api/" target="_blank" style="color:var(--amber);font-weight:700">pexels.com/api</a>
    ‚Üí Sign up ‚Üí "Your API key" ‚Üí copy v√† ƒëi·ªÅn v√†o <code style="background:#fde68a;border-radius:4px;padding:1px 6px">PEXELS_KEY</code> trong source code.
  </div>
  <button onclick="document.getElementById('px-banner').style.display='none'" style="background:none;border:none;cursor:pointer;font-size:18px;color:#92400e">‚úï</button>
</div>

<!-- HOME -->
<div id="panel-home" class="panel active">
<div class="page-wrap home-page-wrap">

  <!-- Hero with dynamic greeting -->
  <div id="home-hero-wrap"></div>

  <!-- Stats strip (mobile: horizontal scroll row) -->
  <div class="home-stats-strip" id="home-stats-strip">
    <div class="hss-item" id="hss-streak"><div class="hss-val">‚Äî</div><div class="hss-lbl">üî• Streak</div></div>
    <div class="hss-sep"></div>
    <div class="hss-item" id="hss-xp"><div class="hss-val">‚Äî</div><div class="hss-lbl">‚ö° XP</div></div>
    <div class="hss-sep"></div>
    <div class="hss-item" id="hss-words"><div class="hss-val">‚Äî</div><div class="hss-lbl">üìñ ƒê√£ h·ªçc</div></div>
    <div class="hss-sep"></div>
    <div class="hss-item" id="hss-today"><div class="hss-val">‚Äî</div><div class="hss-lbl">üìÖ H√¥m nay</div></div>
  </div>

  <!-- Week calendar strip -->
  <div class="home-week-wrap">
    <div class="home-section-lbl">üìÖ Tu·∫ßn n√†y</div>
    <div class="week-row" id="week-calendar"></div>
  </div>

  <!-- Continue learning (dynamic) -->
  <div id="home-continue-wrap"></div>

  <!-- Skills section label -->
  <div class="home-section-lbl" style="margin-top:4px">üéØ Luy·ªán t·∫≠p</div>

  <!-- Core skills: 2 big cards -->
  <div class="home-skill-grid">
    <div class="home-skill-card hsk-listen" onclick="showPanel('listening')">
      <div class="hsk-bg-emoji">üéß</div>
      <div class="hsk-icon">üéß</div>
      <div class="hsk-name">Listening</div>
      <div class="hsk-sub">Nghe ¬∑ Tr·∫Øc nghi·ªám ¬∑ H·ªôi tho·∫°i</div>
      <div class="hsk-chips">
        <span class="hsk-chip">Tr·∫Øc nghi·ªám</span>
        <span class="hsk-chip">H·ªôi tho·∫°i</span>
        <span class="hsk-chip">Dictation</span>
      </div>
    </div>
    <div class="home-skill-card hsk-speak" onclick="showPanel('speaking-pro')">
      <div class="hsk-bg-emoji">üé§</div>
      <div class="hsk-icon">üé§</div>
      <div class="hsk-name">Speaking Pro</div>
      <div class="hsk-sub">Ph√°t √¢m ¬∑ Shadowing ¬∑ Roleplay</div>
      <div class="hsk-chips">
        <span class="hsk-chip">Shadowing</span>
        <span class="hsk-chip">AI Roleplay</span>
      </div>
    </div>
  </div>

  <!-- Secondary skills: 4 icon cards -->
  <div class="home-mini-grid">
    <div class="home-mini-card" onclick="showPanel('topics')">
      <div class="hmc-icon hci-t">üÉè</div>
      <div class="hmc-label">Flashcard</div>
    </div>
    <div class="home-mini-card" onclick="showPanel('writing')">
      <div class="hmc-icon hci-r">‚úçÔ∏è</div>
      <div class="hmc-label">Writing</div>
    </div>
    <div class="home-mini-card" onclick="showPanel('roadmap')">
      <div class="hmc-icon hci-v">üóìÔ∏è</div>
      <div class="hmc-label">L·ªô tr√¨nh</div>
    </div>
    <div class="home-mini-card" onclick="showPanel('progress')">
      <div class="hmc-icon hci-a">üìä</div>
      <div class="hmc-label">Ti·∫øn ƒë·ªô</div>
    </div>
  </div>

  <!-- Today stats (legacy hidden, replaced by strip) -->
  <div id="home-quick-stats" style="display:none">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">
      <div class="card" style="padding:16px">
        <div style="font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:.07em;color:var(--ink4);margin-bottom:12px">üìÖ Tu·∫ßn n√†y</div>
        <div class="week-row" id="week-calendar-desktop"></div>
      </div>
      <div class="card" style="padding:16px">
        <div style="font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:.07em;color:var(--ink4);margin-bottom:12px">‚ö° H√¥m nay</div>
        <div style="display:flex;flex-direction:column;gap:8px" id="home-today-stats">
          <div style="font-size:13px;color:var(--ink3)">ƒêang t·∫£i...</div>
        </div>
      </div>
    </div>
  </div>

</div>
</div>

<!-- IMPORT -->
<div id="panel-import" class="panel">
<div class="page-wrap">
  <div class="page-header">
    <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px">
      <div><div class="page-title">Import <em>T·ª´ V·ª±ng</em> üì•</div><div class="page-sub">Upload file Excel ƒë·ªÉ th√™m t·ª´ v·ª±ng theo ch·ªß ƒë·ªÅ</div></div>
    </div>
  </div>
  <!-- Tabs: Import / L·ªãch s·ª≠ -->
  <div class="tabs" style="margin-bottom:20px">
    <button class="tab-btn active" id="imp-tab-upload" onclick="switchImpTab('upload',this)">üì• Import File</button>
    <button class="tab-btn" id="imp-tab-history" onclick="switchImpTab('history',this)">üïì L·ªãch s·ª≠ Import</button>
    <button class="tab-btn" id="imp-tab-manual" onclick="switchImpTab('manual',this)">‚úçÔ∏è Th√™m th·ªß c√¥ng</button>
  </div>

  <!-- TAB: Upload -->
  <div id="imp-view-upload">
    <div class="info-box">
      <span style="font-size:20px">üìã</span>
      <p><strong>ƒê·ªãnh d·∫°ng Excel:</strong> C·ªôt A=T·ª´ v·ª±ng ¬∑ B=Nghƒ©a ¬∑ C=C√¢u v√≠ d·ª•<br><span style="color:var(--teal);font-weight:600">‚ú® Ph√°t √¢m IPA & ch·ªß ƒë·ªÅ s·∫Ω ƒë∆∞·ª£c t·ª± ƒë·ªông nh·∫≠n di·ªán</span></p>
      <button class="btn btn-outline btn-sm" onclick="downloadTemplate()">‚¨á Template</button>
    </div>
    <!-- Ch·ªçn ch·ªß ƒë·ªÅ tr∆∞·ªõc khi import -->
    <div class="imp-topic-row">
      <div style="flex:1;min-width:200px">
        <div class="imp-topic-label">üìö Ch·ªß ƒë·ªÅ cho l·∫ßn import n√†y</div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <select class="sel-inp" id="imp-topic-select" style="flex:1;min-width:160px">
            <option value="">ü§ñ T·ª± ƒë·ªông nh·∫≠n di·ªán</option>
          </select>
          <span style="font-size:12px;color:var(--teal);font-weight:600;white-space:nowrap">ho·∫∑c</span>
          <input class="finp" id="imp-topic-new" placeholder="T·∫°o ch·ªß ƒë·ªÅ m·ªõi..." style="flex:1;min-width:140px;margin:0">
        </div>
        <div style="font-size:11px;color:var(--ink3);margin-top:4px">ƒê·ªÉ tr·ªëng = t·ª± ƒë·ªông ph√¢n lo·∫°i theo t·ª´ng t·ª´</div>
      </div>
    </div>
    <div class="drop-zone" id="drop-zone" onclick="document.getElementById('file-input').click()" ondragover="handleDrag(event,true)" ondragleave="handleDrag(event,false)" ondrop="handleDrop(event)">
      <div class="dz-icon">üìÇ</div>
      <div class="dz-title">K√©o th·∫£ file Excel v√†o ƒë√¢y</div>
      <div class="dz-sub">ho·∫∑c nh·∫•n ƒë·ªÉ ch·ªçn file ‚Äî .xlsx, .xls</div>
      <input type="file" id="file-input" accept=".xlsx,.xls,.csv" style="display:none" onchange="handleFile(event)">
    </div>
    <div id="import-preview" style="display:none;margin-top:14px">
      <div class="card">
        <div style="font-weight:700;margin-bottom:14px;font-family:var(--font-d)">üîç Xem tr∆∞·ªõc d·ªØ li·ªáu</div>
        <div id="preview-wrap" style="overflow-x:auto;max-height:300px;overflow-y:auto"></div>
        <div style="display:flex;gap:10px;margin-top:14px;flex-wrap:wrap">
          <button class="btn btn-primary" onclick="confirmImport()">‚úÖ X√°c nh·∫≠n Import</button>
          <button class="btn btn-outline" onclick="document.getElementById('import-preview').style.display='none'">H·ªßy</button>
        </div>
      </div>
    </div>
  </div>

  <!-- TAB: L·ªãch s·ª≠ -->
  <div id="imp-view-history" style="display:none">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:8px">
      <div style="font-size:14px;font-weight:700;color:var(--ink)" id="imp-hist-count">ƒêang t·∫£i...</div>
      <button class="btn btn-sm" style="background:var(--rose-light);color:var(--rose);border:1.5px solid #fecdd3" onclick="confirmClearAllHistory()">üóë X√≥a t·∫•t c·∫£ l·ªãch s·ª≠</button>
    </div>
    <div id="imp-hist-list"></div>
    <div id="imp-hist-empty" style="display:none;text-align:center;padding:40px 16px;color:var(--ink3)">
      <div style="font-size:40px;margin-bottom:10px">üì≠</div>
      <div style="font-weight:700;margin-bottom:4px">Ch∆∞a c√≥ l·ªãch s·ª≠ import</div>
      <div style="font-size:13px">Import file Excel ƒë·ªÉ b·∫Øt ƒë·∫ßu</div>
    </div>
  </div>

  <!-- TAB: Th·ªß c√¥ng -->
  <div id="imp-view-manual" style="display:none">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <div style="font-weight:700;font-size:14px">‚ûï Th√™m t·ª´ th·ªß c√¥ng</div>
        <button class="btn btn-primary btn-sm" onclick="openModal()">+ Th√™m t·ª´ m·ªõi</button>
      </div>
      <div style="font-size:13px;color:var(--ink3)">Nh·∫≠p t·ª´ng t·ª´ v·ª±ng n·∫øu ch∆∞a c√≥ file Excel.</div>
    </div>
  </div>
</div>
</div>

<!-- ROADMAP -->
<div id="panel-roadmap" class="panel">
<div class="page-wrap">
  <div class="rdp-header">
    <h2>üóìÔ∏è L·ªô tr√¨nh h·ªçc c√° nh√¢n</h2>
    <p>M·ªói ng√†y h·ªçc 10 t·ª´ v·ª±ng ‚Äî ki√™n tr√¨ l√† ch√¨a kh√≥a th√†nh c√¥ng!</p>
  </div>
  <div class="rdp-stat-grid" id="rdp-top-stats"></div>
  <div class="rdp-tabs">
    <button class="rdp-tab active" onclick="switchRdpTab('plan',this)">üìÖ L·ªô tr√¨nh</button>
    <button class="rdp-tab" onclick="switchRdpTab('stats',this)">üìä Th·ªëng k√™</button>
    <button class="rdp-tab" onclick="switchRdpTab('quiz10',this)">üß© H·ªçc h√¥m nay</button>
    <button class="rdp-tab" onclick="switchRdpTab('review',this)">üîÅ √în t·∫≠p</button>
  </div>
  <div id="rdp-plan-view"></div>
  <div id="rdp-stats-view" style="display:none"></div>
  <div id="rdp-quiz10-view" style="display:none"></div>
  <div id="rdp-review-view" style="display:none"></div>
</div>
</div>


<!-- TOPICS -->
<div id="panel-topics" class="panel">
<div class="page-wrap">
  <div class="page-header">
    <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px">
      <div>
        <div class="page-title">Ch·ªß ƒë·ªÅ <em>H·ªçc T·∫≠p</em> üìö</div>
        <div class="page-sub">Qu·∫£n l√Ω v√† h·ªçc t·∫≠p theo ch·ªß ƒë·ªÅ</div>
      </div>
      <button class="btn btn-primary btn-sm" onclick="openAddTopicModal()">+ T·∫°o ch·ªß ƒë·ªÅ m·ªõi</button>
    </div>
  </div>
  <div id="topics-list"></div>
</div>
</div>

<!-- TOPIC DETAIL -->
<div id="panel-topic-detail" class="panel">
<div class="page-wrap">
  <div style="display:flex;align-items:flex-start;gap:12px;margin-bottom:18px;flex-wrap:wrap">
    <button class="btn btn-outline btn-sm" onclick="showPanel('topics')" style="flex-shrink:0">‚Üê Quay l·∫°i</button>
    <div style="flex:1;min-width:0">
      <div class="topic-detail-name" id="td-name">‚Äî</div>
      <div class="topic-detail-meta" id="td-meta"></div>
    </div>
    <div style="display:flex;gap:8px;flex-shrink:0;flex-wrap:wrap">
      <button class="btn btn-outline btn-sm" onclick="openEditTopicModal()">‚úèÔ∏è S·ª≠a t√™n</button>
      <button class="btn btn-sm" style="background:var(--rose-light);color:var(--rose);border:1.5px solid #fecdd3" onclick="confirmDeleteTopic()">üóë X√≥a ch·ªß ƒë·ªÅ</button>
    </div>
  </div>
  <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;padding:12px 0;border-bottom:1px solid var(--border);margin-bottom:16px">
    <button class="btn btn-primary btn-sm" onclick="startStudyFromDetail('flashcard')">üÉè H·ªçc Flashcard</button>
    <button class="btn btn-outline btn-sm" onclick="startStudyFromDetail('quiz')">üß© Quiz</button>
    <button class="btn btn-outline btn-sm" onclick="openAddWordToTopicModal()">+ Th√™m t·ª´ m·ªõi</button>
  </div>
  <div class="card">
    <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;align-items:center">
      <input type="search" class="search-inp" placeholder="üîç T√¨m t·ª´ trong ch·ªß ƒë·ªÅ..." oninput="filterDetailVocab(this.value)" id="detail-search" style="flex:1;min-width:140px">
      <span id="td-count" style="font-size:13px;color:var(--ink3);white-space:nowrap"></span>
    </div>
    <div class="tbl-wrap">
      <table class="vtbl">
        <thead><tr><th>‚≠ê</th><th>T·ª´ v·ª±ng</th><th>IPA</th><th>Nghƒ©a</th><th>C√¢u v√≠ d·ª•</th><th style="text-align:center">Thao t√°c</th></tr></thead>
        <tbody id="detail-tbody"></tbody>
      </table>
    </div>
    <!-- Mobile card view -->
    <div class="vocab-card-list" id="detail-card-list"></div>
    <div id="detail-empty" style="text-align:center;padding:32px 16px;color:var(--ink3);font-size:14px;display:none">Ch∆∞a c√≥ t·ª´ n√†o. Nh·∫•n "+ Th√™m t·ª´ m·ªõi" ƒë·ªÉ b·∫Øt ƒë·∫ßu.</div>
  </div>
</div>
</div>

<!-- STUDY -->
<div id="panel-study" class="panel">
<div class="page-wrap">
  <div class="study-top">
    <button class="btn btn-outline btn-sm" onclick="showPanel('topics')">‚Üê Quay l·∫°i</button>
    <div class="pbar-wrap"><div class="pbar-fill" id="study-pfill" style="width:0%"></div></div>
    <div class="plbl" id="study-plbl">0/0</div>
  </div>
  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('flashcard',this)">üÉè Flashcard</button>
    <button class="tab-btn" onclick="switchTab('quiz',this)">üß© B√†i t·∫≠p</button>
    <button class="tab-btn" onclick="switchTab('speaking',this)">üé§ Speaking</button>
  </div>
  <div id="tab-flashcard"></div>
  <div id="tab-quiz" style="display:none"></div>
  <div id="tab-speaking" style="display:none"></div>
</div>
</div>

<!-- VOCAB LIST -->
<div id="panel-vocab-list" class="panel">
<div class="page-wrap">
  <div class="page-header">
    <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px">
      <div>
        <div class="page-title">Danh S√°ch <em>T·ª´ V·ª±ng</em></div>
        <div class="page-sub" id="vocab-count-sub">ƒêang t·∫£i...</div>
      </div>
      <button class="btn btn-primary btn-sm" onclick="openModal()">+ Th√™m t·ª´ m·ªõi</button>
    </div>
  </div>
  <div class="card">
    <!-- Search & Filter bar -->
    <div class="search-bar" style="margin-bottom:12px">
      <input type="search" class="search-inp" placeholder="üîç T√¨m t·ª´ v·ª±ng..." oninput="filterVocab(this.value)" id="vocab-search" style="flex:1;min-width:160px">
      <select class="sel-inp" id="topic-filter" onchange="filterVocab(document.getElementById('vocab-search').value)" style="min-width:150px"></select>
      <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer;color:var(--ink2);font-weight:600;white-space:nowrap"><input type="checkbox" id="starred-only" onchange="filterVocab(document.getElementById('vocab-search').value)" style="accent-color:var(--teal)"> ‚≠ê ƒê√°nh d·∫•u</label>
    </div>
    <!-- Bulk action toolbar (shown when items checked) -->
    <div id="bulk-toolbar" style="display:none;align-items:center;gap:10px;flex-wrap:wrap;padding:10px 14px;background:var(--rose-light);border:1.5px solid #fecdd3;border-radius:var(--radius-sm);margin-bottom:12px;animation:mIn .2s ease">
      <span id="bulk-count" style="font-size:13px;font-weight:700;color:var(--rose)">0 t·ª´ ƒë∆∞·ª£c ch·ªçn</span>
      <div style="flex:1"></div>
      <button class="btn btn-sm btn-outline" onclick="selectAllVisible()" style="font-size:12px">‚òë Ch·ªçn t·∫•t c·∫£</button>
      <button class="btn btn-sm btn-outline" onclick="clearSelection()" style="font-size:12px">‚úï B·ªè ch·ªçn</button>
      <button class="btn btn-sm" style="background:var(--rose);color:#fff;border:none" onclick="confirmDeleteSelected()">üóë X√≥a <span id="bulk-del-count">0</span> t·ª´</button>
    </div>
    <div class="tbl-wrap">
      <table class="vtbl">
        <thead>
          <tr>
            <th style="width:36px"><input type="checkbox" id="check-all" onchange="toggleCheckAll(this)" style="accent-color:var(--teal);width:15px;height:15px;cursor:pointer" title="Ch·ªçn t·∫•t c·∫£"></th>
            <th style="width:32px">‚≠ê</th>
            <th>T·ª´ v·ª±ng</th>
            <th>IPA</th>
            <th>Nghƒ©a</th>
            <th>C√¢u v√≠ d·ª•</th>
            <th>Ch·ªß ƒë·ªÅ</th>
            <th style="text-align:center">Thao t√°c</th>
          </tr>
        </thead>
        <tbody id="vocab-tbody"></tbody>
      </table>
    </div>
    <!-- Mobile card view -->
    <div class="vocab-card-list" id="vocab-card-list"></div>
    <!-- Footer: total count -->
    <div id="vocab-footer" style="display:flex;align-items:center;justify-content:space-between;padding:10px 4px 0;border-top:1px solid var(--border);margin-top:8px;flex-wrap:wrap;gap:6px">
      <span id="vocab-footer-count" style="font-size:13px;color:var(--ink3)"></span>
      <span id="vocab-footer-total" style="font-size:12px;color:var(--ink4)"></span>
    </div>
    <!-- Pagination -->
    <div id="vocab-pagination" class="pagination" style="display:none"></div>
    <div id="vocab-empty" class="empty-state" style="display:none">
      <div class="empty-icon">üì≠</div><div class="empty-title">Ch∆∞a c√≥ t·ª´ v·ª±ng</div><div class="empty-sub">Import Excel ho·∫∑c th√™m th·ªß c√¥ng</div>
      <button class="btn btn-primary" onclick="showPanel('import')">üì• Import ngay</button>
    </div>
  </div>
</div>
</div>

<!-- PROGRESS -->
<div id="panel-progress" class="panel">
<div class="page-wrap">
  <div class="page-header"><div class="page-title">Ti·∫øn ƒê·ªô <em>H·ªçc T·∫≠p</em> üìä</div><div class="page-sub">Theo d√µi h√†nh tr√¨nh c·ªßa b·∫°n</div></div>
  <div class="stats-grid" id="progress-stats"></div>
  <div class="card"><div style="font-family:var(--font-d);font-weight:700;margin-bottom:14px;font-size:16px">üèÜ Th√†nh t√≠ch</div><div class="ach-grid" id="achievements"></div></div>
</div>
</div>

<!-- WRITING -->
<div id="panel-writing" class="panel">
<div class="page-wrap">
  <div class="wr-hero">
    <h2>Writing Practice ‚úçÔ∏è</h2>
    <p>Luy·ªán vi·∫øt c√¢u ti·∫øng Anh t·ª´ c√¢u g·ªëc ti·∫øng Vi·ªát ‚Äî AI ch·∫•m ƒëi·ªÉm t·ª©c th√¨</p>
  </div>
  <div id="wr-content"></div>
</div>
</div>

<!-- LISTENING MODULE -->
<div id="panel-listening" class="panel">
<div class="page-wrap">
  <div class="page-header">
    <div class="page-title">Listening <em>Practice</em> üéß</div>
    <div class="page-sub">4 d·∫°ng b√†i ‚Äî chu·∫©n BBC Learning English & IELTS</div>
  </div>

  <!-- Redesigned hero banner -->
  <div style="background:linear-gradient(135deg,#0c4a6e 0%,#0891b2 55%,#0d9488 100%);border-radius:16px;padding:22px 26px;color:#fff;margin-bottom:22px;position:relative;overflow:hidden;">
    <div style="position:absolute;top:-30px;right:-30px;width:160px;height:160px;border-radius:50%;background:rgba(255,255,255,.06)"></div>
    <div style="position:absolute;right:22px;top:50%;transform:translateY(-50%);font-size:64px;opacity:.16">üéß</div>
    <div style="font-family:var(--font-d);font-size:20px;font-weight:900;margin-bottom:4px">Luy·ªán nghe t·ª´ v·ª±ng ƒë√£ h·ªçc</div>
    <div style="font-size:13px;opacity:.82;margin-bottom:14px">Nghe audio ‚Üí ƒêi·ªÅn t·ª´ / Ch·ªçn ƒë√°p √°n / Nghe h·ªôi tho·∫°i / Ch√≠nh t·∫£</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <span style="background:rgba(255,255,255,.18);border:1px solid rgba(255,255,255,.3);border-radius:20px;padding:3px 11px;font-size:11px;font-weight:700">‚úÖ Web Speech API</span>
      <span style="background:rgba(255,255,255,.18);border:1px solid rgba(255,255,255,.3);border-radius:20px;padding:3px 11px;font-size:11px;font-weight:700">üê¢ 0.75x ‚Äî 1.25x speed</span>
      <span style="background:rgba(255,255,255,.18);border:1px solid rgba(255,255,255,.3);border-radius:20px;padding:3px 11px;font-size:11px;font-weight:700">üìä L∆∞u ƒëi·ªÉm</span>
    </div>
  </div>

  <!-- Mode tabs - new grid design -->
  <div class="lt-mode-tabs" id="lt-tabs">
    <div class="lt-mode-tab active" onclick="switchLtTab('mc',this)">
      <div class="lt-mode-tab-icon">üÖê</div>
      <div class="lt-mode-tab-label">Tr·∫Øc nghi·ªám</div>
    </div>
    <div class="lt-mode-tab" onclick="switchLtTab('dialogue',this)">
      <div class="lt-mode-tab-icon">üí¨</div>
      <div class="lt-mode-tab-label">H·ªôi tho·∫°i</div>
    </div>
    <div class="lt-mode-tab" onclick="switchLtTab('fill',this)">
      <div class="lt-mode-tab-icon">‚úèÔ∏è</div>
      <div class="lt-mode-tab-label">ƒêi·ªÅn t·ª´</div>
    </div>
    <div class="lt-mode-tab" onclick="switchLtTab('dictation',this)">
      <div class="lt-mode-tab-icon">üìù</div>
      <div class="lt-mode-tab-label">Ch√≠nh t·∫£</div>
    </div>
  </div>

  <div id="lt-content"></div>
</div>
</div>

<!-- SPEAKING PRO MODULE -->
<div id="panel-speaking-pro" class="panel">
<div class="page-wrap">
  <div class="page-header">
    <div class="page-title">Speaking <em>Pro</em> üé§</div>
    <div class="page-sub">Shadowing ¬∑ Ph√°t √¢m ¬∑ Roleplay AI ¬∑ Read Aloud</div>
  </div>

  <!-- Redesigned hero banner -->
  <div style="background:linear-gradient(135deg,#2e1065 0%,#7c3aed 55%,#0d9488 100%);border-radius:16px;padding:22px 26px;color:#fff;margin-bottom:22px;position:relative;overflow:hidden;">
    <div style="position:absolute;top:-30px;right:-30px;width:160px;height:160px;border-radius:50%;background:rgba(255,255,255,.06)"></div>
    <div style="position:absolute;right:22px;top:50%;transform:translateY(-50%);font-size:64px;opacity:.16">üó£Ô∏è</div>
    <div style="font-family:var(--font-d);font-size:20px;font-weight:900;margin-bottom:4px">Luy·ªán n√≥i nh∆∞ ng∆∞·ªùi b·∫£n x·ª©</div>
    <div style="font-size:13px;opacity:.82;margin-bottom:14px">Shadowing ¬∑ Ph√°t √¢m t·ª´ng √¢m ¬∑ AI Roleplay ¬∑ ƒê·ªçc to ¬∑ Pitch & Stress</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <span style="background:rgba(255,255,255,.18);border:1px solid rgba(255,255,255,.3);border-radius:20px;padding:3px 11px;font-size:11px;font-weight:700">üéôÔ∏è Web Speech API</span>
      <span style="background:rgba(255,255,255,.18);border:1px solid rgba(255,255,255,.3);border-radius:20px;padding:3px 11px;font-size:11px;font-weight:700">üìä Score Ring</span>
      <span style="background:rgba(255,255,255,.18);border:1px solid rgba(255,255,255,.3);border-radius:20px;padding:3px 11px;font-size:11px;font-weight:700">ü§ñ AI Feedback</span>
    </div>
  </div>

  <!-- Mode tabs - new grid design -->
  <div class="sp-mode-tabs" id="sp-tabs">
    <div class="sp-mode-tab active" onclick="switchSpTab('shadow',this)">
      <div class="sp-mode-tab-icon">üîÅ</div>
      <div class="sp-mode-tab-label">Shadowing</div>
    </div>
    <div class="sp-mode-tab" onclick="switchSpTab('pronunciation',this)">
      <div class="sp-mode-tab-icon">üî§</div>
      <div class="sp-mode-tab-label">Ph√°t √¢m</div>
    </div>
    <div class="sp-mode-tab" onclick="switchSpTab('roleplay',this)">
      <div class="sp-mode-tab-icon">üé≠</div>
      <div class="sp-mode-tab-label">Roleplay</div>
    </div>
    <div class="sp-mode-tab" onclick="switchSpTab('readaloud',this)">
      <div class="sp-mode-tab-icon">üìñ</div>
      <div class="sp-mode-tab-label">Read Aloud</div>
    </div>
  </div>

  <div id="sp-content"></div>
</div>
</div>

</main>
</div>

<!-- ADD MODAL -->
<!-- ADD WORD MODAL -->
<div class="modal-overlay" id="add-modal">
  <div class="modal">
    <div class="modal-title">‚ûï Th√™m t·ª´ m·ªõi</div>
    <div class="modal-sub" id="add-modal-sub">Nh·∫≠p t·ª´ ti·∫øng Anh ‚Äî th√¥ng tin s·∫Ω t·ª± ƒë·ªông ƒëi·ªÅn</div>
    <div class="fg">
      <label class="flbl">T·ª´ v·ª±ng *</label>
      <div style="display:flex;gap:8px;align-items:center">
        <input class="finp" id="input-word" placeholder="e.g. appreciate" style="flex:1" oninput="clearAutoFill()" onkeydown="if(event.key==='Enter')lookupWord()">
        <button class="btn btn-primary btn-sm" id="lookup-btn" onclick="lookupWord()" style="white-space:nowrap;flex-shrink:0">üîç Tra t·ª´</button>
      </div>
    </div>
    <!-- Auto-fill preview card -->
    <div id="autofill-card" style="display:none;background:var(--teal-light);border:1.5px solid rgba(13,148,136,.25);border-radius:var(--radius-sm);padding:14px 16px;margin-bottom:14px;animation:mIn .2s ease">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px">
        <div>
          <span id="af-word" style="font-family:var(--font-d);font-weight:800;font-size:18px;color:var(--teal)"></span>
          <span id="af-ipa" style="font-size:13px;color:var(--ink3);font-style:italic;margin-left:8px"></span>
        </div>
        <span id="af-topic" class="badge badge-teal" style="flex-shrink:0"></span>
      </div>
      <div id="af-meaning" style="font-size:14px;font-weight:600;color:var(--ink);margin-bottom:6px"></div>
      <div id="af-example" style="font-size:13px;color:var(--ink2);font-style:italic;line-height:1.6"></div>
      <div style="margin-top:10px;font-size:12px;color:var(--ink3)">‚úèÔ∏è C√≥ th·ªÉ ch·ªânh s·ª≠a b√™n d∆∞·ªõi n·∫øu c·∫ßn</div>
    </div>
    <div id="autofill-loading" style="display:none;text-align:center;padding:16px;color:var(--ink3);font-size:13px">
      <div style="font-size:22px;margin-bottom:6px">‚è≥</div>ƒêang tra t·ª´ ƒëi·ªÉn...
    </div>
    <!-- Editable fields (shown after lookup) -->
    <div id="autofill-fields" style="display:none">
      <div class="fg"><label class="flbl">Ph√°t √¢m (IPA)</label><input class="finp" id="input-ipa" placeholder="/…ôÀàpriÀê Éie…™t/"></div>
      <div class="fg"><label class="flbl">Nghƒ©a ti·∫øng Vi·ªát</label><input class="finp" id="input-meaning" placeholder="ƒë√°nh gi√° cao, tr√¢n tr·ªçng"></div>
      <div class="fg"><label class="flbl">C√¢u v√≠ d·ª•</label><input class="finp" id="input-example" placeholder="I really appreciate your help."></div>
      <div class="fg"><label class="flbl">Ch·ªß ƒë·ªÅ</label><input class="finp" id="input-topic" placeholder="Daily Conversation" list="topic-datalist"><datalist id="topic-datalist"></datalist></div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeModal()">H·ªßy</button>
      <button class="btn btn-primary" id="add-word-btn" onclick="addWord()" style="display:none">‚úÖ Th√™m t·ª´</button>
    </div>
  </div>
</div>

<!-- ADD/EDIT TOPIC MODAL -->
<div class="modal-overlay" id="topic-modal">
  <div class="modal">
    <div class="modal-title" id="topic-modal-title">üìö T·∫°o ch·ªß ƒë·ªÅ m·ªõi</div>
    <div class="modal-sub" id="topic-modal-sub">ƒê·∫∑t t√™n ch·ªß ƒë·ªÅ ƒë·ªÉ t·ªï ch·ª©c t·ª´ v·ª±ng</div>
    <div class="fg"><label class="flbl">T√™n ch·ªß ƒë·ªÅ *</label><input class="finp" id="topic-name-inp" placeholder="e.g. Travel, Business, Daily Life..."></div>
    <div class="fg"><label class="flbl">M√¥ t·∫£ (t√πy ch·ªçn)</label><input class="finp" id="topic-desc-inp" placeholder="M√¥ t·∫£ ng·∫Øn v·ªÅ ch·ªß ƒë·ªÅ"></div>
    <div class="modal-actions"><button class="btn btn-outline" onclick="closeTopicModal()">H·ªßy</button><button class="btn btn-primary" id="topic-modal-ok" onclick="saveTopicModal()">T·∫°o ch·ªß ƒë·ªÅ</button></div>
  </div>
</div>

<!-- EDIT WORD MODAL -->
<div class="modal-overlay" id="edit-word-modal">
  <div class="modal">
    <div class="modal-title">‚úèÔ∏è S·ª≠a t·ª´ v·ª±ng</div>
    <div class="modal-sub">Ch·ªânh s·ª≠a th√¥ng tin t·ª´ v·ª±ng</div>
    <input type="hidden" id="edit-word-id">
    <div class="fg"><label class="flbl">T·ª´ v·ª±ng *</label><input class="finp" id="ew-word" placeholder="e.g. appreciate"></div>
    <div class="fg"><label class="flbl">Ph√°t √¢m (IPA)</label><input class="finp" id="ew-ipa" placeholder="e.g. /…ôÀàpriÀê Éie…™t/"></div>
    <div class="fg"><label class="flbl">Nghƒ©a ti·∫øng Vi·ªát *</label><input class="finp" id="ew-meaning" placeholder="e.g. ƒë√°nh gi√° cao"></div>
    <div class="fg"><label class="flbl">C√¢u v√≠ d·ª•</label><input class="finp" id="ew-example" placeholder="e.g. I really appreciate your help."></div>
    <div class="fg"><label class="flbl">Ch·ªß ƒë·ªÅ *</label><input class="finp" id="ew-topic" placeholder="e.g. Daily Conversation" list="topic-datalist2"><datalist id="topic-datalist2"></datalist></div>
    <div class="modal-actions"><button class="btn btn-outline" onclick="closeEditWordModal()">H·ªßy</button><button class="btn btn-primary" onclick="saveWord()">L∆∞u thay ƒë·ªïi</button></div>
  </div>
</div>

<!-- CONFIRM DIALOG -->
<div class="confirm-overlay" id="confirm-overlay">
  <div class="confirm-box">
    <div class="confirm-icon" id="confirm-icon">‚ö†Ô∏è</div>
    <div class="confirm-title" id="confirm-title">X√°c nh·∫≠n x√≥a</div>
    <div class="confirm-msg" id="confirm-msg">B·∫°n c√≥ ch·∫Øc mu·ªën th·ª±c hi·ªán h√†nh ƒë·ªông n√†y?</div>
    <div class="confirm-actions">
      <button class="btn btn-outline" onclick="closeConfirm()">H·ªßy</button>
      <button class="btn" id="confirm-ok-btn" style="background:var(--rose);color:#fff" onclick="runConfirmAction()">X√≥a</button>
    </div>
  </div>
</div>


<div id="toast" class="toast" style="display:none"></div>

<script>
/* ‚îÄ‚îÄ STATE ‚îÄ‚îÄ */
let S={vocab:[],topics:{},stats:{streak:0,xp:0,lastDate:''},currentTopic:null,study:{words:[],idx:0},quiz:{questions:[],current:0,correct:0,wrong:0},importBuf:[]};

/* ‚îÄ‚îÄ VI CACHE ‚Äî cache IPA/meaning lookups ‚îÄ‚îÄ */
const _viCache = {};
function loadViCache(){
  try{ const d=localStorage.getItem('speakup_vi_v1'); if(d) Object.assign(_viCache,JSON.parse(d)); }catch(e){}
}
function saveViCache(){
  try{
    const keys=Object.keys(_viCache);
    if(keys.length>300) keys.slice(0,keys.length-300).forEach(k=>delete _viCache[k]);
    localStorage.setItem('speakup_vi_v1',JSON.stringify(_viCache));
  }catch(e){}
}
// topics = { "topicName": { desc: "" } }

const SAMPLES=[
  {word:'appreciate',ipa:'/…ôÀàpriÀê Éie…™t/',meaning:'ƒë√°nh gi√° cao, tr√¢n tr·ªçng',example:'I really appreciate your help with this project.',topic:'Daily Conversation'},
  {word:'convenient',ipa:'/k…ônÀàviÀêni…ônt/',meaning:'ti·ªán l·ª£i, thu·∫≠n ti·ªán',example:'It is very convenient to have a supermarket nearby.',topic:'Daily Conversation'},
  {word:'suggest',ipa:'/s…ôÀàd íest/',meaning:'ƒë·ªÅ xu·∫•t, g·ª£i √Ω',example:'Can you suggest a good restaurant around here?',topic:'Daily Conversation'},
  {word:'available',ipa:'/…ôÀàve…™l…ôbl/',meaning:'s·∫µn c√≥, c√≥ th·ªÉ d√πng',example:'Is this room available for next Monday?',topic:'Daily Conversation'},
  {word:'deadline',ipa:'/Ààdedla…™n/',meaning:'h·∫°n ch√≥t',example:'We need to finish the report before the deadline.',topic:'Work & Office'},
  {word:'presentation',ipa:'/Àåprez…ônÀàte…™ É…ôn/',meaning:'b√†i thuy·∫øt tr√¨nh',example:'She gave an impressive presentation to the board.',topic:'Work & Office'},
  {word:'collaborate',ipa:'/k…ôÀàl√¶b…ôre…™t/',meaning:'c·ªông t√°c, h·ª£p t√°c',example:'We collaborate with teams across different countries.',topic:'Work & Office'},
  {word:'efficient',ipa:'/…™Ààf…™ É…ônt/',meaning:'hi·ªáu qu·∫£, nƒÉng su·∫•t',example:'This new software makes our workflow more efficient.',topic:'Work & Office'},
];
const DLGS={
  'Daily Conversation':[
    {s:'A',t:'Hey, could you suggest a good coffee shop nearby?',h:'suggest',vi:'B·∫°n c√≥ th·ªÉ g·ª£i √Ω qu√°n c√† ph√™ g·∫ßn ƒë√¢y kh√¥ng?'},
    {s:'B',t:'Sure! There is a really convenient one just around the corner.',h:'convenient',vi:'C√≥ ch·ª©! C√≥ m·ªôt qu√°n r·∫•t ti·ªán l·ª£i ngay g√≥c ph·ªë.'},
    {s:'A',t:'Oh great! Is it available for a quick meeting?',h:'available',vi:'Tuy·ªát! ·ªû ƒë√≥ c√≥ ch·ªó ƒë·ªÉ h·ªçp nhanh kh√¥ng?'},
    {s:'B',t:'I really appreciate you asking ‚Äî I go there all the time!',h:'appreciate',vi:'T√¥i th·ª±c s·ª± tr√¢n tr·ªçng v√¨ b·∫°n h·ªèi ‚Äî t√¥i hay ƒë·∫øn ƒë√≥ l·∫Øm!'}
  ],
  'Work & Office':[
    {s:'A',t:'Hi, do you know when the presentation is scheduled?',h:'presentation',vi:'B√†i thuy·∫øt tr√¨nh ƒë∆∞·ª£c l√™n l·ªãch khi n√†o v·∫≠y?'},
    {s:'B',t:'It is tomorrow morning. The deadline for the slides is tonight.',h:'deadline',vi:'S√°ng mai. H·∫°n ch√≥t n·ªôp slide l√† t·ªëi nay.'},
    {s:'A',t:'We should collaborate on the final slides then.',h:'collaborate',vi:'V·∫≠y ch√∫ng ta n√™n c√πng h·ª£p t√°c l√†m slide cu·ªëi.'},
    {s:'B',t:'Agreed. Let us make the process more efficient.',h:'efficient',vi:'ƒê·ªìng √Ω. H√£y l√†m cho qu√° tr√¨nh hi·ªáu qu·∫£ h∆°n.'}
  ]
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SESSION PERSISTENCE ‚Äî l∆∞u/kh√¥i ph·ª•c ƒë√∫ng m√†n h√¨nh & b∆∞·ªõc ƒëang l√†m
   Key: speakup_session_v2_{uid} ‚Äî ri√™ng m·ªói user, kh√¥ng b·ªã ghi ƒë√® khi ƒë·ªïi t√†i kho·∫£n
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const SESSION_KEY = 'speakup_session_v1'; // legacy fallback ‚Äî KH√îNG d√πng tr·ª±c ti·∫øp n·ªØa
/* Tr·∫£ v·ªÅ session key ri√™ng theo uid ‚Äî g·ªçi thay cho SESSION_KEY ·ªü m·ªçi n∆°i */
function _sessionKey(){
  const uid = (typeof _currentUser !== 'undefined' && _currentUser && _currentUser.uid) ? _currentUser.uid : null;
  return uid ? ('speakup_session_v2_' + uid) : SESSION_KEY;
}

function saveSession(){
  try{
    const activePanel = [...document.querySelectorAll('.panel')]
      .find(p=>p.classList.contains('active'))?.id?.replace('panel-','') || 'home';
    const activeStudyTab = ['flashcard','quiz','speaking']
      .find(t=>document.getElementById('tab-'+t)?.style.display!=='none') || 'flashcard';
    const activeRdpTab = ['plan','stats','quiz10','review']
      .find(t=>document.getElementById('rdp-'+t+'-view')?.style.display==='block') || 'plan';

    const session = {
      panel: activePanel,
      currentTopic: S.currentTopic,
      studyIdx: S.study?.idx || 0,
      speakingIdx: (activeStudyTab==='speaking') ? (S.study?.idx||0) : undefined,
      studyTab: activeStudyTab,
      topicQuiz: S.quiz?.questions?.length ? {
        batchIdx: S.quiz.batchIdx||0,
        current: S.quiz.current||0,
        correct: S.quiz.correct||0,
        wrong: S.quiz.wrong||0,
        lives: S.quiz.lives??3,
        missed: S.quiz.missed||[],
        questions: (S.quiz.questions||[]).map(q=>({
          ...q, word: {id: q.word?.id}
        }))
      } : null,
      rdpTab: activeRdpTab,
      rdpSession: _rdpSession ? {
        current: _rdpSession.current,
        correct: _rdpSession.correct,
        wrong: _rdpSession.wrong,
        lives: _rdpSession.lives,
        extraMode: _rdpSession.extraMode,
        savedToLog: _rdpSession.savedToLog,
        missed: (_rdpSession.missed||[]).map(m=>({wordId:m.word?.id, answer:m.answer})),
        wordIds: (_rdpSession.words||[]).map(w=>w.id),
        questions: (_rdpSession.questions||[]).map(q=>({
          step:q.step, type:q.type, wordId:q.word?.id,
          correct:q.correct, opts:q.opts, sent:q.sent,
          sentence:q.sentence, tokens:q.tokens,
          _answered:q._answered, _correct:q._correct,
          _feedbackLabel:q._feedbackLabel, _userAns:q._userAns,
          _selectedId:q._selectedId, _scored:q._scored,
          _retried:q._retried, _skipped:q._skipped,
        }))
      } : null,
      reviewSession: _reviewSession ? {
        current: _reviewSession.current,
        correct: _reviewSession.correct,
        wrong: _reviewSession.wrong,
        total: _reviewSession.total,
        missed: (_reviewSession.missed||[]).map(m=>({wordId:m.word?.id, answer:m.answer})),
        questions: (_reviewSession.questions||[]).map(q=>({
          wordId:q.word?.id, correct:q.correct, opts:q.opts,
          _answered:q._answered, _correct:q._correct,
          _feedbackLabel:q._feedbackLabel, _selectedId:q._selectedId,
        }))
      } : null,
      ts: Date.now() // d√πng ƒë·ªÉ hi·ªÉn th·ªã th·ªùi gian l∆∞u n·∫øu c·∫ßn, kh√¥ng d√πng ƒë·ªÉ h·∫øt h·∫°n
    };
    localStorage.setItem(_sessionKey(), JSON.stringify(session));
  }catch(e){ console.warn('saveSession error',e); }
}

function restoreSession(){
  try{
    const raw = localStorage.getItem(_sessionKey());
    if(!raw) return false;
    const sess = JSON.parse(raw);

    const panel = sess.panel || 'home';
    if(sess.currentTopic) S.currentTopic = sess.currentTopic;

    // ‚îÄ‚îÄ Kh√¥i ph·ª•c Roadmap Quiz ‚îÄ‚îÄ
    if(sess.rdpSession?.wordIds?.length){
      const rs = sess.rdpSession;
      const words = rs.wordIds.map(id=>S.vocab.find(v=>String(v.id)===String(id))).filter(Boolean);
      if(words.length){
        const questions = (rs.questions||[]).map(sq=>{
          const word = S.vocab.find(v=>String(v.id)===String(sq.wordId));
          if(!word) return null;
          return {...sq, word};
        }).filter(Boolean);
        if(questions.length){
          _rdpSession = {
            words, questions,
            current: rs.current||0, correct: rs.correct||0,
            wrong: rs.wrong||0, lives: rs.lives??3,
            extraMode: rs.extraMode||false, savedToLog: rs.savedToLog||false,
            missed: (rs.missed||[]).map(m=>({
              word: S.vocab.find(v=>String(v.id)===String(m.wordId)), answer:m.answer
            })).filter(m=>m.word),
          };
        }
      }
    }

    // ‚îÄ‚îÄ Kh√¥i ph·ª•c Review Session ‚îÄ‚îÄ
    if(sess.reviewSession?.questions?.length){
      const rv = sess.reviewSession;
      const questions = rv.questions.map(sq=>{
        const word = S.vocab.find(v=>String(v.id)===String(sq.wordId));
        if(!word) return null;
        return {...sq, word};
      }).filter(Boolean);
      if(questions.length){
        _reviewSession = {
          questions, current:rv.current||0, correct:rv.correct||0,
          wrong:rv.wrong||0, total:rv.total||questions.length,
          missed:(rv.missed||[]).map(m=>({
            word:S.vocab.find(v=>String(v.id)===String(m.wordId)), answer:m.answer
          })).filter(m=>m.word),
        };
      }
    }

    // ‚îÄ‚îÄ Kh√¥i ph·ª•c Study (flashcard / quiz / speaking) ‚îÄ‚îÄ
    if(sess.currentTopic){
      const topicWords = S.vocab.filter(v=>v.topic===sess.currentTopic);
      // Flashcard d√πng studyIdx
      S.study = { words:topicWords, idx:sess.studyIdx||0 };
      // N·∫øu tab ƒëang l√† speaking th√¨ d√πng speakingIdx (n·∫øu c√≥)
      if(sess.studyTab==='speaking' && typeof sess.speakingIdx==='number'){
        S.study.idx = Math.min(sess.speakingIdx, Math.max(topicWords.length-1,0));
      }
      if(sess.topicQuiz?.questions?.length){
        const tq = sess.topicQuiz;
        const questions = tq.questions.map(sq=>{
          const word = S.vocab.find(v=>String(v.id)===String(sq.word?.id));
          if(!word) return null;
          return {...sq, word};
        }).filter(Boolean);
        if(questions.length) S.quiz = {...tq, questions};
      }
    }

    // ‚îÄ‚îÄ ƒêi·ªÅu h∆∞·ªõng ƒë·∫øn ƒë√∫ng panel & tab ‚îÄ‚îÄ
    showPanel(panel);

    if(panel==='study'){
      const tab = sess.studyTab || 'flashcard';
      const btn = document.querySelector(`#panel-study .tabs .tab-btn[onclick*="'${tab}'"]`);
      switchTab(tab, btn);
    }

    if(panel==='roadmap'){
      const rdpTab = sess.rdpTab || 'plan';
      const tabMap = ['plan','stats','quiz10','review'];
      const tabIdx = tabMap.indexOf(rdpTab);
      const tabBtns = document.querySelectorAll('.rdp-tab');
      const tabBtn = tabBtns[tabIdx>=0?tabIdx:0];
      document.querySelectorAll('.rdp-tab').forEach(b=>b.classList.remove('active'));
      if(tabBtn) tabBtn.classList.add('active');
      tabMap.forEach(t=>{
        const el=document.getElementById('rdp-'+t+'-view');
        if(el) el.style.display=t===rdpTab?'block':'none';
      });
      if(rdpTab==='plan') renderRdpPlan();
      else if(rdpTab==='stats') renderRdpStats();
      else if(rdpTab==='quiz10'){ if(_rdpSession) showRdpQuestion(); else renderRdpQuiz10(); }
      else if(rdpTab==='review'){ if(_reviewSession) showReviewQuestion(); else renderReviewSetup(); }
      renderRdpTopStats();
    }

    showToast('‚úÖ ƒê√£ kh√¥i ph·ª•c phi√™n h·ªçc tr∆∞·ªõc');
    return true;
  }catch(e){ console.warn('restoreSession error',e); return false; }
}

/* ‚îÄ‚îÄ INIT ‚îÄ‚îÄ */
function init(){
  loadImgCache();
  loadViCache();
  if(!PEXELS_KEY||PEXELS_KEY==='YOUR_PEXELS_API_KEY'){const b=document.getElementById('px-banner');if(b)b.style.display='flex';}
  try{
    const d=localStorage.getItem('speakup4');
    if(d){
      const parsed = JSON.parse(d);
      // Merge ch·ªçn l·ªçc: ch·ªâ restore vocab, topics, stats ‚Äî kh√¥ng restore study.words/quiz.questions
      S.vocab   = parsed.vocab   || S.vocab;
      S.topics  = parsed.topics  || S.topics;
      S.stats   = parsed.stats   || S.stats;
      S.currentTopic = parsed.currentTopic || S.currentTopic;
      if(parsed.study)  S.study  = { words: [], idx: parsed.study.idx || 0 };
      if(parsed.quiz)   S.quiz   = { questions:[], current:0, correct: parsed.quiz.correct||0, wrong: parsed.quiz.wrong||0, batchIdx: parsed.quiz.batchIdx||0, lives:3, missed:[] };
    }
  }catch(e){ console.warn('load S error', e); }
  if(!S.vocab.length){SAMPLES.forEach(addV);S.topics={'Daily Conversation':{desc:'Giao ti·∫øp h√†ng ng√†y'},'Work & Office':{desc:'M√¥i tr∆∞·ªùng c√¥ng s·ªü'}};}
  S.vocab.forEach(v=>{if(!S.topics[v.topic])S.topics[v.topic]={desc:''};});
  updStats(); renderTopics(); renderVocabList(); renderWeekCal();
  // init() KH√îNG t·ª± kh√¥i ph·ª•c session v√¨ ch∆∞a bi·∫øt user l√† ai.
  // Session s·∫Ω ƒë∆∞·ª£c kh√¥i ph·ª•c trong _afterLogin() sau khi x√°c th·ª±c xong.
  showPanel('home'); // hi·ªÉn th·ªã home t·∫°m, login wall s·∫Ω ƒë√® l√™n
  // T·ª± ƒë·ªông l∆∞u m·ªói 5 gi√¢y v√† khi tho√°t trang
  setInterval(saveSession, 5000);
  window.addEventListener('beforeunload', saveSession);
  window.addEventListener('pagehide', saveSession);
}
function save(){
  try{
    // Ch·ªâ l∆∞u d·ªØ li·ªáu c·ªët l√µi ‚Äî KH√îNG l∆∞u study.words (duplicate vocab),
    // quiz.questions (t√°i t·∫°o ƒë∆∞·ª£c), importBuf (data t·∫°m th·ªùi)
    const toSave = {
      vocab:   S.vocab,
      topics:  S.topics,
      stats:   S.stats,
      currentTopic: S.currentTopic,
      study:   { idx: S.study?.idx || 0 },   // ch·ªâ l∆∞u index, kh√¥ng l∆∞u words array
      quiz:    {                               // ch·ªâ l∆∞u meta, kh√¥ng l∆∞u questions array
        batchIdx: S.quiz?.batchIdx || 0,
        correct:  S.quiz?.correct  || 0,
        wrong:    S.quiz?.wrong    || 0,
      }
      // importBuf c·ªë t√¨nh KH√îNG l∆∞u (data preview t·∫°m th·ªùi)
    };
    localStorage.setItem('speakup4', JSON.stringify(toSave));
  }catch(e){ console.warn('save error', e); }
  saveSession();
}
function addV(d){S.vocab.push({id:Date.now()+Math.random(),word:d.word,ipa:d.ipa||'',meaning:d.meaning||'',example:d.example||'',topic:d.topic||'General',starred:false,learned:false,reviewCount:0,imageUrl:d.imageUrl||''});}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   IMAGE SYSTEM ‚Äî Pexels API
   ‚Ä¢ Pexels: kho ·∫£nh l·ªõn nh·∫•t, mi·ªÖn ph√≠, ~100-300ms/request
   ‚Ä¢ Key validation: Claude Haiku ki·ªÉm tra alt text c·ªßa ·∫£nh
     ‚Üí n·∫øu kh√¥ng kh·ªõp nghƒ©a t·ª´ ‚Üí ƒë·ªÉ tr·ªëng, kh√¥ng hi·ªán ·∫£nh sai
   ‚Ä¢ Cache localStorage: m·ªói t·ª´ g·ªçi API 1 l·∫ßn duy nh·∫•t
   ‚ñ∫ L·∫•y key mi·ªÖn ph√≠ (~30 gi√¢y): pexels.com/api
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const PEXELS_KEY = 'xV4XBEeOSCXUpCnGztNJCwqfNwpqgHv1VpNMF1BrUeKPpB25tFJZd324'; // ‚Üê paste key v√†o ƒë√¢y

/* Cache */
const _imgCache = {};
function loadImgCache(){
  try{ const d=localStorage.getItem('speakup_px_v1'); if(d) Object.assign(_imgCache,JSON.parse(d)); }catch(e){}
}
function saveImgCache(){
  try{
    const keys=Object.keys(_imgCache);
    if(keys.length>120) keys.slice(0,keys.length-120).forEach(k=>delete _imgCache[k]);
    localStorage.setItem('speakup_px_v1',JSON.stringify(_imgCache));
  }catch(e){}
}

/* Kh√¥ng c√≥ ·∫£nh ‚Üí kh√¥ng hi·ªÉn th·ªã g√¨ (tr·∫£ v·ªÅ null) */
function getWordImageUrl(){ return null; }

/* Ki·ªÉm tra ·∫£nh c√≥ ƒë√∫ng ng·ªØ nghƒ©a kh√¥ng b·∫±ng Claude Haiku */
async function isImageRelevant(word, meaning, imgAlt, imgUrl){
  // N·∫øu alt text r√µ r√†ng ch·ª©a t·ª´/nghƒ©a ‚Üí pass ngay, kh√¥ng c·∫ßn g·ªçi AI
  const combined = (imgAlt||''  ).toLowerCase();
  const wordLow  = word.toLowerCase();
  if(combined.includes(wordLow)) return true;

  // V·ªõi c√°c t·ª´ tr·ª´u t∆∞·ª£ng (c·∫£m x√∫c, ƒë·ªông t·ª´ ph·ª©c t·∫°p) ‚Üí g·ªçi Claude Haiku ki·ªÉm tra nhanh
  try{
    const res = await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST', headers:{
          'Content-Type':'application/json',
          'x-api-key':getAnthropicKey()||'',
          'anthropic-version':'2023-06-01',
          'anthropic-dangerous-direct-browser-access':'true'
        },
        body: JSON.stringify({
          model:'claude-haiku-4-5-20251001', max_tokens:10,
        messages:[{role:'user', content:
          `Does a photo described as "${imgAlt}" clearly illustrate the English word "${word}" (meaning: "${meaning}")? Reply only YES or NO.`
        }]
      })
    });
    if(res.ok){
      const d = await res.json();
      const ans = (d?.content?.[0]?.text||''  ).trim().toUpperCase();
      return ans.startsWith('YES');
    }
  }catch(e){}
  // N·∫øu kh√¥ng ki·ªÉm tra ƒë∆∞·ª£c ‚Üí ch·∫•p nh·∫≠n ·∫£nh (kh√¥ng b·ªè s√≥t qu√° nhi·ªÅu)
  return true;
}

/* Fetch ·∫£nh t·ª´ Pexels + validate */
async function fetchWordImage(word, meaning='', example=''){
  const key = word.toLowerCase().trim();
  // null trong cache = ƒë√£ th·ª≠ nh∆∞ng kh√¥ng c√≥ ·∫£nh ph√π h·ª£p
  if(key in _imgCache) return _imgCache[key];

  if(!PEXELS_KEY || PEXELS_KEY==='YOUR_PEXELS_API_KEY'){ _imgCache[key]=null; return null; }

  // T·∫°o query t·ª´ example sentence ƒë·ªÉ s√°t nghƒ©a h∆°n
  const stop = new Set(['a','an','the','is','are','was','to','of','in','on','at','and','or','i','we','you','it','this','that','can','will','have','has','for','with','very','really','so','just','not','be','been','do','did','need','my','your','its','our','they','them']);
  const exWords = (example||''  ).toLowerCase().replace(/[^a-z\s]/g,'').split(/\s+/).filter(w=>w.length>3&&!stop.has(w)&&w!==key).slice(0,3);
  const query = exWords.length ? `${word} ${exWords.join(' ')}` : word;

  try{
    const res = await fetch(
      `https://api.pexels.com/v1/search?query=${encodeURIComponent(query)}&per_page=5&orientation=landscape`,
      { headers:{ Authorization: PEXELS_KEY } }
    );
    if(!res.ok){ _imgCache[key]=null; return null; }
    const data = await res.json();
    const photos = data?.photos||[];

    // Th·ª≠ l·∫ßn l∆∞·ª£t t·ª´ng ·∫£nh, ki·ªÉm tra ƒë·ªô ph√π h·ª£p
    for(const photo of photos){
      const imgUrl = photo?.src?.large || photo?.src?.medium;
      const alt    = photo?.alt || '';
      if(!imgUrl) continue;
      const ok = await isImageRelevant(word, meaning, alt, imgUrl);
      if(ok){
        _imgCache[key] = imgUrl;
        saveImgCache();
        return imgUrl;
      }
    }

    // Kh√¥ng c√≥ ·∫£nh n√†o ph√π h·ª£p ‚Üí ƒë·ªÉ tr·ªëng
    _imgCache[key] = null;
    saveImgCache();
    return null;
  }catch(e){
    _imgCache[key] = null;
    return null;
  }
}

async function fetchAndStoreImage(wordObj){
  const url = await fetchWordImage(wordObj.word, wordObj.meaning||''  , wordObj.example||''  );
  wordObj.imageUrl = url || '';
}

/* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
const NAV_IDX={home:0,roadmap:1,'import':2,topics:3,'vocab-list':4,writing:5,progress:6,'topic-detail':3};
function showPanel(n){
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.getElementById('panel-'+n).classList.add('active');
  const idx=NAV_IDX[n]??-1;
  document.querySelectorAll('.nav-item').forEach((e,i)=>e.classList.toggle('active',i===idx));
  // Map panel names to nav data-panel values (some panels share a nav item)
  const panelToNav = {
    'home':'home','roadmap':'roadmap','topics':'topics',
    'topic-detail':'topics','study':'topics',
    'listening':'listening','speaking-pro':'speaking-pro',
    'writing':'writing','vocab-list':'vocab-list',
    'progress':'progress','import':'home'
  };
  const activeNav = panelToNav[n] || '';
  document.querySelectorAll('.mob-item').forEach(e=>{
    const dp = e.getAttribute('data-panel');
    e.classList.toggle('active', dp === activeNav && dp !== '__account__');
  });
  if(n==='vocab-list')renderVocabList();
  if(n==='import'){populateImpTopicSelect();}
  if(n==='topics')renderTopics();
  if(n==='progress')renderProgress();
  if(n==='roadmap')renderRoadmap();
  if(n==='writing')renderWritingSetup();
  saveSession();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   TOPIC CRUD
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function getTopics(){
  const t={};
  S.vocab.forEach(v=>{if(!t[v.topic])t[v.topic]=[];t[v.topic].push(v);});
  // Also include empty topics
  Object.keys(S.topics||{}).forEach(k=>{if(!t[k])t[k]=[];});
  return t;
}

function renderTopics(){
  const topics=getTopics();const el=document.getElementById('topics-list');
  if(!Object.keys(topics).length){
    el.innerHTML=`<div class="empty-state"><div class="empty-icon">üìö</div><div class="empty-title">Ch∆∞a c√≥ ch·ªß ƒë·ªÅ</div><div class="empty-sub">T·∫°o ch·ªß ƒë·ªÅ m·ªõi ho·∫∑c import t·ª´ v·ª±ng</div><button class="btn btn-primary" onclick="openAddTopicModal()">+ T·∫°o ch·ªß ƒë·ªÅ m·ªõi</button></div>`;return;
  }
  el.innerHTML=`<div class="topics-grid">${Object.entries(topics).map(([name,words])=>{
    const learned=words.filter(w=>w.learned).length;const pct=words.length?Math.round(learned/words.length*100):0;
    const desc=(S.topics||{})[name]?.desc||'';
    const rule=TOPIC_RULES.find(r=>r.name===name);
    const emoji=rule?.emoji||'üìå';
    return`<div class="topic-card">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:4px">
        <div class="topic-name" style="cursor:pointer;display:flex;align-items:center;gap:6px" onclick="openTopicDetail('${esc(name)}')"><span style="font-size:18px">${emoji}</span>${name}</div>
        <div style="display:flex;gap:4px;flex-shrink:0;margin-left:8px">
          <button class="act-btn act-edit" title="S·ª≠a t√™n" onclick="event.stopPropagation();openEditTopicModalDirect('${esc(name)}')">‚úèÔ∏è</button>
          <button class="act-btn act-del" title="X√≥a ch·ªß ƒë·ªÅ" onclick="event.stopPropagation();confirmDeleteTopicByName('${esc(name)}')">üóë</button>
        </div>
      </div>
      ${desc?`<div style="font-size:12px;color:var(--ink3);margin-bottom:6px">${desc}</div>`:''}
      <div class="topic-meta"><span>üìñ ${words.length} t·ª´</span><span>‚úÖ ${learned} ƒë√£ h·ªçc</span></div>
      <div class="topic-pbar"><div class="topic-pbar-fill" style="width:${pct}%"></div></div>
      <div style="font-size:11px;color:var(--ink4);margin-bottom:12px">${pct}% ho√†n th√†nh</div>
      <div class="topic-actions">
        <button class="btn btn-primary btn-sm" onclick="startStudy('${esc(name)}','flashcard')">üÉè H·ªçc t·ª´</button>
        <button class="btn btn-outline btn-sm" onclick="openTopicDetail('${esc(name)}')">üìã Chi ti·∫øt</button>
        <button class="btn btn-outline btn-sm" onclick="startStudy('${esc(name)}','quiz')">üß© Quiz</button>
      </div>
    </div>`;
  }).join('')}</div>`;
}

/* ‚îÄ‚îÄ Add Topic Modal ‚îÄ‚îÄ */
let _topicEditMode=null; // null=add, string=editing topic name
function openAddTopicModal(){
  _topicEditMode=null;
  document.getElementById('topic-modal-title').textContent='üìö T·∫°o ch·ªß ƒë·ªÅ m·ªõi';
  document.getElementById('topic-modal-sub').textContent='ƒê·∫∑t t√™n ch·ªß ƒë·ªÅ ƒë·ªÉ t·ªï ch·ª©c t·ª´ v·ª±ng';
  document.getElementById('topic-modal-ok').textContent='T·∫°o ch·ªß ƒë·ªÅ';
  document.getElementById('topic-name-inp').value='';
  document.getElementById('topic-desc-inp').value='';
  document.getElementById('topic-modal').classList.add('show');
  setTimeout(()=>document.getElementById('topic-name-inp').focus(),100);
}
function openEditTopicModalDirect(name){
  _topicEditMode=name;
  document.getElementById('topic-modal-title').textContent='‚úèÔ∏è S·ª≠a ch·ªß ƒë·ªÅ';
  document.getElementById('topic-modal-sub').textContent='ƒê·ªïi t√™n ‚Äî t·∫•t c·∫£ t·ª´ v·ª±ng s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t t·ª± ƒë·ªông';
  document.getElementById('topic-modal-ok').textContent='L∆∞u thay ƒë·ªïi';
  document.getElementById('topic-name-inp').value=name;
  document.getElementById('topic-desc-inp').value=(S.topics||{})[name]?.desc||'';
  document.getElementById('topic-modal').classList.add('show');
  setTimeout(()=>document.getElementById('topic-name-inp').focus(),100);
}
function openEditTopicModal(){openEditTopicModalDirect(S.currentTopic);}
function closeTopicModal(){document.getElementById('topic-modal').classList.remove('show');}

function saveTopicModal(){
  const newName=document.getElementById('topic-name-inp').value.trim();
  const desc=document.getElementById('topic-desc-inp').value.trim();
  if(!newName){showToast('Vui l√≤ng nh·∫≠p t√™n ch·ªß ƒë·ªÅ','error');return;}
  if(!S.topics)S.topics={};

  if(_topicEditMode===null){
    // ADD new topic
    if(S.topics[newName]!==undefined){showToast('Ch·ªß ƒë·ªÅ ƒë√£ t·ªìn t·∫°i!','error');return;}
    S.topics[newName]={desc};
    closeTopicModal();save();renderTopics();updTopicFilter();
    showToast(`‚úÖ ƒê√£ t·∫°o ch·ªß ƒë·ªÅ "${newName}"!`);
  } else {
    // EDIT existing topic
    const old=_topicEditMode;
    if(newName!==old && S.topics[newName]!==undefined){showToast('T√™n ch·ªß ƒë·ªÅ ƒë√£ t·ªìn t·∫°i!','error');return;}
    // Rename in topics map
    delete S.topics[old];S.topics[newName]={desc};
    // Rename in all vocab
    S.vocab.forEach(v=>{if(v.topic===old)v.topic=newName;});
    // If currently viewing detail of this topic
    if(S.currentTopic===old)S.currentTopic=newName;
    closeTopicModal();save();renderTopics();renderVocabList();updTopicFilter();
    if(document.getElementById('panel-topic-detail').classList.contains('active')){
      openTopicDetail(newName);
    }
    showToast(`‚úÖ ƒê√£ ƒë·ªïi t√™n th√†nh "${newName}"!`);
  }
}

/* ‚îÄ‚îÄ Delete Topic ‚îÄ‚îÄ */
function confirmDeleteTopicByName(name){
  const topicName = String(name); // capture in closure, avoid scope issues
  const cnt=(getTopics()[topicName]||[]).length;
  openConfirm('üóëÔ∏è','X√≥a ch·ªß ƒë·ªÅ',
    'X√≥a ch·ªß ƒë·ªÅ "<strong>'+topicName+'</strong>"?<br><span style="color:var(--rose)">'+cnt+' t·ª´ v·ª±ng</span> trong ch·ªß ƒë·ªÅ n√†y c≈©ng s·∫Ω b·ªã x√≥a.',
    function(){
      S.vocab = S.vocab.filter(v => v.topic !== topicName);
      if(S.topics) delete S.topics[topicName];
      save();
      renderTopics();
      renderVocabList();
      updTopicFilter();
      // Always navigate back to topics list
      showPanel('topics');
      showToast('üóë ƒê√£ x√≥a ch·ªß ƒë·ªÅ "' + topicName + '"');
    }
  );
}
function confirmDeleteTopic(){confirmDeleteTopicByName(S.currentTopic);}

/* ‚îÄ‚îÄ Topic Detail ‚îÄ‚îÄ */
function openTopicDetail(name){
  S.currentTopic=name;
  showPanel('topic-detail');
  renderTopicDetail();
}
function renderTopicDetail(){
  const name=S.currentTopic;
  const words=S.vocab.filter(v=>v.topic===name);
  document.getElementById('td-name').textContent=name;
  const desc=(S.topics||{})[name]?.desc;
  document.getElementById('td-meta').textContent=(desc?desc+' ¬∑ ':'')+words.length+' t·ª´ v·ª±ng ¬∑ '+words.filter(w=>w.learned).length+' ƒë√£ h·ªçc';
  renderDetailTable(words);
}
function renderDetailTable(words){
  const tbody=document.getElementById('detail-tbody');
  const empty=document.getElementById('detail-empty');
  const cnt=document.getElementById('td-count');
  cnt.textContent=words.length+' t·ª´';
  if(!words.length){tbody.innerHTML='';empty.style.display='block';return;}
  empty.style.display='none';
  tbody.innerHTML=words.map(w=>`<tr>
    <td><button class="act-btn ${w.starred?'act-star on':'act-star'}" onclick="toggleStarDetail('${w.id}')">${w.starred?'‚òÖ':'‚òÜ'}</button></td>
    <td style="font-family:var(--font-d);font-weight:700;font-size:15px;color:var(--teal)">${w.word}</td>
    <td style="font-style:italic;color:var(--ink3);font-size:13px">${w.ipa||'‚Äî'}</td>
    <td style="max-width:150px;font-size:14px">${w.meaning}</td>
    <td style="font-style:italic;color:var(--ink3);font-size:13px;max-width:180px">${w.example||'‚Äî'}</td>
    <td>
      <div style="display:flex;gap:4px;justify-content:center">
        <button class="act-btn act-edit" title="S·ª≠a" onclick="openEditWordModal('${w.id}')">‚úèÔ∏è</button>
        <button class="act-btn" title="Nghe" onclick="speak('${esc(w.word)}')" style="color:var(--ink3);font-size:13px">üîä</button>
        <button class="act-btn act-del" title="X√≥a" onclick="confirmDeleteWord('${w.id}')">üóë</button>
      </div>
    </td>
  </tr>`).join('');
  // Mobile card view for topic detail
  const cardList = document.getElementById('detail-card-list');
  if(cardList){
    cardList.innerHTML = words.map(w => {
      const ex = w.example ? `<div class="vocab-card-example">"${w.example}"</div>` : '';
      return `<div class="vocab-card-item">
        <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:8px;margin-bottom:4px">
          <div style="flex:1;min-width:0">
            <div class="vocab-card-word">${w.word}
              <button class="act-btn ${w.starred?'act-star on':'act-star'}" onclick="toggleStarDetail('${w.id}')" style="font-size:16px;margin-left:6px">${w.starred?'‚òÖ':'‚òÜ'}</button>
            </div>
            <div class="vocab-card-ipa">${w.ipa||''}</div>
          </div>
        </div>
        <div class="vocab-card-meaning">${w.meaning}</div>
        ${ex}
        <div class="vocab-card-footer">
          <button class="audio-chip" style="padding:4px 10px;font-size:12px" onclick="speak('${esc(w.word)}')">üîä</button>
          <div class="vocab-card-actions">
            <button class="act-btn act-edit" title="S·ª≠a" onclick="openEditWordModal('${w.id}')">‚úèÔ∏è</button>
            <button class="act-btn act-del" title="X√≥a" onclick="confirmDeleteWord('${w.id}')">üóë</button>
          </div>
        </div>
      </div>`;
    }).join('');
  }
}
function filterDetailVocab(search){
  const words=S.vocab.filter(v=>v.topic===S.currentTopic&&(search?v.word.toLowerCase().includes(search.toLowerCase())||v.meaning.includes(search):true));
  renderDetailTable(words);
}
function toggleStarDetail(id){
  const w=S.vocab.find(v=>v.id==id);if(w){w.starred=!w.starred;save();renderTopicDetail();}
}
function startStudyFromDetail(mode){startStudy(S.currentTopic,mode);}
function openAddWordToTopicModal(){
  document.getElementById('input-topic').value=S.currentTopic;
  document.getElementById('add-modal-sub').textContent='Th√™m v√†o ch·ªß ƒë·ªÅ: '+S.currentTopic;
  openModal();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   WORD CRUD
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

/* ‚îÄ‚îÄ Edit Word ‚îÄ‚îÄ */
function openEditWordModal(id){
  const w=S.vocab.find(v=>v.id==id);if(!w)return;
  document.getElementById('edit-word-id').value=w.id;
  document.getElementById('ew-word').value=w.word;
  document.getElementById('ew-ipa').value=w.ipa||'';
  document.getElementById('ew-meaning').value=w.meaning;
  document.getElementById('ew-example').value=w.example||'';
  document.getElementById('ew-topic').value=w.topic;
  // populate datalist
  const dl=document.getElementById('topic-datalist2');
  if(dl)dl.innerHTML=[...new Set(S.vocab.map(v=>v.topic))].map(t=>`<option value="${t}">`).join('');
  document.getElementById('edit-word-modal').classList.add('show');
  setTimeout(()=>document.getElementById('ew-word').focus(),100);
}
function closeEditWordModal(){document.getElementById('edit-word-modal').classList.remove('show');}
function saveWord(){
  const id=document.getElementById('edit-word-id').value;
  const word=document.getElementById('ew-word').value.trim();
  const meaning=document.getElementById('ew-meaning').value.trim();
  const topic=document.getElementById('ew-topic').value.trim();
  if(!word||!meaning||!topic){showToast('Nh·∫≠p ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc *','error');return;}
  const w=S.vocab.find(v=>v.id==id);
  if(w){
    const oldTopic=w.topic;
    w.word=word;w.ipa=document.getElementById('ew-ipa').value.trim();
    w.meaning=meaning;w.example=document.getElementById('ew-example').value.trim();w.topic=topic;
    if(!S.topics)S.topics={};
    if(!S.topics[topic])S.topics[topic]={desc:''};
  }
  save();closeEditWordModal();
  // Refresh current view
  if(document.getElementById('panel-topic-detail').classList.contains('active'))renderTopicDetail();
  if(document.getElementById('panel-vocab-list').classList.contains('active'))renderVocabList();
  renderTopics();updTopicFilter();
  showToast(`‚úÖ ƒê√£ c·∫≠p nh·∫≠t "${word}"!`);
}

/* ‚îÄ‚îÄ Delete Word ‚îÄ‚îÄ */
function confirmDeleteWord(id){
  const w=S.vocab.find(v=>v.id==id);if(!w)return;
  openConfirm('üóëÔ∏è','X√≥a t·ª´ v·ª±ng','X√≥a t·ª´ "<strong>'+w.word+'</strong>" (<em>'+w.meaning+'</em>)?',()=>{
    S.vocab=S.vocab.filter(v=>v.id!=id);
    save();
    if(document.getElementById('panel-topic-detail').classList.contains('active'))renderTopicDetail();
    if(document.getElementById('panel-vocab-list').classList.contains('active'))renderVocabList();
    renderTopics();
    showToast(`üóë ƒê√£ x√≥a "${w.word}"`);
  });
}

/* ‚îÄ‚îÄ Delete Word from vocab list ‚îÄ‚îÄ */
function confirmDeleteWordFromList(id){confirmDeleteWord(id);}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CONFIRM DIALOG
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let _confirmAction = null;
function openConfirm(icon, title, msg, onOk){
  _confirmAction = onOk;
  document.getElementById('confirm-icon').textContent = icon;
  document.getElementById('confirm-title').textContent = title;
  document.getElementById('confirm-msg').innerHTML = msg;
  const overlay = document.getElementById('confirm-overlay');
  overlay.classList.add('show');
}
function closeConfirm(){
  const overlay = document.getElementById('confirm-overlay');
  overlay.classList.remove('show');
  _confirmAction = null;
}
function runConfirmAction(){
  const action = _confirmAction;
  closeConfirm();
  if(typeof action === 'function') action();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   START STUDY
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function startStudy(topic,mode){
  const isRestart = (mode === 'restart');

  // ƒê·ªçc session ƒë√£ l∆∞u
  let sess = null;
  try{ const raw=localStorage.getItem(_sessionKey()); if(raw) sess=JSON.parse(raw); }catch(e){}
  const hasSavedSession = sess && sess.currentTopic === topic;

  if(isRestart){
    // "H·ªçc l·∫°i" ‚Üí x√≥a s·∫°ch v·ªã tr√≠ c≈©
    if(sess){ sess.studyIdx=0; sess.speakingIdx=0; sess.topicQuiz=null;
      try{localStorage.setItem(_sessionKey(),JSON.stringify(sess));}catch(e){} }
  }

  S.currentTopic = topic;
  const topicWords = [...S.vocab.filter(v=>v.topic===topic)];
  const clamp = idx => Math.min(idx||0, Math.max(topicWords.length-1, 0));

  // ‚îÄ‚îÄ Flashcard idx ‚îÄ‚îÄ
  const savedFcIdx  = (!isRestart && hasSavedSession) ? clamp(sess.studyIdx) : 0;

  // ‚îÄ‚îÄ Speaking idx (ri√™ng, fallback v·ªÅ studyIdx) ‚îÄ‚îÄ
  const savedSpkIdx = (!isRestart && hasSavedSession)
    ? clamp(typeof sess.speakingIdx==='number' ? sess.speakingIdx : sess.studyIdx)
    : 0;

  // ‚îÄ‚îÄ Quiz state ‚îÄ‚îÄ
  let restoredQuiz = null;
  if(!isRestart && hasSavedSession && sess.topicQuiz?.questions?.length){
    const tq = sess.topicQuiz;
    const questions = tq.questions.map(sq=>{
      const word = S.vocab.find(v=>String(v.id)===String(sq.word?.id));
      return word ? {...sq, word} : null;
    }).filter(Boolean);
    if(questions.length) restoredQuiz = {...tq, questions};
  }

  // G√°n state
  S.study = {words:topicWords, idx:savedFcIdx};
  S.quiz  = restoredQuiz || {questions:[],current:0,correct:0,wrong:0,lives:3,missed:[],batchIdx:0};

  showPanel('study'); updPbar();

  if(mode==='quiz'){
    switchTab('quiz', document.querySelector('#panel-study .tab-btn:nth-child(2)'));
    if(!isRestart && restoredQuiz && restoredQuiz.current>0){
      const tot=restoredQuiz.questions.length;
      showToast(`‚ñ∂ Ti·∫øp t·ª•c B√†i t·∫≠p ‚Äî c√¢u ${restoredQuiz.current+1}/${tot}`, 'success');
    }
  } else if(mode==='speaking'){
    S.study.idx = savedSpkIdx;
    switchTab('speaking', document.querySelector('#panel-study .tab-btn:nth-child(3)'));
    if(!isRestart && savedSpkIdx>0){
      showToast(`‚ñ∂ Ti·∫øp t·ª•c Speaking ‚Äî t·ª´ ${savedSpkIdx+1}/${topicWords.length} ‚Äî "${topicWords[savedSpkIdx]?.word||''}"`, 'success');
    }
  } else {
    switchTab('flashcard', document.querySelector('#panel-study .tab-btn:nth-child(1)'));
    if(!isRestart && savedFcIdx>0){
      showToast(`‚ñ∂ Ti·∫øp t·ª•c Flashcard ‚Äî t·ª´ ${savedFcIdx+1}/${topicWords.length} ‚Äî "${topicWords[savedFcIdx]?.word||''}"`, 'success');
    }
  }
}
function updPbar(){const{words,idx}=S.study;const pct=words.length?Math.round(idx/words.length*100):0;document.getElementById('study-pfill').style.width=pct+'%';document.getElementById('study-plbl').textContent=idx+'/'+words.length;}
function switchTab(tab,btn){
  const studyPanel = document.getElementById('panel-study');
  studyPanel.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  if(btn)btn.classList.add('active');
  ['flashcard','quiz','speaking'].forEach(t=>document.getElementById('tab-'+t).style.display=t===tab?'block':'none');
  if(tab==='flashcard')renderFlashcard();
  if(tab==='quiz')renderQuiz();
  if(tab==='speaking')renderSpeaking();
  saveSession();
}
function goTab(tab){
  const btn = document.querySelector(`#panel-study .tabs .tab-btn[onclick*="'${tab}'"]`);
  switchTab(tab, btn);
}

/* ‚îÄ‚îÄ FLASHCARD ‚îÄ‚îÄ */
function renderFlashcard(){
  const{words,idx}=S.study;const w=words[idx%words.length];if(!w)return;
  const ex=(w.example||'').replace(new RegExp(w.word,'gi'),m=>`<strong>${m}</strong>`);
  // D√πng cache (c√≥ th·ªÉ null = kh√¥ng c√≥ ·∫£nh)
  const _cached = (w.word.toLowerCase().trim()) in _imgCache ? _imgCache[w.word.toLowerCase().trim()] : undefined;
  const initialImg = _cached || (w.imageUrl && !w.imageUrl.includes('data:') ? w.imageUrl : null);

  document.getElementById('tab-flashcard').innerHTML=`
    <div class="fc-card" id="fc">
      <!-- Image: ch·ªâ hi·ªán n·∫øu c√≥ ·∫£nh ph√π h·ª£p -->
      <div id="fc-img-wrap" style="position:relative;overflow:hidden;background:var(--bg2);${initialImg?''  :'display:none'}">
        <img id="fc-img" src="${initialImg||''  }" alt="${w.word}"
          onerror="document.getElementById('fc-img-wrap').style.display='none'"
          style="width:100%;height:auto;max-height:320px;display:block;object-fit:cover;transition:opacity .4s">
        <div id="fc-img-loading" style="display:none;position:absolute;inset:0;background:rgba(245,243,239,.85);align-items:center;justify-content:center;flex-direction:column;gap:6px">
          <div style="width:28px;height:28px;border:3px solid var(--teal);border-top-color:transparent;border-radius:50%;animation:spin .8s linear infinite"></div>
          <div style="font-size:11px;color:var(--ink3);font-weight:600">ƒêang t·∫£i ·∫£nh‚Ä¶</div>
        </div>
        <!-- Topic badge overlay -->
        <div style="position:absolute;top:12px;left:12px">
          <span class="badge badge-teal" style="backdrop-filter:blur(8px);background:rgba(255,255,255,.85)">${(()=>{const r=TOPIC_RULES.find(r=>r.name===w.topic);return (r?.emoji||'üìå')+' '+w.topic;})()}</span>
        </div>
        <!-- Progress overlay -->
        <div style="position:absolute;top:12px;right:12px;background:rgba(0,0,0,.45);color:#fff;border-radius:20px;padding:3px 10px;font-size:12px;font-weight:700">${idx+1} / ${words.length}</div>
      </div>

      <!-- Body -->
      <div class="fc-card-body">
        <div style="display:flex;align-items:baseline;gap:10px;flex-wrap:wrap;margin-bottom:4px">
          <div class="fc-word">${w.word}</div>
          <div class="fc-ipa" style="margin-bottom:0">${w.ipa||''}</div>
        </div>
        <button class="audio-chip" style="margin-bottom:14px" onclick="speak('${esc(w.word)}')">üîä Nghe ph√°t √¢m</button>

        <div class="fc-divider"></div>

        <!-- Nghƒ©a -->
        <div style="display:flex;align-items:flex-start;gap:8px;margin-bottom:10px">
          <span style="font-size:18px;flex-shrink:0;margin-top:1px">üáªüá≥</span>
          <div class="fc-meaning">${w.meaning}</div>
        </div>

        <!-- C√¢u v√≠ d·ª• -->
        ${w.example ? `
        <div class="fc-example">${ex}</div>
        <button class="audio-chip" style="margin-top:10px" onclick="speak('${esc(w.example)}')">üîä Nghe c√¢u m·∫´u</button>
        ` : ''}
      </div>

      <!-- Footer: ƒëi·ªÅu h∆∞·ªõng Prev/Next + ƒë√°nh gi√° -->
      <div class="fc-card-footer" style="flex-direction:column;gap:12px;align-items:stretch;">
        <!-- H√†ng Prev / Next -->
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
          <button class="btn btn-outline btn-sm fc-prev-btn" onclick="fcPrev()" ${idx===0?'disabled':''} style="flex:1;justify-content:center;">‚Üê Tr∆∞·ªõc</button>
          <span style="font-size:12px;color:var(--ink4);font-weight:700;white-space:nowrap;">${idx+1} / ${words.length}</span>
          <button class="btn btn-outline btn-sm fc-next-btn" onclick="fcNext()" ${idx>=words.length-1?'disabled':''} style="flex:1;justify-content:center;">Ti·∫øp ‚Üí</button>
        </div>
        <!-- H√†ng ƒë√°nh gi√° -->
        <div>
          <div style="font-size:13px;color:var(--ink3);font-weight:600;margin-bottom:8px;text-align:center;">B·∫°n nh·ªõ t·ª´ n√†y kh√¥ng?</div>
          <div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap;">
            <button class="rate-btn rb-hard" onclick="rateCard('hard')">üòÖ Kh√≥ nh·ªõ</button>
            <button class="rate-btn rb-ok" onclick="rateCard('ok')">ü§î T·∫°m ·ªïn</button>
            <button class="rate-btn rb-easy" onclick="rateCard('easy')">üòä Nh·ªõ r·ªìi!</button>
          </div>
        </div>
      </div>
    </div>`;

  // Fetch Pexels n·∫øu ch∆∞a c√≥ trong cache
  const _cacheKey = w.word.toLowerCase().trim();
  if(!(_cacheKey in _imgCache)){
    const wrap    = document.getElementById('fc-img-wrap');
    const loading = document.getElementById('fc-img-loading');
    const imgEl   = document.getElementById('fc-img');
    if(loading) loading.style.display='flex';
    if(wrap && !initialImg) wrap.style.display='block'; // show wrap khi ƒëang load

    fetchWordImage(w.word, w.meaning||'', w.example||'').then(url => {
      if(loading) loading.style.display='none';
      if(url && imgEl){
        imgEl.style.opacity='0';
        imgEl.src = url;
        imgEl.style.opacity='1';
        if(wrap) wrap.style.display='block';
      } else {
        // Kh√¥ng c√≥ ·∫£nh ph√π h·ª£p ‚Üí ·∫©n v√πng ·∫£nh
        if(wrap) wrap.style.display='none';
      }
      const vw = S.vocab.find(x=>x.id===w.id);
      if(vw){ vw.imageUrl = url||''  ; save(); }
    });
  }
}

// flipCard kh√¥ng c√≤n d√πng nh∆∞ng gi·ªØ ƒë·ªÉ tr√°nh l·ªói n·∫øu c√≥ ref c≈©
function flipCard(){}

/* ‚îÄ‚îÄ Prev / Next flashcard (kh√¥ng t√≠nh XP, ch·ªâ ƒëi·ªÅu h∆∞·ªõng) ‚îÄ‚îÄ */
function fcPrev(){
  if(S.study.idx > 0){
    S.study.idx--;
    _saveFcPosition();
    updPbar();
    renderFlashcard();
  }
}
function fcNext(){
  const{words,idx}=S.study;
  if(idx < words.length - 1){
    S.study.idx++;
    _saveFcPosition();
    updPbar();
    renderFlashcard();
  }
}

/* ‚îÄ‚îÄ L∆∞u v·ªã tr√≠ flashcard v√†o localStorage ngay l·∫≠p t·ª©c ‚îÄ‚îÄ */
function _saveFcPosition(){
  try{
    const raw = localStorage.getItem(_sessionKey());
    const sess = raw ? JSON.parse(raw) : {};
    sess.studyIdx     = S.study.idx;
    sess.currentTopic = S.currentTopic;
    sess.panel        = 'study';
    sess.studyTab     = 'flashcard';
    localStorage.setItem(_sessionKey(), JSON.stringify(sess));
  }catch(e){}
  save(); // c≈©ng sync v√†o speakup4 ƒë·ªÉ firebase bi·∫øt
}

function rateCard(level){
  const{words,idx}=S.study;const w=words[idx%words.length];
  const v=S.vocab.find(x=>x.id===w.id);
  if(v){v.difficulty=level;v.reviewCount=(v.reviewCount||0)+1;if(level==='easy')v.learned=true;}
  gainXP(level==='easy'?10:level==='ok'?5:2);S.study.idx++;
  _saveFcPosition(); // l∆∞u v·ªã tr√≠ ngay sau m·ªói l·∫ßn ƒë√°nh gi√°
  if(S.study.idx>=words.length){
    S.study.idx=0;_saveFcPosition(); // reset v·ªÅ ƒë·∫ßu khi ho√†n th√†nh
    document.getElementById('tab-flashcard').innerHTML=`<div class="result"><div style="font-size:56px;margin-bottom:16px">üéâ</div><div class="result-msg">Ho√†n th√†nh Flashcard!</div><div class="result-sub">ƒê√£ √¥n xong ${words.length} t·ª´</div><div class="xp-pill">+${words.length*7} XP ‚ö°</div><div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap"><button class="btn btn-primary" onclick="goTab('dialogue')">üí¨ H·ªçc h·ªôi tho·∫°i</button><button class="btn btn-outline" onclick="startStudy('${esc(S.currentTopic)}','restart')">üîÑ H·ªçc l·∫°i</button></div></div>`;
  }else renderFlashcard();
  updPbar();save();
}

/* ‚îÄ‚îÄ DIALOGUE ‚Äî m·ªói t·ª´ 1 ƒëo·∫°n h·ªôi tho·∫°i ri√™ng ‚îÄ‚îÄ */

// Cache: { wordId: lines[] }
const _dlgCache = {};
// Index t·ª´ ƒëang xem trong tab dialogue
let _dlgWordIdx = 0;

// ‚îÄ‚îÄ Fallback tƒ©nh cho sample topics ‚îÄ‚îÄ
function getStaticDlgForWord(word, topic){
  // D√πng DLGS n·∫øu c√≥ v√† t·ª´ xu·∫•t hi·ªán trong ƒë√≥
  const static_lines = DLGS[topic];
  if(static_lines){
    const relevant = static_lines.filter(ln => ln.h && ln.h.toLowerCase() === word.word.toLowerCase());
    if(relevant.length){
      // L·∫•y 2-3 c√¢u xung quanh d√≤ng c√≥ t·ª´ ƒë√≥
      const idx = static_lines.indexOf(relevant[0]);
      const start = Math.max(0, idx - 1);
      const end   = Math.min(static_lines.length, start + 4);
      return static_lines.slice(start, end);
    }
  }
  return null;
}

// ‚îÄ‚îÄ Fallback offline: t·∫°o h·ªôi tho·∫°i ƒë∆°n gi·∫£n t·ª´ c√¢u v√≠ d·ª• ‚îÄ‚îÄ
function buildWordFallbackDlg(w){
  const ex = w.example || `I use the word "${w.word}" quite often.`;
  return [
    {s:'A', t:`Hey, have you ever used the word "${w.word}" before?`,            h:'',     vi:`N√†y, b·∫°n ƒë√£ d√πng t·ª´ "${w.word}" bao gi·ªù ch∆∞a?`},
    {s:'B', t:`Yes! For example: ${ex}`,                                          h:w.word,  vi:`C√≥! V√≠ d·ª•: ${w.meaning}`},
    {s:'A', t:`Oh I see, that makes sense. I should use it more often.`,          h:'',     vi:`·ªí t√¥i hi·ªÉu r·ªìi, h·ª£p l√Ω ƒë·∫•y. T√¥i n√™n d√πng t·ª´ ƒë√≥ nhi·ªÅu h∆°n.`},
    {s:'B', t:`Definitely! The word "${w.word}" is very useful in daily life.`,   h:w.word,  vi:`Ch·∫Øc ch·∫Øn r·ªìi! T·ª´ "${w.word}" r·∫•t h·ªØu √≠ch trong cu·ªôc s·ªëng h√†ng ng√†y.`},
  ];
}

// ‚îÄ‚îÄ G·ªçi Claude sinh 1 ƒëo·∫°n h·ªôi tho·∫°i ng·∫Øn cho 1 t·ª´ ‚îÄ‚îÄ
async function generateWordDialogue(w, topic){
  const cacheKey = 'wd_' + w.id;
  // Check memory cache
  if(_dlgCache[cacheKey]) return _dlgCache[cacheKey];
  // Check localStorage cache
  try{
    const stored = localStorage.getItem('speakup_dlg_' + String(w.id));
    if(stored){
      const parsed = JSON.parse(stored);
      _dlgCache[cacheKey] = parsed;
      return parsed;
    }
  }catch(e){}

  const apiKey = getAnthropicKey();
  if(!apiKey){
    const fb = getStaticDlgForWord(w, topic) || buildWordFallbackDlg(w);
    _dlgCache[cacheKey] = fb;
    return fb;
  }

  const contextMap = {
    'Work & Office':'two colleagues at the office','Travel & Tourism':'two friends on a trip',
    'Food & Dining':'two friends at a restaurant','Technology':'two coworkers discussing tech',
    'Health & Medical':'a patient and a doctor','Education':'a student and a teacher',
    'Environment & Nature':'two people outdoors','Sports & Fitness':'two gym friends',
    'Arts & Entertainment':'two friends at a caf√©','Finance & Economy':'two friends over coffee',
    'Science & Research':'two colleagues in a lab','Daily Conversation':'two friends chatting',
    'Emotions & Psychology':'two close friends talking','Daily Life':'two neighbors talking',
  };
  const context = contextMap[topic] || 'two people having a conversation';

  const prompt = `Create a short 4-line English dialogue for Vietnamese learners.
WORD: "${w.word}" (Vietnamese meaning: "${w.meaning || ''}") ‚Äî example: "${w.example || ''}"
SCENARIO: ${context}
STRICT RULES:
- Exactly 4 turns: A, B, A, B
- The "t" field (spoken text) must be ENGLISH ONLY ‚Äî absolutely NO Vietnamese words
- Use "${w.word}" naturally in at least 2 turns ‚Äî mark each usage in the "h" field
- Each "t": 8-14 natural spoken English words
- The "vi" field is the Vietnamese translation of that English line (ONLY place for Vietnamese)
- The dialogue must be coherent and feel like a real conversation

Return ONLY a JSON array, no markdown, no explanation:
[{"s":"A","t":"ENGLISH ONLY","h":"","vi":"Vietnamese translation here"},{"s":"B","t":"ENGLISH ONLY with ${w.word}","h":"${w.word}","vi":"Vietnamese translation here"},{"s":"A","t":"ENGLISH ONLY","h":"","vi":"Vietnamese translation here"},{"s":"B","t":"ENGLISH ONLY with ${w.word}","h":"${w.word}","vi":"Vietnamese translation here"}]
JSON:`;

  try{
    const res = await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'x-api-key':apiKey,
        'anthropic-version':'2023-06-01',
        'anthropic-dangerous-direct-browser-access':'true'
      },
      body:JSON.stringify({
        model:'claude-haiku-4-5-20251001',
        max_tokens:600,
        messages:[{role:'user',content:prompt}]
      })
    });
    if(res.ok){
      const d = await res.json();
      const raw = (d?.content?.[0]?.text||'').trim();
      const cleaned = raw.replace(/^```(?:json)?\n?/,'').replace(/\n?```$/,'').trim();
      const parsed = JSON.parse(cleaned);
      if(Array.isArray(parsed) && parsed.length >= 4){
        const lines = parsed.slice(0,4).map(ln=>({
          s: ln.s==='B'?'B':'A',
          t: String(ln.t||''),
          h: String(ln.h||''),
          vi: String(ln.vi||'')
        }));
        _dlgCache[cacheKey] = lines;
        try{ localStorage.setItem('speakup_dlg_'+String(w.id), JSON.stringify(lines)); }catch(e){}
        return lines;
      }
    }
  }catch(e){ console.warn('generateWordDialogue error:',e); }

  const fb = getStaticDlgForWord(w, topic) || buildWordFallbackDlg(w);
  _dlgCache[cacheKey] = fb;
  return fb;
}

// ‚îÄ‚îÄ Render to√†n b·ªô tab dialogue ‚îÄ‚îÄ
async function renderDialogue(){
  const topic = S.currentTopic;
  const words = S.study.words;
  if(!words.length){
    document.getElementById('tab-dialogue').innerHTML =
      `<div class="empty-state"><div class="empty-icon">üí¨</div><div class="empty-title">Kh√¥ng c√≥ t·ª´ v·ª±ng</div></div>`;
    return;
  }
  // ƒê·∫£m b·∫£o index h·ª£p l·ªá
  _dlgWordIdx = Math.min(_dlgWordIdx, words.length - 1);
  if(_dlgWordIdx < 0) _dlgWordIdx = 0;
  await renderDlgWord(topic, words, _dlgWordIdx);
}

// ‚îÄ‚îÄ Render 1 t·ª´ c·ª• th·ªÉ (g·ªçi API n·∫øu c·∫ßn, hi·ªán skeleton tr∆∞·ªõc) ‚îÄ‚îÄ
async function renderDlgWord(topic, words, idx){
  const el = document.getElementById('tab-dialogue');
  const w  = words[idx];
  _dlgWordIdx = idx;

  // Render shell ngay l·∫≠p t·ª©c (word header + nav + skeleton)
  el.innerHTML = buildDlgShell(topic, words, idx, null);

  // Ki·ªÉm tra cache nhanh (sync)
  const cacheKey = 'wd_' + w.id;
  const cached = _dlgCache[cacheKey] || (() => {
    try{
      const s = localStorage.getItem('speakup_dlg_'+String(w.id));
      if(s){ const p=JSON.parse(s); _dlgCache[cacheKey]=p; return p; }
    }catch(e){}
    return null;
  })();

  if(cached){
    el.innerHTML = buildDlgShell(topic, words, idx, cached);
    return;
  }

  // Hi·ªán skeleton loading trong v√πng h·ªôi tho·∫°i
  document.getElementById('dlg-lines-area').innerHTML = `
    <div class="dlg-loading">
      ${[70,55,80,60].map((w,i)=>`<div class="dlg-loading-line" style="width:${w}%;margin-left:${i%2===0?'0':'auto'};animation-delay:${i*0.15}s"></div>`).join('')}
    </div>`;

  const lines = await generateWordDialogue(w, topic);
  // Sau khi nh·∫≠n xong, re-render ƒë·∫ßy ƒë·ªß
  if(document.getElementById('tab-dialogue')){ // v·∫´n trong tab n√†y
    el.innerHTML = buildDlgShell(topic, words, idx, lines);
  }
}

// ‚îÄ‚îÄ Build HTML cho to√†n b·ªô dialogue tab ‚îÄ‚îÄ
function buildDlgShell(topic, words, idx, lines){
  const w = words[idx];
  const rule = TOPIC_RULES.find(r=>r.name===topic);
  const emoji = rule?.emoji || 'üí¨';

  // Nav dots
  const dots = words.map((x,i)=>`<div class="dlg-dot ${i<idx?'seen':''} ${i===idx?'active':''}" onclick="renderDlgWord('${esc(topic)}',S.study.words,${i})" title="${esc(x.word)}"></div>`).join('');

  // Word header
  const header = `
    <div class="dlg-word-header">
      <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap">
        <div style="flex:1;min-width:0">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:2px">
            <span class="badge badge-teal">${emoji} ${topic}</span>
            <span style="font-size:12px;color:var(--ink4);font-weight:600">${idx+1} / ${words.length}</span>
          </div>
          <div class="dlg-word-title">${w.word}</div>
          <div class="dlg-word-ipa">${w.ipa||''}</div>
          <div class="dlg-word-meaning">üáªüá≥ ${w.meaning||'‚Äî'}</div>
          ${w.example?`<div class="dlg-word-example">"${w.example}"</div>`:''}
        </div>
        <div style="display:flex;flex-direction:column;gap:6px;flex-shrink:0">
          <button class="audio-chip" onclick="speak('${esc(w.word)}')" style="font-size:12px;padding:5px 11px">üîä T·ª´</button>
          ${w.example?`<button class="audio-chip" onclick="speak('${esc(w.example)}')" style="font-size:12px;padding:5px 11px">üîä C√¢u</button>`:''}
        </div>
      </div>
    </div>`;

  // Nav bar
  const navBar = `
    <div class="dlg-nav-bar">
      <button class="btn btn-outline btn-sm" onclick="prevDlgWord()" ${idx===0?'disabled':''}>‚Üê Tr∆∞·ªõc</button>
      <div class="dlg-nav-dots">${dots}</div>
      <button class="btn btn-${idx===words.length-1?'primary':'outline'} btn-sm" onclick="nextDlgWord()">
        ${idx===words.length-1?'ƒê·∫øn Quiz ‚Üí':'Ti·∫øp ‚Üí'}
      </button>
    </div>`;

  // Lines area
  const linesHtml = lines ? buildDlgLinesHtml(lines, w) : `
    <div class="dlg-loading" id="dlg-lines-area">
      ${[70,55,80,60].map((pw,i)=>`<div class="dlg-loading-line" style="width:${pw}%;margin-left:${i%2===0?'0':'auto'};animation-delay:${i*0.15}s"></div>`).join('')}
    </div>`;

  // Refresh button + play button
  const footer = lines ? `
    <div style="display:flex;gap:10px;margin-top:14px;flex-wrap:wrap;align-items:center">
      <button class="audio-chip" onclick="playCurrentDlg()">‚ñ∂ Ph√°t h·ªôi tho·∫°i</button>
      <button class="btn btn-ghost btn-sm" onclick="refreshCurrentDlg()">üîÑ T·∫°o l·∫°i</button>
      <div style="flex:1"></div>
      <button class="btn btn-outline btn-sm" onclick="goTab('quiz')">ƒê·∫øn b√†i t·∫≠p ‚Üí</button>
    </div>` : '';

  return header + navBar +
    `<div class="card" style="padding:18px" id="dlg-lines-area">${linesHtml ? linesHtml : ''}</div>` +
    footer;
}

// ‚îÄ‚îÄ Build HTML c√°c d√≤ng h·ªôi tho·∫°i ‚îÄ‚îÄ
function buildDlgLinesHtml(lines, w){
  return `<div class="dlg-wrap">${lines.map((ln,idx)=>`
    <div class="dlg-msg ${ln.s==='B'?'right':''}" style="animation-delay:${idx*0.07}s">
      <div class="dlg-av">${ln.s==='A'?'üë®':'üë©'}</div>
      <div>
        <div class="dlg-speaker">${ln.s==='A'?'Alex':'Sam'}</div>
        <div class="dlg-bubble">
          <div class="dlg-text">${hlW(ln.t, w.word)}</div>
          ${ln.vi?`<div style="font-size:11px;color:var(--ink4);margin-top:5px;font-style:italic;border-top:1px solid var(--border);padding-top:4px">üáªüá≥ ${ln.vi}</div>`:''}
          <div style="margin-top:8px">
            <button class="audio-chip" style="padding:4px 10px;font-size:11px" onclick="speak('${esc(ln.t)}')">üîä</button>
          </div>
        </div>
      </div>
    </div>`).join('')}
  </div>`;
}

function prevDlgWord(){
  if(_dlgWordIdx > 0) renderDlgWord(S.currentTopic, S.study.words, _dlgWordIdx - 1);
}
function nextDlgWord(){
  const words = S.study.words;
  if(_dlgWordIdx < words.length - 1){
    renderDlgWord(S.currentTopic, words, _dlgWordIdx + 1);
  } else {
    goTab('quiz');
  }
}
function refreshCurrentDlg(){
  const w = S.study.words[_dlgWordIdx];
  if(!w) return;
  const cacheKey = 'wd_' + w.id;
  delete _dlgCache[cacheKey];
  try{ localStorage.removeItem('speakup_dlg_' + String(w.id)); }catch(e){}
  renderDlgWord(S.currentTopic, S.study.words, _dlgWordIdx);
}
function playCurrentDlg(){
  const w = S.study.words[_dlgWordIdx];
  if(!w) return;
  const lines = _dlgCache['wd_' + w.id];
  if(!lines) return;
  window.speechSynthesis.cancel();
  let i = 0;
  const femaleVoice = getFemaleUSVoice();
  function speakNext(){
    if(i >= lines.length) return;
    const ln = lines[i++];
    const u = new SpeechSynthesisUtterance(ln.t);
    u.lang='en-US'; u.rate=0.85;
    if(femaleVoice) u.voice = femaleVoice;
    u.onend = ()=>setTimeout(speakNext, 380);
    u.onerror = ()=>setTimeout(speakNext, 380);
    window.speechSynthesis.speak(u);
  }
  if(window.speechSynthesis.getVoices().length===0){
    window.speechSynthesis.onvoiceschanged=()=>{_femaleUSVoice=null;speakNext();};
  } else { speakNext(); }
}
function hlW(text,word){if(!word)return text;return text.replace(new RegExp('\\b'+word+'\\b','gi'),m=>`<span class="hl">${m}</span>`);}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   QUIZ ENGINE v2 ‚Äî Batch 10 t·ª´ ¬∑ 3 b∆∞·ªõc/t·ª´
   Th·ª© t·ª± m·ªói t·ª´: 1) Tr·∫Øc nghi·ªám  2) ƒêi·ªÅn t·ª´  3) S·∫Øp x·∫øp c√¢u
   K·∫øt th√∫c batch: L√†m l·∫°i  /  10 t·ª´ ti·∫øp theo
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

const LETTERS   = ['A','B','C','D'];
const BATCH_SIZE = 5;
let _qzPicked   = [];
let _matchSel   = null;
let _matchDone  = 0;
let _matchTotal = 0;

/* ‚îÄ‚îÄ Chia t·ª´ th√†nh c√°c batch 10 t·ª´ ‚îÄ‚îÄ */
function getQzBatchWords(){
  const all    = S.study.words;
  const offset = (S.quiz.batchIdx||0) * BATCH_SIZE;
  return all.slice(offset, offset + BATCH_SIZE);
}

/* ‚îÄ‚îÄ Build c√¢u h·ªèi cho 1 batch:
     M·ªói t·ª´ sinh ƒë√∫ng 3 c√¢u theo th·ª© t·ª±:
     [0] meaning-mc   ‚Üí Tr·∫Øc nghi·ªám ch·ªçn nghƒ©a
     [1] fill-blank   ‚Üí ƒêi·ªÅn t·ª´ v√†o c√¢u
     [2] word-builder ‚Üí S·∫Øp x·∫øp th√†nh c√¢u
‚îÄ‚îÄ */
function buildQ(words){
  const all = S.study.words;  // pool ƒë·ªÉ l·∫•y "other" choices
  const q   = [];
  words.forEach(w => {
    const others = shuffle(all.filter(x => x.id !== w.id));

    /* B∆∞·ªõc 1 ‚Äì Tr·∫Øc nghi·ªám */
    const mcOpts = shuffle([w, ...others.slice(0,3)]).map(x=>({label:x.meaning, id:String(x.id)}));
    q.push({ step:1, type:'meaning-mc', word:w, opts:mcOpts, correct:String(w.id) });

    /* B∆∞·ªõc 2 ‚Äì ƒêi·ªÅn t·ª´ */
    // Strip ph·∫ßn d·ªãch ti·∫øng Vi·ªát trong ngo·∫∑c tr∆∞·ªõc khi hi·ªÉn th·ªã c√¢u
    const exFill = (w.example||'').replace(/\s*[\(\Ôºà][^\)\Ôºâ]*[\)\Ôºâ]/g,'').replace(/\s*[\u2014\u2013-]\s*[^\x00-\x7F].*$/u,'').trim();
    const sent = exFill;
    q.push({ step:2, type:'fill-blank', word:w, sent, correct:w.word.toLowerCase() });

    /* B∆∞·ªõc 3 ‚Äì S·∫Øp x·∫øp c√¢u */
    // Strip ph·∫ßn d·ªãch ti·∫øng Vi·ªát trong ngo·∫∑c ƒë∆°n/ngo·∫∑c k√©p ·ªü cu·ªëi c√¢u
    // VD: "To be honest, I don't like this. (Th·∫≠t l√≤ng m√† n√≥i...)" ‚Üí ch·ªâ l·∫•y ph·∫ßn ti·∫øng Anh
    const exampleRaw = w.example || `I use the word ${w.word} every day`;
    const enOnly = exampleRaw
      .replace(/\s*[\(\Ôºà][^\)\Ôºâ]*[\)\Ôºâ]/g, '')   // x√≥a (...) v√† Ôºà...Ôºâ
      .replace(/\s*[‚Äî‚Äì-]\s*[^\x00-\x7F].*$/u, '') // x√≥a "‚Äî <ti·∫øng Vi·ªát>" ·ªü cu·ªëi
      .replace(/\s{2,}/g, ' ')
      .trim();
    const raw  = (enOnly || `I use the word ${w.word} every day`).replace(/[.!?,]/g,'').trim();
    const toks = shuffle(raw.split(' ').filter(Boolean));
    q.push({ step:3, type:'word-builder', word:w, sentence:raw, tokens:toks });
  });
  S.quiz.questions = q;
  S.quiz.current   = 0;
  S.quiz.correct   = 0;
  S.quiz.wrong     = 0;
  S.quiz.lives     = 3;
  S.quiz.missed    = [];
}

function renderQuiz(){
  const words = getQzBatchWords();
  if(!words.length){
    document.getElementById('tab-quiz').innerHTML =
      `<div class="empty-state"><div class="empty-icon">üì≠</div>
       <div class="empty-title">Ch∆∞a c√≥ t·ª´ v·ª±ng</div>
       <div class="empty-sub">Import ho·∫∑c th√™m t·ª´ ƒë·ªÉ b·∫Øt ƒë·∫ßu luy·ªán t·∫≠p</div>
       <button class="btn btn-primary" onclick="showPanel('import')">üì• Import ngay</button></div>`;
    return;
  }
  if(!S.quiz.questions.length) buildQ(words);
  showQ();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   HEADER: progress bar  ¬∑  step badge  ¬∑  hearts
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function qzHeader(){
  const { questions, current, lives } = S.quiz;
  const total   = questions.length;              // 10 t·ª´ √ó 3 = 30
  const pct     = total ? Math.round(current / total * 100) : 0;
  const hp      = lives ?? 3;
  const hearts  = [0,1,2].map(i =>
    `<span class="qz-heart ${i >= hp ? 'lost' : ''}">‚ù§Ô∏è</span>`).join('');
  const q       = questions[current];
  const stepTxt = q ? `B∆∞·ªõc ${q.step}/3` : '';
  const wordIdx = q ? Math.floor(current / 3) + 1 : 0;
  const batchSz = Math.ceil(questions.length / 3);

  return `<div class="qz-topbar">
    <span class="qz-close" onclick="confirmExitQuiz()" title="Tho√°t">‚úï</span>
    <div style="flex:1;min-width:0">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px">
        <span style="font-size:11px;font-weight:700;color:var(--ink4)">T·ª´ ${wordIdx}/${batchSz} ¬∑ ${stepTxt}</span>
        <span style="font-size:11px;font-weight:700;color:var(--ink3)">${pct}%</span>
      </div>
      <div class="qz-pbar-wrap"><div class="qz-pbar-fill" style="width:${pct}%"></div></div>
    </div>
    <div class="qz-lives" style="margin-left:10px">${hearts}</div>
  </div>
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;gap:8px">
    <button class="btn btn-ghost btn-sm" onclick="prevQ()" ${current===0?'disabled style="opacity:.35;cursor:default"':''} style="font-size:12px;padding:6px 12px;border:1.5px solid var(--border);border-radius:8px">
      ‚Üê C√¢u tr∆∞·ªõc
    </button>
    <span style="font-size:12px;color:var(--ink4);font-weight:600">${current+1} / ${total}</span>
    <button class="btn btn-ghost btn-sm" onclick="skipQ()" style="font-size:12px;padding:6px 12px;border:1.5px solid var(--border);border-radius:8px">
      C√¢u sau ‚Üí
    </button>
  </div>`;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   STEP INDICATOR per word (‚óè‚óè‚óã ‚Üí ‚óè‚óè‚óè)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function stepBadge(step){
  const labels = ['Tr·∫Øc nghi·ªám','ƒêi·ªÅn t·ª´','S·∫Øp x·∫øp c√¢u'];
  const icons  = ['üÖê','‚úèÔ∏è','üîÄ'];
  return `<div style="display:flex;gap:8px;margin-bottom:14px;align-items:center;flex-wrap:wrap">
    ${[1,2,3].map(s=>`
      <div style="display:flex;align-items:center;gap:5px;padding:5px 10px;border-radius:20px;
        background:${s===step?'var(--teal)':s<step?'var(--teal-light)':'var(--bg2)'};
        border:1.5px solid ${s===step?'var(--teal)':s<step?'rgba(13,148,136,.3)':'var(--border)'};
        font-size:12px;font-weight:700;
        color:${s===step?'#fff':s<step?'var(--teal)':'var(--ink4)'}">
        ${s<step?'‚úì':icons[s-1]} ${labels[s-1]}
      </div>`).join('')}
  </div>`;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MAIN RENDER
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function showQ(){
  const { questions, current } = S.quiz;
  const el = document.getElementById('tab-quiz');
  if(current >= questions.length){ showQzBatchResult(); return; }

  const q = questions[current];
  const w = q.word;
  const header = qzHeader();
  const badge  = stepBadge(q.step);
  let card = '';

  /* ‚îÄ‚îÄ B∆∞·ªõc 1: Tr·∫Øc nghi·ªám ‚îÄ‚îÄ */
  if(q.type === 'meaning-mc'){
    card = `<div class="qz-card">
      ${badge}
      <div class="qz-type-label">üá¨üáß Ch·ªçn nghƒ©a ƒë√∫ng</div>
      <div class="qz-word-hero">${w.word}
        <button class="audio-chip" style="font-size:12px;padding:4px 10px;margin-left:8px;vertical-align:middle"
          onclick="speak('${esc(w.word)}')">üîä</button>
      </div>
      <div class="qz-word-ipa">${w.ipa||''}</div>
      ${w.example ? `<div class="qz-sentence">"${w.example}"</div>` : ''}
      <div class="qz-question">T·ª´ n√†y c√≥ nghƒ©a l√† g√¨?</div>
      <div class="opts">
        ${q.opts.map((o,i)=>`
          <button class="opt" data-id="${o.id}"
            onclick="checkMCOpt(this,'${o.id}','${q.correct}')">
            <span class="opt-letter">${LETTERS[i]}</span>${o.label}
          </button>`).join('')}
      </div>
    </div>`;
  }

  /* ‚îÄ‚îÄ B∆∞·ªõc 2: ƒêi·ªÅn t·ª´ ‚îÄ‚îÄ */
  else if(q.type === 'fill-blank'){
    const display = q.sent
      ? q.sent.replace(new RegExp('\\b'+q.word.word+'\\b','i'),
          `<span class="qz-blank">_____</span>`)
      : `<span class="qz-blank">_____</span>`;
    card = `<div class="qz-card">
      ${badge}
      <div class="qz-type-label">‚úèÔ∏è ƒêi·ªÅn t·ª´ c√≤n thi·∫øu</div>
      <div style="margin-bottom:8px;display:flex;align-items:center;gap:10px;flex-wrap:wrap">
        <div id="fill-word-hidden" style="display:inline-flex;align-items:center;gap:8px;background:var(--bg2);border:2px dashed var(--border2);border-radius:10px;padding:6px 14px;cursor:pointer" onclick="revealFillWord()" title="Nh·∫•n ƒë·ªÉ xem t·ª´">
          <span style="font-size:18px;font-weight:800;color:var(--ink4);letter-spacing:3px">${'?'.repeat(Math.min(w.word.length,6))}</span>
          <span style="font-size:11px;color:var(--ink4);font-weight:600">üëÅ Hi·ªán t·ª´</span>
        </div>
        <div id="fill-word-revealed" style="display:none;align-items:baseline;gap:8px">
          <span class="qz-word-hero" style="font-size:20px">${w.word}</span>
          <span class="qz-word-ipa">&nbsp;${w.ipa||''}</span>
        </div>
      </div>
      <div class="qz-sentence">${display}</div>
      <div style="font-size:13px;color:var(--ink3);margin-bottom:12px">
        üí° G·ª£i √Ω: <strong>${w.meaning}</strong>
      </div>
      <input class="fill-inp" id="fill-ans"
        placeholder="Nh·∫≠p t·ª´ ti·∫øng Anh‚Ä¶"
        autocomplete="off" autocorrect="off" autocapitalize="off"
        onkeydown="if(event.key==='Enter')checkFill()">
      <button class="btn btn-primary" style="width:100%;margin-top:6px"
        onclick="checkFill()">Ki·ªÉm tra ‚úì</button>
    </div>`;
  }

  /* ‚îÄ‚îÄ B∆∞·ªõc 3: S·∫Øp x·∫øp c√¢u ‚îÄ‚îÄ */
  else if(q.type === 'word-builder'){
    card = `<div class="qz-card" id="wb-card" data-correct="${esc(q.sentence)}">
      ${badge}
      <div class="qz-type-label">üîÄ S·∫Øp x·∫øp th√†nh c√¢u ƒë√∫ng</div>
      <div style="margin-bottom:12px">
        <span class="qz-word-hero" style="font-size:20px">${w.word}</span>
        <span style="font-size:14px;color:var(--ink3)"> ‚Äî ${w.meaning}</span>
      </div>
      <div style="font-size:13px;color:var(--ink3);margin-bottom:8px;font-weight:600">
        Nh·∫•n t·ª´ng t·ª´ ƒë·ªÉ x√¢y d·ª±ng c√¢u ƒë√∫ng ‚Üì
      </div>
      <div class="chips-area target" id="ans-chips" style="min-height:54px"></div>
      <div style="font-size:12px;color:var(--ink4);margin-bottom:8px">Ngu·ªìn t·ª´:</div>
      <div class="chips-area" id="src-chips">
        ${q.tokens.map(t=>`<div class="chip" data-word="${esc(t)}" onclick="pickChipEl(this)">${t}</div>`).join('')}
      </div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn btn-outline btn-sm" onclick="clearBuilder()">üîÑ X√≥a</button>
        <button class="btn btn-primary" style="flex:1" onclick="checkOrder()">Ki·ªÉm tra ‚úì</button>
      </div>
    </div>`;
  }

  el.innerHTML = header + card;
  _qzPicked = [];
  if(q.type==='fill-blank') setTimeout(()=>document.getElementById('fill-ans')?.focus(), 120);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   FEEDBACK BAR (Duolingo-style)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function showFeedback(isOk, correctLabel){
  const el = document.getElementById('tab-quiz');
  // Remove old feedback if any
  document.querySelectorAll('.qz-feedback').forEach(f=>f.remove());
  const fb = document.createElement('div');
  fb.className = `qz-feedback ${isOk?'ok':'err'}`;
  if(isOk){
    fb.innerHTML = `
      <div class="qz-feedback-icon">üéâ</div>
      <div class="qz-feedback-msg">
        <div class="qz-feedback-title ok">Ch√≠nh x√°c!</div>
      </div>
      <button class="btn btn-primary qz-next-btn" onclick="advanceQ()">Ti·∫øp ‚Üí</button>`;
  } else {
    fb.innerHTML = `
      <div class="qz-feedback-icon">üí°</div>
      <div class="qz-feedback-msg" style="flex:1">
        <div class="qz-feedback-title err">Ch∆∞a ƒë√∫ng!</div>
        <div class="qz-feedback-sub">ƒê√°p √°n: <strong>${correctLabel}</strong></div>
      </div>
      <div style="display:flex;flex-direction:column;gap:7px;flex-shrink:0">
        <button class="btn btn-primary qz-next-btn" style="font-size:13px;padding:9px 16px" onclick="retryQ()">
          üîÑ L√†m l·∫°i
        </button>
        <button class="btn btn-outline qz-next-btn" style="font-size:13px;padding:9px 16px;background:#fff" onclick="advanceQ()">
          B·ªè qua ‚Üí
        </button>
      </div>`;
  }
  el.appendChild(fb);
  fb.scrollIntoView({behavior:'smooth',block:'nearest'});
}

function advanceQ(){
  S.quiz.current++;
  _saveQuizPosition();
  showQ();
}

/* Quay l·∫°i c√¢u tr∆∞·ªõc */
function prevQ(){
  if(S.quiz.current > 0){
    S.quiz.current--;
    _saveQuizPosition();
    showQ();
  }
}

/* B·ªè qua c√¢u hi·ªán t·∫°i (kh√¥ng t√≠nh ƒëi·ªÉm, kh√¥ng tr·ª´ lives) */
function skipQ(){
  if(S.quiz.current < S.quiz.questions.length - 1){
    S.quiz.current++;
    _saveQuizPosition();
    showQ();
  } else {
    showQzBatchResult();
  }
}

/* ‚îÄ‚îÄ L∆∞u v·ªã tr√≠ quiz ngay l·∫≠p t·ª©c ‚îÄ‚îÄ */
function _saveQuizPosition(){
  try{
    const raw = localStorage.getItem(_sessionKey());
    const sess = raw ? JSON.parse(raw) : {};
    sess.currentTopic = S.currentTopic;
    sess.panel        = 'study';
    sess.studyTab     = 'quiz';
    sess.topicQuiz    = S.quiz?.questions?.length ? {
      batchIdx : S.quiz.batchIdx||0,
      current  : S.quiz.current||0,
      correct  : S.quiz.correct||0,
      wrong    : S.quiz.wrong||0,
      lives    : S.quiz.lives??3,
      missed   : S.quiz.missed||[],
      questions: (S.quiz.questions||[]).map(q=>({...q, word:{id:q.word?.id}}))
    } : null;
    localStorage.setItem(_sessionKey(), JSON.stringify(sess));
  }catch(e){}
}

/* L√†m l·∫°i c√¢u v·ª´a sai ‚Äî reset ho√†n to√†n tr·∫°ng th√°i c√¢u, kh√¥ng t√≠nh sai th√™m */
function retryQ(){
  // Reset picked array TR∆Ø·ªöC khi render l·∫°i
  _qzPicked = [];
  // X√≥a feedback
  document.querySelectorAll('.qz-feedback').forEach(f=>f.remove());
  // Render l·∫°i to√†n b·ªô c√¢u (showQ s·∫Ω re-render fresh DOM, chips s·∫°ch ho√†n to√†n)
  showQ();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CHECK FUNCTIONS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function checkMCOpt(btn, selId, correctId){
  document.querySelectorAll('#tab-quiz .opt').forEach(b=>{
    b.classList.add('disabled');
    if(b.dataset.id===correctId) b.classList.add('correct');
    else if(b===btn && selId!==correctId) b.classList.add('wrong');
  });
  const isOk = selId===correctId;
  const q = S.quiz.questions[S.quiz.current];
  if(!q._scored){
    if(isOk){ S.quiz.correct++; gainXP(8); }
    else {
      S.quiz.wrong++;
      if(S.quiz.lives>0) S.quiz.lives--;
      const lbl = document.querySelector(`#tab-quiz .opt[data-id="${correctId}"]`)
                  ?.querySelector('.opt-letter')?.nextSibling?.textContent?.trim() || '';
      S.quiz.missed.push({word:q.word, answer:lbl});
    }
    q._scored = true;
    _saveQuizPosition();
  }
  const correctEl = document.querySelector(`#tab-quiz .opt[data-id="${correctId}"]`);
  const lbl = correctEl ? [...correctEl.childNodes].filter(n=>n.nodeType===3).map(n=>n.textContent.trim()).join('') : '';
  showFeedback(isOk, lbl);
}

function revealFillWord(){
  const hidden   = document.getElementById('fill-word-hidden');
  const revealed = document.getElementById('fill-word-revealed');
  if(hidden)   hidden.style.display   = 'none';
  if(revealed) revealed.style.display = 'inline-flex';
}

function checkFill(){
  const inp = document.getElementById('fill-ans');
  if(!inp) return;
  const q   = S.quiz.questions[S.quiz.current];
  const ans = inp.value.trim().toLowerCase();
  if(!ans){ showToast('Nh·∫≠p t·ª´ v√†o tr∆∞·ªõc!','error'); return; }
  // Accept n·∫øu ƒë√∫ng ho·∫∑c ch·ªâ kh√°c 1 k√Ω t·ª± (typo tolerance)
  const isOk = ans===q.correct || levenshtein(ans,q.correct)<=1;
  inp.classList.add(isOk?'correct':'wrong');
  inp.disabled = true;
  if(!q._scored){
    if(isOk){ S.quiz.correct++; gainXP(12); }
    else {
      S.quiz.wrong++;
      if(S.quiz.lives>0) S.quiz.lives--;
      S.quiz.missed.push({word:q.word, answer:q.word.word});
    }
    q._scored = true;
    _saveQuizPosition();
  }
  showFeedback(isOk, q.word.word);
}

/* Levenshtein distance ‚Äì typo tolerance ¬±1 */
function levenshtein(a,b){
  const m=a.length,n=b.length;
  const dp=Array.from({length:m+1},(_,i)=>Array.from({length:n+1},(_,j)=>i||j));
  for(let i=1;i<=m;i++) for(let j=1;j<=n;j++)
    dp[i][j]=a[i-1]===b[j-1]?dp[i-1][j-1]:1+Math.min(dp[i-1][j],dp[i][j-1],dp[i-1][j-1]);
  return dp[m][n];
}

/* ‚îÄ‚îÄ pickChipEl: d√πng data-word, kh√¥ng closure ph·ª©c t·∫°p ‚îÄ‚îÄ */
function pickChipEl(el){
  if(el.classList.contains('source')) return;
  const w = el.dataset.word;
  el.classList.add('source');
  _qzPicked.push(w);
  const area = document.getElementById('ans-chips');
  if(!area) return;
  const placed = document.createElement('div');
  placed.className = 'chip placed';
  placed.textContent = w;
  placed.onclick = function(){
    placed.remove();
    const idx = _qzPicked.indexOf(w);
    if(idx !== -1) _qzPicked.splice(idx, 1);
    // Tr·∫£ chip v·ªÅ src: t√¨m src chip c√≥ data-word=w v√† ƒëang source
    const srcs = document.querySelectorAll('#src-chips .chip');
    for(const c of srcs){
      if(c.dataset.word === w && c.classList.contains('source')){
        c.classList.remove('source');
        break;
      }
    }
  };
  area.appendChild(placed);
}
/* Gi·ªØ pickChip c≈© ƒë·ªÉ kh√¥ng l·ªói n·∫øu c√≤n ref */
function pickChip(el,w){ pickChipEl(el); }

function clearBuilder(){
  _qzPicked = [];
  const ans = document.getElementById('ans-chips');
  if(ans) ans.innerHTML = '';
  document.querySelectorAll('#src-chips .chip').forEach(c => {
    c.classList.remove('source');
    c.style.pointerEvents = '';
  });
}

function checkOrder(){
  const card = document.getElementById('wb-card');
  if(!card) return;
  const correct = card.dataset.correct || '';
  const ans = _qzPicked.join(' ').toLowerCase().replace(/[.!?,]/g,'').trim();
  const cor = correct.toLowerCase().replace(/[.!?,]/g,'').trim();
  if(!ans){ showToast('H√£y s·∫Øp x·∫øp √≠t nh·∫•t m·ªôt t·ª´!','error'); return; }
  const isOk = ans === cor;
  const q = S.quiz.questions[S.quiz.current];
  // Ch·ªâ t√≠nh ƒëi·ªÉm/lives l·∫ßn ƒê·∫¶U TI√äN submit
  if(!q._scored){
    if(isOk){ S.quiz.correct++; gainXP(15); }
    else {
      S.quiz.wrong++;
      if(S.quiz.lives > 0) S.quiz.lives--;
      S.quiz.missed.push({word: q.word, answer: correct});
    }
    q._scored = true;
    _saveQuizPosition();
  }
  // X√≥a feedback c≈©
  document.querySelectorAll('.qz-feedback').forEach(f => f.remove());
  if(isOk){
    // ƒê√∫ng ‚Üí lock chips, hi·ªán feedback ƒë√∫ng
    document.querySelectorAll('#src-chips .chip').forEach(c => c.style.pointerEvents = 'none');
    showFeedback(true, correct);
  } else {
    // Sai ‚Üí reset chips ƒë·ªÉ s·∫Øp x·∫øp l·∫°i ngay, hi·ªán feedback nh·ªè + n√∫t b·ªè qua
    clearBuilder();
    const el = document.getElementById('tab-quiz');
    const fb = document.createElement('div');
    fb.className = 'qz-feedback err';
    fb.innerHTML = '<div class="qz-feedback-icon">üí°</div>'
      + '<div class="qz-feedback-msg" style="flex:1">'
      + '<div class="qz-feedback-title err">Ch∆∞a ƒë√∫ng! S·∫Øp x·∫øp l·∫°i b√™n tr√™n ‚Üë</div>'
      + '<div class="qz-feedback-sub">G·ª£i √Ω: <strong>' + correct + '</strong></div>'
      + '</div>'
      + '<button class="btn btn-outline qz-next-btn" style="font-size:13px;padding:9px 16px;background:#fff;flex-shrink:0" onclick="advanceQ()">B·ªè qua ‚Üí</button>';
    el.appendChild(fb);
    fb.scrollIntoView({behavior:'smooth', block:'nearest'});
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   K·∫æT TH√öC BATCH ‚Äî M√†n h√¨nh k·∫øt qu·∫£
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function showQzBatchResult(){
  const { correct, wrong, missed, batchIdx } = S.quiz;
  const all     = S.study.words;
  const total   = S.quiz.questions.length;   // 30 c√¢u
  const wordCnt = Math.ceil(total / 3);      // 10 t·ª´
  const score   = total ? Math.round(correct / total * 100) : 100;
  const xp      = correct * 10;
  const hasNext = ((batchIdx||0) + 1) * BATCH_SIZE < all.length;

  gainXP(xp); save();

  const emoji = score>=90?'üèÜ':score>=70?'üåü':score>=50?'üëç':'üí™';
  const title = score>=90?'Xu·∫•t s·∫Øc!':score>=70?'T·ªët l·∫Øm!':score>=50?'Kh√° ·ªïn!':'C·ªë g·∫Øng th√™m!';

  // Danh s√°ch t·ª´ sai (unique by word id)
  const missedUniq = missed ? [...new Map(missed.map(m=>[m.word.id,m])).values()] : [];
  const reviewHtml = missedUniq.length ? `
    <div class="qz-review">
      <div style="padding:12px 14px;font-size:12px;font-weight:800;color:var(--ink3);
        text-transform:uppercase;letter-spacing:.07em;border-bottom:1px solid var(--border);
        background:var(--surface2);border-radius:12px 12px 0 0">
        üìã T·ª´ c·∫ßn √¥n l·∫°i (${missedUniq.length})
      </div>
      ${missedUniq.map(m=>`
        <div class="qz-review-item">
          <div class="qz-review-word">${m.word.word}</div>
          <div class="qz-review-right">
            <span style="color:var(--ink3)">ƒê√°p √°n: </span><strong>${m.answer}</strong><br>
            <span style="color:var(--ink4);font-size:11px;font-style:italic">${m.word.meaning}</span>
          </div>
        </div>`).join('')}
    </div>` : '';

  // N√∫t batch ti·∫øp theo
  const nextBatchNum = (batchIdx||0)+2;
  const nextStart    = ((batchIdx||0)+1)*BATCH_SIZE+1;
  const nextEnd      = Math.min(nextStart+BATCH_SIZE-1, all.length);

  document.getElementById('tab-quiz').innerHTML = `
    <div class="qz-result">
      <span class="qz-result-emoji">${emoji}</span>
      <div class="qz-result-title">${title}</div>
      <div style="font-size:13px;color:var(--ink3);margin-bottom:4px">
        ƒê√£ luy·ªán xong <strong>${wordCnt} t·ª´</strong> ¬∑
        ƒê·ª£t ${(batchIdx||0)+1}/${Math.ceil(all.length/BATCH_SIZE)}
      </div>

      <div class="qz-score-circle">
        <div class="qz-score-num">${score}%</div>
        <div class="qz-score-lbl">ƒëi·ªÉm</div>
      </div>

      <div class="qz-stat-row">
        <div class="qz-stat">
          <span class="qz-stat-val" style="color:var(--teal)">${correct}</span>
          <div class="qz-stat-lbl">‚úÖ ƒê√∫ng</div>
        </div>
        <div class="qz-stat">
          <span class="qz-stat-val" style="color:var(--rose)">${wrong}</span>
          <div class="qz-stat-lbl">‚ùå Sai</div>
        </div>
        <div class="qz-stat">
          <span class="qz-stat-val" style="color:var(--amber)">+${xp}</span>
          <div class="qz-stat-lbl">‚ö° XP</div>
        </div>
      </div>

      ${reviewHtml}

      <div style="display:flex;flex-direction:column;gap:10px;margin-top:20px;max-width:320px;margin-left:auto;margin-right:auto">
        ${hasNext ? `
        <button class="btn btn-primary" style="font-size:15px;padding:14px" onclick="nextBatch()">
          ‚ñ∂ 5 t·ª´ ti·∫øp theo (${nextStart}‚Äì${nextEnd})
        </button>` : `
        <button class="btn btn-primary" style="font-size:15px;padding:14px" onclick="goTab('speaking')">
          üé§ Speaking ‚Üí
        </button>`}
        <button class="btn btn-outline" style="font-size:14px;padding:12px" onclick="restartBatch()">
          üîÑ L√†m l·∫°i ${wordCnt} t·ª´ n√†y
        </button>
        ${hasNext ? `
        <button class="btn btn-ghost btn-sm" onclick="goTab('speaking')">
          B·ªè qua ‚Üí Speaking
        </button>` : ''}
      </div>
    </div>`;
}

/* ‚îÄ‚îÄ Batch navigation ‚îÄ‚îÄ */
function nextBatch(){
  S.quiz = {
    questions:[], current:0, correct:0, wrong:0,
    lives:3, missed:[], batchIdx: ((S.quiz.batchIdx||0) + 1)
  };
  _saveQuizPosition();
  renderQuiz();
}
function restartBatch(){
  S.quiz = {
    questions:[], current:0, correct:0, wrong:0,
    lives:3, missed:[], batchIdx: S.quiz.batchIdx||0
  };
  _saveQuizPosition();
  renderQuiz();
}
function restartQuiz(){
  S.quiz = {questions:[],current:0,correct:0,wrong:0,lives:3,missed:[],batchIdx:0};
  _saveQuizPosition();
  renderQuiz();
}
function confirmExitQuiz(){
  openConfirm('üö™','Tho√°t b√†i t·∫≠p?','Ti·∫øn ƒë·ªô batch hi·ªán t·∫°i s·∫Ω kh√¥ng ƒë∆∞·ª£c l∆∞u.',()=>{ S.quiz={questions:[],current:0,correct:0,wrong:0,lives:3,missed:[],batchIdx:S.quiz.batchIdx||0}; goTab('flashcard'); });
}

/* ‚îÄ‚îÄ SPEAKING ‚îÄ‚îÄ */
let isRec=false,recog=null;
function renderSpeaking(){
  const words=S.study.words;const w=words[S.study.idx%words.length]||words[0];if(!w)return;
  document.getElementById('tab-speaking').innerHTML=`
    <div class="card" style="margin-bottom:14px">
      <div style="display:flex;gap:14px;align-items:flex-start">
        <div style="flex:1;min-width:0">
          <div class="speak-word-big">${w.word}</div>
          <div style="color:var(--ink3);font-style:italic;margin-bottom:10px">${w.ipa||''} ‚Äî ${w.meaning}</div>
          ${w.example?`<div class="speak-ex">"${w.example}"</div>`:''}
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <button class="audio-chip" onclick="speak('${esc(w.word)}')">üîä Ph√°t √¢m t·ª´</button>
            <button class="audio-chip" onclick="speak('${esc(w.example||w.word)}')">üîä Nghe c√¢u m·∫´u</button>
          </div>
        </div>
        ${(()=>{const _sp=_imgCache[w.word.toLowerCase().trim()]; return _sp ? `
        <div style="flex-shrink:0">
          <div style="width:100px;border-radius:10px;overflow:hidden;border:1.5px solid var(--border);background:var(--bg2);">
            <img id="sp-img" src="${_sp}" alt="${w.word}" loading="lazy"
              onerror="this.closest('div').style.display='none'"
              style="width:100%;height:auto;max-height:110px;display:block;object-fit:cover">
          </div>
        </div>` : '<div id="sp-img-slot" style="flex-shrink:0;width:0"></div>'; })()}
      </div>
    </div>
    <div class="rec-zone">
      <div style="font-size:14px;font-weight:600;color:var(--ink)">üé§ ƒê·ªçc to c√¢u v√≠ d·ª•</div>
      <button class="rec-ring" id="rec-btn" onclick="toggleRec()">üéôÔ∏è</button>
      <div class="waveform" id="waveform" style="display:none">${[1,2,3,4,5,6].map(()=>'<div class="wb"></div>').join('')}</div>
      <div id="rec-status" style="font-size:13px;color:var(--ink3)">Nh·∫•n ƒë·ªÉ ghi √¢m</div>
    </div>
    <div id="transcript-result" style="display:none" class="card">
      <div style="font-size:12px;font-weight:700;color:var(--ink3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px">üìù Nh·∫≠n d·∫°ng gi·ªçng n√≥i</div>
      <div class="transcript-box" id="transcript-text"></div>
      <div id="score-wrap" style="text-align:center;margin-top:14px"></div>
    </div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:14px;gap:8px">
      <button class="btn btn-outline btn-sm" onclick="prevSpeak()" ${S.study.idx===0?'disabled style="opacity:.35;cursor:not-allowed"':''}>‚Üê Tr∆∞·ªõc</button>
      <span style="font-size:13px;color:var(--ink3);font-weight:600">${S.study.idx+1} / ${words.length}</span>
      <button class="btn btn-outline btn-sm" onclick="nextSpeak()">${S.study.idx>=words.length-1?'üîÑ H·ªçc l·∫°i':'T·ª´ ti·∫øp ‚Üí'}</button>
    </div>`;

  // Fetch Pexels cho speaking n·∫øu ch∆∞a cache
  if(!(w.word.toLowerCase().trim() in _imgCache)){
    fetchWordImage(w.word, w.meaning||'', w.example||'').then(url=>{
      if(url){
        const slot = document.getElementById('sp-img-slot');
        if(slot){
          slot.style.width='100px';
          slot.innerHTML=`<div style="width:100px;border-radius:10px;overflow:hidden;border:1.5px solid var(--border);background:var(--bg2)"><img src="${url}" alt="${w.word}" style="width:100%;height:auto;max-height:110px;display:block;object-fit:cover"></div>`;
        }
        const vw=S.vocab.find(x=>x.id===w.id); if(vw){vw.imageUrl=url;save();}
      }
    });
  }
}
function toggleRec(){isRec?stopRec():startRec();}
function startRec(){
  isRec=true;document.getElementById('rec-btn').classList.add('recording');document.getElementById('rec-btn').textContent='‚èπÔ∏è';
  document.getElementById('rec-status').textContent='ƒêang nghe... ƒë·ªçc to c√¢u v√≠ d·ª•';document.getElementById('waveform').style.display='flex';document.getElementById('transcript-result').style.display='none';
  if('webkitSpeechRecognition' in window||'SpeechRecognition' in window){
    const SR=window.SpeechRecognition||window.webkitSpeechRecognition;recog=new SR();recog.lang='en-US';recog.interimResults=true;
    recog.onresult=e=>{const t=Array.from(e.results).map(r=>r[0].transcript).join('');document.getElementById('transcript-text').textContent=t;document.getElementById('transcript-result').style.display='block';};
    recog.onend=()=>{if(isRec)scoreRec();};recog.start();
  }else{showToast('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ghi √¢m','error');isRec=false;}
}
function stopRec(){isRec=false;document.getElementById('rec-btn').classList.remove('recording');document.getElementById('rec-btn').textContent='üéôÔ∏è';document.getElementById('waveform').style.display='none';document.getElementById('rec-status').textContent='ƒêang x·ª≠ l√Ω...';if(recog)recog.stop();setTimeout(scoreRec,400);}
function scoreRec(){
  const words=S.study.words;const w=words[S.study.idx%words.length]||words[0];
  const transcript=(document.getElementById('transcript-text')||{}).textContent||'';
  if(!transcript){document.getElementById('rec-status').textContent='Kh√¥ng nghe ƒë∆∞·ª£c ‚Äî th·ª≠ l·∫°i!';return;}
  const target=(w.example||w.word).toLowerCase().replace(/[^a-z\s]/g,'').split(' ');
  const said=transcript.toLowerCase().replace(/[^a-z\s]/g,'').split(' ');
  const matched=target.filter(t=>said.some(s=>s.includes(t.slice(0,4))));
  const score=Math.min(100,Math.round(matched.length/target.length*100));
  document.getElementById('rec-status').textContent='Xong!';
  const clr=score>=70?'var(--teal)':score>=40?'var(--amber)':'var(--rose)';
  document.getElementById('score-wrap').innerHTML=`<div style="font-family:var(--font-d);font-size:44px;font-weight:900;color:${clr}">${score}%</div><div style="font-size:13px;color:var(--ink3);margin-top:2px">${score>=70?'üåü Ph√°t √¢m t·ªët!':score>=40?'üëç Luy·ªán th√™m nh√©':'üí™ Th·ª≠ l·∫°i!'}</div>`;
  document.getElementById('transcript-result').style.display='block';
  if(score>=60)gainXP(20);
  _saveSpkPosition();
  save();
}
function nextSpeak(){
  const words=S.study.words;
  if(S.study.idx < words.length-1){
    S.study.idx++;
  } else {
    S.study.idx=0; // wrap around
  }
  _saveSpkPosition();
  renderSpeaking();
}
function prevSpeak(){
  if(S.study.idx > 0){
    S.study.idx--;
    _saveSpkPosition();
    renderSpeaking();
  }
}
/* ‚îÄ‚îÄ L∆∞u v·ªã tr√≠ Speaking ngay l·∫≠p t·ª©c ‚îÄ‚îÄ */
function _saveSpkPosition(){
  try{
    const raw = localStorage.getItem(_sessionKey());
    const sess = raw ? JSON.parse(raw) : {};
    sess.currentTopic  = S.currentTopic;
    sess.panel         = 'study';
    sess.studyTab      = 'speaking';
    sess.speakingIdx   = S.study.idx;
    localStorage.setItem(_sessionKey(), JSON.stringify(sess));
  }catch(e){}
  save();
}

/* ‚îÄ‚îÄ VOCAB LIST ‚îÄ‚îÄ */
let _selectedIds = new Set();
let _visibleWords = [];
let _vocabPage = 1;
const VOCAB_PAGE_SIZE = 50;

function renderVocabList(){
  updTopicFilter();
  _selectedIds.clear();
  _vocabPage = 1;
  filterVocab('');
}

function updTopicFilter(){
  const topicsFromVocab = S.vocab.map(v => v.topic);
  const topicsFromObj = Object.keys(S.topics || {});
  const allTopics = [...new Set([...topicsFromVocab, ...topicsFromObj])].sort();
  const currentVal = document.getElementById('topic-filter')?.value || '';
  document.getElementById('topic-filter').innerHTML =
    `<option value="">üìÇ T·∫•t c·∫£ ch·ªß ƒë·ªÅ (${allTopics.length})</option>` +
    allTopics.map(t => {
      const rule = TOPIC_RULES.find(r => r.name === t);
      const emoji = rule?.emoji || 'üìå';
      const cnt = S.vocab.filter(v => v.topic === t).length;
      return `<option value="${t}" ${currentVal===t?'selected':''}>${emoji} ${t} (${cnt})</option>`;
    }).join('');
  ['topic-datalist','topic-datalist2'].forEach(id => {
    const dl = document.getElementById(id);
    if(dl) dl.innerHTML = allTopics.map(t => `<option value="${t}">`).join('');
  });
}

function filterVocab(search){
  const topic = document.getElementById('topic-filter')?.value || '';
  const starred = document.getElementById('starred-only')?.checked || false;
  let words = S.vocab;
  if(search) words = words.filter(w =>
    w.word.toLowerCase().includes(search.toLowerCase()) ||
    w.meaning.toLowerCase().includes(search.toLowerCase()) ||
    (w.example||'').toLowerCase().includes(search.toLowerCase())
  );
  if(topic) words = words.filter(w => w.topic === topic);
  if(starred) words = words.filter(w => w.starred);
  _visibleWords = words;
  // Reset to page 1 when filter changes
  _vocabPage = 1;
  renderVocabPage();
}

function renderVocabPage(){
  const words = _visibleWords;
  const tbody = document.getElementById('vocab-tbody');
  const empty = document.getElementById('vocab-empty');
  const footer = document.getElementById('vocab-footer');
  const footerCount = document.getElementById('vocab-footer-count');
  const footerTotal = document.getElementById('vocab-footer-total');
  const sub = document.getElementById('vocab-count-sub');
  const paginationEl = document.getElementById('vocab-pagination');
  const total = S.vocab.length;

  sub.textContent = `T·ªïng c·ªông ${total} t·ª´ v·ª±ng ¬∑ ${Object.keys(getTopics()).length} ch·ªß ƒë·ªÅ`;

  if(!words.length){
    tbody.innerHTML = '';
    empty.style.display = 'block';
    footer.style.display = 'none';
    paginationEl.style.display = 'none';
    _selectedIds.clear();
    updBulkToolbar();
    return;
  }

  empty.style.display = 'none';
  footer.style.display = 'flex';

  // Pagination calc
  const totalPages = Math.ceil(words.length / VOCAB_PAGE_SIZE);
  _vocabPage = Math.max(1, Math.min(_vocabPage, totalPages));
  const start = (_vocabPage - 1) * VOCAB_PAGE_SIZE;
  const pageWords = words.slice(start, start + VOCAB_PAGE_SIZE);

  // Footer
  footerCount.textContent = words.length < total
    ? `Hi·ªÉn th·ªã ${words.length} / ${total} t·ª´ ¬∑ Trang ${_vocabPage}/${totalPages}`
    : `Trang ${_vocabPage}/${totalPages} ¬∑ T·ªïng: ${total} t·ª´`;
  const learnedCount = S.vocab.filter(v => v.learned).length;
  footerTotal.textContent = `‚úÖ ${learnedCount} ƒë√£ h·ªçc ¬∑ ‚≠ê ${S.vocab.filter(v=>v.starred).length} ƒë√°nh d·∫•u`;

  // Get all topics for inline select
  const allTopics = [...new Set([...S.vocab.map(v=>v.topic), ...Object.keys(S.topics||{})])].sort();

  tbody.innerHTML = pageWords.map(w => {
    const checked = _selectedIds.has(String(w.id));
    const rule = TOPIC_RULES.find(r => r.name === w.topic);
    const emoji = rule?.emoji || 'üìå';
    const topicOpts = allTopics.map(t =>
      `<option value="${t}" ${t===w.topic?'selected':''}>${t}</option>`
    ).join('');
    return `<tr class="${checked?'row-selected':''}" id="row-${w.id}">
      <td style="width:36px;text-align:center">
        <input type="checkbox" class="row-check" data-id="${w.id}" onchange="toggleRowCheck(this)" ${checked?'checked':''}
          style="accent-color:var(--teal);width:15px;height:15px;cursor:pointer">
      </td>
      <td class="td-word"><button class="act-btn ${w.starred?'act-star on':'act-star'}" onclick="toggleStar('${w.id}')">${w.starred?'‚òÖ':'‚òÜ'}</button></td>
      <td class="td-word vt-word">${w.word}</td>
      <td class="td-ipa vt-ipa">${w.ipa||'‚Äî'}</td>
      <td class="td-meaning" style="font-size:14px">${w.meaning}</td>
      <td class="td-example" style="font-style:italic;color:var(--ink3);font-size:13px">${w.example||'‚Äî'}</td>
      <td class="td-topic">
        <select class="topic-select-inline" onchange="changeWordTopic('${w.id}',this.value)" title="ƒê·ªïi ch·ªß ƒë·ªÅ">${topicOpts}</select>
      </td>
      <td class="td-actions">
        <div style="display:flex;gap:4px;justify-content:center">
          <button class="act-btn act-edit" title="S·ª≠a" onclick="openEditWordModal('${w.id}')">‚úèÔ∏è</button>
          <button class="act-btn" title="Nghe" onclick="speak('${esc(w.word)}')" style="color:var(--ink3);font-size:13px">üîä</button>
          <button class="act-btn act-del" title="X√≥a" onclick="confirmDeleteWord('${w.id}')">üóë</button>
        </div>
      </td>
    </tr>`;
  }).join('');

  // Render pagination
  renderPagination(totalPages, paginationEl);
  syncCheckAll();
}

function renderPagination(totalPages, el){
  if(totalPages <= 1){ el.style.display='none'; return; }
  el.style.display = 'flex';
  const p = _vocabPage;
  let html = `<button class="pg-btn" onclick="goVocabPage(1)" ${p===1?'disabled':''}>¬´</button>
    <button class="pg-btn" onclick="goVocabPage(${p-1})" ${p===1?'disabled':''}>‚Äπ</button>`;
  // Page numbers with ellipsis
  const pages = [];
  for(let i=1;i<=totalPages;i++){
    if(i===1||i===totalPages||Math.abs(i-p)<=2) pages.push(i);
    else if(pages[pages.length-1]!=='...') pages.push('...');
  }
  pages.forEach(pg => {
    if(pg==='...') html+=`<span class="pg-info">‚Ä¶</span>`;
    else html+=`<button class="pg-btn ${pg===p?'active':''}" onclick="goVocabPage(${pg})">${pg}</button>`;
  });
  html+=`<button class="pg-btn" onclick="goVocabPage(${p+1})" ${p===totalPages?'disabled':''}>‚Ä∫</button>
    <button class="pg-btn" onclick="goVocabPage(${totalPages})" ${p===totalPages?'disabled':''}>¬ª</button>`;
  el.innerHTML = html;
}

function goVocabPage(page){
  _vocabPage = page;
  renderVocabPage();
  // Scroll vocab table into view
  document.getElementById('vocab-tbody')?.closest('.card')?.scrollIntoView({behavior:'smooth',block:'start'});
}

function changeWordTopic(id, newTopic){
  const w = S.vocab.find(v => String(v.id) === String(id));
  if(!w) return;
  const oldTopic = w.topic;
  w.topic = newTopic;
  if(!S.topics) S.topics={};
  if(!S.topics[newTopic]){ const rule=TOPIC_RULES.find(r=>r.name===newTopic); S.topics[newTopic]={desc:rule?.desc||''}; }
  save();
  renderTopics();
  updTopicFilter();
  showToast(`‚úÖ ƒê√£ chuy·ªÉn "${w.word}" ‚Üí ${newTopic}`);
}

function toggleRowCheck(cb){
  const id = String(cb.dataset.id);
  if(cb.checked) _selectedIds.add(id);
  else _selectedIds.delete(id);
  const row = document.getElementById('row-'+id);
  if(row) row.classList.toggle('row-selected', cb.checked);
  syncCheckAll();
  updBulkToolbar();
}

function toggleCheckAll(masterCb){
  // Only affect visible page words
  const pageStart = (_vocabPage-1)*VOCAB_PAGE_SIZE;
  const pageWords = _visibleWords.slice(pageStart, pageStart+VOCAB_PAGE_SIZE);
  pageWords.forEach(w => {
    const id = String(w.id);
    if(masterCb.checked) _selectedIds.add(id);
    else _selectedIds.delete(id);
    const cb = document.querySelector(`.row-check[data-id="${id}"]`);
    if(cb) cb.checked = masterCb.checked;
    const row = document.getElementById('row-'+id);
    if(row) row.classList.toggle('row-selected', masterCb.checked);
  });
  updBulkToolbar();
}

function syncCheckAll(){
  const masterCb = document.getElementById('check-all');
  if(!masterCb) return;
  const pageStart = (_vocabPage-1)*VOCAB_PAGE_SIZE;
  const pageIds = _visibleWords.slice(pageStart, pageStart+VOCAB_PAGE_SIZE).map(w=>String(w.id));
  const allChecked = pageIds.length>0 && pageIds.every(id=>_selectedIds.has(id));
  const someChecked = pageIds.some(id=>_selectedIds.has(id));
  masterCb.checked = allChecked;
  masterCb.indeterminate = someChecked && !allChecked;
}

function selectAllVisible(){
  _visibleWords.forEach(w => {
    const id = String(w.id); _selectedIds.add(id);
    const cb = document.querySelector(`.row-check[data-id="${id}"]`);
    if(cb) cb.checked = true;
    const row = document.getElementById('row-'+id);
    if(row) row.classList.add('row-selected');
  });
  syncCheckAll(); updBulkToolbar();
}

function clearSelection(){
  _selectedIds.clear();
  document.querySelectorAll('.row-check').forEach(cb=>{cb.checked=false;});
  document.querySelectorAll('.row-selected').forEach(row=>row.classList.remove('row-selected'));
  syncCheckAll(); updBulkToolbar();
}

function updBulkToolbar(){
  const toolbar = document.getElementById('bulk-toolbar');
  const n = _selectedIds.size;
  if(n>0){
    toolbar.style.display='flex';
    document.getElementById('bulk-count').textContent=`${n} t·ª´ ƒë∆∞·ª£c ch·ªçn`;
    document.getElementById('bulk-del-count').textContent=n;
  } else { toolbar.style.display='none'; }
}

function confirmDeleteSelected(){
  const n = _selectedIds.size; if(!n) return;
  const ids = [..._selectedIds];
  const words = ids.map(id=>S.vocab.find(v=>String(v.id)===id)).filter(Boolean);
  const names = words.slice(0,5).map(w=>`<strong>${w.word}</strong>`).join(', ');
  const more = words.length>5?` v√† ${words.length-5} t·ª´ kh√°c`:'';
  openConfirm('üóëÔ∏è',`X√≥a ${n} t·ª´ v·ª±ng`,
    `B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ${names}${more}?<br><span style="color:var(--rose);font-size:12px">H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.</span>`,
    function(){
      S.vocab = S.vocab.filter(v=>!ids.includes(String(v.id)));
      _selectedIds.clear();
      save(); renderTopics(); updTopicFilter();
      filterVocab(document.getElementById('vocab-search')?.value||'');
      showToast(`üóë ƒê√£ x√≥a ${n} t·ª´ v·ª±ng`);
    }
  );
}

function toggleStar(id){
  const w=S.vocab.find(v=>v.id==id);
  if(w){w.starred=!w.starred;save();renderVocabPage();}
}

/* ‚îÄ‚îÄ IMPORT ‚îÄ‚îÄ */
function handleDrag(e,en){e.preventDefault();document.getElementById('drop-zone').classList.toggle('drag',en);}
function handleDrop(e){e.preventDefault();handleDrag(e,false);const f=e.dataTransfer.files[0];if(f)processFile(f);}
function handleFile(e){
  const f=e.target.files[0];
  if(!f) return;
  // L∆∞u t√™n file v√†o DOM ƒë·ªÉ d√πng khi confirmImport
  const dzTitle=document.querySelector('#drop-zone .dz-title');
  if(dzTitle){ dzTitle.dataset.filename=f.name; dzTitle.textContent=f.name; }
  // C·∫≠p nh·∫≠t topic select v·ªõi ch·ªß ƒë·ªÅ hi·ªán c√≥
  populateImpTopicSelect();
  processFile(f);
}
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SMART TOPIC CLASSIFICATION ENGINE
   15+ topics, multi-layer scoring:
   word + Vietnamese meaning + example sentence
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const TOPIC_RULES = [
  { name:'Work & Office', emoji:'üíº', desc:'M√¥i tr∆∞·ªùng c√¥ng s·ªü, ngh·ªÅ nghi·ªáp',
    en:/\b(work|job|office|business|career|employ|manage|boss|colleague|meeting|deadline|project|report|salary|resign|hire|client|company|profession|corporate|staff|team|budget|negotiate|contract|promote|task|productivity|efficient|schedule|email|present|depart|department|headquarter|invest|revenue|profit|market|brand|strategy|executive|manag)\b/i,
    vi:/c√¥ng vi·ªác|vƒÉn ph√≤ng|kinh doanh|ngh·ªÅ nghi·ªáp|nh√¢n vi√™n|qu·∫£n l√Ω|s·∫øp|ƒë·ªìng nghi·ªáp|h·ªçp|d·ª± √°n|b√°o c√°o|l∆∞∆°ng|th√¥i vi·ªác|tuy·ªÉn d·ª•ng|kh√°ch h√†ng|c√¥ng ty|chuy√™n nghi·ªáp|ng√¢n s√°ch|th∆∞∆°ng l∆∞·ª£ng|h·ª£p ƒë·ªìng|thƒÉng ch·ª©c|nƒÉng su·∫•t|l·ªãch tr√¨nh|email|thuy·∫øt tr√¨nh|chi·∫øn l∆∞·ª£c|doanh thu|l·ª£i nhu·∫≠n|th∆∞∆°ng hi·ªáu/ },
  { name:'Travel & Tourism', emoji:'‚úàÔ∏è', desc:'Du l·ªãch, kh√°ch s·∫°n, ph∆∞∆°ng ti·ªán',
    en:/\b(travel|trip|tour|hotel|flight|airport|passport|visa|tourist|destination|journey|voyage|sightseeing|accommodation|booking|reservation|luggage|baggage|itinerary|cruise|resort|hostel|check.?in|check.?out|transit|transfer|depart|arriv|board|customs|immigration|souvenir|landmark|guide|excursion|backpack|adventure|explore)\b/i,
    vi:/du l·ªãch|chuy·∫øn ƒëi|kh√°ch s·∫°n|s√¢n bay|h·ªô chi·∫øu|visa|ƒëi·ªÉm ƒë·∫øn|h√†nh l√Ω|ƒë·∫∑t ph√≤ng|tham quan|ƒë·∫∑t v√©|h√†nh tr√¨nh|c·∫£ng bi·ªÉn|khu ngh·ªâ d∆∞·ª°ng|nh·∫≠n ph√≤ng|tr·∫£ ph√≤ng|qu√° c·∫£nh|h·∫£i quan|nh·∫≠p c·∫£nh|qu√† l∆∞u ni·ªám|h∆∞·ªõng d·∫´n vi√™n|phi√™u l∆∞u|kh√°m ph√°|tham quan/ },
  { name:'Food & Dining', emoji:'üçΩÔ∏è', desc:'·∫®m th·ª±c, nh√† h√†ng, n·∫•u ƒÉn',
    en:/\b(food|eat|cook|restaurant|meal|dish|recipe|ingredient|flavor|taste|delicious|cuisine|appetizer|dessert|beverage|drink|chef|menu|order|serve|breakfast|lunch|dinner|snack|vegetarian|spicy|sweet|sour|bitter|salty|grill|bake|boil|fry|roast|season|portion|buffet|takeaway|delivery)\b/i,
    vi:/ƒÉn|n·∫•u|nh√† h√†ng|b·ªØa ƒÉn|m√≥n ƒÉn|c√¥ng th·ª©c|nguy√™n li·ªáu|h∆∞∆°ng v·ªã|th∆°m ngon|·∫©m th·ª±c|khai v·ªã|tr√°ng mi·ªáng|ƒë·ªì u·ªëng|ƒë·∫ßu b·∫øp|th·ª±c ƒë∆°n|g·ªçi m√≥n|ph·ª•c v·ª•|b·ªØa s√°ng|b·ªØa tr∆∞a|b·ªØa t·ªëi|ƒÉn v·∫∑t|chay|cay|ng·ªçt|chua|ƒë·∫Øng|m·∫∑n|n∆∞·ªõng|h·∫•p|chi√™n|rang|rang|kh·∫©u ph·∫ßn|t·ª± ch·ªçn|giao h√†ng/ },
  { name:'Technology', emoji:'üíª', desc:'C√¥ng ngh·ªá, m√°y t√≠nh, ph·∫ßn m·ªÅm',
    en:/\b(technology|tech|computer|software|hardware|internet|digital|app|application|device|smartphone|laptop|tablet|program|code|data|network|server|cloud|database|algorithm|artificial|intelligence|AI|machine|learning|cyber|security|hack|encrypt|update|download|upload|interface|browser|website|platform|social.?media|stream|wireless|bluetooth|processor|memory|storage|pixel|screen|battery)\b/i,
    vi:/c√¥ng ngh·ªá|m√°y t√≠nh|ph·∫ßn m·ªÅm|ph·∫ßn c·ª©ng|internet|k·ªπ thu·∫≠t s·ªë|·ª©ng d·ª•ng|thi·∫øt b·ªã|ƒëi·ªán tho·∫°i|laptop|m√°y t√≠nh b·∫£ng|l·∫≠p tr√¨nh|d·ªØ li·ªáu|m·∫°ng|m√°y ch·ªß|ƒë√°m m√¢y|c∆° s·ªü d·ªØ li·ªáu|thu·∫≠t to√°n|tr√≠ tu·ªá nh√¢n t·∫°o|b·∫£o m·∫≠t|t·∫£i xu·ªëng|t·∫£i l√™n|giao di·ªán|tr√¨nh duy·ªát|trang web|n·ªÅn t·∫£ng|m·∫°ng x√£ h·ªôi|kh√¥ng d√¢y|b·ªô nh·ªõ|m√†n h√¨nh|pin/ },
  { name:'Health & Medical', emoji:'üè•', desc:'S·ª©c kh·ªèe, y t·∫ø, b·ªánh vi·ªán',
    en:/\b(health|medical|doctor|hospital|patient|disease|illness|symptom|treatment|medicine|drug|vaccine|surgery|diagnosis|prescription|pharmacy|nurse|clinic|therapy|mental|physical|exercise|diet|nutrition|vitamin|immune|infection|virus|bacteria|cancer|diabetes|blood|pressure|heart|lung|brain|bone|muscle|pain|fever|cough|wound|heal|recover|prevent)\b/i,
    vi:/s·ª©c kh·ªèe|y t·∫ø|b√°c sƒ©|b·ªánh vi·ªán|b·ªánh nh√¢n|b·ªánh|tri·ªáu ch·ª©ng|ƒëi·ªÅu tr·ªã|thu·ªëc|vaccine|ph·∫´u thu·∫≠t|ch·∫©n ƒëo√°n|ƒë∆°n thu·ªëc|nh√† thu·ªëc|y t√°|ph√≤ng kh√°m|tr·ªã li·ªáu|t√¢m l√Ω|th·ªÉ ch·∫•t|t·∫≠p th·ªÉ d·ª•c|ch·∫ø ƒë·ªô ƒÉn|dinh d∆∞·ª°ng|vitamin|mi·ªÖn d·ªãch|nhi·ªÖm tr√πng|virus|vi khu·∫©n|ung th∆∞|ti·ªÉu ƒë∆∞·ªùng|m√°u|tim|ph·ªïi|n√£o|x∆∞∆°ng|c∆°|ƒëau|s·ªët|ho|v·∫øt th∆∞∆°ng|h·ªìi ph·ª•c|ph√≤ng ng·ª´a/ },
  { name:'Education', emoji:'üìö', desc:'H·ªçc t·∫≠p, tr∆∞·ªùng h·ªçc, ki·∫øn th·ª©c',
    en:/\b(education|school|study|learn|student|teacher|class|lesson|lecture|university|college|graduate|degree|exam|test|homework|assignment|curriculum|subject|course|knowledge|skill|read|write|research|library|scholar|academic|professor|tutor|enroll|attend|grade|certificate|diploma|scholarship)\b/i,
    vi:/gi√°o d·ª•c|tr∆∞·ªùng h·ªçc|h·ªçc t·∫≠p|h·ªçc sinh|sinh vi√™n|gi√°o vi√™n|l·ªõp h·ªçc|b√†i h·ªçc|b√†i gi·∫£ng|ƒë·∫°i h·ªçc|cao ƒë·∫≥ng|t·ªët nghi·ªáp|b·∫±ng c·∫•p|k·ª≥ thi|b√†i t·∫≠p|ch∆∞∆°ng tr√¨nh h·ªçc|m√¥n h·ªçc|kh√≥a h·ªçc|ki·∫øn th·ª©c|k·ªπ nƒÉng|ƒë·ªçc|vi·∫øt|nghi√™n c·ª©u|th∆∞ vi·ªán|h·ªçc thu·∫≠t|gi√°o s∆∞|gia s∆∞|ghi danh|ƒëi·ªÉm s·ªë|ch·ª©ng ch·ªâ|h·ªçc b·ªïng/ },
  { name:'Environment & Nature', emoji:'üåø', desc:'M√¥i tr∆∞·ªùng, thi√™n nhi√™n, kh√≠ h·∫≠u',
    en:/\b(environment|nature|ecology|climate|weather|forest|ocean|river|mountain|animal|plant|species|biodiversity|pollution|recycle|sustainable|renewable|energy|solar|wind|carbon|emission|greenhouse|global.?warm|deforest|conservation|wildlife|habitat|ecosystem|natural|earth|planet|atmosphere|temperature|storm|flood|drought|earthquake)\b/i,
    vi:/m√¥i tr∆∞·ªùng|thi√™n nhi√™n|sinh th√°i|kh√≠ h·∫≠u|th·ªùi ti·∫øt|r·ª´ng|ƒë·∫°i d∆∞∆°ng|s√¥ng|n√∫i|ƒë·ªông v·∫≠t|th·ª±c v·∫≠t|lo√†i|ƒëa d·∫°ng sinh h·ªçc|√¥ nhi·ªÖm|t√°i ch·∫ø|b·ªÅn v·ªØng|nƒÉng l∆∞·ª£ng t√°i t·∫°o|nƒÉng l∆∞·ª£ng m·∫∑t tr·ªùi|kh√≠ th·∫£i|hi·ªáu ·ª©ng nh√† k√≠nh|n√≥ng l√™n to√†n c·∫ßu|ph√° r·ª´ng|b·∫£o t·ªìn|ƒë·ªông v·∫≠t hoang d√£|h·ªá sinh th√°i|tr√°i ƒë·∫•t|b·∫ßu kh√≠ quy·ªÉn|nhi·ªát ƒë·ªô|b√£o|l≈© l·ª•t|h·∫°n h√°n|ƒë·ªông ƒë·∫•t/ },
  { name:'Sports & Fitness', emoji:'‚öΩ', desc:'Th·ªÉ thao, v·∫≠n ƒë·ªông, thi ƒë·∫•u',
    en:/\b(sport|fitness|exercise|run|swim|play|game|match|competition|champion|athlete|train|coach|team|score|goal|win|lose|tournament|league|stadium|gym|workout|yoga|cycling|basketball|football|soccer|tennis|golf|boxing|martial|muscle|strength|endurance|sprint|jump|throw|kick|tackle)\b/i,
    vi:/th·ªÉ thao|th·ªÉ d·ª•c|v·∫≠n ƒë·ªông|ch·∫°y|b∆°i|ch∆°i|tr·∫≠n ƒë·∫•u|thi ƒë·∫•u|v√¥ ƒë·ªãch|v·∫≠n ƒë·ªông vi√™n|hu·∫•n luy·ªán|hu·∫•n luy·ªán vi√™n|ƒë·ªôi|ƒëi·ªÉm s·ªë|b√†n th·∫Øng|th·∫Øng|thua|gi·∫£i ƒë·∫•u|s√¢n v·∫≠n ƒë·ªông|ph√≤ng gym|yoga|ƒë·∫°p xe|b√≥ng r·ªï|b√≥ng ƒë√°|qu·∫ßn v·ª£t|golf|ƒë·∫•m b·ªëc|c∆° b·∫Øp|s·ª©c m·∫°nh|s·ª©c b·ªÅn/ },
  { name:'Arts & Entertainment', emoji:'üé®', desc:'Ngh·ªá thu·∫≠t, gi·∫£i tr√≠, vƒÉn h√≥a',
    en:/\b(art|music|movie|film|theater|dance|paint|draw|sculpt|photograph|literature|novel|poem|story|concert|perform|actor|singer|artist|creative|culture|gallery|museum|exhibition|festival|fashion|design|animation|cartoon|drama|comedy|romance|horror|award|celebrity|entertain|media|show|episode|series)\b/i,
    vi:/ngh·ªá thu·∫≠t|√¢m nh·∫°c|phim|r·∫°p chi·∫øu phim|nh√† h√°t|m√∫a|v·∫Ω|nhi·∫øp ·∫£nh|vƒÉn h·ªçc|ti·ªÉu thuy·∫øt|th∆°|c√¢u chuy·ªán|bu·ªïi h√≤a nh·∫°c|bi·ªÉu di·ªÖn|di·ªÖn vi√™n|ca sƒ©|ngh·ªá sƒ©|s√°ng t·∫°o|vƒÉn h√≥a|b·∫£o t√†ng|tri·ªÉn l√£m|l·ªÖ h·ªôi|th·ªùi trang|thi·∫øt k·∫ø|ho·∫°t h√¨nh|phim truy·ªÅn h√¨nh|h√†i k·ªãch|l√£ng m·∫°n|kinh d·ªã|gi·∫£i th∆∞·ªüng|gi·∫£i tr√≠/ },
  { name:'Finance & Economy', emoji:'üí∞', desc:'T√†i ch√≠nh, kinh t·∫ø, ƒë·∫ßu t∆∞',
    en:/\b(finance|money|bank|invest|stock|market|economy|trade|currency|exchange|loan|credit|debt|budget|tax|income|profit|loss|asset|liability|fund|portfolio|dividend|interest|inflation|recession|GDP|wealth|poverty|insurance|mortgage|transaction|payment|deposit|withdraw|account|capital)\b/i,
    vi:/t√†i ch√≠nh|ti·ªÅn|ng√¢n h√†ng|ƒë·∫ßu t∆∞|c·ªï phi·∫øu|th·ªã tr∆∞·ªùng|kinh t·∫ø|th∆∞∆°ng m·∫°i|ti·ªÅn t·ªá|trao ƒë·ªïi|vay|t√≠n d·ª•ng|n·ª£|ng√¢n s√°ch|thu·∫ø|thu nh·∫≠p|l·ª£i nhu·∫≠n|thua l·ªó|t√†i s·∫£n|qu·ªπ|c·ªï t·ª©c|l√£i su·∫•t|l·∫°m ph√°t|suy tho√°i|gi√†u c√≥|ngh√®o ƒë√≥i|b·∫£o hi·ªÉm|vay th·∫ø ch·∫•p|giao d·ªãch|thanh to√°n|ti·ªÅn g·ª≠i|r√∫t ti·ªÅn/ },
  { name:'Science & Research', emoji:'üî¨', desc:'Khoa h·ªçc, nghi√™n c·ª©u, th√≠ nghi·ªám',
    en:/\b(science|research|experiment|theory|hypothesis|evidence|analyze|discover|invent|physics|chemistry|biology|astronomy|geology|evolution|gene|DNA|cell|atom|molecule|element|compound|reaction|force|energy|gravity|light|sound|radiation|laboratory|microscope|telescope|publish|journal|scientist|breakthrough)\b/i,
    vi:/khoa h·ªçc|nghi√™n c·ª©u|th√≠ nghi·ªám|l√Ω thuy·∫øt|gi·∫£ thuy·∫øt|b·∫±ng ch·ª©ng|ph√¢n t√≠ch|kh√°m ph√°|ph√°t minh|v·∫≠t l√Ω|h√≥a h·ªçc|sinh h·ªçc|thi√™n vƒÉn h·ªçc|ƒë·ªãa ch·∫•t|ti·∫øn h√≥a|gen|AND|t·∫ø b√†o|nguy√™n t·ª≠|ph√¢n t·ª≠|nguy√™n t·ªë|ph·∫£n ·ª©ng|l·ª±c|nƒÉng l∆∞·ª£ng|tr·ªçng l·ª±c|√°nh s√°ng|√¢m thanh|ph√≥ng x·∫°|ph√≤ng th√≠ nghi·ªám|nh√† khoa h·ªçc/ },
  { name:'Law & Politics', emoji:'‚öñÔ∏è', desc:'Ph√°p lu·∫≠t, ch√≠nh tr·ªã, x√£ h·ªôi',
    en:/\b(law|legal|court|judge|lawyer|attorney|crime|criminal|police|arrest|trial|verdict|sentence|constitution|right|freedom|democracy|government|election|vote|parliament|policy|regulation|rule|justice|civil|human.?right|citizen|nation|state|president|minister|congress|senate|treaty|sanction|rebel|protest|diplomacy)\b/i,
    vi:/ph√°p lu·∫≠t|t√≤a √°n|th·∫©m ph√°n|lu·∫≠t s∆∞|t·ªôi ph·∫°m|c·∫£nh s√°t|b·∫Øt gi·ªØ|phi√™n t√≤a|ph√°n quy·∫øt|hi·∫øn ph√°p|quy·ªÅn|t·ª± do|d√¢n ch·ªß|ch√≠nh ph·ªß|b·∫ßu c·ª≠|b·ªè phi·∫øu|qu·ªëc h·ªôi|ch√≠nh s√°ch|quy ƒë·ªãnh|c√¥ng l√Ω|d√¢n s·ª±|nh√¢n quy·ªÅn|c√¥ng d√¢n|t·ªïng th·ªëng|b·ªô tr∆∞·ªüng|hi·ªáp ∆∞·ªõc|tr·ª´ng ph·∫°t|bi·ªÉu t√¨nh|ngo·∫°i giao/ },
  { name:'Emotions & Psychology', emoji:'üß†', desc:'C·∫£m x√∫c, t√¢m l√Ω, h√†nh vi',
    en:/\b(emotion|feeling|mood|happy|sad|angry|fear|anxiety|stress|depression|joy|love|hate|envy|jealous|proud|shame|guilt|empath|compassion|motivat|confidence|personality|behavior|habit|attitude|perception|memory|dream|consciousness|subconscious|trauma|therapy|mental|psycholog|self.?esteem|lonely|grief|comfort|trust|insecurity|satisfaction)\b/i,
    vi:/c·∫£m x√∫c|c·∫£m gi√°c|t√¢m tr·∫°ng|h·∫°nh ph√∫c|bu·ªìn|t·ª©c gi·∫≠n|s·ª£ h√£i|lo l·∫Øng|cƒÉng th·∫≥ng|tr·∫ßm c·∫£m|ni·ªÅm vui|t√¨nh y√™u|gh√©t|ƒë·ªë k·ªµ|ghen tu√¥ng|t·ª± h√†o|x·∫•u h·ªï|t·ªôi l·ªói|ƒë·ªìng c·∫£m|l√≤ng tr·∫Øc ·∫©n|ƒë·ªông l·ª±c|t·ª± tin|t√≠nh c√°ch|h√†nh vi|th√≥i quen|th√°i ƒë·ªô|nh·∫≠n th·ª©c|k√Ω ·ª©c|gi·∫•c m∆°|√Ω th·ª©c|ch·∫•n th∆∞∆°ng t√¢m l√Ω|tr·ªã li·ªáu|t√¢m l√Ω h·ªçc|c√¥ ƒë∆°n|ƒëau bu·ªìn|tin t∆∞·ªüng/ },
  { name:'Daily Life', emoji:'üè†', desc:'Cu·ªôc s·ªëng h√†ng ng√†y, gia ƒë√¨nh, x√£ h·ªôi',
    en:/\b(daily|everyday|routine|home|house|family|friend|relationship|neighbor|community|shop|buy|sell|price|pay|rent|own|clean|wash|cook|sleep|wake|dress|commute|drive|walk|transport|weather|season|holiday|weekend|morning|evening|night|personal|social|activity|habit|free.?time|hobby|relax)\b/i,
    vi:/h√†ng ng√†y|th∆∞·ªùng ng√†y|th√≥i quen|nh√†|gia ƒë√¨nh|b·∫°n b√®|m·ªëi quan h·ªá|h√†ng x√≥m|c·ªông ƒë·ªìng|mua s·∫Øm|mua|b√°n|gi√°|tr·∫£ ti·ªÅn|thu√™|s·ªü h·ªØu|d·ªçn d·∫πp|gi·∫∑t|n·∫•u ƒÉn|ng·ªß|th·ª©c d·∫≠y|m·∫∑c qu·∫ßn √°o|ƒëi l√†m|l√°i xe|ƒëi b·ªô|ph∆∞∆°ng ti·ªán|th·ªùi ti·∫øt|m√πa|ng√†y l·ªÖ|cu·ªëi tu·∫ßn|bu·ªïi s√°ng|bu·ªïi t·ªëi|c√° nh√¢n|x√£ h·ªôi|ho·∫°t ƒë·ªông|gi·∫£i tr√≠/ },
];

function smartClassifyTopic(word, meaning='', example='') {
  const corpus = (word + ' ' + meaning + ' ' + example).toLowerCase();
  const viCorpus = (meaning + ' ' + example).toLowerCase();
  const enCorpus = (word + ' ' + example).toLowerCase();

  let best = null, bestScore = 0;
  const scores = [];
  for (const rule of TOPIC_RULES) {
    let score = 0;
    const enMatches = (enCorpus.match(rule.en) || []).length;
    const viMatches = (viCorpus.match(rule.vi) || []).length;
    score = enMatches * 2 + viMatches * 3;
    if (score > 0) scores.push({name:rule.name, score});
    if (score > bestScore) { bestScore = score; best = rule.name; }
  }
  return best || 'Daily Conversation';
}

// Claude API-powered classification for batch import (optional enhancement)
async function classifyWithClaude(word, engDef, example){
  const apiKey=getAnthropicKey();
  if(!apiKey) return null;
  const topicNames=TOPIC_RULES.map(r=>r.name).join(', ');
  try{
    const res=await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'Content-Type':'application/json','x-api-key':apiKey,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},
      body:JSON.stringify({
        model:'claude-haiku-4-5-20251001',max_tokens:30,
        messages:[{role:'user',content:
          `Classify the English word "${word}" (definition: "${engDef}"; example: "${example}") into exactly ONE of these topics: ${topicNames}. Reply with ONLY the topic name, nothing else.`
        }]
      })
    });
    if(res.ok){const d=await res.json();const t=(d?.content?.[0]?.text||'').trim();if(TOPIC_RULES.find(r=>r.name===t))return t;}
  }catch(e){}
  return null;
}

function processFile(file){
  const r=new FileReader();r.onload=async e=>{
    const wb=XLSX.read(e.target.result,{type:'binary'});const ws=wb.Sheets[wb.SheetNames[0]];
    const rows=XLSX.utils.sheet_to_json(ws,{header:1});
    const raw=rows.slice(1).filter(r=>r[0]).map(r=>({
      word:String(r[0]||'').trim(),
      meaning:String(r[1]||'').trim(),
      example:String(r[2]||'').trim(),
      ipa:'',topic:'...'
    }));
    if(!raw.length){showToast('File kh√¥ng c√≥ d·ªØ li·ªáu!','error');return;}
    showImportProgress(raw, 0);
    S.importBuf=raw;
    await autoEnrichWords(raw);
    showPreview(raw);
    S.importBuf=raw;
  };r.readAsBinaryString(file);
}

function showImportProgress(data, done){
  const pct = data.length ? Math.round(done/data.length*100) : 0;
  document.getElementById('preview-wrap').innerHTML=`
    <div style="padding:20px 8px;text-align:center">
      <div style="font-size:22px;margin-bottom:10px">üîç</div>
      <div style="font-family:var(--font-d);font-size:15px;font-weight:700;margin-bottom:6px;color:var(--ink)">ƒêang ph√¢n t√≠ch ${data.length} t·ª´ v·ª±ng...</div>
      <div style="font-size:13px;color:var(--ink3);margin-bottom:14px">Tra IPA chu·∫©n US & t·ª± ƒë·ªông ph√¢n ch·ªß ƒë·ªÅ th√¥ng minh</div>
      <div style="background:var(--bg2);border-radius:6px;height:10px;overflow:hidden;max-width:320px;margin:0 auto 8px">
        <div style="height:100%;background:linear-gradient(90deg,var(--teal),var(--teal-mid));border-radius:6px;width:${pct}%;transition:width .3s"></div>
      </div>
      <div style="font-size:12px;color:var(--ink4)">${done} / ${data.length} t·ª´ (${pct}%)</div>
    </div>`;
  document.getElementById('import-preview').style.display='block';
}

async function autoEnrichWords(data){
  const BATCH=4;
  let done=0;
  for(let i=0;i<data.length;i+=BATCH){
    const batch=data.slice(i,i+BATCH);
    await Promise.all(batch.map(async d=>{
      // Step 1: Smart classify from existing data (word + meaning + example)
      d.topic = smartClassifyTopic(d.word, d.meaning, d.example);
      // Step 2: Fetch IPA + enrich with dictionary definition for better classification
      try{
        const res=await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(d.word)}`);
        if(res.ok){
          const json=await res.json(); const entry=json[0];
          // IPA - prefer US accent
          const usPh=entry?.phonetics?.find(p=>p.audio?.includes('-us')||p.sourceUrl?.includes('-us'));
          const anyPh=entry?.phonetics?.find(p=>p.text);
          d.ipa=usPh?.text||anyPh?.text||entry?.phonetic||'';
          // Re-classify with richer data from dictionary
          const dictDef=(entry?.meanings?.[0]?.definitions?.[0]?.definition||'');
          const dictEx=(entry?.meanings?.[0]?.definitions?.[0]?.example||d.example);
          const enrichedTopic = smartClassifyTopic(d.word, d.meaning+' '+dictDef, dictEx||d.example);
          d.topic = enrichedTopic;
          // Fill example if empty
          if(!d.example && dictEx) d.example = dictEx;
          // Step 3: If regex classification is weak/default, try Claude API
          if(d.topic==='Daily Conversation' && dictDef){
            const aiTopic = await classifyWithClaude(d.word, dictDef, d.example||'');
            if(aiTopic) d.topic = aiTopic;
          }
        }
      }catch(err){}
      // Pexels image (async, validation included)
      if(!d.imageUrl){
        d.imageUrl = '';
        fetchWordImage(d.word, d.meaning||'', d.example||'').then(url=>{ d.imageUrl=url||''; });
      }
      done++;
    }));
    showImportProgress(data, done);
  }
}

function showPreview(data){
  // Group by auto-detected topics for summary
  const topicCount={};
  data.forEach(d=>{topicCount[d.topic]=(topicCount[d.topic]||0)+1;});
  const topicSummary=Object.entries(topicCount).sort((a,b)=>b[1]-a[1])
    .map(([t,c])=>{const rule=TOPIC_RULES.find(r=>r.name===t);return`<span style="background:var(--teal-light);border:1px solid rgba(13,148,136,.25);border-radius:20px;padding:3px 10px;font-size:12px;font-weight:600;color:var(--teal)">${rule?.emoji||'üìå'} ${t} <strong>(${c})</strong></span>`;}).join('');
  document.getElementById('preview-wrap').innerHTML=`
    <div style="margin-bottom:12px">
      <div style="font-size:12px;font-weight:700;color:var(--ink3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px">üìä Ph√¢n b·ªï ch·ªß ƒë·ªÅ t·ª± ƒë·ªông (${Object.keys(topicCount).length} ch·ªß ƒë·ªÅ)</div>
      <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px">${topicSummary}</div>
    </div>
    <table class="vtbl"><thead><tr><th>T·ª´ v·ª±ng</th><th>IPA (auto US)</th><th>Nghƒ©a</th><th>C√¢u v√≠ d·ª•</th><th>Ch·ªß ƒë·ªÅ (auto)</th></tr></thead>
    <tbody>${data.slice(0,30).map(d=>{const rule=TOPIC_RULES.find(r=>r.name===d.topic);return`<tr>
      <td class="vt-word">${d.word}</td>
      <td class="vt-ipa">${d.ipa||'‚Äî'}</td>
      <td style="max-width:130px">${d.meaning}</td>
      <td style="font-size:12px;font-style:italic;color:var(--ink3);max-width:180px">${d.example||'‚Äî'}</td>
      <td><span class="badge badge-teal">${rule?.emoji||'üìå'} ${d.topic}</span></td>
    </tr>`;}).join('')}</tbody></table>
    ${data.length>30?`<div style="font-size:12px;color:var(--ink3);padding:8px">... v√† ${data.length-30} t·ª´ n·ªØa</div>`:''}`;
  document.getElementById('import-preview').style.display='block';
  showToast(`‚úÖ Ph√¢n t√≠ch xong ${data.length} t·ª´ ‚Äî ${Object.keys(topicCount).length} ch·ªß ƒë·ªÅ!`);
}
function confirmImport(){
  const buf=S.importBuf;
  // L·∫•y topic override t·ª´ UI
  const topicOverride = (document.getElementById('imp-topic-new')?.value.trim())
    || (document.getElementById('imp-topic-select')?.value) || '';
  // √Åp d·ª•ng ch·ªß ƒë·ªÅ override n·∫øu c√≥
  if(topicOverride){
    buf.forEach(d=>{ d.topic = topicOverride; });
  }
  const added=[];const duplicates=[];
  const addedWords=[];
  buf.forEach(d=>{
    if(S.vocab.find(v=>v.word.toLowerCase()===d.word.toLowerCase())){
      duplicates.push(d.word);
    } else {
      addV(d);added.push(d.word);addedWords.push({...d,id:S.vocab[S.vocab.length-1].id});
    }
  });
  // Auto-create topics
  if(!S.topics)S.topics={};
  buf.forEach(d=>{
    if(d.topic && !S.topics[d.topic]){
      const rule=TOPIC_RULES.find(r=>r.name===d.topic);
      S.topics[d.topic]={desc: rule ? rule.desc : ''};
    }
  });
  // L·∫•y fileName t·ª´ drop-zone title n·∫øu c√≥
  const dzTitle = document.querySelector('#drop-zone .dz-title');
  const fileName = (dzTitle && dzTitle.dataset.filename) ? dzTitle.dataset.filename : 'Import';
  // L∆∞u l·ªãch s·ª≠ n·∫øu c√≥ t·ª´ ƒë∆∞·ª£c th√™m
  if(addedWords.length > 0){
    addImpHistoryEntry(addedWords, fileName, topicOverride);
  }
  S.importBuf=[];document.getElementById('import-preview').style.display='none';
  // Reset topic fields
  if(document.getElementById('imp-topic-new')) document.getElementById('imp-topic-new').value='';
  gainXP(added.length*2);save();renderTopics();updTopicFilter();renderVocabList();
  if(duplicates.length===0){
    showToast(`‚úÖ ƒê√£ th√™m ${added.length} t·ª´ v√†o ${[...new Set(buf.map(d=>d.topic))].length} ch·ªß ƒë·ªÅ!`);
  } else if(added.length===0){
    showToast(`‚ö†Ô∏è T·∫•t c·∫£ ${duplicates.length} t·ª´ ƒë√£ t·ªìn t·∫°i!`,'error');
  } else {
    showDuplicateReport(added, duplicates);
  }
}
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   IMPORT TABS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function switchImpTab(tab, btn){
  document.querySelectorAll('#panel-import .tab-btn').forEach(b=>b.classList.remove('active'));
  if(btn) btn.classList.add('active');
  ['upload','history','manual'].forEach(t=>{
    const el = document.getElementById('imp-view-'+t);
    if(el) el.style.display = t===tab ? 'block' : 'none';
  });
  if(tab==='history') renderImpHistory();
  if(tab==='upload') populateImpTopicSelect();
}

function populateImpTopicSelect(){
  const sel = document.getElementById('imp-topic-select');
  if(!sel) return;
  const allTopics = [...new Set([...S.vocab.map(v=>v.topic),...Object.keys(S.topics||{})])].sort();
  sel.innerHTML = '<option value="">ü§ñ T·ª± ƒë·ªông nh·∫≠n di·ªán</option>'
    + allTopics.map(t=>{
        const rule = TOPIC_RULES.find(r=>r.name===t);
        return `<option value="${t}">${rule?.emoji||'üìå'} ${t}</option>`;
      }).join('');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   IMPORT HISTORY ‚Äî localStorage: speakup_imp_hist
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function getImpHistory(){
  try{ const d=localStorage.getItem('speakup_imp_hist'); return d?JSON.parse(d):[]; }catch(e){ return []; }
}
function saveImpHistory(h){
  try{ localStorage.setItem('speakup_imp_hist',JSON.stringify(h)); }catch(e){}
}
function addImpHistoryEntry(words, fileName, topicOverride){
  const h = getImpHistory();
  const topicCounts = {};
  words.forEach(w=>{ topicCounts[w.topic]=(topicCounts[w.topic]||0)+1; });
  h.unshift({
    id: Date.now(),
    fileName: fileName||'Import',
    topicOverride: topicOverride||'',
    datetime: new Date().toISOString(),
    wordIds: words.map(w=>w.id),
    topics: topicCounts,
    count: words.length
  });
  // Gi·ªØ t·ªëi ƒëa 50 l·ªãch s·ª≠
  saveImpHistory(h.slice(0,50));
}

function renderImpHistory(){
  const h = getImpHistory();
  const list = document.getElementById('imp-hist-list');
  const empty = document.getElementById('imp-hist-empty');
  const countEl = document.getElementById('imp-hist-count');
  if(!h.length){
    list.innerHTML='';
    empty.style.display='block';
    countEl.textContent='Ch∆∞a c√≥ l·ªãch s·ª≠';
    return;
  }
  empty.style.display='none';
  countEl.textContent=`${h.length} l·∫ßn import`;

  list.innerHTML = h.map((entry,idx) => {
    const dt = new Date(entry.datetime);
    const dateStr = dt.toLocaleDateString('vi-VN',{day:'2-digit',month:'2-digit',year:'numeric'});
    const timeStr = dt.toLocaleTimeString('vi-VN',{hour:'2-digit',minute:'2-digit'});
    const topicBadges = Object.entries(entry.topics||{}).map(([t,c])=>{
      const rule=TOPIC_RULES.find(r=>r.name===t);
      return `<span class="imp-hist-chip">${rule?.emoji||'üìå'} ${t} (${c})</span>`;
    }).join('');
    // ƒê·∫øm t·ª´ c√≤n t·ªìn t·∫°i trong vocab
    const existCount = (entry.wordIds||[]).filter(id=>S.vocab.find(v=>v.id==id)).length;
    const missingCount = entry.count - existCount;
    return `<div class="imp-hist-item" id="imp-hist-${entry.id}">
      <div class="imp-hist-header">
        <div>
          <div class="imp-hist-title">üìÅ ${entry.fileName}</div>
          <div class="imp-hist-meta">
            <span>üóì ${dateStr} ${timeStr}</span>
            <span>¬∑</span>
            <span style="color:var(--teal);font-weight:700">${entry.count} t·ª´</span>
            ${entry.topicOverride?`<span>¬∑ Ch·ªß ƒë·ªÅ: <strong>${entry.topicOverride}</strong></span>`:''}
            ${missingCount>0?`<span style="color:var(--rose)">¬∑ ${missingCount} t·ª´ ƒë√£ x√≥a</span>`:''}
          </div>
        </div>
        <div class="imp-hist-actions">
          <button class="btn btn-outline btn-sm" onclick="viewImpHistoryWords(${entry.id})">üëÅ Xem t·ª´</button>
          <button class="btn btn-sm" style="background:var(--rose-light);color:var(--rose);border:1.5px solid #fecdd3" onclick="confirmDeleteImpHistory(${entry.id})">üóë</button>
        </div>
      </div>
      <div class="imp-hist-body">${topicBadges}</div>
    </div>`;
  }).join('');
}

function viewImpHistoryWords(id){
  const h = getImpHistory();
  const entry = h.find(e=>e.id==id);
  if(!entry) return;
  const words = (entry.wordIds||[]).map(wid=>S.vocab.find(v=>v.id==wid)).filter(Boolean);
  const deleted = entry.count - words.length;

  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay show';
  overlay.id = 'imp-hist-modal';
  overlay.innerHTML = `<div class="modal" style="max-width:680px;max-height:85vh;overflow-y:auto">
    <div class="modal-title">üìã T·ª´ v·ª±ng ƒë√£ import</div>
    <div class="modal-sub">
      ${new Date(entry.datetime).toLocaleString('vi-VN')} ¬∑ ${entry.fileName}
      ${deleted>0?`<span style="color:var(--rose);font-size:12px;margin-left:8px">(${deleted} t·ª´ ƒë√£ b·ªã x√≥a)</span>`:''}
    </div>
    <div style="margin:12px 0;display:flex;flex-direction:column;gap:8px;max-height:420px;overflow-y:auto">
      ${words.length ? words.map(w=>`
        <div style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px 12px;display:flex;align-items:center;gap:10px;flex-wrap:wrap">
          <div style="flex:1;min-width:0">
            <span style="font-family:var(--font-d);font-weight:700;color:var(--teal);font-size:15px">${w.word}</span>
            <span style="font-size:12px;color:var(--ink3);font-style:italic;margin-left:6px">${w.ipa||''}</span>
            <div style="font-size:13px;margin-top:2px">${w.meaning}</div>
            ${w.example?`<div style="font-size:12px;color:var(--ink3);font-style:italic;margin-top:2px">"${w.example}"</div>`:''}
          </div>
          <div style="display:flex;gap:5px;flex-shrink:0">
            <button class="act-btn act-edit" onclick="openEditWordModal('${w.id}');closeImpHistModal()" title="S·ª≠a">‚úèÔ∏è</button>
            <button class="act-btn act-del" onclick="confirmDeleteWord('${w.id}');closeImpHistModal()" title="X√≥a">üóë</button>
          </div>
        </div>`).join('')
        : '<div style="text-align:center;padding:20px;color:var(--ink3)">T·∫•t c·∫£ t·ª´ ƒë√£ b·ªã x√≥a</div>'}
    </div>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeImpHistModal()">ƒê√≥ng</button>
    </div>
  </div>`;
  document.body.appendChild(overlay);
  overlay.addEventListener('click', e=>{ if(e.target===overlay) closeImpHistModal(); });
}

function closeImpHistModal(){
  const m = document.getElementById('imp-hist-modal');
  if(m) m.remove();
}

function confirmDeleteImpHistory(id){
  openConfirm('üóëÔ∏è','X√≥a l·ªãch s·ª≠ import','X√≥a m·ª•c n√†y kh·ªèi l·ªãch s·ª≠? (Kh√¥ng x√≥a t·ª´ v·ª±ng)',()=>{
    const h = getImpHistory().filter(e=>e.id!=id);
    saveImpHistory(h);
    renderImpHistory();
    showToast('üóë ƒê√£ x√≥a kh·ªèi l·ªãch s·ª≠');
  });
}

function confirmClearAllHistory(){
  openConfirm('üóëÔ∏è','X√≥a to√†n b·ªô l·ªãch s·ª≠','X√≥a t·∫•t c·∫£ l·ªãch s·ª≠ import? (Kh√¥ng x√≥a t·ª´ v·ª±ng)',()=>{
    saveImpHistory([]);
    renderImpHistory();
    showToast('üóë ƒê√£ x√≥a to√†n b·ªô l·ªãch s·ª≠');
  });
}

function downloadTemplate(){
  const wb=XLSX.utils.book_new();const ws=XLSX.utils.aoa_to_sheet([
    ['T·ª´ v·ª±ng','Nghƒ©a ti·∫øng Vi·ªát','C√¢u v√≠ d·ª•'],
    ['appreciate','ƒë√°nh gi√° cao','I really appreciate your help.'],
    ['convenient','ti·ªán l·ª£i','It is very convenient to have a supermarket nearby.'],
    ['deadline','h·∫°n ch√≥t','We need to finish the report before the deadline.']
  ]);
  XLSX.utils.book_append_sheet(wb,ws,'Template');XLSX.writeFile(wb,'SpeakUp_Template.xlsx');showToast('üì• ƒê√£ t·∫£i template (3 c·ªôt)!');
}
function openModal(){
  document.getElementById('add-modal').classList.add('show');
  document.getElementById('add-modal-sub').textContent='Nh·∫≠p t·ª´ ti·∫øng Anh ‚Äî th√¥ng tin s·∫Ω t·ª± ƒë·ªông ƒëi·ªÅn';
  ['input-word','input-ipa','input-meaning','input-example'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('input-topic').value='';
  document.getElementById('autofill-card').style.display='none';
  document.getElementById('autofill-loading').style.display='none';
  document.getElementById('autofill-fields').style.display='none';
  document.getElementById('add-word-btn').style.display='none';
  setTimeout(()=>document.getElementById('input-word').focus(),120);
}
function closeModal(){document.getElementById('add-modal').classList.remove('show');}

function clearAutoFill(){
  document.getElementById('autofill-card').style.display='none';
  document.getElementById('autofill-fields').style.display='none';
  document.getElementById('add-word-btn').style.display='none';
  document.getElementById('autofill-loading').style.display='none';
}

async function lookupWord(){
  const word=document.getElementById('input-word').value.trim();
  if(!word){showToast('Nh·∫≠p t·ª´ v·ª±ng tr∆∞·ªõc!','error');return;}
  // Check duplicate immediately
  if(S.vocab.find(v=>v.word.toLowerCase()===word.toLowerCase())){
    showToast(`‚ö†Ô∏è "${word}" ƒë√£ t·ªìn t·∫°i trong danh s√°ch!`,'error');return;
  }
  document.getElementById('autofill-card').style.display='none';
  document.getElementById('autofill-fields').style.display='none';
  document.getElementById('add-word-btn').style.display='none';
  document.getElementById('autofill-loading').style.display='block';
  document.getElementById('autofill-loading').innerHTML='<div style="font-size:22px;margin-bottom:6px">‚è≥</div>ƒêang tra t·ª´ ƒëi·ªÉn & d·ªãch nghƒ©a...';
  document.getElementById('lookup-btn').disabled=true;
  document.getElementById('lookup-btn').textContent='‚è≥';

  let ipa='',meaning='',example='',topic='Daily Conversation',engDef='',partOfSpeech='';
  try{
    const res=await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(word)}`);
    if(res.ok){
      const json=await res.json();const entry=json[0];
      const usPh=entry?.phonetics?.find(p=>p.audio?.includes('-us')||p.sourceUrl?.includes('-us'));
      const anyPh=entry?.phonetics?.find(p=>p.text);
      ipa=usPh?.text||anyPh?.text||entry?.phonetic||'';
      const firstDef=entry?.meanings?.[0]?.definitions?.[0];
      engDef=firstDef?.definition||'';
      example=firstDef?.example||'';
      partOfSpeech=entry?.meanings?.[0]?.partOfSpeech||'';
      topic = smartClassifyTopic(word, engDef, example);
    }
  }catch(e){}

  // D·ªãch nghƒ©a + sinh c√¢u v√≠ d·ª• b·∫±ng Claude n·∫øu c√≥ API key
  const apiKey=getAnthropicKey();
  if(apiKey){
    document.getElementById('autofill-loading').innerHTML='<div style="font-size:22px;margin-bottom:6px">ü§ñ</div>Claude ƒëang d·ªãch nghƒ©a & t·∫°o c√¢u v√≠ d·ª•...';
    try{
      const enrichResult=await batchEnrichWords([{word,engDef,partOfSpeech,example}]);
      const r=enrichResult[word]||enrichResult[word.toLowerCase()];
      if(r?.meaning) meaning=r.meaning;
      if(r?.example&&!example) example=r.example;
    }catch(e){}
  }

  // Fallback offline dict
  if(!meaning){
    const key=word.toLowerCase().trim();
    meaning=(_viCache&&_viCache[key])||OFFLINE_DICT[key]||'';
  }

  document.getElementById('autofill-loading').style.display='none';
  document.getElementById('autofill-loading').innerHTML='<div style="font-size:22px;margin-bottom:6px">‚è≥</div>ƒêang tra t·ª´ ƒëi·ªÉn...';
  document.getElementById('lookup-btn').disabled=false;
  document.getElementById('lookup-btn').textContent='üîç Tra t·ª´';

  // Populate preview card
  document.getElementById('af-word').textContent=word;
  document.getElementById('af-ipa').textContent=ipa||'(ch∆∞a c√≥ IPA)';
  document.getElementById('af-topic').textContent=topic;
  document.getElementById('af-meaning').textContent=meaning?`üáªüá≥ ${meaning}`:'üìù Nh·ªõ nh·∫≠p nghƒ©a ti·∫øng Vi·ªát b√™n d∆∞·ªõi';
  document.getElementById('af-example').textContent=example?`"${example}"`:'(ch∆∞a c√≥ c√¢u v√≠ d·ª•)';
  document.getElementById('autofill-card').style.display='block';

  // Fill editable fields
  document.getElementById('input-ipa').value=ipa;
  document.getElementById('input-meaning').value=meaning;
  document.getElementById('input-example').value=example;
  document.getElementById('input-topic').value=topic;
  document.getElementById('autofill-fields').style.display='block';
  document.getElementById('add-word-btn').style.display='inline-flex';
  // Focus meaning n·∫øu ch∆∞a c√≥, else focus word
  if(!meaning) setTimeout(()=>document.getElementById('input-meaning').focus(),100);
}

async function addWord(){
  const word=document.getElementById('input-word').value.trim();
  const meaning=document.getElementById('input-meaning').value.trim();
  const topic=document.getElementById('input-topic').value.trim()||'Daily Conversation';
  if(!word){showToast('Nh·∫≠p t·ª´ v·ª±ng tr∆∞·ªõc!','error');return;}
  if(!meaning){showToast('Vui l√≤ng nh·∫≠p nghƒ©a ti·∫øng Vi·ªát!','error');document.getElementById('input-meaning').focus();return;}
  if(S.vocab.find(v=>v.word.toLowerCase()===word.toLowerCase())){showToast(`‚ö†Ô∏è "${word}" ƒë√£ t·ªìn t·∫°i!`,'error');return;}
  const ipa=document.getElementById('input-ipa').value.trim();
  const imageUrl = ''  ;
  addV({word,ipa,meaning,example:document.getElementById('input-example').value.trim(),topic,imageUrl});
  // Fetch Pexels image in background
  const newEntry = S.vocab[S.vocab.length-1];
  const _mn=document.getElementById('input-meaning').value.trim();
  const _ex=document.getElementById('input-example').value.trim();
  fetchWordImage(word,_mn,_ex).then(url=>{ if(newEntry){ newEntry.imageUrl=url||''; save(); } });
  if(!S.topics)S.topics={};
  if(!S.topics[topic]){const rule=TOPIC_RULES.find(r=>r.name===topic);S.topics[topic]={desc:rule?.desc||''};}
  save();closeModal();renderTopics();renderVocabList();updTopicFilter();
  if(document.getElementById('panel-topic-detail').classList.contains('active')&&S.currentTopic===topic)renderTopicDetail();
  showToast(`‚úÖ ƒê√£ th√™m "${word}"!`);gainXP(5);
}

/* ‚îÄ‚îÄ PROGRESS ‚îÄ‚îÄ */
function renderProgress(){
  const total=S.vocab.length;const learned=S.vocab.filter(v=>v.learned).length;const starred=S.vocab.filter(v=>v.starred).length;const topics=Object.keys(getTopics()).length;
  document.getElementById('progress-stats').innerHTML=[{icon:'üìñ',lbl:'T·ªïng t·ª´',val:total,c:'var(--teal)'},{icon:'‚úÖ',lbl:'ƒê√£ h·ªçc',val:learned,c:'#0891b2'},{icon:'‚≠ê',lbl:'ƒê√°nh d·∫•u',val:starred,c:'var(--amber)'},{icon:'üóÇÔ∏è',lbl:'Ch·ªß ƒë·ªÅ',val:topics,c:'var(--violet)'},{icon:'üî•',lbl:'Streak',val:S.stats.streak+'ng√†y',c:'#ea580c'},{icon:'‚ö°',lbl:'T·ªïng XP',val:S.stats.xp,c:'var(--amber)'}]
    .map(s=>`<div class="stat-tile"><div class="stat-tile-icon">${s.icon}</div><div class="stat-tile-val" style="color:${s.c}">${s.val}</div><div class="stat-tile-lbl">${s.lbl}</div></div>`).join('');
  const ach=[];if(total>=10)ach.push({i:'üå±',n:'M·∫ßm non',d:'Th√™m 10 t·ª´ ƒë·∫ßu'});if(learned>=5)ach.push({i:'üéØ',n:'T·∫≠p trung',d:'Ho√†n th√†nh 5 t·ª´'});if(S.stats.streak>=3)ach.push({i:'üî•',n:'Streak x3',d:'3 ng√†y li√™n ti·∫øp'});if(S.stats.xp>=100)ach.push({i:'‚ö°',n:'100 XP',d:'ƒê·∫°t m·ªëc 100 ƒëi·ªÉm'});if(!ach.length)ach.push({i:'üèÅ',n:'B·∫Øt ƒë·∫ßu',d:'H√†nh tr√¨nh m·ªõi kh·ªüi ƒë·∫ßu'});
  document.getElementById('achievements').innerHTML=ach.map(a=>`<div class="ach-item"><div class="ach-icon">${a.i}</div><div><div class="ach-name">${a.n}</div><div class="ach-desc">${a.d}</div></div></div>`).join('');
}

/* ‚îÄ‚îÄ WEEK CAL ‚îÄ‚îÄ */
function renderWeekCal(){
  const days=['CN','T2','T3','T4','T5','T6','T7'];const today=new Date().getDay();
  document.getElementById('week-calendar').innerHTML=days.map((d,i)=>`<div class="wday"><div class="wday-lbl">${d}</div><div class="wday-dot${i===today?' today':''}">${i===today?'üî•':''}</div></div>`).join('');
}

function showDuplicateReport(added, duplicates){
  // Show a nice result card inline
  const el=document.getElementById('import-preview');
  document.getElementById('preview-wrap').innerHTML=`
    <div style="padding:8px 0">
      <div style="display:flex;gap:14px;flex-wrap:wrap;margin-bottom:16px">
        <div style="flex:1;min-width:140px;background:var(--teal-light);border:1.5px solid rgba(13,148,136,.25);border-radius:var(--radius-sm);padding:14px;text-align:center">
          <div style="font-family:var(--font-d);font-size:28px;font-weight:900;color:var(--teal)">${added.length}</div>
          <div style="font-size:12px;color:var(--ink3);margin-top:2px">‚úÖ T·ª´ ƒë√£ th√™m th√†nh c√¥ng</div>
        </div>
        <div style="flex:1;min-width:140px;background:var(--amber-light);border:1.5px solid #fde68a;border-radius:var(--radius-sm);padding:14px;text-align:center">
          <div style="font-family:var(--font-d);font-size:28px;font-weight:900;color:var(--amber)">${duplicates.length}</div>
          <div style="font-size:12px;color:var(--ink3);margin-top:2px">‚ö†Ô∏è T·ª´ b·ªã tr√πng (ƒë√£ b·ªè qua)</div>
        </div>
      </div>
      <div style="font-size:13px;font-weight:700;color:var(--ink2);margin-bottom:8px">üìã Danh s√°ch t·ª´ tr√πng:</div>
      <div style="display:flex;flex-wrap:wrap;gap:6px">${duplicates.map(w=>`<span style="background:var(--amber-light);border:1px solid #fde68a;border-radius:20px;padding:3px 10px;font-size:12px;font-weight:600;color:var(--amber)">${w}</span>`).join('')}</div>
    </div>`;
  el.style.display='block';
  // Update buttons
  const okBtn=el.querySelector('.btn.btn-primary');if(okBtn)okBtn.style.display='none';
}

/* ‚îÄ‚îÄ VOICE SELECTION ‚îÄ‚îÄ */
let _femaleUSVoice=null;
function getFemaleUSVoice(){
  if(_femaleUSVoice) return _femaleUSVoice;
  const voices=window.speechSynthesis.getVoices();
  // Priority: Samantha (macOS/iOS US female), then any en-US female
  const priority=['Samantha','Google US English','Microsoft Aria','Zira','Karen','Victoria','Allison','Susan','Joanna','Ivy','Kendra','Kimberly','Salli'];
  for(const name of priority){
    const v=voices.find(v=>v.name.includes(name)&&v.lang.startsWith('en'));
    if(v){_femaleUSVoice=v;return v;}
  }
  // Fallback: any en-US voice
  const enUS=voices.find(v=>v.lang==='en-US');
  if(enUS){_femaleUSVoice=enUS;return enUS;}
  return null;
}

function speak(text){
  if(!window.speechSynthesis) return;
  window.speechSynthesis.cancel();
  const doSpeak=()=>{
    const u=new SpeechSynthesisUtterance(text);
    u.lang='en-US';
    u.rate=0.85;
    const v=getFemaleUSVoice();
    if(v) u.voice=v;
    // Workaround for Chrome bug where long utterances get cut off
    const resumeTimer=setInterval(()=>{
      if(!window.speechSynthesis.speaking){clearInterval(resumeTimer);return;}
      window.speechSynthesis.pause();window.speechSynthesis.resume();
    },10000);
    u.onend=()=>clearInterval(resumeTimer);
    u.onerror=()=>clearInterval(resumeTimer);
    window.speechSynthesis.speak(u);
  };
  // Voices may not be loaded yet on first call
  if(window.speechSynthesis.getVoices().length===0){
    window.speechSynthesis.onvoiceschanged=()=>{_femaleUSVoice=null;doSpeak();};
  } else {
    doSpeak();
  }
}
function gainXP(n){S.stats.xp=(S.stats.xp||0)+n;const today=new Date().toDateString();if(S.stats.lastDate!==today){S.stats.streak=(S.stats.streak||0)+1;S.stats.lastDate=today;}updStats();save();}
function updStats(){document.getElementById('stat-streak').textContent=S.stats.streak;document.getElementById('stat-xp').textContent=S.stats.xp;document.getElementById('stat-words').textContent=S.vocab.filter(v=>v.learned).length;}
let _tt;function showToast(msg,type='success'){const t=document.getElementById('toast');t.textContent=msg;t.className='toast '+type;t.style.display='flex';clearTimeout(_tt);_tt=setTimeout(()=>t.style.display='none',2600);}
function esc(s){return String(s||'').replace(/'/g,"\\'").replace(/"/g,'&quot;');}
function shuffle(a){return[...a].sort(()=>Math.random()-.5);}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ROADMAP ‚Äî L·ªô tr√¨nh h·ªçc c√° nh√¢n
   ‚Ä¢ M·ªói ng√†y: 10 t·ª´ v·ª±ng ∆∞u ti√™n theo ch·ªß ƒë·ªÅ
   ‚Ä¢ B·∫£ng th·ªëng k√™: ng√†y / tu·∫ßn / th√°ng / qu√Ω / nƒÉm
   ‚Ä¢ Quiz 10 t·ª´ m·ªói ng√†y
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

// Roadmap state
function getRdpState(){
  try{const d=localStorage.getItem('speakup_rdp_v1');if(d){
    const s=JSON.parse(d);
    // migrate: n·∫øu c√≥ topicPriority c≈© ‚Üí chuy·ªÉn sang topicFilter array
    if(!s.topicFilter){
      s.topicFilter = s.topicPriority ? [s.topicPriority] : [];
    }
    return s;
  }}catch(e){}
  return {dailyGoal:10, logs:{}, topicPriority:'', topicFilter:[]};
}
function saveRdpState(r){try{localStorage.setItem('speakup_rdp_v1',JSON.stringify(r));}catch(e){}}

function getDateKey(d){return(d||new Date()).toISOString().slice(0,10);}

function getTodayWords(count=10){
  const rdp=getRdpState();
  const topicFilter=rdp.topicFilter||[];
  const topicPrio=rdp.topicPriority;
  const today=getDateKey();
  const logs=rdp.logs||{};

  // Pool vocab: n·∫øu c√≥ topicFilter th√¨ ch·ªâ l·∫•y t·ª´ thu·ªôc c√°c ch·ªß ƒë·ªÅ ƒë√£ ch·ªçn
  const vocabPool = topicFilter.length>0 ? S.vocab.filter(v=>topicFilter.includes(v.topic)) : S.vocab;

  // T·∫≠p h·ª£p ID c√°c t·ª´ ƒë√£ h·ªçc trong c√°c ng√†y TR∆Ø·ªöC (kh√¥ng t√≠nh h√¥m nay)
  const studiedBefore=new Set();
  Object.entries(logs).forEach(([dateKey, log])=>{
    if(dateKey===today) return; // b·ªè qua h√¥m nay
    (log.results||[]).forEach(r=>studiedBefore.add(String(r.id)));
  });

  // C√°c t·ª´ h√¥m nay ƒëang h·ªçc (gi·ªØ l·∫°i ƒë·ªÉ kh√¥ng b·ªã m·∫•t gi·ªØa ch·ª´ng)
  const todayResults=logs[today]?.results||[];
  const todayIds=new Set(todayResults.map(r=>String(r.id)));

  // Pool ∆∞u ti√™n: t·ª´ ch∆∞a h·ªçc bao gi·ªù (ch∆∞a c√≥ trong log ng√†y n√†o v√† ch∆∞a learned)
  let freshPool=vocabPool.filter(v=>!v.learned && !studiedBefore.has(String(v.id)) && !todayIds.has(String(v.id)));
  if(topicPrio && !topicFilter.length) freshPool=[...freshPool.filter(v=>v.topic===topicPrio),...freshPool.filter(v=>v.topic!==topicPrio)];

  // N·∫øu h√¥m nay ƒëang h·ªçc d·ªü ‚Üí gi·ªØ nguy√™n set h√¥m nay tr∆∞·ªõc
  const todayWords=todayIds.size>0 ? vocabPool.filter(v=>todayIds.has(String(v.id))) : [];

  // Gh√©p: t·ª´ h√¥m nay (ƒëang h·ªçc) + t·ª´ m·ªõi ho√†n to√†n
  let result=[...todayWords];
  for(const w of freshPool){
    if(result.length>=count) break;
    if(!result.find(x=>x.id===w.id)) result.push(w);
  }

  // N·∫øu v·∫´n ch∆∞a ƒë·ªß ‚Üí th√™m t·ª´ ƒë√£ h·ªçc c√°c ng√†y tr∆∞·ªõc (√¥n l·∫°i)
  if(result.length<count){
    let reviewPool=vocabPool.filter(v=>studiedBefore.has(String(v.id))&&!result.find(x=>x.id===v.id));
    if(topicPrio && !topicFilter.length) reviewPool=[...reviewPool.filter(v=>v.topic===topicPrio),...reviewPool.filter(v=>v.topic!==topicPrio)];
    for(const w of reviewPool){
      if(result.length>=count) break;
      result.push(w);
    }
  }

  // Cu·ªëi c√πng n·∫øu v·∫´n thi·∫øu ‚Üí th√™m t·ª´ learned ch∆∞a c√≥
  if(result.length<count){
    const learnedPool=vocabPool.filter(v=>v.learned&&!result.find(x=>x.id===v.id));
    for(const w of learnedPool){
      if(result.length>=count) break;
      result.push(w);
    }
  }

  return result.slice(0,count);
}

/* T√≠nh t·ª´ v·ª±ng d·ª± ki·∫øn cho ng√†y t∆∞∆°ng lai
   M√¥ ph·ªèng: b·ªè qua t·∫•t c·∫£ t·ª´ ƒë√£ xu·∫•t hi·ªán trong log c√°c ng√†y tr∆∞·ªõc ng√†y ƒë√≥ */
function getFutureWords(targetDateKey, count, logs, topicPrio, topicFilter){
  // T·∫≠p h·ª£p t·ª´ ƒë√£ h·ªçc trong t·∫•t c·∫£ ng√†y TR∆Ø·ªöC targetDate
  const studiedBefore=new Set();
  Object.entries(logs).forEach(([dateKey, log])=>{
    if(dateKey>=targetDateKey) return;
    (log.results||[]).forEach(r=>studiedBefore.add(String(r.id)));
  });
  // Pool vocab l·ªçc theo ch·ªß ƒë·ªÅ n·∫øu c√≥
  const vocabPool = (topicFilter&&topicFilter.length>0) ? S.vocab.filter(v=>topicFilter.includes(v.topic)) : S.vocab;
  let freshPool=vocabPool.filter(v=>!v.learned && !studiedBefore.has(String(v.id)));
  if(topicPrio && !(topicFilter&&topicFilter.length)) freshPool=[...freshPool.filter(v=>v.topic===topicPrio),...freshPool.filter(v=>v.topic!==topicPrio)];
  if(freshPool.length>=count) return freshPool.slice(0,count);
  // B·ªï sung t·ª´ ƒë√£ h·ªçc n·∫øu kh√¥ng ƒë·ªß
  const extra=vocabPool.filter(v=>v.learned&&!freshPool.find(x=>x.id===v.id));
  return [...freshPool,...extra].slice(0,count);
}

function renderRoadmap(){
  renderRdpTopStats();
  switchRdpTab('plan', document.querySelector('.rdp-tab'));
}

function renderRdpTopStats(){
  const rdp=getRdpState();
  const today=getDateKey();
  const logs=rdp.logs||{};
  // Today's log
  const todayLog=logs[today]||{};
  const todayDone=(todayLog.results||[]).filter(r=>r.correct).length;
  const todayTotal=(todayLog.results||[]).length;
  // Current streak
  let streak=0;
  const d=new Date();
  while(true){
    const k=getDateKey(d);
    const lg=logs[k];
    if(lg && (lg.results||[]).length>0){streak++;d.setDate(d.getDate()-1);}
    else break;
  }
  // Total studied days
  const totalDays=Object.keys(logs).filter(k=>logs[k].results?.length>0).length;
  // Total correct all time
  const totalCorrect=Object.values(logs).reduce((s,l)=>s+(l.results||[]).filter(r=>r.correct).length,0);
  document.getElementById('rdp-top-stats').innerHTML=[
    {icon:'üî•',val:streak+'',lbl:'Streak (ng√†y)',c:'#ea580c'},
    {icon:'‚úÖ',val:todayDone+'/'+rdp.dailyGoal,lbl:'H√¥m nay',c:'var(--teal)'},
    {icon:'üìÖ',val:totalDays+'',lbl:'Ng√†y h·ªçc',c:'var(--violet)'},
    {icon:'‚≠ê',val:totalCorrect+'',lbl:'T·ªïng ƒë√∫ng',c:'var(--amber)'},
  ].map(s=>`<div class="rdp-stat-tile"><span class="rdp-stat-val" style="color:${s.c}">${s.val}</span><div class="rdp-stat-lbl">${s.icon} ${s.lbl}</div></div>`).join('');
}

function switchRdpTab(tab, btn){
  document.querySelectorAll('.rdp-tab').forEach(b=>b.classList.remove('active'));
  if(btn)btn.classList.add('active');
  document.getElementById('rdp-plan-view').style.display=tab==='plan'?'block':'none';
  document.getElementById('rdp-stats-view').style.display=tab==='stats'?'block':'none';
  document.getElementById('rdp-quiz10-view').style.display=tab==='quiz10'?'block':'none';
  document.getElementById('rdp-review-view').style.display=tab==='review'?'block':'none';
  if(tab==='plan') renderRdpPlan();
  if(tab==='stats') renderRdpStats();
  if(tab==='quiz10'){ if(!_rdpSession) renderRdpQuiz10(); else showRdpQuestion(); }
  if(tab==='review') renderReviewSetup();
  saveSession();
}

function renderRdpPlan(){
  const rdp=getRdpState();
  const logs=rdp.logs||{};
  const today=getDateKey();
  // Generate 14 days: 7 past + today + 6 future
  const days=[];
  for(let i=-7;i<=6;i++){
    const d=new Date();d.setDate(d.getDate()+i);
    days.push({date:getDateKey(d),isToday:i===0,isPast:i<0,isFuture:i>0,d});
  }
  const allTopics=[...new Set([...S.vocab.map(v=>v.topic),...Object.keys(S.topics||{})])].sort();
  const topicFilter=rdp.topicFilter||[];
  const selectedCount=topicFilter.length;

  // Gi√° tr·ªã select: '' = t·∫•t c·∫£, ho·∫∑c t√™n ch·ªß ƒë·ªÅ c·ª• th·ªÉ
  const selectVal = topicFilter.length===1 ? topicFilter[0] : '';

  let html=`<div class="card" style="margin-bottom:14px">
    <div style="font-weight:700;font-size:14px;margin-bottom:14px;color:var(--ink)">‚öôÔ∏è C√†i ƒë·∫∑t l·ªô tr√¨nh</div>
    <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end">

      <div style="flex:1;min-width:160px">
        <label class="flbl">üìö Ch·ªß ƒë·ªÅ luy·ªán t·∫≠p</label>
        <select class="sel-inp" style="width:100%" onchange="saveRdpTopicFilter(this.value)">
          <option value="" ${selectVal===''?'selected':''}>üîÄ T·∫•t c·∫£ ch·ªß ƒë·ªÅ</option>
          ${allTopics.map(t=>{
            const rule=TOPIC_RULES.find(r=>r.name===t);
            const emoji=rule?.emoji||'üìå';
            const cnt=S.vocab.filter(v=>v.topic===t).length;
            return `<option value="${t}" ${selectVal===t?'selected':''}>${emoji} ${t} (${cnt} t·ª´)</option>`;
          }).join('')}
        </select>
      </div>

      <div style="flex:1;min-width:130px">
        <label class="flbl">üéØ M·ª•c ti√™u m·ªói ng√†y</label>
        <select class="sel-inp" style="width:100%" onchange="saveRdpGoal(this.value)">
          ${[5,10,15,20].map(n=>`<option value="${n}" ${rdp.dailyGoal===n?'selected':''}>${n} t·ª´/ng√†y</option>`).join('')}
        </select>
      </div>

      <button class="btn btn-primary btn-sm" onclick="switchRdpTab('quiz10',document.querySelectorAll('.rdp-tab')[2])">üß© H·ªçc h√¥m nay</button>
    </div>
  </div>`;

  html+=days.map(({date,isToday,isPast,isFuture,d})=>{
    const log=logs[date]||{};
    const results=log.results||[];
    const done=results.filter(r=>r.correct).length;
    const total=results.length;
    const goal=rdp.dailyGoal||10;
    const pct=goal?Math.round(done/goal*100):0;
    const weekday=['CN','T2','T3','T4','T5','T6','T7'][d.getDay()];
    const dateStr=`${weekday}, ${d.getDate()}/${d.getMonth()+1}`;
    let badgeClass='rdp-badge-future',badgeText='S·∫Øp t·ªõi';
    let cardClass='';
    if(isToday){badgeClass='rdp-badge-today';badgeText='H√¥m nay';}
    else if(isPast&&total>0&&done>=Math.floor(goal*0.7)){badgeClass='rdp-badge-done';badgeText='‚úÖ ƒê√£ h·ªçc';cardClass='completed';}
    else if(isPast&&total===0){badgeClass='rdp-badge-miss';badgeText='‚ö†Ô∏è B·ªè qua';cardClass='missed';}
    else if(isPast&&total>0){badgeClass='rdp-badge-done';badgeText=`‚úçÔ∏è ${done}/${total}`;cardClass='completed';}

    // Words for this day
    const words=isPast?results.map(r=>S.vocab.find(v=>v.id==r.id)).filter(Boolean):
      isToday?getTodayWords(goal):
      getFutureWords(date,goal,logs,rdp.topicPriority,rdp.topicFilter||[]);
    const wordsPreview=words.slice(0,5).map(w=>{
      if(!w) return '';
      const res=results.find(r=>r.id==w.id);
      let chipClass='rdp-word-chip';
      if(res?.correct)chipClass='rdp-word-chip learned';
      else if(res&&!res.correct)chipClass='rdp-word-chip missed-chip';
      return`<span class="${chipClass}">${w.word}</span>`;
    }).join('');
    const moreCount=words.length>5?`<span style="font-size:11px;color:var(--ink4)">+${words.length-5} t·ª´</span>`:'';

    return`<div class="rdp-day-card ${isToday?'today-card':''} ${cardClass}" ${isToday?'':'style="cursor:default"'}>
      <div class="rdp-day-badge ${badgeClass}">${badgeText}</div>
      <div class="rdp-day-title">${dateStr} ${isToday?'üî•':''}</div>
      <div class="rdp-day-meta">
        <span>üéØ ${goal} t·ª´ m·ª•c ti√™u</span>
        ${total>0?`<span>‚úÖ ${done}/${total} ƒë√∫ng</span>`:'<span>üìñ Ch∆∞a h·ªçc</span>'}
        ${log.xp?`<span>‚ö° +${log.xp} XP</span>`:''}
      </div>
      <div class="rdp-words-preview">${wordsPreview}${moreCount}</div>
      ${total>0?`<div class="rdp-prog-bar"><div class="rdp-prog-fill" style="width:${Math.min(100,pct)}%"></div></div>`:''}
    </div>`;
  }).join('');

  document.getElementById('rdp-plan-view').innerHTML=html;
}

function saveRdpPrio(val){const r=getRdpState();r.topicPriority=val;saveRdpState(r);showToast('‚úÖ ƒê√£ l∆∞u ∆∞u ti√™n ch·ªß ƒë·ªÅ');}
function saveRdpGoal(val){const r=getRdpState();r.dailyGoal=parseInt(val)||10;saveRdpState(r);renderRdpPlan();showToast('‚úÖ C·∫≠p nh·∫≠t m·ª•c ti√™u '+val+' t·ª´/ng√†y');}

function saveRdpTopicFilter(val){
  const r=getRdpState();
  // val='' ‚Üí t·∫•t c·∫£; val=t√™n ch·ªß ƒë·ªÅ ‚Üí ch·ªâ ch·ªß ƒë·ªÅ ƒë√≥
  r.topicFilter = val ? [val] : [];
  r.topicPriority = val || '';
  saveRdpState(r);
  if(_rdpSession){ _rdpSession=null; }
  renderRdpPlan();
  showToast(val ? `üìö Ch·ªâ h·ªçc ch·ªß ƒë·ªÅ: ${val}` : 'üîÄ H·ªçc t·∫•t c·∫£ ch·ªß ƒë·ªÅ');
}

// Current stats period offset & type
let _statsPeriod = 'week'; // 'day'|'week'|'month'|'quarter'|'year'
let _statsOffset = 0;

function renderRdpStats(){
  _statsOffset = 0;
  renderPeriodStats();
}

function renderPeriodStats(){
  const rdp = getRdpState();
  const logs = rdp.logs || {};
  const today = new Date();
  const goal = rdp.dailyGoal || 10;

  // ‚îÄ‚îÄ Period calculation ‚îÄ‚îÄ
  function getPeriodDays(offset, period){
    const ref = new Date(today);
    let start, end, label, sublabel;
    if(period === 'day'){
      ref.setDate(ref.getDate() - offset);
      start = new Date(ref); start.setHours(0,0,0,0);
      end   = new Date(ref); end.setHours(23,59,59,999);
      const weekdays = ['CN','T2','T3','T4','T5','T6','T7'];
      label = offset===0 ? 'H√¥m nay' : offset===1 ? 'H√¥m qua' : `${weekdays[ref.getDay()]} ${ref.getDate()}/${ref.getMonth()+1}`;
      sublabel = `${ref.getDate()}/${ref.getMonth()+1}/${ref.getFullYear()}`;
    } else if(period === 'week'){
      const dow = ref.getDay();
      const mon = new Date(ref); mon.setDate(ref.getDate() - offset*7 - (dow===0?6:dow-1)); mon.setHours(0,0,0,0);
      start = new Date(mon);
      end   = new Date(mon); end.setDate(mon.getDate()+6); end.setHours(23,59,59,999);
      label = offset===0?'Tu·∫ßn n√†y':offset===1?'Tu·∫ßn tr∆∞·ªõc':`${offset} tu·∫ßn tr∆∞·ªõc`;
      sublabel = `${start.getDate()}/${start.getMonth()+1} ‚Äì ${end.getDate()}/${end.getMonth()+1}/${end.getFullYear()}`;
    } else if(period === 'month'){
      const m = new Date(today.getFullYear(), today.getMonth() - offset, 1);
      start = m;
      end   = new Date(m.getFullYear(), m.getMonth()+1, 0, 23,59,59,999);
      const mnames=['T1','T2','T3','T4','T5','T6','T7','T8','T9','T10','T11','T12'];
      label = offset===0?'Th√°ng n√†y':offset===1?'Th√°ng tr∆∞·ªõc':mnames[m.getMonth()]+' '+m.getFullYear();
      sublabel = `${mnames[m.getMonth()]}/${m.getFullYear()}`;
    } else if(period === 'quarter'){
      const curQ = Math.floor(today.getMonth()/3);
      const qStart = new Date(today.getFullYear(), (curQ - offset)*3, 1);
      start = qStart;
      end   = new Date(qStart.getFullYear(), qStart.getMonth()+3, 0, 23,59,59,999);
      const qNum = Math.floor(start.getMonth()/3)+1;
      label = offset===0?'Qu√Ω n√†y':offset===1?'Qu√Ω tr∆∞·ªõc':`Q${qNum}/${start.getFullYear()}`;
      sublabel = `Q${qNum} ${start.getFullYear()}`;
    } else { // year
      const yr = today.getFullYear() - offset;
      start = new Date(yr, 0, 1);
      end   = new Date(yr, 11, 31, 23,59,59,999);
      label = offset===0?'NƒÉm nay':offset===1?'NƒÉm ngo√°i':`NƒÉm ${yr}`;
      sublabel = `${yr}`;
    }
    // collect dates
    const dates = [];
    const cur = new Date(start); cur.setHours(0,0,0,0);
    while(cur <= end){ dates.push(new Date(cur)); cur.setDate(cur.getDate()+1); }
    return { start, end, dates, label, sublabel };
  }

  const { start, end, dates, label, sublabel } = getPeriodDays(_statsOffset, _statsPeriod);

  // Aggregate
  let totalCorrect=0, totalWrong=0, totalStudied=0;
  const dayMap = {};
  const learnedInPeriod = new Set(); // unique word ids learned (correct) in period
  dates.forEach(d => {
    const k = getDateKey(d);
    const log = logs[k] || {};
    const results = log.results || [];
    const c = results.filter(r=>r.correct).length;
    const w = results.filter(r=>!r.correct).length;
    dayMap[k] = { correct:c, wrong:w, total:results.length, xp:log.xp||0, results };
    totalCorrect += c;
    totalWrong += w;
    if(results.length>0) totalStudied++;
    results.filter(r=>r.correct).forEach(r=>learnedInPeriod.add(r.id));
  });
  const totalTotal = totalCorrect + totalWrong;
  const acc = totalTotal>0 ? Math.round(totalCorrect/totalTotal*100) : 0;
  const totalLearnedWords = learnedInPeriod.size;

  // Avg per day within studied days
  const avgPerDay = totalStudied>0 ? (totalLearnedWords/totalStudied).toFixed(1) : 0;

  // Build chart data ‚Äî for day view show hours, else show dates
  let chartData = [];
  if(_statsPeriod === 'day'){
    // hourly chart (just show daily words)
    chartData = [{label: sublabel, val: totalCorrect}];
  } else if(_statsPeriod === 'week'){
    const dayNames=['T2','T3','T4','T5','T6','T7','CN'];
    chartData = dates.map((d,i) => ({ label:dayNames[i], val:(dayMap[getDateKey(d)]||{}).correct||0, date:d }));
  } else if(_statsPeriod === 'month'){
    // weekly buckets within month
    const weeks = {};
    dates.forEach(d => {
      const dow = d.getDay(); const mon = new Date(d); mon.setDate(d.getDate()-(dow===0?6:dow-1));
      const wk = getDateKey(mon);
      if(!weeks[wk]) weeks[wk]={label:'T'+mon.getDate(), val:0};
      weeks[wk].val += (dayMap[getDateKey(d)]||{}).correct||0;
    });
    chartData = Object.values(weeks);
  } else if(_statsPeriod === 'quarter'){
    // monthly buckets
    const months=['T1','T2','T3','T4','T5','T6','T7','T8','T9','T10','T11','T12'];
    const mmap = {};
    dates.forEach(d => {
      const mk = `${d.getFullYear()}-${d.getMonth()}`;
      if(!mmap[mk]) mmap[mk] = { label:months[d.getMonth()], val:0 };
      mmap[mk].val += (dayMap[getDateKey(d)]||{}).correct||0;
    });
    chartData = Object.values(mmap);
  } else { // year
    const months=['T1','T2','T3','T4','T5','T6','T7','T8','T9','T10','T11','T12'];
    const mmap = {};
    dates.forEach(d => {
      const mk = d.getMonth();
      if(!mmap[mk]) mmap[mk] = { label:months[mk], val:0 };
      mmap[mk].val += (dayMap[getDateKey(d)]||{}).correct||0;
    });
    chartData = Object.values(mmap);
  }
  const maxVal = Math.max(...chartData.map(x=>x.val), 1);

  const isFirst = _statsOffset === 0;

  const el = document.getElementById('rdp-stats-view');
  el.innerHTML = `
    <!-- Period filter bar -->
    <div style="background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius-sm);padding:4px;display:flex;gap:2px;margin-bottom:14px;overflow-x:auto;scrollbar-width:none">
      ${[['day','üìÜ Ng√†y'],['week','üìÖ Tu·∫ßn'],['month','üóì Th√°ng'],['quarter','üìä Qu√Ω'],['year','üóÉ NƒÉm']].map(([p,lbl])=>`
        <button onclick="_statsPeriod='${p}';_statsOffset=0;renderPeriodStats()"
          style="flex:1;min-width:max-content;padding:7px 14px;border-radius:6px;border:none;cursor:pointer;
          font-family:var(--font-b);font-size:13px;font-weight:600;transition:all .15s;white-space:nowrap;
          background:${_statsPeriod===p?'var(--surface)':'transparent'};
          color:${_statsPeriod===p?'var(--teal)':'var(--ink3)'};
          box-shadow:${_statsPeriod===p?'var(--shadow-sm)':'none'}">
          ${lbl}
        </button>`).join('')}
    </div>

    <!-- Period navigator -->
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:8px">
      <div>
        <div style="font-family:var(--font-d);font-weight:700;font-size:18px;color:var(--ink)">${label}</div>
        <div style="font-size:13px;color:var(--ink3)">${sublabel}</div>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-outline btn-sm" onclick="_statsOffset++;renderPeriodStats()">‚Üê Tr∆∞·ªõc</button>
        ${!isFirst?`<button class="btn btn-outline btn-sm" onclick="_statsOffset=Math.max(0,_statsOffset-1);renderPeriodStats()">Sau ‚Üí</button>`:''}
        ${!isFirst?`<button class="btn btn-ghost btn-sm" onclick="_statsOffset=0;renderPeriodStats()">Hi·ªán t·∫°i</button>`:''}
      </div>
    </div>

    <!-- Vocab learned highlight -->
    <div style="background:linear-gradient(135deg,var(--teal-light),rgba(8,145,178,.08));border:2px solid rgba(13,148,136,.25);border-radius:var(--radius);padding:18px 20px;margin-bottom:14px;display:flex;align-items:center;gap:16px;flex-wrap:wrap">
      <div style="flex:1;min-width:120px">
        <div style="font-size:12px;font-weight:700;color:var(--teal);text-transform:uppercase;letter-spacing:.07em;margin-bottom:4px">
          üìñ T·ª´ v·ª±ng h·ªçc ƒë∆∞·ª£c ${_statsPeriod==='day'?'h√¥m nay':_statsPeriod==='week'?'tu·∫ßn n√†y':_statsPeriod==='month'?'th√°ng n√†y':_statsPeriod==='quarter'?'qu√Ω n√†y':'nƒÉm nay'}
        </div>
        <div style="font-family:var(--font-d);font-size:42px;font-weight:900;color:var(--teal);line-height:1">${totalLearnedWords}</div>
        <div style="font-size:12px;color:var(--ink3);margin-top:4px">t·ª´ v·ª±ng ƒë·∫°t y√™u c·∫ßu</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:8px;min-width:140px">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
          <span style="font-size:12px;color:var(--ink3)">‚åÄ M·ªói ng√†y h·ªçc</span>
          <span style="font-family:var(--font-d);font-weight:800;color:var(--teal);font-size:16px">${avgPerDay} t·ª´</span>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
          <span style="font-size:12px;color:var(--ink3)">üìÖ Ng√†y c√≥ h·ªçc</span>
          <span style="font-family:var(--font-d);font-weight:800;color:var(--violet);font-size:16px">${totalStudied}${_statsPeriod!=='day'?' ng√†y':''}</span>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
          <span style="font-size:12px;color:var(--ink3)">üéØ ƒê·ªô ch√≠nh x√°c</span>
          <span style="font-family:var(--font-d);font-weight:800;color:var(--amber);font-size:16px">${acc}%</span>
        </div>
      </div>
    </div>

    <!-- Summary stats -->
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:16px">
      ${[
        {icon:'üìñ',val:totalLearnedWords,lbl:'T·ª´ h·ªçc ƒë∆∞·ª£c',c:'var(--teal)'},
        {icon:'‚úÖ',val:totalCorrect,lbl:'L∆∞·ª£t ƒë√∫ng',c:'#059669'},
        {icon:'üéØ',val:acc+'%',lbl:'Ch√≠nh x√°c',c:'var(--amber)'},
        {icon:'‚ùå',val:totalWrong,lbl:'L∆∞·ª£t sai',c:'var(--rose)'},
      ].map(s=>`<div class="card" style="padding:12px;text-align:center">
        <div style="font-size:18px;margin-bottom:4px">${s.icon}</div>
        <div style="font-family:var(--font-d);font-size:${String(s.val).length>5?'15':'22'}px;font-weight:900;color:${s.c}">${s.val}</div>
        <div style="font-size:11px;color:var(--ink3);margin-top:2px">${s.lbl}</div>
      </div>`).join('')}
    </div>

    <!-- Bar chart -->
    <div class="card" style="margin-bottom:16px">
      <div style="font-family:var(--font-d);font-weight:700;font-size:14px;margin-bottom:14px">üìä Bi·ªÉu ƒë·ªì s·ªë t·ª´ ƒë√∫ng</div>
      <div style="display:flex;align-items:flex-end;gap:${chartData.length>10?'4':'8'}px;height:100px;padding-bottom:0">
        ${chartData.map(item=>{
          const h = Math.round(item.val/maxVal*80)+4;
          return`<div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;min-width:0">
            <div style="font-size:10px;font-weight:700;color:var(--ink3)">${item.val>0?item.val:''}</div>
            <div style="width:100%;border-radius:4px 4px 0 0;background:${item.val>0?'linear-gradient(180deg,var(--teal-mid),var(--teal))':'var(--bg2)'};height:${item.val>0?h:4}px;transition:height .4s"></div>
            <div style="font-size:${chartData.length>10?'9':'10'}px;color:var(--ink4);font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%">${item.label}</div>
          </div>`;
        }).join('')}
      </div>
    </div>

    <!-- Daily detail for week view -->
    ${_statsPeriod==='week'?`
    <div class="card" style="margin-bottom:16px">
      <div style="font-family:var(--font-d);font-weight:700;font-size:14px;margin-bottom:12px">üìã Chi ti·∫øt t·ª´ng ng√†y</div>
      <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:6px">
        ${dates.map((d,i)=>{
          const dayNames=['T2','T3','T4','T5','T6','T7','CN'];
          const k=getDateKey(d);
          const day=dayMap[k]||{correct:0,wrong:0,total:0};
          const isToday=getDateKey(d)===getDateKey(today);
          const isFut=d>today;
          let bg='var(--surface2)', border='var(--border)', icon='‚Äî', txtColor='var(--ink4)';
          if(isToday){bg='var(--teal-light)';border='rgba(13,148,136,.35)';icon='üî•';txtColor='var(--teal)';}
          else if(isFut){icon='¬∑';}
          else if(day.total===0){bg='var(--rose-light)';border='#fecdd3';icon='üò¥';txtColor='var(--rose)';}
          else if(day.correct>=Math.floor(goal*.7)){bg='var(--teal-light)';border='rgba(13,148,136,.3)';icon='‚úÖ';txtColor='var(--teal)';}
          else{bg='var(--amber-light)';border='#fde68a';icon='üìù';txtColor='var(--amber)';}
          return`<div style="background:${bg};border:1.5px solid ${border};border-radius:8px;padding:8px 4px;text-align:center">
            <div style="font-size:11px;font-weight:700;color:${txtColor};margin-bottom:2px">${dayNames[i]}</div>
            <div style="font-size:16px;margin-bottom:2px">${icon}</div>
            ${day.total>0?`<div style="font-size:10px;font-weight:700;color:${txtColor}">${day.correct}/${day.total}</div>`:''}
            ${day.total>0&&!isToday?`<div style="font-size:9px;color:var(--ink4)">${Math.round(day.correct/day.total*100)}%</div>`:''}
          </div>`;
        }).join('')}
      </div>
      ${dates.some(d=>(dayMap[getDateKey(d)]||{}).results?.length>0)?`
      <div style="margin-top:14px;border-top:1px solid var(--border);padding-top:12px">
        <div style="font-size:12px;font-weight:700;color:var(--ink3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px">T·ª´ ƒë√£ h·ªçc trong k·ª≥</div>
        <div style="display:flex;flex-wrap:wrap;gap:5px">
          ${dates.flatMap(d=>(dayMap[getDateKey(d)]||{}).results||[]).map(r=>{
            const w=S.vocab.find(v=>v.id==r.id); if(!w) return '';
            const col=r.correct?'var(--teal)':'var(--rose)'; const bg=r.correct?'var(--teal-light)':'var(--rose-light)';
            return`<span style="background:${bg};color:${col};border-radius:20px;padding:3px 9px;font-size:12px;font-weight:600">${r.correct?'‚úì':'‚úó'} ${w.word}</span>`;
          }).join('')}
        </div>
      </div>`:''}
    </div>`:''}
  `;
}

// Keep legacy alias
let _statsWeekOffset = 0;
function renderWeekStats(){
  _statsPeriod='week'; _statsOffset=_statsWeekOffset;
  renderPeriodStats();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   REVIEW ENGINE ‚Äî √în t·∫≠p to√†n b·ªô t·ª´ ƒë√£ h·ªçc, ch·ªâ tr·∫Øc nghi·ªám
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let _reviewSession = null;

function renderReviewSetup(){
  const el = document.getElementById('rdp-review-view');
  // L·∫•y to√†n b·ªô t·ª´ ƒë√£ t·ª´ng h·ªçc (c√≥ trong log) + t·ª´ ƒë√£ ƒë√°nh d·∫•u learned
  const allLogged = new Set();
  const rdp = getRdpState();
  Object.values(rdp.logs||{}).forEach(log=>{
    (log.results||[]).forEach(r=>allLogged.add(r.id));
  });
  const reviewPool = S.vocab.filter(v => v.learned || allLogged.has(v.id));

  if(!reviewPool.length){
    el.innerHTML = `<div class="empty-state">
      <div class="empty-icon">üì≠</div>
      <div class="empty-title">Ch∆∞a c√≥ t·ª´ ƒë·ªÉ √¥n t·∫≠p</div>
      <div class="empty-sub">H√£y h·ªçc m·ªôt v√†i bu·ªïi tr∆∞·ªõc, t·ª´ ƒë√£ h·ªçc s·∫Ω xu·∫•t hi·ªán ·ªü ƒë√¢y ƒë·ªÉ √¥n l·∫°i.</div>
      <button class="btn btn-primary" onclick="switchRdpTab('quiz10',document.querySelectorAll('.rdp-tab')[2])">üß© B·∫Øt ƒë·∫ßu h·ªçc</button>
    </div>`;
    return;
  }

  const total = reviewPool.length;
  const presets = [10,20,30,50].filter(n=>n<=total);
  if(!presets.includes(total) && total<=100) presets.push(total);

  el.innerHTML = `
    <div class="card" style="margin-bottom:14px">
      <div style="font-family:var(--font-d);font-size:18px;font-weight:800;margin-bottom:4px">üîÅ √în t·∫≠p t·ª´ v·ª±ng</div>
      <div style="font-size:13px;color:var(--ink3);margin-bottom:18px">Tr·∫Øc nghi·ªám ng·∫´u nhi√™n t·ª´ <strong>${total}</strong> t·ª´ b·∫°n ƒë√£ h·ªçc tr∆∞·ªõc ƒë√≥</div>

      <!-- Pool info -->
      <div style="display:flex;gap:10px;margin-bottom:18px;flex-wrap:wrap">
        <div style="flex:1;min-width:100px;background:var(--teal-light);border:1.5px solid rgba(13,148,136,.2);border-radius:var(--radius-sm);padding:14px;text-align:center">
          <div style="font-family:var(--font-d);font-size:28px;font-weight:900;color:var(--teal)">${total}</div>
          <div style="font-size:12px;color:var(--ink3);margin-top:2px">üìñ T·ª´ c√≥ th·ªÉ √¥n</div>
        </div>
        <div style="flex:1;min-width:100px;background:var(--violet-light);border:1.5px solid rgba(124,58,237,.15);border-radius:var(--radius-sm);padding:14px;text-align:center">
          <div style="font-family:var(--font-d);font-size:28px;font-weight:900;color:var(--violet)">${S.vocab.filter(v=>v.learned).length}</div>
          <div style="font-size:12px;color:var(--ink3);margin-top:2px">‚úÖ ƒê√£ h·ªçc thu·ªôc</div>
        </div>
        <div style="flex:1;min-width:100px;background:var(--amber-light);border:1.5px solid rgba(245,158,11,.2);border-radius:var(--radius-sm);padding:14px;text-align:center">
          <div style="font-family:var(--font-d);font-size:28px;font-weight:900;color:var(--amber)">${reviewPool.filter(v=>!v.learned).length}</div>
          <div style="font-size:12px;color:var(--ink3);margin-top:2px">üìù Ch∆∞a thu·ªôc</div>
        </div>
      </div>

      <!-- Ch·ªçn s·ªë l∆∞·ª£ng t·ª´ -->
      <div style="margin-bottom:18px">
        <label class="flbl" style="margin-bottom:10px">Ch·ªçn s·ªë l∆∞·ª£ng t·ª´ √¥n t·∫≠p</label>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px">
          ${presets.map(n=>`
            <button class="rev-preset-btn ${n===Math.min(20,total)?'active':''}"
              onclick="setReviewCount(${n},this)"
              style="padding:8px 16px;border-radius:8px;border:2px solid ${n===Math.min(20,total)?'var(--teal)':'var(--border2)'};
              background:${n===Math.min(20,total)?'var(--teal-light)':'var(--surface)'};
              color:${n===Math.min(20,total)?'var(--teal)':'var(--ink2)'};
              font-weight:700;font-size:14px;cursor:pointer;transition:all .15s">
              ${n===total?'T·∫•t c·∫£ ('+n+')':n+' t·ª´'}
            </button>`).join('')}
        </div>
        <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
          <label class="flbl" style="margin:0;white-space:nowrap">Ho·∫∑c nh·∫≠p th·ªß c√¥ng:</label>
          <input type="number" id="review-custom-count"
            value="${Math.min(20,total)}" min="5" max="${total}"
            style="width:90px;padding:8px 12px;border:1.5px solid var(--border2);border-radius:8px;font-size:14px;font-weight:700;color:var(--ink);background:var(--surface);outline:none;font-family:var(--font-b)"
            oninput="syncReviewCount(this.value)">
          <span style="font-size:13px;color:var(--ink3)">/ ${total} t·ª´ t·ªëi ƒëa</span>
        </div>
      </div>

      <!-- L·ªçc ngu·ªìn t·ª´ -->
      <div style="margin-bottom:18px">
        <label class="flbl" style="margin-bottom:8px">Ngu·ªìn t·ª´ √¥n t·∫≠p</label>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:13px;font-weight:600;color:var(--ink2)">
            <input type="radio" name="rev-source" value="all" checked style="accent-color:var(--teal)"> T·∫•t c·∫£ t·ª´ ƒë√£ h·ªçc
          </label>
          <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:13px;font-weight:600;color:var(--ink2)">
            <input type="radio" name="rev-source" value="notlearned" style="accent-color:var(--teal)"> Ch·ªâ t·ª´ ch∆∞a thu·ªôc
          </label>
          <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:13px;font-weight:600;color:var(--ink2)">
            <input type="radio" name="rev-source" value="learned" style="accent-color:var(--teal)"> Ch·ªâ t·ª´ ƒë√£ thu·ªôc
          </label>
        </div>
      </div>

      <button class="btn btn-primary" style="width:100%;font-size:15px;padding:14px"
        onclick="startReviewSession()">
        üöÄ B·∫Øt ƒë·∫ßu √¥n t·∫≠p
      </button>
    </div>
  `;
  // Store pool globally for session
  window._reviewPool = reviewPool;
  window._reviewCount = Math.min(20, total);
}

function setReviewCount(n, btn){
  window._reviewCount = n;
  document.getElementById('review-custom-count').value = n;
  document.querySelectorAll('.rev-preset-btn').forEach(b=>{
    const isThis = b===btn;
    b.style.border = isThis?'2px solid var(--teal)':'2px solid var(--border2)';
    b.style.background = isThis?'var(--teal-light)':'var(--surface)';
    b.style.color = isThis?'var(--teal)':'var(--ink2)';
  });
}

function syncReviewCount(val){
  const n = parseInt(val)||10;
  window._reviewCount = n;
  // deselect all presets
  document.querySelectorAll('.rev-preset-btn').forEach(b=>{
    b.style.border='2px solid var(--border2)';
    b.style.background='var(--surface)';
    b.style.color='var(--ink2)';
  });
}

function startReviewSession(){
  const sourceVal = document.querySelector('input[name="rev-source"]:checked')?.value || 'all';
  const rdp = getRdpState();
  const allLogged = new Set();
  Object.values(rdp.logs||{}).forEach(log=>{
    (log.results||[]).forEach(r=>allLogged.add(r.id));
  });
  let pool = S.vocab.filter(v => v.learned || allLogged.has(v.id));
  if(sourceVal === 'notlearned') pool = pool.filter(v=>!v.learned);
  else if(sourceVal === 'learned') pool = pool.filter(v=>v.learned);

  if(!pool.length){
    showToast('Kh√¥ng c√≥ t·ª´ ph√π h·ª£p v·ªõi b·ªô l·ªçc!','error');
    return;
  }

  const count = Math.max(1, Math.min(parseInt(window._reviewCount)||20, pool.length));
  const words = shuffle(pool).slice(0, count);

  // Build MC questions
  const questions = words.map(w=>{
    const others = shuffle(S.vocab.filter(x=>x.id!==w.id));
    const opts = shuffle([w, ...others.slice(0,3)]).map(x=>({label:x.meaning, id:String(x.id)}));
    return { word:w, opts, correct:String(w.id), _answered:false, _correct:false, _selectedId:null };
  });

  _reviewSession = {
    questions, current:0, correct:0, wrong:0, missed:[],
    total: questions.length
  };
  showReviewQuestion();
}

function showReviewQuestion(){
  const el = document.getElementById('rdp-review-view');
  const s = _reviewSession;
  if(!s){ renderReviewSetup(); return; }
  if(s.current >= s.questions.length){ showReviewResult(); return; }

  const q = s.questions[s.current];
  const w = q.word;
  const pct = Math.round(s.current/s.total*100);

  const topbar = `
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
      <div style="flex:1">
        <div style="display:flex;justify-content:space-between;font-size:11px;font-weight:700;color:var(--ink4);margin-bottom:4px">
          <span>C√¢u ${s.current+1} / ${s.total}</span><span>${pct}%</span>
        </div>
        <div style="height:6px;background:var(--bg2);border-radius:3px;overflow:hidden">
          <div style="height:100%;width:${pct}%;background:linear-gradient(90deg,var(--violet),var(--teal));border-radius:3px;transition:width .3s"></div>
        </div>
      </div>
      <div style="font-size:12px;font-weight:700;color:var(--teal)">‚úÖ ${s.correct} &nbsp;‚ùå ${s.wrong}</div>
    </div>
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;gap:8px">
      <button onclick="revPrevQ()" ${s.current===0?'disabled':''}
        style="padding:6px 14px;border:1.5px solid var(--border);border-radius:8px;background:var(--surface);cursor:pointer;font-size:12px;font-weight:600;color:var(--ink3);${s.current===0?'opacity:.35;cursor:default':''}">
        ‚Üê Tr∆∞·ªõc
      </button>
      <button onclick="revNextQ()" ${q._answered?'':'disabled'}
        style="padding:6px 14px;border:1.5px solid var(--border);border-radius:8px;background:var(--surface);cursor:pointer;font-size:12px;font-weight:600;${q._answered?'color:var(--teal);border-color:var(--teal)':'color:var(--ink4);opacity:.4;cursor:not-allowed'}">
        Ti·∫øp ‚Üí
      </button>
    </div>`;

  const optHtml = q.opts.map((o,i)=>{
    let cls = 'opt';
    if(q._answered){
      if(o.id===q.correct) cls+=' correct';
      else if(q._selectedId===o.id) cls+=' wrong';
      cls+=' disabled';
    }
    return `<button class="${cls}" ${q._answered?'disabled':''} data-id="${o.id}"
      onclick="revCheckMC(this,'${o.id}','${q.correct}')">
      <span class="opt-letter">${['A','B','C','D'][i]}</span>${o.label}
    </button>`;
  }).join('');

  const feedbackHtml = q._answered ? (q._correct
    ? `<div class="qz-feedback ok" style="margin-top:10px"><div class="qz-feedback-icon">üéâ</div><div class="qz-feedback-msg"><div class="qz-feedback-title ok">Ch√≠nh x√°c!</div></div></div>`
    : `<div class="qz-feedback err" style="margin-top:10px"><div class="qz-feedback-icon">üí°</div><div class="qz-feedback-msg"><div class="qz-feedback-title err">Ch∆∞a ƒë√∫ng!</div><div class="qz-feedback-sub">ƒê√°p √°n: <strong>${q._feedbackLabel||''}</strong></div></div></div>`
  ) : '';

  el.innerHTML = topbar + `
    <div class="qz-card">
      <div style="font-size:11px;font-weight:700;color:var(--violet);text-transform:uppercase;letter-spacing:.07em;margin-bottom:8px">üîÅ √în t·∫≠p ¬∑ Tr·∫Øc nghi·ªám</div>
      <div class="qz-word-hero">${w.word}
        <button style="font-size:12px;padding:4px 10px;margin-left:8px;vertical-align:middle;background:var(--teal-light);border:1px solid rgba(13,148,136,.2);border-radius:20px;cursor:pointer;color:var(--teal)" onclick="speak('${w.word.replace(/'/,"\'")}')" >üîä</button>
      </div>
      ${w.ipa?`<div class="qz-word-ipa">${w.ipa}</div>`:''}
      ${w.example?`<div class="qz-sentence" style="margin-bottom:10px">"${w.example}"</div>`:''}
      <div class="qz-question" style="margin-bottom:12px">T·ª´ n√†y c√≥ nghƒ©a l√† g√¨?</div>
      <div class="opts">${optHtml}</div>
      ${feedbackHtml}
    </div>`;
}

function revCheckMC(btn, selId, correctId){
  const s = _reviewSession;
  const q = s?.questions[s.current];
  if(!q || q._answered) return;
  const correctOpt = q.opts.find(o=>o.id===correctId);
  const lbl = correctOpt?correctOpt.label:'';
  q._selectedId = selId;
  const isOk = selId===correctId;
  q._answered = true; q._correct = isOk; q._feedbackLabel = lbl;
  if(isOk){ s.correct++; gainXP(5); }
  else { s.wrong++; s.missed.push({word:q.word, answer:lbl}); }
  showReviewQuestion();
}

function revPrevQ(){
  if(!_reviewSession || _reviewSession.current<=0) return;
  _reviewSession.current--;
  showReviewQuestion();
}

function revNextQ(){
  const s = _reviewSession;
  if(!s) return;
  const q = s.questions[s.current];
  if(!q || !q._answered){ showToast('H√£y tr·∫£ l·ªùi c√¢u n√†y tr∆∞·ªõc!','error'); return; }
  s.current++;
  showReviewQuestion();
}

function showReviewResult(){
  const s = _reviewSession;
  const { correct, wrong, missed, total } = s;
  const score = total ? Math.round(correct/total*100) : 100;
  const xp = correct*5;
  const emoji = score>=90?'üèÜ':score>=70?'üåü':score>=50?'üëç':'üí™';
  const title = score>=90?'Xu·∫•t s·∫Øc!':score>=70?'T·ªët l·∫Øm!':score>=50?'Kh√° ·ªïn!':'C·ªë g·∫Øng th√™m!';

  const missedUniq = [...new Map(missed.map(m=>[m.word.id,m])).values()];
  const reviewHtml = missedUniq.length ? `
    <div class="qz-review" style="margin-top:16px">
      <div style="padding:12px 14px;font-size:12px;font-weight:800;color:var(--ink3);text-transform:uppercase;letter-spacing:.07em;border-bottom:1px solid var(--border);background:var(--surface2);border-radius:12px 12px 0 0">
        üìã T·ª´ c·∫ßn √¥n th√™m (${missedUniq.length})
      </div>
      ${missedUniq.map(m=>`<div class="qz-review-item">
        <div class="qz-review-word">${m.word.word}</div>
        <div class="qz-review-right">
          <span style="color:var(--ink3)">ƒê√∫ng: </span><strong>${m.answer}</strong><br>
          <span style="color:var(--ink4);font-size:11px;font-style:italic">${m.word.meaning}</span>
        </div></div>`).join('')}
    </div>` : '';

  document.getElementById('rdp-review-view').innerHTML = `
    <div class="qz-result">
      <span class="qz-result-emoji">${emoji}</span>
      <div class="qz-result-title">${title}</div>
      <div style="font-size:13px;color:var(--ink3);margin-bottom:4px">√în t·∫≠p <strong>${total} t·ª´</strong></div>
      <div class="qz-score-circle" style="border-color:var(--violet)">
        <div class="qz-score-num" style="color:var(--violet)">${score}%</div>
        <div class="qz-score-lbl">ƒëi·ªÉm</div>
      </div>
      <div class="qz-stat-row">
        <div class="qz-stat"><span class="qz-stat-val" style="color:var(--teal)">${correct}</span><div class="qz-stat-lbl">‚úÖ ƒê√∫ng</div></div>
        <div class="qz-stat"><span class="qz-stat-val" style="color:var(--rose)">${wrong}</span><div class="qz-stat-lbl">‚ùå Sai</div></div>
        <div class="qz-stat"><span class="qz-stat-val" style="color:var(--amber)">+${xp}</span><div class="qz-stat-lbl">‚ö° XP</div></div>
      </div>
      ${reviewHtml}
      <div style="display:flex;flex-direction:column;gap:10px;margin-top:20px;max-width:320px;margin-left:auto;margin-right:auto">
        <button class="btn btn-primary" style="font-size:14px;padding:13px;background:var(--violet);border-color:var(--violet)"
          onclick="renderReviewSetup()">üîÅ √în t·∫≠p l·∫°i</button>
        ${missedUniq.length?`<button class="btn btn-outline" style="font-size:14px;padding:12px;border-color:var(--rose);color:var(--rose)"
          onclick="startReviewWithWords(${JSON.stringify(missedUniq.map(m=>m.word.id))})">
          ‚ùå √în l·∫°i ${missedUniq.length} t·ª´ sai
        </button>`:''}
        <button class="btn btn-ghost btn-sm" onclick="switchRdpTab('stats',document.querySelectorAll('.rdp-tab')[1])">üìä Xem th·ªëng k√™</button>
      </div>
    </div>`;
  _reviewSession = null;
}

function startReviewWithWords(ids){
  const words = ids.map(id=>S.vocab.find(v=>String(v.id)===String(id))).filter(Boolean);
  if(!words.length){ renderReviewSetup(); return; }
  const questions = words.map(w=>{
    const others = shuffle(S.vocab.filter(x=>x.id!==w.id));
    const opts = shuffle([w,...others.slice(0,3)]).map(x=>({label:x.meaning, id:String(x.id)}));
    return { word:w, opts, correct:String(w.id), _answered:false, _correct:false, _selectedId:null };
  });
  _reviewSession = { questions, current:0, correct:0, wrong:0, missed:[], total:questions.length };
  showReviewQuestion();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ROADMAP QUIZ ENGINE ‚Äî Full 3-step (same as topic quiz)
   State: _rdpSession = { words, questions, current, correct, wrong, lives, missed, batchIdx, extraMode }
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let _rdpSession = null;

/* L·∫•y t·ª´ h√¥m nay (goal) ho·∫∑c t·ª´ b·ªï sung n·∫øu extraMode */
function getRdpWords(extra=false){
  const rdp = getRdpState();
  const goal = rdp.dailyGoal || 10;
  if(!extra) return getTodayWords(goal);
  // Extra: l·∫•y c√°c t·ª´ KH√ÅC v·ªõi set h√¥m nay V√Ä ch∆∞a h·ªçc ng√†y tr∆∞·ªõc
  const today=getDateKey();
  const logs=rdp.logs||{};
  const studiedBefore=new Set();
  Object.entries(logs).forEach(([dateKey,log])=>{
    if(dateKey===today) return;
    (log.results||[]).forEach(r=>studiedBefore.add(String(r.id)));
  });
  const todaySet = new Set(getTodayWords(goal).map(w=>String(w.id)));
  const topicFilter = rdp.topicFilter||[];
  const vocabPool = topicFilter.length>0 ? S.vocab.filter(v=>topicFilter.includes(v.topic)) : S.vocab;
  // ∆Øu ti√™n: t·ª´ ch∆∞a bao gi·ªù h·ªçc, kh√¥ng n·∫±m trong set h√¥m nay
  let pool = vocabPool.filter(v => !todaySet.has(String(v.id)) && !studiedBefore.has(String(v.id)) && !v.learned);
  if(rdp.topicPriority && !topicFilter.length) pool=[...pool.filter(v=>v.topic===rdp.topicPriority),...pool.filter(v=>v.topic!==rdp.topicPriority)];
  if(pool.length < goal){
    // B·ªï sung t·ª´ ƒë√£ h·ªçc ng√†y tr∆∞·ªõc n·∫øu kh√¥ng ƒë·ªß
    const extra2=vocabPool.filter(v=>!todaySet.has(String(v.id))&&!pool.find(x=>x.id===v.id));
    pool=[...pool,...extra2];
  }
  return shuffle(pool).slice(0, goal);
}

function buildRdpQuestions(words){
  const all = S.vocab;
  const q = [];
  words.forEach(w => {
    const others = shuffle(all.filter(x => x.id !== w.id));
    /* Step 1: Tr·∫Øc nghi·ªám */
    const mcOpts = shuffle([w, ...others.slice(0,3)]).map(x=>({label:x.meaning, id:String(x.id)}));
    q.push({ step:1, type:'meaning-mc', word:w, opts:mcOpts, correct:String(w.id) });
    /* Step 2: ƒêi·ªÅn t·ª´ */
    const exFill = (w.example||'').replace(/\s*[\(\Ôºà][^\)\Ôºâ]*[\)\Ôºâ]/g,'').replace(/\s*[\u2014\u2013-]\s*[^\x00-\x7F].*$/u,'').trim();
    q.push({ step:2, type:'fill-blank', word:w, sent:exFill, correct:w.word.toLowerCase() });
    /* Step 3: S·∫Øp x·∫øp c√¢u */
    const exampleRaw = w.example || `I use the word ${w.word} every day`;
    const enOnly = exampleRaw.replace(/\s*[\(\Ôºà][^\)\Ôºâ]*[\)\Ôºâ]/g,'').replace(/\s*[‚Äî‚Äì-]\s*[^\x00-\x7F].*$/u,'').replace(/\s{2,}/g,' ').trim();
    // Strip m·ªçi d·∫•u c√¢u + k√Ω t·ª± Unicode ·∫©n ‚Äî ƒë√¢y l√† ngu·ªìn duy nh·∫•t ƒë·ªÉ so s√°nh
    const rawBase = (enOnly||`I use the word ${w.word} every day`);
    const raw = rawBase
      .replace(/[\u00A0\u200B\u200C\u200D\uFEFF\u2060]/g, ' ')
      .replace(/[.!?,;:'"()\[\]{}]/g, '')
      .replace(/\s+/g, ' ')
      .trim();
    const toks = shuffle(raw.split(' ').filter(Boolean));
    q.push({ step:3, type:'word-builder', word:w, sentence:raw, tokens:toks });
  });
  return q;
}

function renderRdpQuiz10(extra=false){
  const rdp = getRdpState();
  const goal = rdp.dailyGoal || 10;
  const words = getRdpWords(extra);

  if(!words.length){
    document.getElementById('rdp-quiz10-view').innerHTML=`
      <div class="empty-state">
        <div class="empty-icon">üì≠</div>
        <div class="empty-title">Ch∆∞a c√≥ t·ª´ v·ª±ng</div>
        <div class="empty-sub">Import t·ª´ v·ª±ng ƒë·ªÉ b·∫Øt ƒë·∫ßu h·ªçc theo l·ªô tr√¨nh</div>
        <button class="btn btn-primary" onclick="showPanel('import')">üì• Import t·ª´ v·ª±ng</button>
      </div>`;
    return;
  }

  const questions = buildRdpQuestions(words);
  _rdpSession = {
    words, questions, current:0, correct:0, wrong:0,
    lives:3, missed:[], batchIdx:0,
    extraMode: extra, savedToLog: false
  };
  _rdpQzPicked = [];
  showRdpQuestion();
}

/* Picked array for word-builder in roadmap */
let _rdpQzPicked = [];

function showRdpQuestion(){
  const el = document.getElementById('rdp-quiz10-view');
  const s = _rdpSession;
  if(!s){ renderRdpQuiz10(); return; }

  const { questions, current, correct, wrong, lives, words } = s;

  if(current >= questions.length){
    showRdpResult();
    return;
  }

  const q = questions[current];
  const w = q.word;
  const total = questions.length;
  const pct = Math.round(current / total * 100);
  const hp = Math.max(0, lives ?? 3);
  const hearts = [0,1,2].map(i => `<span class="qz-heart ${i >= hp ? 'lost' : ''}">‚ù§Ô∏è</span>`).join('');
  const stepTxt = `B∆∞·ªõc ${q.step}/3`;
  const wordIdx = Math.floor(current / 3) + 1;
  const wordTotal = Math.ceil(total / 3);

  // Step indicator
  const labels = ['Tr·∫Øc nghi·ªám','ƒêi·ªÅn t·ª´','S·∫Øp x·∫øp c√¢u'];
  const icons  = ['üÖê','‚úèÔ∏è','üîÄ'];
  const badge = `<div style="display:flex;gap:8px;margin-bottom:14px;align-items:center;flex-wrap:wrap">
    ${[1,2,3].map(sn=>`<div style="display:flex;align-items:center;gap:5px;padding:5px 10px;border-radius:20px;
      background:${sn===q.step?'var(--teal)':sn<q.step?'var(--teal-light)':'var(--bg2)'};
      border:1.5px solid ${sn===q.step?'var(--teal)':sn<q.step?'rgba(13,148,136,.3)':'var(--border)'};
      font-size:12px;font-weight:700;
      color:${sn===q.step?'#fff':sn<q.step?'var(--teal)':'var(--ink4)'}">
      ${sn<q.step?'‚úì':icons[sn-1]} ${labels[sn-1]}</div>`).join('')}
  </div>`;

  // Top bar
  const topbar = `<div class="qz-topbar">
    <div style="flex:1;min-width:0">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px">
        <span style="font-size:11px;font-weight:700;color:var(--ink4)">T·ª´ ${wordIdx}/${wordTotal} ¬∑ ${stepTxt}</span>
        <span style="font-size:11px;font-weight:700;color:var(--ink3)">${pct}%</span>
      </div>
      <div class="qz-pbar-wrap"><div class="qz-pbar-fill" style="width:${pct}%"></div></div>
    </div>
    <div class="qz-lives" style="margin-left:10px">${hearts}</div>
  </div>
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;gap:8px">
    <button class="btn btn-ghost btn-sm" id="rdp-prev-btn"
      onclick="rdpPrevQ()"
      ${current===0?'disabled':''}
      style="font-size:12px;padding:6px 12px;border:1.5px solid var(--border);border-radius:8px;${current===0?'opacity:.35;cursor:default':''}">
      ‚Üê Tr∆∞·ªõc
    </button>
    <span style="font-size:12px;color:var(--ink4);font-weight:600">${current+1} / ${total}</span>
    <button class="btn btn-ghost btn-sm" id="rdp-next-btn"
      onclick="rdpNextQ()"
      ${(q._answered && q._correct) ? '' : 'disabled'}
      style="font-size:12px;padding:6px 12px;border:1.5px solid var(--border);border-radius:8px;${(q._answered && q._correct) ? '' : 'opacity:.35;cursor:not-allowed'}">
      Ti·∫øp ‚Üí
    </button>
  </div>`;

  let card = '';
  /* Step 1 */
  if(q.type==='meaning-mc'){
    card = `<div class="qz-card">
      ${badge}
      <div class="qz-type-label">üá¨üáß Ch·ªçn nghƒ©a ƒë√∫ng</div>
      <div class="qz-word-hero">${w.word}
        <button class="audio-chip" style="font-size:12px;padding:4px 10px;margin-left:8px;vertical-align:middle" onclick="speak('${esc(w.word)}')">üîä</button>
      </div>
      <div class="qz-word-ipa">${w.ipa||''}</div>
      ${w.example?`<div class="qz-sentence">"${w.example}"</div>`:''}
      <div class="qz-question">T·ª´ n√†y c√≥ nghƒ©a l√† g√¨?</div>
      <div class="opts">
        ${q.opts.map((o,i)=>{
          let cls='opt';
          if(q._answered){ if(o.id===q.correct) cls+=' correct'; else if(q._selectedId===o.id) cls+=' wrong'; cls+=' disabled'; }
          return `<button class="${cls}" ${q._answered?'disabled':''} data-id="${o.id}" onclick="rdpCheckMC(this,'${o.id}','${q.correct}')">
            <span class="opt-letter">${['A','B','C','D'][i]}</span>${o.label}
          </button>`;}).join('')}
      </div>
      ${q._answered?rdpFeedbackHtml(q._correct, q._feedbackLabel):''}
    </div>`;
  }
  /* Step 2 */
  else if(q.type==='fill-blank'){
    const display = q.sent
      ? q.sent.replace(new RegExp('\\b'+q.word.word+'\\b','i'), `<span class="qz-blank">_____</span>`)
      : `<span class="qz-blank">_____</span>`;
    card = `<div class="qz-card">
      ${badge}
      <div class="qz-type-label">‚úèÔ∏è ƒêi·ªÅn t·ª´ c√≤n thi·∫øu</div>
      <div style="margin-bottom:8px;display:flex;align-items:center;gap:10px;flex-wrap:wrap">
        <div id="rdp-fill-hidden" style="display:${q._answered?'none':'inline-flex'};align-items:center;gap:8px;background:var(--bg2);border:2px dashed var(--border2);border-radius:10px;padding:6px 14px;cursor:pointer" onclick="rdpRevealFill()" title="Nh·∫•n ƒë·ªÉ xem t·ª´">
          <span style="font-size:18px;font-weight:800;color:var(--ink4);letter-spacing:3px">${'?'.repeat(Math.min(w.word.length,6))}</span>
          <span style="font-size:11px;color:var(--ink4);font-weight:600">üëÅ Hi·ªán t·ª´</span>
        </div>
        <div id="rdp-fill-revealed" style="display:${q._answered?'inline-flex':'none'};align-items:baseline;gap:8px">
          <span class="qz-word-hero" style="font-size:20px">${w.word}</span>
          <span class="qz-word-ipa">&nbsp;${w.ipa||''}</span>
        </div>
      </div>
      <div class="qz-sentence">${display}</div>
      <div style="font-size:13px;color:var(--ink3);margin-bottom:12px">üí° G·ª£i √Ω: <strong>${w.meaning}</strong></div>
      <input class="fill-inp ${q._answered?(q._correct?'correct':'wrong'):''}" id="rdp-fill-ans"
        value="${q._answered?(q._userAns||''):''}"
        placeholder="Nh·∫≠p t·ª´ ti·∫øng Anh‚Ä¶"
        autocomplete="off" autocorrect="off" autocapitalize="off"
        ${q._answered?'disabled':''}
        onkeydown="if(event.key==='Enter')rdpCheckFill()">
      ${q._answered
        ? rdpFeedbackHtml(q._correct, q.word.word)
        : `<button class="btn btn-primary" style="width:100%;margin-top:6px" onclick="rdpCheckFill()">Ki·ªÉm tra ‚úì</button>`}
    </div>`;
  }
  /* Step 3 */
  else if(q.type==='word-builder'){
    // Reset _rdpQzPicked m·ªói l·∫ßn render word-builder (DOM b·ªã t·∫°o m·ªõi ho√†n to√†n)
    _rdpQzPicked = [];
    let srcChips = '', ansChips = '';
    if(q._answered){
      const sentWords = q.sentence.split(' ').filter(Boolean);
      ansChips = sentWords.map(t=>`<div class="chip placed" style="pointer-events:none">${t}</div>`).join('');
      srcChips = q.tokens.map(t=>`<div class="chip source" style="opacity:.2;pointer-events:none">${t}</div>`).join('');
    } else {
      srcChips = q.tokens.map(t=>`<div class="chip" onclick="rdpPickChip(this)">${t}</div>`).join('');
    }
    card = `<div class="qz-card" id="rdp-wb-card" data-correct="${esc(q.sentence)}">
      ${badge}
      <div class="qz-type-label">üîÄ S·∫Øp x·∫øp th√†nh c√¢u ƒë√∫ng</div>
      <div style="margin-bottom:12px">
        <span class="qz-word-hero" style="font-size:20px">${w.word}</span>
        <span style="font-size:14px;color:var(--ink3)"> ‚Äî ${w.meaning}</span>
      </div>
      <div style="font-size:13px;color:var(--ink3);margin-bottom:8px;font-weight:600">Nh·∫•n t·ª´ng t·ª´ ƒë·ªÉ x√¢y d·ª±ng c√¢u ƒë√∫ng ‚Üì</div>
      <div class="chips-area target" id="rdp-ans-chips" style="min-height:54px">${q._answered?ansChips:''}</div>
      <div style="font-size:12px;color:var(--ink4);margin-bottom:8px">Ngu·ªìn t·ª´:</div>
      <div class="chips-area" id="rdp-src-chips">${srcChips}</div>
      ${q._answered
        ? rdpFeedbackHtml(q._correct, q.sentence)
        : `<div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn btn-outline btn-sm" onclick="rdpClearBuilder()">üîÑ X√≥a</button>
            <button class="btn btn-primary" style="flex:1" onclick="rdpCheckOrder()">Ki·ªÉm tra ‚úì</button>
          </div>`}
    </div>`;
  }

  el.innerHTML = topbar + card;
  // KH√îNG reset _rdpQzPicked ·ªü ƒë√¢y ‚Äî ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω trong block word-builder ·ªü tr√™n

  if(q.type==='fill-blank' && !q._answered) setTimeout(()=>document.getElementById('rdp-fill-ans')?.focus(), 120);
}

function rdpFeedbackHtml(isOk, label){
  if(isOk) return `<div class="qz-feedback ok" style="margin-top:12px">
    <div class="qz-feedback-icon">üéâ</div>
    <div class="qz-feedback-msg"><div class="qz-feedback-title ok">Ch√≠nh x√°c!</div></div>
    <button class="btn btn-primary qz-next-btn" onclick="rdpNextQ()">Ti·∫øp ‚Üí</button>
  </div>`;
  return `<div class="qz-feedback err" style="margin-top:12px">
    <div class="qz-feedback-icon">üí°</div>
    <div class="qz-feedback-msg" style="flex:1">
      <div class="qz-feedback-title err">Ch∆∞a ƒë√∫ng!</div>
      <div class="qz-feedback-sub">ƒê√°p √°n: <strong>${label||''}</strong></div>
    </div>
    <div style="display:flex;flex-direction:column;gap:7px;flex-shrink:0">
      <button class="btn btn-primary qz-next-btn" style="font-size:13px;padding:9px 16px" onclick="rdpRetryQ()">üîÑ L√†m l·∫°i</button>
      <button class="btn btn-outline qz-next-btn" style="font-size:13px;padding:9px 16px;background:#fff" onclick="rdpSkipAfterWrong()">B·ªè qua ‚Üí</button>
    </div>
  </div>`;
}

function rdpMarkAnswered(isOk, feedbackLabel, userAns=''){
  const q = _rdpSession.questions[_rdpSession.current];
  if(q._scored) return;
  q._answered = true; q._correct = isOk; q._feedbackLabel = feedbackLabel; q._userAns = userAns;
  q._scored = true;
  if(isOk){
    _rdpSession.correct++;
    if(!q._retried) gainXP(8);
  } else {
    _rdpSession.wrong++;
    if(_rdpSession.lives>0) _rdpSession.lives--;
    _rdpSession.missed.push({word:q.word, answer:feedbackLabel});
  }
  saveSession();
}

/* B·ªè qua sau khi sai (d√πng trong feedback button) */
function rdpSkipAfterWrong(){
  const s = _rdpSession;
  if(!s) return;
  // ƒê√°nh d·∫•u cho ph√©p ti·∫øn ti·∫øp d√π sai
  const q = s.questions[s.current];
  if(q) q._skipped = true; // flag ƒë·ªÉ topbar next ƒë∆∞·ª£c unlock
  s.current++;
  _rdpQzPicked = [];
  showRdpQuestion();
  saveSession();
}

/* L√†m l·∫°i c√¢u v·ª´a sai ‚Äî reset UI + _scored ƒë·ªÉ check functions ho·∫°t ƒë·ªông l·∫°i
   ƒêi·ªÉm sai ƒë√£ ƒë∆∞·ª£c ghi nh·∫≠n r·ªìi, rdpMarkAnswered s·∫Ω kh√¥ng c·ªông th√™m XP khi ƒë√∫ng l·∫ßn 2 */
function rdpRetryQ(){
  const q = _rdpSession?.questions[_rdpSession.current];
  if(!q) return;
  q._answered = false;
  q._correct  = undefined;
  q._feedbackLabel = undefined;
  q._userAns  = undefined;
  q._selectedId = undefined;
  q._scored   = false;
  q._retried  = true;
  if(q.type === 'word-builder'){
    q.tokens = shuffle(q.sentence.split(' ').filter(Boolean));
  }
  _rdpQzPicked = [];
  showRdpQuestion();
}

function rdpCheckMC(btn, selId, correctId){
  const q = _rdpSession?.questions[_rdpSession.current];
  if(!q || q._scored) return;
  // Extract label BEFORE re-render, from opts data (not DOM)
  const correctOpt = q.opts.find(o => String(o.id) === String(correctId));
  const lbl = correctOpt ? correctOpt.label : '';
  q._selectedId = String(selId);
  const isOk = String(selId) === String(correctId);
  rdpMarkAnswered(isOk, lbl, String(selId));
  showRdpQuestion();
}

function rdpRevealFill(){
  const h=document.getElementById('rdp-fill-hidden'), r=document.getElementById('rdp-fill-revealed');
  if(h)h.style.display='none'; if(r)r.style.display='inline-flex';
}

function rdpCheckFill(){
  const inp = document.getElementById('rdp-fill-ans');
  if(!inp) return;
  const q = _rdpSession?.questions[_rdpSession.current];
  if(!q || q._scored) return;
  const ans = inp.value.trim().toLowerCase();
  if(!ans){ showToast('Nh·∫≠p t·ª´ v√†o tr∆∞·ªõc!','error'); return; }
  const isOk = ans===q.correct || levenshtein(ans,q.correct)<=1;
  rdpMarkAnswered(isOk, q.word.word, ans);
  showRdpQuestion();
}

function rdpPickChip(el){
  if(el.classList.contains('source')) return;
  el.classList.add('source');
  const w = el.textContent.trim();
  _rdpQzPicked.push(w);
  const area = document.getElementById('rdp-ans-chips');
  if(!area) return;
  const placed = document.createElement('div');
  placed.className = 'chip placed';
  placed.textContent = w;
  placed.onclick = function(){
    placed.remove();
    const idx = _rdpQzPicked.lastIndexOf(w);
    if(idx !== -1) _rdpQzPicked.splice(idx, 1);
    const srcs = document.querySelectorAll('#rdp-src-chips .chip');
    for(const c of srcs){
      if(c.textContent.trim()===w && c.classList.contains('source')){
        c.classList.remove('source'); break;
      }
    }
  };
  area.appendChild(placed);
}

function rdpClearBuilder(){
  _rdpQzPicked = [];
  const ans = document.getElementById('rdp-ans-chips');
  if(ans) ans.innerHTML = '';
  document.querySelectorAll('#rdp-src-chips .chip').forEach(c=>{ c.classList.remove('source'); c.style.pointerEvents=''; });
}

function rdpCheckOrder(){
  const q = _rdpSession?.questions[_rdpSession.current];
  if(!q || q._scored) return;
  if(!_rdpQzPicked.length){ showToast('H√£y s·∫Øp x·∫øp √≠t nh·∫•t m·ªôt t·ª´!','error'); return; }

  // So s√°nh t·ª´ng token m·ªôt (case-insensitive) thay v√¨ join chu·ªói
  // tr√°nh m·ªçi v·∫•n ƒë·ªÅ v·ªÅ whitespace, encoding, unicode ·∫©n
  const pickedTokens = _rdpQzPicked.map(t => t.toLowerCase().trim());
  const correctTokens = q.sentence.split(' ').filter(Boolean).map(t => t.toLowerCase().trim());

  let isOk = pickedTokens.length === correctTokens.length;
  if(isOk){
    for(let i = 0; i < correctTokens.length; i++){
      if(pickedTokens[i] !== correctTokens[i]){ isOk = false; break; }
    }
  }
  rdpMarkAnswered(isOk, q.sentence, _rdpQzPicked.join(' '));
  showRdpQuestion();
}

function rdpPrevQ(){
  if(!_rdpSession || _rdpSession.current <= 0) return;
  _rdpSession.current--;
  _rdpQzPicked = [];
  showRdpQuestion();
}

function rdpNextQ(){
  if(!_rdpSession) return;
  const q = _rdpSession.questions[_rdpSession.current];
  // Ch·ªâ cho ti·∫øp n·∫øu ƒë√£ tr·∫£ l·ªùi ƒë√∫ng (ho·∫∑c ƒë√£ b·ªè qua qua n√∫t B·ªè qua trong feedback)
  if(!q || !q._scored){ showToast('H√£y tr·∫£ l·ªùi c√¢u n√†y tr∆∞·ªõc!','error'); return; }
  if(q._answered && !q._correct){
    // V·∫´n ƒëang hi·ªán feedback sai ‚Üí kh√¥ng cho ti·∫øp t·ª´ topbar, ph·∫£i d√πng n√∫t trong feedback
    showToast('Nh·∫•n üîÑ L√†m l·∫°i ho·∫∑c B·ªè qua ‚Üí','error'); return;
  }
  _rdpSession.current++;
  _rdpQzPicked = [];
  showRdpQuestion();
  saveSession();
}

function showRdpResult(){
  const s = _rdpSession;
  const rdp = getRdpState();
  const { words, correct, wrong, missed, extraMode } = s;
  const total = s.questions.length;
  const score = total ? Math.round(correct / total * 100) : 100;
  const xp = correct * 10;

  // Save log only once, only for regular (non-extra) mode
  if(!s.savedToLog && !extraMode){
    const today = getDateKey();
    const r = getRdpState();
    if(!r.logs) r.logs = {};
    const wordResults = words.map(w => {
      const qs = s.questions.filter(q=>q.word.id===w.id);
      const correctCount = qs.filter(q=>q._correct).length;
      return { id: w.id, correct: correctCount >= 2 }; // correct n·∫øu ƒë√∫ng √≠t nh·∫•t 2/3 b∆∞·ªõc
    });
    r.logs[today] = { results: wordResults, xp };
    saveRdpState(r);
    s.savedToLog = true;
    gainXP(xp);
    renderRdpTopStats();
  }

  const emoji = score>=90?'üèÜ':score>=70?'üåü':score>=50?'üëç':'üí™';
  const title = score>=90?'Xu·∫•t s·∫Øc!':score>=70?'T·ªët l·∫Øm!':score>=50?'Kh√° ·ªïn!':'C·ªë g·∫Øng th√™m!';
  const missedUniq = missed ? [...new Map(missed.map(m=>[m.word.id,m])).values()] : [];
  const reviewHtml = missedUniq.length ? `
    <div class="qz-review">
      <div style="padding:12px 14px;font-size:12px;font-weight:800;color:var(--ink3);text-transform:uppercase;letter-spacing:.07em;border-bottom:1px solid var(--border);background:var(--surface2);border-radius:12px 12px 0 0">
        üìã T·ª´ c·∫ßn √¥n l·∫°i (${missedUniq.length})
      </div>
      ${missedUniq.map(m=>`<div class="qz-review-item">
        <div class="qz-review-word">${m.word.word}</div>
        <div class="qz-review-right">
          <span style="color:var(--ink3)">ƒê√°p √°n: </span><strong>${m.answer}</strong><br>
          <span style="color:var(--ink4);font-size:11px;font-style:italic">${m.word.meaning}</span>
        </div></div>`).join('')}
    </div>` : '';

  // Check if there are extra words available
  const goal = rdp.dailyGoal || 10;
  const todaySet = new Set(getTodayWords(goal).map(w=>w.id));
  const extraAvail = S.vocab.filter(v=>!todaySet.has(v.id)).length >= 3;

  document.getElementById('rdp-quiz10-view').innerHTML = `
    <div class="qz-result">
      <span class="qz-result-emoji">${emoji}</span>
      <div class="qz-result-title">${title}</div>
      <div style="font-size:13px;color:var(--ink3);margin-bottom:4px">
        ${extraMode?'H·ªçc th√™m':''} <strong>${words.length} t·ª´</strong> h√¥m nay
      </div>
      <div class="qz-score-circle">
        <div class="qz-score-num">${score}%</div>
        <div class="qz-score-lbl">ƒëi·ªÉm</div>
      </div>
      <div class="qz-stat-row">
        <div class="qz-stat"><span class="qz-stat-val" style="color:var(--teal)">${correct}</span><div class="qz-stat-lbl">‚úÖ ƒê√∫ng</div></div>
        <div class="qz-stat"><span class="qz-stat-val" style="color:var(--rose)">${wrong}</span><div class="qz-stat-lbl">‚ùå Sai</div></div>
        <div class="qz-stat"><span class="qz-stat-val" style="color:var(--amber)">+${xp}</span><div class="qz-stat-lbl">‚ö° XP</div></div>
      </div>
      ${reviewHtml}
      <div style="display:flex;flex-direction:column;gap:10px;margin-top:20px;max-width:320px;margin-left:auto;margin-right:auto">
        <button class="btn btn-primary" style="font-size:14px;padding:13px" onclick="renderRdpQuiz10(false)">üîÑ H·ªçc l·∫°i t·ª´ h√¥m nay</button>
        ${extraAvail?`<button class="btn btn-outline" style="font-size:14px;padding:12px;border-color:var(--violet);color:var(--violet)" onclick="renderRdpQuiz10(true)">‚ûï H·ªçc th√™m t·ª´ m·ªõi</button>`:''}
        <button class="btn btn-ghost btn-sm" onclick="switchRdpTab('stats',document.querySelectorAll('.rdp-tab')[1])">üìä Xem th·ªëng k√™</button>
      </div>
    </div>`;
}

// Legacy alias
function showRdpQ10(){ showRdpQuestion(); }



/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ANTHROPIC API KEY MANAGEMENT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function getAnthropicKey(){
  try{
    const s=localStorage.getItem('speakup_settings');
    if(s){const p=JSON.parse(s);if(p.apiKey&&p.apiKey.startsWith('sk-'))return p.apiKey;}
  }catch(e){}
  return null;
}
function saveAnthropicKey(key){
  try{
    const s=localStorage.getItem('speakup_settings');
    const p=s?JSON.parse(s):{};
    p.apiKey=key;
    localStorage.setItem('speakup_settings',JSON.stringify(p));
  }catch(e){}
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   GEMINI API KEY MANAGEMENT (MI·ªÑN PH√ç ‚Äî Writing Module)
   ‚ñ∫ L·∫•y key mi·ªÖn ph√≠ t·∫°i: https://aistudio.google.com/apikey
   ‚ñ∫ 1.000 request/ng√†y ¬∑ Kh√¥ng c·∫ßn th·∫ª t√≠n d·ª•ng
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function getGeminiKey(){
  try{
    const s=localStorage.getItem('speakup_settings');
    if(s){ const p=JSON.parse(s); if(p.geminiKey&&p.geminiKey.length>10) return p.geminiKey; }
  }catch(e){}
  return null;
}
function saveGeminiKey(key){
  try{
    const s=localStorage.getItem('speakup_settings');
    const p=s?JSON.parse(s):{};
    p.geminiKey=key;
    localStorage.setItem('speakup_settings',JSON.stringify(p));
  }catch(e){}
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   GEMINI API CALLER ‚Äî Writing Module
   T·ª± ƒë·ªông fallback qua 3 models n·∫øu b·ªã quota/rate limit:
   1. gemini-2.0-flash-lite  (nhanh nh·∫•t, free 1500 req/ng√†y)
   2. gemini-1.5-flash-8b    (nh·∫π, free 1000 req/ng√†y)
   3. gemini-1.5-flash       (m·∫°nh h∆°n, free 500 req/ng√†y)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const GEMINI_MODELS = [
  'gemini-2.0-flash-lite',
  'gemini-1.5-flash-8b',
  'gemini-1.5-flash',
];

// L∆∞u model n√†o ƒëang b·ªã quota ƒë·ªÉ b·ªè qua l·∫ßn sau (reset m·ªói 1 gi·ªù)
const _modelQuotaHit = {};

async function _callOneModel(model, apiKey, prompt, maxTokens){
  const res = await fetch(
    `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${encodeURIComponent(apiKey)}`,
    {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        contents:[{ parts:[{ text: prompt }] }],
        generationConfig:{ maxOutputTokens: maxTokens, temperature: 0.7 }
      })
    }
  );
  const d = await res.json();
  if(!res.ok){
    const msg = d?.error?.message || 'HTTP ' + res.status;
    const err = new Error(msg);
    err.status  = res.status;
    err.model   = model;
    // Quota exceeded (429) ho·∫∑c free tier limit (400 + quota message)
    err.isQuota = res.status===429 ||
      (res.status===400 && (msg.includes('quota') || msg.includes('RESOURCE_EXHAUSTED'))) ||
      msg.toLowerCase().includes('quota') ||
      msg.toLowerCase().includes('rate') ||
      msg.toLowerCase().includes('exceeded');
    err.isInvalidKey = res.status===400 && msg.includes('API_KEY');
    throw err;
  }
  const text = d?.candidates?.[0]?.content?.parts?.[0]?.text || '';
  if(!text) throw Object.assign(new Error('Response r·ªóng'), {model, isQuota:false});
  return text;
}

async function callGemini(prompt, maxTokens=1500){
  const apiKey = getGeminiKey();
  if(!apiKey) throw Object.assign(new Error('NO_GEMINI_KEY'), {noKey:true});

  const now = Date.now();
  // L·ªçc ra c√°c model ch∆∞a b·ªã quota (ho·∫∑c ƒë√£ h·∫øt 1 gi·ªù cooling)
  const available = GEMINI_MODELS.filter(m => {
    const t = _modelQuotaHit[m];
    return !t || (now - t) > 60 * 60 * 1000; // reset sau 1 gi·ªù
  });

  if(!available.length){
    // T·∫•t c·∫£ ƒë·ªÅu b·ªã quota ‚Üí reset v√† th·ª≠ l·∫°i t·ª´ ƒë·∫ßu
    GEMINI_MODELS.forEach(m => delete _modelQuotaHit[m]);
    available.push(...GEMINI_MODELS);
  }

  let lastErr = null;
  for(const model of available){
    try{
      const text = await _callOneModel(model, apiKey, prompt, maxTokens);
      // Th√†nh c√¥ng ‚Üí c·∫≠p nh·∫≠t UI n·∫øu ƒëang d√πng model fallback
      if(model !== GEMINI_MODELS[0]){
        console.info(`[Gemini] D√πng model fallback: ${model}`);
      }
      return text;
    } catch(err){
      lastErr = err;
      if(err.isInvalidKey){
        // Key sai ‚Üí b√°o l·ªói ngay, kh√¥ng th·ª≠ model kh√°c
        err.invalidKey = true;
        throw err;
      }
      if(err.isQuota){
        // Quota/rate limit ‚Üí ƒë√°nh d·∫•u model n√†y v√† th·ª≠ model ti·∫øp theo
        _modelQuotaHit[model] = Date.now();
        console.warn(`[Gemini] Quota exceeded: ${model} ‚Üí th·ª≠ model ti·∫øp theo...`);
        continue;
      }
      // L·ªói kh√°c (network, parse...) ‚Üí throw lu√¥n
      throw err;
    }
  }

  // T·∫•t c·∫£ model ƒë·ªÅu th·∫•t b·∫°i
  const finalErr = new Error(
    'T·∫•t c·∫£ Gemini models ƒë·ªÅu ƒëang b·ªã gi·ªõi h·∫°n quota. ' +
    'Vui l√≤ng th·ª≠ l·∫°i sau √≠t ph√∫t.\n\n' +
    'üí° Tip: M·ªói key mi·ªÖn ph√≠ c√≥ gi·ªõi h·∫°n request/ng√†y. ' +
    'B·∫°n c√≥ th·ªÉ t·∫°o th√™m key t·∫°i aistudio.google.com/apikey'
  );
  finalErr.isQuota = true;
  throw finalErr;
}

/* Alias ƒë·ªÉ c√°c h√†m c≈© g·ªçi callClaude v·∫´n ho·∫°t ƒë·ªông */
async function callClaude(prompt, maxTokens){ return callGemini(prompt, maxTokens); }

/* Parse JSON t·ª´ Claude ‚Äî x·ª≠ l√Ω m·ªçi ki·ªÉu format */
function cleanGeminiJson(raw){
  if(!raw) return null;
  let s = raw.trim();
  // B·ªè markdown code block
  s = s.replace(/^```(?:json)?\s*/i,'').replace(/\s*```\s*$/i,'').trim();
  try{ return JSON.parse(s); }catch(_){}
  const arrMatch = s.match(/(\[[\s\S]*\])/);
  if(arrMatch){ try{ return JSON.parse(arrMatch[1]); }catch(_){} }
  const objMatch = s.match(/(\{[\s\S]*\})/);
  if(objMatch){ try{ return JSON.parse(objMatch[1]); }catch(_){} }
  const startArr = s.indexOf('[');
  const startObj = s.indexOf('{');
  if(startArr !== -1){ try{ return JSON.parse(s.slice(startArr)); }catch(_){} }
  if(startObj !== -1){ try{ return JSON.parse(s.slice(startObj)); }catch(_){} }
  return null;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   WRITING PRACTICE MODULE v3 ‚Äî Template Engine
   ‚úÖ 6 d·∫°ng b√†i t·∫≠p ƒëa d·∫°ng, sinh t·ª± ƒë·ªông t·ª´ JavaScript
   ‚úÖ Kh√¥ng c·∫ßn AI ƒë·ªÉ t·∫°o c√¢u ‚Äî lu√¥n ho·∫°t ƒë·ªông 100%
   ‚úÖ Ch·∫•m offline th√¥ng minh + AI n·∫øu c√≥ Gemini key
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let _wrSession = null;

/* ‚îÄ‚îÄ‚îÄ Parse JSON helper ‚îÄ‚îÄ‚îÄ */
function parseClaudeJson(raw){ return cleanGeminiJson(raw); }

/* ‚îÄ‚îÄ helpers d√πng tr∆∞·ªõc khi khai b√°o templates ‚îÄ‚îÄ */
function cleanEx(ex){
  return (ex||'').replace(/\s*[\(\Ôºà][^\)\Ôºâ]*[\)\Ôºâ]/g,'').replace(/\s*[‚Äî‚Äì\-]\s*[^\x00-\x7F].*$/u,'').trim();
}
function viOfEx(ex){
  if(!ex) return '';
  const m = ex.match(/[(\uFF08]([^)\uFF09]*[\u00C0-\u024F\u1E00-\u1EFF][^)\uFF09]*)[)\uFF09]/u);
  return m ? m[1].trim() : '';
}
function escRegex(s){ return s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); }
function breakSentence(ex, word){
  const broken = ex
    .replace(/\bdon't\b/gi, "doesnt")
    .replace(/\bdoesn't\b/gi, "dont")
    .replace(/\bare\b/g, 'is')
    .replace(/\bwas\b/g, 'were')
    .replace(/\bvery\b/, 'very much')
    .replace(/([a-z])\.$/, '$1');
  return broken !== ex ? broken : ex.split(' ').map((w,i,a)=>i===1?a[2]||w:i===2?a[1]||w:w).join(' ');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   TEMPLATE ENGINE ‚Äî 6 d·∫°ng b√†i t·∫≠p phong ph√∫
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const WR_TEMPLATES = [

  /* ‚ë† D·ªäCH C√ÇU ‚Äî ƒê·ªçc nghƒ©a ti·∫øng Vi·ªát ‚Üí vi·∫øt c√¢u ti·∫øng Anh */
  {
    id:'translate', label:'üåè D·ªãch sang ti·∫øng Anh', color:'var(--teal)',
    canUse: w => !!(w.example && w.meaning),
    build(w){
      const ex = cleanEx(w.example);
      const vi = viOfEx(w.example) || `Vi·∫øt c√¢u ti·∫øng Anh d√πng t·ª´ "${w.word}" v·ªõi nghƒ©a: ${w.meaning}`;
      return {
        prompt: `üáªüá≥ <strong>${vi}</strong>`,
        sub: `üí° G·ª£i √Ω: d√πng t·ª´ <strong>"${w.word}"</strong>${w.ipa?' <span style="color:var(--ink3);font-style:italic">'+w.ipa+'</span>':''}`,
        answer: ex, word: w.word,
      };
    }
  },

  /* ‚ë° ƒêI·ªÄN T·ª™ ‚Äî C√¢u c√≥ blank, ƒëi·ªÅn t·ª´ ƒë√∫ng v√†o */
  {
    id:'fill-blank', label:'üìù ƒêi·ªÅn t·ª´ v√†o ch·ªó tr·ªëng', color:'var(--violet)',
    canUse: w => !!(w.example && w.example.toLowerCase().includes(w.word.toLowerCase())),
    build(w){
      const ex = cleanEx(w.example);
      const re = new RegExp('\\b('+escRegex(w.word)+'\\w*)','i');
      const blanked = ex.replace(re, m => '_'.repeat(Math.max(m.length, 6)));
      if(blanked === ex) return null;
      return {
        prompt: `ƒêi·ªÅn t·ª´ ƒë√∫ng v√†o ch·ªó tr·ªëng ƒë·ªÉ ho√†n th√†nh c√¢u:`,
        sub: `<div style="font-size:17px;font-weight:700;color:var(--ink);line-height:1.8;margin:6px 0">"${escHtml(blanked)}"</div><span style="font-size:12px;color:var(--ink3)">üáªüá≥ Nghƒ©a: ${w.meaning}</span>`,
        answer: ex, word: w.word, fillMode: true,
      };
    }
  },

  /* ‚ë¢ VI·∫æT C√ÇU V·ªöI T·ª™ CHO S·∫¥N ‚Äî C√≥ c√¢u ti·∫øng Vi·ªát c·ª• th·ªÉ ƒë·ªÉ d·ªãch */
  {
    id:'use-word', label:'‚úçÔ∏è Vi·∫øt c√¢u v·ªõi t·ª´ cho s·∫µn', color:'var(--amber)',
    canUse: w => !!(w.word && w.meaning),
    build(w){
      // Sinh c√¢u ti·∫øng Vi·ªát c·ª• th·ªÉ t·ª´ nghƒ©a v√† ch·ªß ƒë·ªÅ c·ªßa t·ª´
      const meaning = w.meaning || '';
      const word    = w.word;
      const topic   = w.topic || '';

      // B·ªô c√¢u ti·∫øng Vi·ªát theo t·ª´ng ch·ªß ƒë·ªÅ / lo·∫°i t·ª´
      const topicSentences = {
        'Work & Office': [
          `Ch√∫ng t√¥i ƒë√£ ${meaning} v·ªõi c√°c nh√≥m ·ªü nhi·ªÅu qu·ªëc gia kh√°c nhau.`,
          `S·∫øp t√¥i lu√¥n khuy·∫øn kh√≠ch nh√¢n vi√™n ${meaning} trong c√¥ng vi·ªác.`,
          `ƒê·ªÉ ho√†n th√†nh d·ª± √°n ƒë√∫ng h·∫°n, ch√∫ng ta c·∫ßn ${meaning} hi·ªáu qu·∫£ h∆°n.`,
        ],
        'Daily Conversation': [
          `T√¥i th·ª±c s·ª± ${meaning} s·ª± gi√∫p ƒë·ª° c·ªßa b·∫°n h√¥m nay.`,
          `B·∫°n c√≥ th·ªÉ ${meaning} cho t√¥i m·ªôt nh√† h√†ng ngon g·∫ßn ƒë√¢y kh√¥ng?`,
          `Th·∫≠t ${meaning} khi c√≥ si√™u th·ªã ·ªü ngay g·∫ßn nh√†.`,
        ],
        'Travel & Tourism': [
          `Ch√∫ng t√¥i ƒë√£ ${meaning} kh·∫Øp th√†nh ph·ªë trong chuy·∫øn ƒëi v·ª´a r·ªìi.`,
          `H∆∞·ªõng d·∫´n vi√™n ƒë√£ ${meaning} cho ch√∫ng t√¥i v·ªÅ l·ªãch s·ª≠ c·ªßa ƒë·ªãa ƒëi·ªÉm n√†y.`,
        ],
        'Food & Dining': [
          `Nh√† h√†ng n√†y ph·ª•c v·ª• c√°c m√≥n ƒÉn r·∫•t ${meaning}.`,
          `T√¥i th√≠ch ${meaning} nh·ªØng m√≥n ƒÉn m·ªõi m·ªói cu·ªëi tu·∫ßn.`,
        ],
        'Health & Medical': [
          `B√°c sƒ© ƒë√£ ${meaning} t√¥i n√™n ngh·ªâ ng∆°i nhi·ªÅu h∆°n.`,
          `Duy tr√¨ l·ªëi s·ªëng ${meaning} r·∫•t quan tr·ªçng cho s·ª©c kh·ªèe.`,
        ],
        'Technology': [
          `C√¥ng ngh·ªá m·ªõi n√†y gi√∫p ch√∫ng ta ${meaning} c√¥ng vi·ªác nhanh h∆°n.`,
          `·ª®ng d·ª•ng ƒë√≥ r·∫•t ${meaning} cho ng∆∞·ªùi d√πng h√†ng ng√†y.`,
        ],
        'Education': [
          `Gi√°o vi√™n lu√¥n ${meaning} h·ªçc sinh t√¨m t√≤i ki·∫øn th·ª©c m·ªõi.`,
          `H·ªçc ${meaning} theo nh√≥m gi√∫p t√¥i hi·ªÉu b√†i nhanh h∆°n.`,
        ],
      };

      // C√¢u generic d√πng khi kh√¥ng c√≥ ch·ªß ƒë·ªÅ c·ª• th·ªÉ
      const genericSentences = [
        `H√£y vi·∫øt c√¢u ti·∫øng Anh c√≥ nghƒ©a: "${meaning}".`,
        `D√πng t·ª´ "${word}" (${meaning}) ƒë·ªÉ m√¥ t·∫£ m·ªôt t√¨nh hu·ªëng trong cu·ªôc s·ªëng.`,
        `T·∫°o m·ªôt c√¢u ti·∫øng Anh ho√†n ch·ªânh th·ªÉ hi·ªán nghƒ©a "${meaning}".`,
        `Vi·∫øt c√¢u di·ªÖn ƒë·∫°t √Ω: "${meaning}" b·∫±ng ti·∫øng Anh.`,
        `ƒê·∫∑t c√¢u ti·∫øng Anh s·ª≠ d·ª•ng t·ª´ "${word}" ‚Äî nghƒ©a: ${meaning}.`,
      ];

      const pool = topicSentences[topic] || genericSentences;
      // Ch·ªçn ng·∫´u nhi√™n nh∆∞ng ·ªïn ƒë·ªãnh theo word (tr√°nh thay ƒë·ªïi m·ªói l·∫ßn render)
      const idx = Math.abs(word.split('').reduce((a,c)=>a+c.charCodeAt(0),0)) % pool.length;
      const viSentence = pool[idx];

      const ex = cleanEx(w.example) || `${word.charAt(0).toUpperCase()+word.slice(1)} plays an important role in our daily life.`;
      return {
        prompt: `üáªüá≥ D√πng t·ª´ "<strong>${word}</strong>" ƒë·ªÉ d·ªãch c√¢u sau sang ti·∫øng Anh:`,
        sub: `<div style="font-size:18px;font-weight:700;color:var(--ink);line-height:1.6;margin:8px 0 6px;font-family:var(--font-d)">"${escHtml(viSentence)}"</div>`
          + `<div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-top:8px">`
          + `<span style="background:var(--amber-light);color:var(--amber);border-radius:20px;padding:3px 10px;font-size:12px;font-weight:700">üìñ ${word}</span>`
          + (w.ipa ? `<span style="font-size:13px;color:var(--ink3);font-style:italic">${w.ipa}</span>` : '')
          + `<span style="font-size:13px;color:var(--ink2)">‚Äî ${meaning}</span>`
          + `</div>`,
        answer: ex, word: w.word, freeWrite: true, viSentence,
      };
    }
  },

  /* ‚ë£ TR·∫¢ L·ªúI C√ÇU H·ªéI ‚Äî D√πng t·ª´ ƒë√≥ trong c√¢u tr·∫£ l·ªùi */
  {
    id:'answer-q', label:'‚ùì Tr·∫£ l·ªùi c√¢u h·ªèi', color:'var(--rose)',
    canUse: w => !!(w.word && w.meaning),
    build(w){
      const qs = [
        `Can you give an example of when someone is <strong>${w.word}</strong>? (Write in English)`,
        `How would you explain "<strong>${w.word}</strong>" to a friend? Use it in a sentence.`,
        `Describe a situation where you need to "<strong>${w.word}</strong>" something.`,
        `Write a sentence that shows the meaning of "<strong>${w.word}</strong>".`,
      ];
      const ex = cleanEx(w.example) || `Being ${w.word} is very important in daily communication.`;
      return {
        prompt: qs[Math.floor(Math.random()*qs.length)],
        sub: `üáªüá≥ Nghƒ©a g·ª£i √Ω: <strong>${w.meaning}</strong>`,
        answer: ex, word: w.word, freeWrite: true,
      };
    }
  },

  /* ‚ë§ S·ª¨A C√ÇU SAI ‚Äî C√¢u c√≥ l·ªói ng·ªØ ph√°p, vi·∫øt l·∫°i ƒë√∫ng */
  {
    id:'fix-error', label:'üîß S·ª≠a c√¢u sai ng·ªØ ph√°p', color:'#0891b2',
    canUse: w => !!(w.example && cleanEx(w.example).split(' ').length >= 5),
    build(w){
      const ex = cleanEx(w.example);
      const broken = breakSentence(ex, w.word);
      if(!broken || broken === ex) return null;
      return {
        prompt: `C√¢u b√™n d∆∞·ªõi c√≥ l·ªói ng·ªØ ph√°p ‚Äî h√£y vi·∫øt l·∫°i cho ƒë√∫ng:`,
        sub: `<div style="font-size:16px;color:var(--rose);font-style:italic;margin:6px 0">"${escHtml(broken)}"</div><span style="font-size:12px;color:var(--ink3)">üáªüá≥ Nghƒ©a ƒë√∫ng: ${w.meaning}</span>`,
        answer: ex, word: w.word,
      };
    }
  },

  /* ‚ë• VI·∫æT M·ªû R·ªòNG ‚Äî Vi·∫øt c√¢u ph·ª©c h·ª£p v·ªõi starter cho s·∫µn */
  {
    id:'expand', label:'üöÄ Vi·∫øt c√¢u m·ªü r·ªông', color:'#7c3aed',
    canUse: w => !!(w.example && w.word && w.meaning),
    build(w){
      const starters = [
        'Although it was difficult, ',
        'If I had the chance, I would ',
        'She told me that ',
        'Every day, people tend to ',
        'The best way to deal with this is to ',
        'I believe that ',
        'It is important to ',
      ];
      const s  = starters[Math.floor(Math.random()*starters.length)];
      const ex = cleanEx(w.example) || `${w.word.charAt(0).toUpperCase()+w.word.slice(1)} helps us grow every day.`;
      return {
        prompt: `Vi·∫øt c√¢u ti·∫øng Anh b·∫Øt ƒë·∫ßu b·∫±ng:`,
        sub: `<div style="font-size:17px;font-weight:700;color:var(--violet);margin:6px 0">"${escHtml(s)}..."</div>`
           + `<span style="font-size:13px;color:var(--ink3)">‚úçÔ∏è H√£y d√πng t·ª´ <strong>"${w.word}"</strong> (${w.meaning}) trong c√¢u</span>`,
        answer: ex, word: w.word, freeWrite: true, starter: s,
      };
    }
  },
];

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   BUILD TASKS ‚Äî Sinh b√†i t·∫≠p t·ª´ vocab pool
   Ph√¢n b·ªï ƒë·ªÅu gi·ªØa c√°c template ƒë∆∞·ª£c ch·ªçn
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function buildWritingTasks(words, count, activeTplIds){
  const tasks   = [];
  const pool    = shuffle([...words]);
  const allowed = (activeTplIds && activeTplIds.length)
    ? WR_TEMPLATES.filter(t => activeTplIds.includes(t.id))
    : WR_TEMPLATES;
  if(!allowed.length) return [];

  let tplIdx = 0;
  for(const w of pool){
    if(!w.word || (!w.example && !w.meaning)) continue;

    // Th·ª≠ tu·∫ßn t·ª± t·ª´ v·ªã tr√≠ tplIdx, xoay v√≤ng qua allowed
    let placed = false;
    for(let attempt = 0; attempt < allowed.length; attempt++){
      const tpl = allowed[(tplIdx + attempt) % allowed.length];
      if(!tpl.canUse(w)) continue;
      try{
        const built = tpl.build(w);
        if(!built) continue;
        tasks.push({ templateId:tpl.id, label:tpl.label, color:tpl.color,
          word:w.word, meaning:w.meaning||'', ipa:w.ipa||'', topic:w.topic||'', ...built });
        tplIdx = (tplIdx + attempt + 1) % allowed.length;
        placed = true;
        break;
      }catch(e){ continue; }
    }

    // Fallback: use-word lu√¥n ho·∫°t ƒë·ªông v·ªõi m·ªçi t·ª´
    if(!placed){
      const fb = WR_TEMPLATES.find(t=>t.id==='use-word');
      if(fb && fb.canUse(w)){
        try{
          const built = fb.build(w);
          if(built) tasks.push({ templateId:'use-word', label:fb.label, color:fb.color,
            word:w.word, meaning:w.meaning||'', ipa:w.ipa||'', topic:w.topic||'', ...built });
        }catch(e){}
      }
    }

    if(tasks.length >= count) break;
  }
  return tasks.slice(0, count);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SMART SCORER ‚Äî Ch·∫•m offline kh√¥ng c·∫ßn AI
   ƒê√°nh gi√° ƒëa ti√™u ch√≠: t·ª´ kh√≥a, c·∫•u tr√∫c, ƒë·ªô t∆∞∆°ng ƒë·ªìng
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function smartScore(userAns, task){
  const ans     = (userAns||'').trim().toLowerCase();
  const correct = (task.answer||'').toLowerCase();
  const word    = (task.word||'').toLowerCase();

  if(!ans) return makeResult(0, 'Ch∆∞a tr·∫£ l·ªùi', false,
    'B·∫°n ch∆∞a vi·∫øt c√¢u.', task.answer, '', userAns, task);

  const hasWord    = ans.includes(word) || levenshtein(ans.split(/\s+/).find(t=>levenshtein(t,word)<=1)||'', word) <= 1;
  const sim        = strSimilarity(ans, correct);
  const wordCount  = ans.split(/\s+/).filter(Boolean).length;
  const hasSubject = /\b(i|we|you|he|she|it|they|the|a|an|my|our|your|this|that|there)\b/.test(ans);
  const hasVerb    = /\b(is|are|was|were|have|has|had|do|does|did|will|can|could|would|should|may|might|am|be|been|go|get|make|take|give|come|see|know|think|feel|need|want|use|work|help|try|look|become|keep|find|say|tell|ask|start|stop|change|happen|create|build|leave|stay|arrive|use|play|run|learn|teach|eat|drink|sleep|walk|drive|grow|buy|pay|open|close|finish|continue|appear|speak|write|read|seem|appear|allow|require|provide|improve|increase|reduce|consider|decide|expect|explain|include|involve|mean|remember|show|understand|turn)\b/.test(ans);

  let score = 0;

  if(task.fillMode){
    // Fill-blank: ch·ªß y·∫øu x√©t c√≥ ƒëi·ªÅn ƒë√∫ng t·ª´ kh√¥ng
    score = hasWord ? Math.round(65 + sim*35) : Math.round(sim*45);
  } else if(task.freeWrite){
    // Free write: linh ho·∫°t h∆°n
    score += hasWord    ? 40 : 0;
    score += hasSubject ? 15 : 0;
    score += hasVerb    ? 15 : 0;
    score += Math.round(sim * 30);
    if(wordCount >= 5 && wordCount <= 25) score += 5;
  } else {
    // Translate / fix-error: so s√°nh s√°t v·ªõi ƒë√°p √°n
    score += Math.round(sim * 55);
    score += hasWord    ? 25 : 0;
    score += hasSubject ?  8 : 0;
    score += hasVerb    ?  7 : 0;
    if(wordCount < 3) score = Math.min(score, 35);
  }

  score = Math.max(0, Math.min(100, score));

  const verdict = score>=88?'Xu·∫•t s·∫Øc!': score>=72?'R·∫•t t·ªët!': score>=55?'Kh√° t·ªët': score>=38?'T·∫°m ƒë∆∞·ª£c': 'C·∫ßn c·∫£i thi·ªán';
  let comment = '';
  if(!hasWord && !task.freeWrite)
    comment = `üí° C√¢u c·ªßa b·∫°n ch∆∞a c√≥ t·ª´ <strong>"${task.word}"</strong>. Th·ª≠ vi·∫øt l·∫°i nh√©!`;
  else if(score >= 80)
    comment = `üéâ Tuy·ªát v·ªùi! C√¢u r·∫•t t·ªët.`;
  else if(score >= 55)
    comment = `‚úÖ Kh√° ·ªïn! So s√°nh v·ªõi c√¢u m·∫´u b√™n d∆∞·ªõi ƒë·ªÉ c·∫£i thi·ªán th√™m.`;
  else if(!hasSubject)
    comment = `üìå C√¢u ch∆∞a c√≥ ch·ªß ng·ªØ r√µ r√†ng (I / She / The...). H√£y vi·∫øt c√¢u ƒë·∫ßy ƒë·ªß h∆°n.`;
  else if(!hasVerb)
    comment = `üìå C√¢u ch∆∞a c√≥ ƒë·ªông t·ª´. Th√™m ƒë·ªông t·ª´ ƒë·ªÉ c√¢u ho√†n ch·ªânh h∆°n.`;
  else
    comment = `üìù Xem c√¢u m·∫´u b√™n d∆∞·ªõi ƒë·ªÉ h·ªçc c√°ch d√πng t·ª´ <strong>"${task.word}"</strong> t·ª± nhi√™n h∆°n.`;

  return makeResult(score, verdict, score>=45, comment, task.answer, '', userAns, task);
}

function makeResult(score, verdict, comp, comment, correction, correctionExplain, userAns, task){
  return { score, verdict, comprehensible:comp, comment, correction, correctionExplain, userAns, vi:task.prompt||task.vi||'', _local:true };
}

/* T√≠nh ƒë·ªô t∆∞∆°ng ƒë·ªìng 2 chu·ªói (0-1) b·∫±ng token overlap c√≥ fuzzy */
function strSimilarity(a, b){
  if(!a||!b) return 0;
  const stop = new Set(['a','an','the','is','are','was','i','to','of','in','on','at','and','or','it','this','that','my','your','we','he','she','they']);
  const tok  = s => s.toLowerCase().replace(/[^a-z\s]/g,'').split(/\s+/).filter(w=>w.length>2&&!stop.has(w));
  const ta = tok(a), tb = tok(b);
  if(!ta.length||!tb.length) return 0;
  const hits = ta.filter(w=>tb.some(bw=>bw===w||levenshtein(w,bw)<=1)).length;
  return hits / Math.max(ta.length, tb.length);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   1. M√ÄN H√åNH SETUP
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderWritingSetup(){
  const el      = document.getElementById('wr-content');
  const apiKey  = getGeminiKey();
  const topics  = [...new Set([...S.vocab.map(v=>v.topic),...Object.keys(S.topics||{})])].filter(Boolean).sort();
  const total   = S.vocab.length;
  const hasVocab= total > 0;

  // ƒê·∫øm t·ª´ theo topic
  const topicCounts = {};
  S.vocab.forEach(v=>{ topicCounts[v.topic||'']=(topicCounts[v.topic||'']||0)+1; });

  // Badge Gemini
  const aiBadge = apiKey
    ? `<span style="display:inline-flex;align-items:center;gap:5px;background:var(--teal-light);color:var(--teal);border-radius:20px;padding:3px 10px;font-size:11px;font-weight:700">
        <img src="https://www.gstatic.com/lamda/images/gemini_sparkle_v002_d4735304ff6292a690345.svg" width="12" height="12">
        AI ch·∫•m b·∫≠t
       </span>`
    : `<span style="display:inline-flex;align-items:center;gap:4px;background:var(--bg2);color:var(--ink3);border-radius:20px;padding:3px 10px;font-size:11px">
        ‚ö° Ch·∫•m offline
       </span>`;

  el.innerHTML = `
    <!-- Header -->
    <div style="background:linear-gradient(135deg,#6d28d9 0%,#0891b2 100%);border-radius:var(--radius);padding:20px 20px 18px;margin-bottom:16px;color:#fff">
      <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:10px">
        <div>
          <div style="font-family:var(--font-d);font-weight:800;font-size:20px;margin-bottom:4px">‚úçÔ∏è Luy·ªán Writing</div>
          <div style="font-size:13px;opacity:.85;line-height:1.5">T·ª± ƒë·ªông t·∫°o b√†i t·ª´ t·ª´ v·ª±ng c·ªßa b·∫°n<br>6 d·∫°ng b√†i ¬∑ Kh√¥ng c·∫ßn API</div>
        </div>
        <div style="text-align:right;flex-shrink:0">
          <div style="font-size:28px;font-weight:800;font-family:var(--font-d)">${total}</div>
          <div style="font-size:11px;opacity:.8">t·ª´ v·ª±ng</div>
        </div>
      </div>
    </div>

    ${!hasVocab ? `
    <div class="card" style="text-align:center;padding:32px;margin-bottom:16px;border:2px dashed var(--border)">
      <div style="font-size:44px;margin-bottom:10px">üì•</div>
      <div style="font-family:var(--font-d);font-weight:700;font-size:16px;margin-bottom:6px">Ch∆∞a c√≥ t·ª´ v·ª±ng</div>
      <div style="font-size:13px;color:var(--ink3);margin-bottom:16px">Import t·ª´ v·ª±ng tr∆∞·ªõc ƒë·ªÉ app t·ª± t·∫°o b√†i t·∫≠p nh√©!</div>
      <button class="btn btn-primary" onclick="showPanel('import')">üì• Import t·ª´ v·ª±ng ngay</button>
    </div>` : ''}

    <!-- Config card -->
    <div class="wr-setup-card" ${!hasVocab?'style="opacity:.45;pointer-events:none"':''}>
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px">
        <div style="font-family:var(--font-d);font-weight:700;font-size:15px">üöÄ C·∫•u h√¨nh b√†i luy·ªán</div>
        ${aiBadge}
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:14px">
        <!-- Ch·ªß ƒë·ªÅ -->
        <div style="flex:1;min-width:160px">
          <label class="flbl">üìö Ch·ªß ƒë·ªÅ</label>
          <select class="sel-inp" id="wr-topic-sel" style="width:100%">
            <option value="">üîÄ T·∫•t c·∫£ (${total} t·ª´)</option>
            ${topics.map(t=>{
              const cnt = topicCounts[t]||0;
              const r   = TOPIC_RULES.find(x=>x.name===t);
              return `<option value="${t}">${r?.emoji||'üìå'} ${t} (${cnt} t·ª´)</option>`;
            }).join('')}
          </select>
        </div>
        <!-- S·ªë c√¢u -->
        <div style="flex:0;min-width:100px">
          <label class="flbl">üìù S·ªë c√¢u</label>
          <select class="sel-inp" id="wr-count-sel" style="width:100%">
            <option value="5">5 c√¢u</option>
            <option value="10" selected>10 c√¢u</option>
            <option value="15">15 c√¢u</option>
            <option value="20">20 c√¢u</option>
          </select>
        </div>
      </div>

      <!-- Lo·∫°i b√†i -->
      <div style="margin-bottom:16px">
        <label class="flbl">üéØ D·∫°ng b√†i (ch·ªçn nhi·ªÅu)</label>
        <div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:6px">
          ${WR_TEMPLATES.map(t=>`
            <label style="display:flex;align-items:center;gap:5px;cursor:pointer;background:var(--surface);border:1.5px solid var(--border);border-radius:20px;padding:4px 10px;font-size:12px;font-weight:600;color:var(--ink2);transition:all .15s"
              id="tpl-lbl-${t.id}">
              <input type="checkbox" id="tpl-${t.id}" checked style="accent-color:${t.color};cursor:pointer"
                onchange="wrUpdateTplStyle('${t.id}','${t.color}')">
              ${t.label}
            </label>`).join('')}
        </div>
      </div>

      <button class="btn btn-primary btn-full" onclick="startWritingSession()" style="font-size:15px;padding:13px;font-weight:800">
        ‚ñ∂ B·∫Øt ƒë·∫ßu luy·ªán ngay
      </button>
    </div>

    <!-- AI t√πy ch·ªçn -->
    <div class="card" style="margin-top:12px">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap">
        <div style="display:flex;align-items:center;gap:7px">
          <img src="https://www.gstatic.com/lamda/images/gemini_sparkle_v002_d4735304ff6292a690345.svg" width="15" height="15">
          <span style="font-size:13px;font-weight:700;color:${apiKey?'var(--teal)':'var(--ink3)'}">
            ${apiKey ? '‚úÖ Gemini AI ch·∫•m b√†i (ƒëang b·∫≠t)' : '‚ú® T√πy ch·ªçn: AI ch·∫•m chi ti·∫øt h∆°n'}
          </span>
        </div>
        <button class="btn btn-ghost btn-sm" style="font-size:11px"
          onclick="(function(){var r=document.getElementById('wr-key-row');r.style.display=r.style.display==='none'?'flex':'none';})()">
          ${apiKey?'ƒê·ªïi / T·∫Øt':'Nh·∫≠p key ‚Üí'}
        </button>
      </div>
      <div style="font-size:12px;color:var(--ink3);margin-top:5px">
        ${apiKey
          ? 'AI nh·∫≠n x√©t chi ti·∫øt, ƒë·ªÅ xu·∫•t c√¢u hay h∆°n. N·∫øu AI l·ªói ‚Üí t·ª± chuy·ªÉn sang ch·∫•m offline.'
          : 'Kh√¥ng b·∫Øt bu·ªôc. Offline scoring ho·∫°t ƒë·ªông t·ªët ƒë·ªÉ luy·ªán t·∫≠p h√†ng ng√†y.'}
      </div>
      <div id="wr-key-row" style="display:none;gap:7px;align-items:center;flex-wrap:wrap;margin-top:8px">
        <input class="finp" id="wr-key-inp" placeholder="AIza..." style="flex:1;min-width:160px;margin:0;font-size:13px"
          value="${apiKey||''}" onkeydown="if(event.key==='Enter')saveWrKey()">
        <button class="btn btn-primary btn-sm" onclick="saveWrKey()">L∆∞u</button>
        ${apiKey?`<button class="btn btn-ghost btn-sm" onclick="saveGeminiKey('');renderWritingSetup()">T·∫Øt AI</button>`:''}
        <a href="https://aistudio.google.com/apikey" target="_blank" style="font-size:12px;color:var(--teal);font-weight:600;white-space:nowrap">L·∫•y key mi·ªÖn ph√≠ ‚Üí</a>
      </div>
    </div>

    <!-- 6 d·∫°ng b√†i -->
    <div class="card" style="margin-top:12px">
      <div style="font-weight:700;font-size:13px;margin-bottom:12px;color:var(--ink)">üéì 6 d·∫°ng b√†i t·∫≠p ƒë∆∞·ª£c t·∫°o t·ª± ƒë·ªông</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        ${WR_TEMPLATES.map(t=>`
          <div style="display:flex;align-items:flex-start;gap:8px;padding:10px;background:var(--surface);border-radius:10px;border:1px solid var(--border)">
            <span style="font-size:18px">${t.label.split(' ')[0]}</span>
            <div>
              <div style="font-size:12px;font-weight:700;color:${t.color}">${t.label.split(' ').slice(1).join(' ')}</div>
              <div style="font-size:11px;color:var(--ink3);line-height:1.4">${wrTplDesc(t.id)}</div>
            </div>
          </div>`).join('')}
      </div>
    </div>`;
}

function wrTplDesc(id){
  return {
    'translate':  'ƒê·ªçc nghƒ©a ti·∫øng Vi·ªát ‚Üí d·ªãch sang ti·∫øng Anh',
    'fill-blank': 'C√¢u c√≥ ch·ªó tr·ªëng ‚Üí ƒëi·ªÅn t·ª´ ƒë√∫ng v√†o',
    'use-word':   'T·ª± vi·∫øt c√¢u ho√†n ch·ªânh c√≥ d√πng t·ª´ cho s·∫µn',
    'answer-q':   'Tr·∫£ l·ªùi c√¢u h·ªèi ti·∫øng Anh c√≥ d√πng t·ª´ ƒë√≥',
    'fix-error':  'C√¢u c√≥ l·ªói ng·ªØ ph√°p ‚Üí vi·∫øt l·∫°i ƒë√∫ng',
    'expand':     'Vi·∫øt c√¢u ph·ª©c h·ª£p t·ª´ c√¢u m·ªü ƒë·∫ßu cho s·∫µn',
  }[id]||'';
}

function wrUpdateTplStyle(id, color){
  const chk = document.getElementById('tpl-'+id);
  const lbl = document.getElementById('tpl-lbl-'+id);
  if(!lbl) return;
  lbl.style.background     = chk?.checked ? color+'20' : 'var(--surface)';
  lbl.style.borderColor    = chk?.checked ? color      : 'var(--border)';
  lbl.style.color          = chk?.checked ? color      : 'var(--ink2)';
}

function saveWrKey(){
  const val = document.getElementById('wr-key-inp')?.value?.trim();
  if(!val){ showToast('Vui l√≤ng nh·∫≠p API key','error'); return; }
  saveGeminiKey(val);
  showToast('‚úÖ ƒê√£ l∆∞u Gemini API key!');
  renderWritingSetup();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   2. KH·ªûI T·∫†O PHI√äN LUY·ªÜN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function startWritingSession(){
  const topicSel  = document.getElementById('wr-topic-sel')?.value||'';
  const count     = parseInt(document.getElementById('wr-count-sel')?.value||'10');

  // L·∫•y template IDs ƒë∆∞·ª£c ch·ªçn
  const activeTpls = WR_TEMPLATES.filter(t=>{
    const chk = document.getElementById('tpl-'+t.id);
    return !chk || chk.checked; // n·∫øu ch∆∞a render ‚Üí d√πng t·∫•t c·∫£
  }).map(t=>t.id);

  if(!activeTpls.length){
    showToast('H√£y ch·ªçn √≠t nh·∫•t 1 d·∫°ng b√†i!','error'); return;
  }

  let pool = topicSel ? S.vocab.filter(v=>v.topic===topicSel) : S.vocab;
  pool = pool.filter(v=>v.word&&(v.example||v.meaning));

  if(pool.length < 2){
    showToast(topicSel
      ? `Ch·ªß ƒë·ªÅ "${topicSel}" c·∫ßn √≠t nh·∫•t 2 t·ª´ c√≥ c√¢u v√≠ d·ª•!`
      : 'C·∫ßn √≠t nh·∫•t 2 t·ª´ v·ª±ng c√≥ c√¢u v√≠ d·ª•!', 'error');
    return;
  }

  const tasks = buildWritingTasks(pool, count, activeTpls);
  if(!tasks.length){
    showToast('Kh√¥ng t·∫°o ƒë∆∞·ª£c b√†i t·∫≠p. H√£y th√™m c√¢u v√≠ d·ª• cho t·ª´ v·ª±ng!','error'); return;
  }

  _wrSession = {
    topic: topicSel||'T·∫•t c·∫£',
    sentences: tasks,
    current: 0, results: [], correctCount: 0,
    useAI: !!getGeminiKey(),
  };
  renderWritingCard();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   3. CARD C√ÇU H·ªéI
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderWritingCard(){
  const s = _wrSession;
  if(!s){ renderWritingSetup(); return; }
  if(s.current >= s.sentences.length){ renderWritingResult(); return; }

  const q      = s.sentences[s.current];
  const total  = s.sentences.length;
  const pct    = Math.round(s.current / total * 100);
  const result = s.results[s.current];
  const tpl    = WR_TEMPLATES.find(t=>t.id===q.templateId) || WR_TEMPLATES[0];

  document.getElementById('wr-content').innerHTML = `
    <!-- Topbar -->
    <div class="wr-topbar">
      <button class="btn btn-ghost btn-sm" onclick="renderWritingSetup()"
        style="padding:5px 8px;flex-shrink:0;font-size:12px;color:var(--ink3)">‚úï</button>
      <div class="wr-pbar-wrap" style="flex:1">
        <div class="wr-pbar-fill" style="width:${pct}%"></div>
      </div>
      <div class="wr-counter">${s.current+1}/${total}</div>
      <div class="wr-score-badge" style="background:var(--teal-light);color:var(--teal)">‚úÖ ${s.correctCount}</div>
    </div>

    <!-- Card b√†i t·∫≠p -->
    <div class="wr-sentence-card">

      <!-- Badge d·∫°ng b√†i + t·ª´ -->
      <div style="display:flex;align-items:center;gap:7px;flex-wrap:wrap;margin-bottom:14px">
        <span class="wr-sentence-type" style="background:${tpl.color}18;color:${tpl.color};border-color:${tpl.color}40">
          ${tpl.label}
        </span>
        <span style="background:var(--surface2);color:var(--ink2);border-radius:20px;padding:3px 10px;font-size:12px;font-weight:700;display:inline-flex;align-items:center;gap:5px">
          üìñ ${q.word}
          <button onclick="speak('${esc(q.word)}')" title="Nghe ph√°t √¢m t·ª´"
            style="background:none;border:none;cursor:pointer;font-size:14px;padding:0 2px;line-height:1;color:var(--teal);opacity:.8" onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=.8">üîä</button>
        </span>
        ${q.topic?`<span style="font-size:11px;color:var(--ink4);background:var(--bg2);border-radius:20px;padding:2px 8px">${q.topic}</span>`:''}
        ${s.useAI&&!result?`<span style="font-size:10px;color:var(--ink4);background:var(--bg2);border-radius:20px;padding:2px 8px;margin-left:auto">‚ú® AI ch·∫•m</span>`:''}
      </div>

      <!-- ƒê·ªÅ b√†i -->
      <div class="wr-vi-sentence" style="font-size:16px;line-height:1.6">${q.prompt}</div>

      <!-- Sub (c√¢u ƒëi·ªÅn blank / g·ª£i √Ω) -->
      ${q.sub ? `<div style="margin:10px 0 4px;padding:10px 14px;background:var(--surface2);border-radius:10px;font-size:13px;line-height:1.7;color:var(--ink2)">${q.sub}</div>` : ''}

      <div class="wr-hint" style="margin-top:8px;margin-bottom:14px">
        ‚úèÔ∏è ${q.fillMode ? 'Vi·∫øt l·∫°i c√¢u ho√†n ch·ªânh (c√≥ ƒëi·ªÅn t·ª´ v√†o)' : 'Vi·∫øt c√¢u ti·∫øng Anh ƒë·∫ßy ƒë·ªß b√™n d∆∞·ªõi'}
      </div>

      <!-- Textarea -->
      <div class="wr-input-wrap">
        <textarea id="wr-ans"
          class="wr-input${result?' evaluated':''}"
          rows="3"
          placeholder="${q.starter ? q.starter+'...' : 'Type your English sentence here...'}"
          ${result?'disabled':''}
          style="font-size:16px;line-height:1.65;resize:vertical"
          onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();checkAnswer()}"
        >${result?escHtml(result.userAns):''}</textarea>
      </div>

      <!-- N√∫t -->
      <div class="wr-submit-row" style="margin-top:12px">
        ${!result ? `
          <button class="btn btn-primary" id="wr-check-btn" onclick="checkAnswer()"
            style="min-width:130px;font-size:15px;padding:11px 20px">
            üîç Ki·ªÉm tra
          </button>
          <span style="font-size:12px;color:var(--ink4);align-self:center">‚Üµ Enter</span>
          ${s.current>0?`<button class="btn btn-ghost btn-sm" onclick="prevWr()" style="margin-left:auto">‚Üê Tr∆∞·ªõc</button>`:''}
        ` : `
          <button class="btn btn-primary" onclick="advanceWr()"
            style="min-width:150px;font-size:15px;padding:11px 20px">
            ${s.current < total-1 ? 'C√¢u ti·∫øp ‚Üí' : 'üèÅ K·∫øt qu·∫£'}
          </button>
          ${s.current>0?`<button class="btn btn-ghost btn-sm" onclick="prevWr()">‚Üê Tr∆∞·ªõc</button>`:''}
        `}
      </div>

      <!-- K·∫øt qu·∫£ ch·∫•m -->
      ${result ? buildEvalCard(result) : ''}
    </div>`;

  if(!result) setTimeout(()=>document.getElementById('wr-ans')?.focus(), 80);
}

function escHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   4. CH·∫§M B√ÄI ‚Äî AI tr∆∞·ªõc, offline fallback
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function checkAnswer(){
  const s = _wrSession; if(!s) return;
  const ans = document.getElementById('wr-ans')?.value?.trim();
  if(!ans){ showToast('H√£y vi·∫øt c√¢u ti·∫øng Anh tr∆∞·ªõc!','error'); return; }

  const btn = document.getElementById('wr-check-btn');
  const q   = s.sentences[s.current];

  /* ‚îÄ‚îÄ Th·ª≠ AI ch·∫•m n·∫øu c√≥ key ‚îÄ‚îÄ */
  if(s.useAI && getGeminiKey()){
    if(btn){ btn.disabled=true; btn.innerHTML='‚ú® AI ƒëang ch·∫•m...'; }
    try{
      const prompt = `You are an English teacher grading a Vietnamese learner's writing.

Exercise type: "${q.templateId}"
Target word: "${q.word}" (meaning: "${q.meaning||''}")
Model answer: "${q.answer||''}"
Student wrote: "${ans}"

Grade 0‚Äì100. Be fair: if student used the target word correctly in a grammatical sentence, give at least 60.
${q.viSentence ? 'Vietnamese sentence to translate: "' + q.viSentence + '" ‚Äî also check if the translation matches this meaning.' : ''}
Free-write tasks (use-word, answer-q, expand) ‚Üí judge on word usage + grammar, not exact match.

Reply ONLY this JSON (no markdown):
{"score":75,"verdict":"Kh√° t·ªët","comprehensible":true,"comment":"Nh·∫≠n x√©t 1-2 c√¢u b·∫±ng ti·∫øng Vi·ªát.","correction":"C√¢u ti·∫øng Anh chu·∫©n v√† t·ª± nhi√™n nh·∫•t.","correctionExplain":"Gi·∫£i th√≠ch ng·∫Øn ti·∫øng Vi·ªát t·∫°i sao c√¢u ƒë√≥ t·ªët h∆°n (n·∫øu kh√°c c√¢u h·ªçc sinh)."}`;

      const raw   = await callGemini(prompt, 450);
      const eval_ = parseClaudeJson(raw);
      if(eval_ && typeof eval_.score !== 'undefined'){
        s.results[s.current] = { ...eval_, userAns:ans, vi:q.prompt };
        if((eval_.score||0)>=60) s.correctCount++;
        gainXP(Math.round((eval_.score||0)/10));
        renderWritingCard(); return;
      }
    }catch(e){
      console.info('[Writing] AI fallback to offline:', e.message);
      // Kh√¥ng b√°o l·ªói ‚Üí t·ª± chuy·ªÉn sang offline
    }
  }

  /* ‚îÄ‚îÄ Ch·∫•m offline (lu√¥n ho·∫°t ƒë·ªông) ‚îÄ‚îÄ */
  if(btn){ btn.disabled=true; btn.innerHTML='‚è≥ ƒêang ch·∫•m...'; }
  await new Promise(r=>setTimeout(r,250));
  const eval_ = smartScore(ans, q);
  s.results[s.current] = eval_;
  if((eval_.score||0)>=60) s.correctCount++;
  gainXP(Math.round((eval_.score||0)/10));
  renderWritingCard();
}

/* ‚îÄ‚îÄ Card hi·ªÉn th·ªã k·∫øt qu·∫£ ch·∫•m ‚îÄ‚îÄ */
function buildEvalCard(r){
  const sc  = r.score||0;
  const cls = sc>=75?'ok':sc>=45?'warn':'err';
  const ic  = sc>=75?'üéâ':sc>=45?'üí°':'‚ùå';
  const col = sc>=75?'#059669':sc>=45?'#d97706':'#e11d48';
  const src = r._local
    ? `<span style="font-size:10px;color:var(--ink4);background:var(--bg2);padding:2px 6px;border-radius:10px;margin-left:6px">‚ö° offline</span>`
    : `<span style="font-size:10px;color:var(--teal);background:var(--teal-light);padding:2px 6px;border-radius:10px;margin-left:6px">‚ú® AI</span>`;

  // N√∫t l√†m l·∫°i ‚Äî ch·ªâ hi·ªán khi ƒëi·ªÉm < 60
  const retryBtn = sc < 60
    ? `<button onclick="retryWrCurrent()"
        style="display:inline-flex;align-items:center;gap:6px;background:var(--rose-light);color:var(--rose);border:1.5px solid #fecdd3;border-radius:var(--radius-sm);padding:9px 16px;cursor:pointer;font-size:13px;font-weight:700;font-family:var(--font-b);transition:all .15s;margin-top:12px;width:100%;justify-content:center"
        onmouseover="this.style.background='#fecdd3'" onmouseout="this.style.background='var(--rose-light)'">
        üîÑ L√†m l·∫°i c√¢u n√†y
      </button>`
    : '';

  return `<div class="wr-eval ${cls}" style="margin-top:16px">
    <div class="wr-eval-header">
      <span class="wr-eval-icon">${ic}</span>
      <span class="wr-eval-verdict">${r.verdict||''}</span>
      ${src}
      <span class="wr-eval-score" style="color:${col};margin-left:auto">${sc}<span style="font-size:12px;opacity:.6">/100</span></span>
    </div>

    <div style="margin:8px 0">
      ${r.comprehensible!==false
        ? `<span style="background:var(--teal-light);color:var(--teal);border-radius:20px;padding:3px 12px;font-size:12px;font-weight:700">‚úì C√¢u d·ªÖ hi·ªÉu</span>`
        : `<span style="background:var(--rose-light);color:var(--rose);border-radius:20px;padding:3px 12px;font-size:12px;font-weight:700">‚úó Kh√≥ hi·ªÉu √Ω</span>`
      }
    </div>

    <div class="wr-eval-comment">${r.comment||''}</div>

    ${r.correction?`
    <div class="wr-eval-correction">
      <div class="wr-eval-correction-lbl">‚úÖ C√¢u m·∫´u tham kh·∫£o</div>
      <div style="display:flex;align-items:flex-start;gap:10px;flex-wrap:wrap">
        <div class="wr-eval-correction-text" style="flex:1">${escHtml(r.correction)}</div>
        <button onclick="speak('${r.correction.replace(/'/g,"\'")}')"
          style="flex-shrink:0;background:var(--teal-light);border:1.5px solid rgba(13,148,136,.3);color:var(--teal);border-radius:20px;padding:5px 12px;cursor:pointer;font-size:12px;font-weight:600;font-family:var(--font-b);white-space:nowrap;transition:all .15s"
          onmouseover="this.style.background='var(--teal-mid);this.style.color=\'#fff\''" onmouseout="this.style.background='var(--teal-light)'">
          üîä Nghe
        </button>
      </div>
      ${r.correctionExplain?`<div class="wr-eval-explain">üí° ${r.correctionExplain}</div>`:''}
    </div>`:''}

    ${retryBtn}
  </div>`;
}

/* L√†m l·∫°i c√¢u hi·ªán t·∫°i ‚Äî xo√° k·∫øt qu·∫£, reset textarea, focus */
function retryWrCurrent(){
  const s = _wrSession; if(!s) return;
  const idx = s.current;
  // Ho√†n t√°c ƒëi·ªÉm correctCount n·∫øu tr∆∞·ªõc ƒë√≥ ƒë√£ t√≠nh
  const prev = s.results[idx];
  if(prev && (prev.score||0) >= 60) s.correctCount = Math.max(0, s.correctCount - 1);
  s.results[idx] = undefined;
  renderWritingCard();
  setTimeout(()=>{
    const ta = document.getElementById('wr-ans');
    if(ta){ ta.value = ''; ta.focus(); }
  }, 80);
  showToast('üîÑ Th·ª≠ l·∫°i n√†o! B·∫°n l√†m ƒë∆∞·ª£c!');
}

function advanceWr(){
  const s=_wrSession; if(!s) return;
  if(s.current<s.sentences.length-1){ s.current++; renderWritingCard(); }
  else renderWritingResult();
}
function prevWr(){
  const s=_wrSession; if(!s||s.current<=0) return;
  s.current--; renderWritingCard();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   5. M√ÄN H√åNH K·∫æT QU·∫¢
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderWritingResult(){
  const s = _wrSession; if(!s) return;
  const done   = s.results.filter(Boolean).length;
  const avg    = done ? Math.round(s.results.filter(Boolean).reduce((a,r)=>a+(r.score||0),0)/done) : 0;
  const emoji  = avg>=85?'üèÜ':avg>=65?'üåü':avg>=45?'üëç':'üí™';
  const title  = avg>=85?'Xu·∫•t s·∫Øc!':avg>=65?'T·ªët l·∫Øm!':avg>=45?'Kh√° ·ªïn!':'C·ªë g·∫Øng th√™m nh√©!';
  const missed = s.results.map((r,i)=>r&&r.score<60?{...r,i}:null).filter(Boolean);

  // Th·ªëng k√™ theo d·∫°ng b√†i
  const tplStats = {};
  s.sentences.forEach((q,i)=>{
    const r = s.results[i];
    if(!r) return;
    tplStats[q.templateId] = tplStats[q.templateId]||{count:0,total:0};
    tplStats[q.templateId].count++;
    tplStats[q.templateId].total += r.score||0;
  });

  document.getElementById('wr-content').innerHTML = `
    <div class="wr-result-wrap">
      <!-- Header k·∫øt qu·∫£ -->
      <div style="text-align:center;padding:20px 0 10px">
        <div style="font-size:52px">${emoji}</div>
        <div class="wr-result-title">${title}</div>
        <div style="font-size:13px;color:var(--ink3);margin-bottom:16px">
          ${done}/${s.sentences.length} c√¢u ¬∑ Ch·ªß ƒë·ªÅ: <strong>${s.topic}</strong>
          ${s.useAI?` ¬∑ <span style="color:var(--teal)">‚ú® AI ch·∫•m</span>`:' ¬∑ ‚ö° offline'}
        </div>
      </div>

      <!-- ƒêi·ªÉm t·ªïng -->
      <div class="wr-result-stats">
        <div class="wr-result-stat">
          <span class="wr-result-stat-val" style="color:var(--violet);font-size:32px">${avg}</span>
          <div class="wr-result-stat-lbl">ƒêi·ªÉm TB /100</div>
        </div>
        <div class="wr-result-stat">
          <span class="wr-result-stat-val" style="color:var(--teal)">${s.correctCount}</span>
          <div class="wr-result-stat-lbl">‚úÖ ƒê·∫°t (‚â•60ƒë)</div>
        </div>
        <div class="wr-result-stat">
          <span class="wr-result-stat-val" style="color:var(--rose)">${done-s.correctCount}</span>
          <div class="wr-result-stat-lbl">‚ùå C·∫ßn √¥n</div>
        </div>
      </div>

      <!-- Th·ªëng k√™ theo d·∫°ng b√†i -->
      ${Object.keys(tplStats).length > 1 ? `
      <div class="card" style="margin-bottom:16px;padding:14px">
        <div style="font-weight:700;font-size:13px;margin-bottom:10px">üìä ƒêi·ªÉm theo d·∫°ng b√†i</div>
        ${Object.entries(tplStats).map(([id,st])=>{
          const tpl = WR_TEMPLATES.find(t=>t.id===id);
          const avg_  = Math.round(st.total/st.count);
          return `<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
            <span style="font-size:12px;min-width:160px;color:var(--ink2)">${tpl?.label||id}</span>
            <div style="flex:1;background:var(--bg2);border-radius:4px;height:6px;overflow:hidden">
              <div style="width:${avg_}%;height:100%;background:${tpl?.color||'var(--teal)'};border-radius:4px;transition:width .4s"></div>
            </div>
            <span style="font-size:12px;font-weight:700;color:var(--ink);min-width:36px;text-align:right">${avg_}ƒë</span>
          </div>`;
        }).join('')}
      </div>` : ''}

      <!-- C√¢u c·∫ßn √¥n -->
      ${missed.length ? `
      <div class="wr-review-list">
        <div style="font-weight:700;font-size:14px;margin-bottom:12px">üìã C√¢u c·∫ßn √¥n l·∫°i (${missed.length})</div>
        ${missed.map(r=>`
          <div class="wr-review-item">
            <div style="font-size:11px;color:var(--ink4);margin-bottom:4px">B·∫°n vi·∫øt:</div>
            <div class="wr-review-user" style="color:var(--rose)">"${escHtml(r.userAns)}"</div>
            ${r.correction?`
            <div style="font-size:11px;color:var(--ink4);margin-top:6px;margin-bottom:2px">‚úÖ C√¢u chu·∫©n:</div>
            <div class="wr-review-correct">"${escHtml(r.correction)}"</div>`:``}
            ${r.correctionExplain?`<div style="font-size:12px;color:var(--ink3);margin-top:3px">üí° ${r.correctionExplain}</div>`:''}
          </div>`).join('')}
      </div>` : `
      <div style="background:var(--teal-light);border-radius:var(--radius);padding:16px;text-align:center;margin-bottom:16px;color:var(--teal);font-weight:700;font-size:15px">
        üéâ Tuy·ªát v·ªùi! T·∫•t c·∫£ c√¢u ƒë·ªÅu ƒë·∫°t ƒëi·ªÉm!
      </div>`}

      <!-- Actions -->
      <div style="display:flex;flex-direction:column;gap:10px;max-width:300px;margin:0 auto">
        <button class="btn btn-primary" style="font-size:15px;padding:14px;font-weight:800" onclick="startWritingSession()">
          ‚ûï Luy·ªán ti·∫øp
        </button>
        <button class="btn btn-outline" style="font-size:14px;padding:12px" onclick="renderWritingSetup()">
          üîÑ Thay ƒë·ªïi c·∫•u h√¨nh
        </button>
      </div>
    </div>`;
}

/* ‚îÄ‚îÄ‚îÄ wrErrCard (gi·ªØ nguy√™n, ch·ªâ d√πng cho edge cases) ‚îÄ‚îÄ‚îÄ */
function wrErrCard(e){
  const msg = String(e&&e.message?e.message:e||'');
  return `<div class="card" style="padding:32px;text-align:center">
    <div style="font-size:44px;margin-bottom:12px">‚ùå</div>
    <div style="font-family:var(--font-d);font-weight:700;font-size:17px;color:var(--rose);margin-bottom:14px">C√≥ l·ªói x·∫£y ra</div>
    <div style="font-size:12px;color:var(--ink4);background:var(--bg2);border-radius:6px;padding:8px;margin-bottom:16px;word-break:break-word;text-align:left">${msg}</div>
    <div style="display:flex;gap:10px;justify-content:center">
      <button class="btn btn-primary btn-sm" onclick="renderWritingSetup()">‚Üê Quay l·∫°i</button>
      <button class="btn btn-outline btn-sm" onclick="startWritingSession()">üîÑ Th·ª≠ l·∫°i</button>
    </div>
  </div>`;
}

/* ‚îÄ‚îÄ‚îÄ Aliases ‚îÄ‚îÄ‚îÄ */
function renderWritingQuestion(){ renderWritingCard(); }
function submitWritingAnswer(){ checkAnswer(); }
function nextWritingQuestion(){ advanceWr(); }
function prevWritingQuestion(){ prevWr(); }
function continueWritingSession(){ startWritingSession(); }
function saveWrAnthropicKey(){ saveWrKey(); }
function saveWrGeminiKey(){ saveWrKey(); }
function buildWritingEvalHtml(r){ return buildEvalCard(r); }
function wrErrorHtml(msg,st){ return wrErrCard({message:msg,status:st}); }


/* ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
   ‚ïë        SPEAKUP AUTH + FIREBASE ENGINE ‚Äî v41                  ‚ïë
   ‚ïë                                                               ‚ïë
   ‚ïë  H·ªá th·ªëng ƒëƒÉng nh·∫≠p / ƒëƒÉng k√Ω n·ªôi b·ªô:                       ‚ïë
   ‚ïë  ‚Ä¢ Admin: username="admin" / pass="Speakup@123123"            ‚ïë
   ‚ïë    ‚Üí Firebase Auth email: admin@speakup.internal              ‚ïë
   ‚ïë    ‚Üí D·ªØ li·ªáu ri√™ng bi·ªát, c√≥ badge üëë Admin                   ‚ïë
   ‚ïë  ‚Ä¢ User th∆∞·ªùng: ƒëƒÉng k√Ω username+password                     ‚ïë
   ‚ïë    ‚Üí Firebase Auth email: {username}@speakup.user             ‚ïë
   ‚ïë    ‚Üí L∆∞u profile v√†o Firestore users/{uid}/profile            ‚ïë
   ‚ïë    ‚Üí Vocab ho√†n to√†n t√°ch bi·ªát theo uid                       ‚ïë
   ‚ïë                                                               ‚ïë
   ‚ïë  Data isolation: users/{uid}/vocab, users/{uid}/_meta         ‚ïë
   ‚ïë  localStorage: backup khi offline, primary khi ch∆∞a login     ‚ïë
   ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù */

/* ‚îÄ‚îÄ CONSTANTS ‚îÄ‚îÄ */
const ADMIN_USERNAME  = 'admin';
const ADMIN_PASSWORD  = 'Speakup@123123';
const ADMIN_FB_EMAIL  = 'admin@speakup.internal';  // email gi·∫£ d√πng ƒë·ªÉ auth Firebase
const USER_DOMAIN     = '@speakup.user';           // suffix email cho user th∆∞·ªùng
const FB_CFG_KEY      = 'speakup_fb_cfg_v1';
const APP_SESSION_KEY = 'speakup_app_session';     // l∆∞u user ƒëang ƒëƒÉng nh·∫≠p

/* ‚îÄ‚îÄ FIREBASE INSTANCES ‚îÄ‚îÄ */
let _app=null, _auth=null, _db=null, _fbReady=false;
let _currentUser=null;   // { uid, username, displayName, role:'admin'|'user' }
let _unsubVocab=null, _unsubMeta=null;
let _syncTimer=null;

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   FIREBASE CONFIG
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function getFbConfig(){
  try{
    const s=localStorage.getItem(FB_CFG_KEY);
    if(s){ const c=JSON.parse(s); if(c?.apiKey&&!c.apiKey.startsWith('YOUR_')&&c.projectId) return c; }
  }catch(_){}
  return null;
}
function isRealConfig(c){ return c&&c.apiKey&&!c.apiKey.startsWith('YOUR_')&&c.projectId; }

async function initFirebase(cfg){
  if(!isRealConfig(cfg)) return false;
  try{
    if(_app){ try{await _app.delete();}catch(_){} }
    _app  = firebase.initializeApp(cfg,'speakup');
    _auth = _app.auth();
    _db   = _app.firestore();
    try{ await _db.enablePersistence({synchronizeTabs:true}); }catch(e){ /* ignore multi-tab */ }
    _fbReady=true;
    window.addEventListener('online',  ()=>{ if(_currentUser) setSyncBadge('ok','‚úÖ Online'); });
    window.addEventListener('offline', ()=>setSyncBadge('offline','üì∂ Offline'));
    console.log('[FB] Ready ‚úÖ',cfg.projectId);
    return true;
  }catch(e){
    console.error('[FB] Init error:',e);
    _fbReady=false; _app=null; _auth=null; _db=null;
    return false;
  }
}

/* Guard: m·ªçi call Firebase ƒë·ªÅu ph·∫£i qua h√†m n√†y */
function _fbOk(){ return _fbReady && _app && _auth && _db; }

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   UI HELPERS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function setSyncBadge(state,text){
  const b=document.getElementById('sync-badge'); if(!b)return;
  b.className='sync-badge '+state;
  b.innerHTML=state==='busy'?`<span class="spin"></span> ${text}`:text;
}

function showLoginWall(){
  // Always show fullscreen login wall ‚Äî c·∫£ desktop l·∫´n mobile
  document.getElementById('login-wall').classList.add('show');
}
function hideLoginWall(){
  document.getElementById('login-wall').classList.remove('show');
  // ƒê√≥ng mob account drawer n·∫øu ƒëang m·ªü
  if(typeof closeMobAccount==='function') closeMobAccount();
}

function _renderLoggedInUI(u){
  document.getElementById('ui-logged-out').style.display='none';
  document.getElementById('ui-logged-in').style.display='block';
  document.getElementById('auth-uname-lbl').textContent = u.displayName || u.username;
  const ph=document.getElementById('auth-av-ph');
  if(u.role==='admin'){
    ph.className='auth-avatar-ph admin-av';
    ph.textContent='üëë';
  } else {
    ph.className='auth-avatar-ph';
    ph.textContent=(u.displayName||u.username||'U')[0].toUpperCase();
  }
  const roleEl=document.getElementById('auth-role-el');
  roleEl.innerHTML=u.role==='admin'
    ?`<div class="auth-role-badge admin">üëë Admin</div>`
    :`<div class="auth-role-badge user">üë§ Th√†nh vi√™n</div>`;
  // Refresh Firebase status dot in sidebar
  if(typeof sbFbRefreshStatus === 'function') setTimeout(sbFbRefreshStatus, 300);
}
function _renderLoggedOutUI(){
  document.getElementById('ui-logged-out').style.display='block';
  document.getElementById('ui-logged-in').style.display='none';
  if(typeof sbFbRefreshStatus === 'function') setTimeout(sbFbRefreshStatus, 300);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SESSION PERSISTENCE (localStorage)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function saveAppSession(u){
  try{ localStorage.setItem(APP_SESSION_KEY,JSON.stringify(u)); }catch(_){}
}
function loadAppSession(){
  try{
    const s=localStorage.getItem(APP_SESSION_KEY);
    return s?JSON.parse(s):null;
  }catch(_){ return null; }
}
function clearAppSession(){
  localStorage.removeItem(APP_SESSION_KEY);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   LOGIN WALL ‚Äî Tab switching
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function switchLoginTab(tab){
  ['login','register'].forEach(t=>{
    document.getElementById('ltab-'+t).classList.toggle('active',t===tab);
    document.getElementById('ltab-'+t+'-panel').style.display=t===tab?'block':'none';
  });
  // Clear errors
  ['li-err','rg-err','rg-ok'].forEach(id=>{
    const el=document.getElementById(id); if(el) el.style.display='none';
  });
}

function togglePw(inputId, icon){
  const inp=document.getElementById(inputId);
  if(!inp) return;
  const show=inp.type==='password';
  inp.type=show?'text':'password';
  icon.textContent=show?'üôà':'üëÅ';
}

function validateUsernameInput(inp){
  const val=inp.value;
  const valid=/^[a-zA-Z0-9_]{3,30}$/.test(val);
  const hint=document.getElementById('rg-un-hint');
  if(!val){ hint.textContent=''; inp.classList.remove('err'); return; }
  if(!valid){
    inp.classList.add('err');
    hint.style.color='var(--rose)';
    hint.textContent='Ch·ªâ d√πng ch·ªØ c√°i, s·ªë, d·∫•u _ (3-30 k√Ω t·ª±)';
  } else {
    inp.classList.remove('err');
    hint.style.color='var(--teal)';
    hint.textContent='‚úì H·ª£p l·ªá';
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   APP LOGIN (admin + user th∆∞·ªùng)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function appLogin(){
  const username = document.getElementById('li-username').value.trim().toLowerCase();
  const password = document.getElementById('li-pass').value;
  const errEl    = document.getElementById('li-err');
  const btn      = document.getElementById('li-btn');

  errEl.style.display='none';
  if(!username||!password){
    errEl.textContent='‚ö†Ô∏è Vui l√≤ng nh·∫≠p t√™n ƒëƒÉng nh·∫≠p v√† m·∫≠t kh·∫©u.';
    errEl.style.display='block'; return;
  }

  btn.disabled=true; btn.textContent='‚è≥ ƒêang ƒëƒÉng nh·∫≠p...';

  try{
    /* ‚ïê‚ïê ADMIN ‚Äî x√°c th·ª±c c·ª•c b·ªô, ƒë·ªìng b·ªô Firebase UID th·∫≠t ‚ïê‚ïê */
    if(username === ADMIN_USERNAME){
      if(password !== ADMIN_PASSWORD){
        errEl.textContent='‚ùå Sai m·∫≠t kh·∫©u admin.';
        errEl.style.display='block'; return;
      }

      // Kh·ªüi ƒë·∫ßu v·ªõi uid c·ª•c b·ªô, s·∫Ω c·∫≠p nh·∫≠t th√†nh Firebase UID th·∫≠t n·∫øu c√≥
      let adminUid = 'admin_root';
      _currentUser = { uid: adminUid, username:'admin', displayName:'Administrator', role:'admin' };
      saveAppSession(_currentUser);

      // N·∫øu Firebase s·∫µn s√†ng ‚Üí ƒëƒÉng nh·∫≠p ƒê·ªíNG B·ªò ƒë·ªÉ l·∫•y UID th·∫≠t
      // (quan tr·ªçng: d·ªØ li·ªáu tr√™n Firestore ƒë∆∞·ª£c l∆∞u theo Firebase UID th·∫≠t)
      if(_fbOk()){
        try{
          let fbUser;
          try{
            const cred = await _auth.signInWithEmailAndPassword(ADMIN_FB_EMAIL, ADMIN_PASSWORD);
            fbUser = cred.user;
          }catch(e){
            if(e.code==='auth/user-not-found'||e.code==='auth/invalid-credential'||
               e.code==='auth/wrong-password'||e.code==='auth/invalid-email'){
              // T·∫°o t√†i kho·∫£n Firebase cho admin l·∫ßn ƒë·∫ßu
              const cred2 = await _auth.createUserWithEmailAndPassword(ADMIN_FB_EMAIL, ADMIN_PASSWORD);
              fbUser = cred2.user;
              await _db.collection('users').doc(fbUser.uid).collection('_meta').doc('profile').set({
                username:'admin', displayName:'Administrator', role:'admin',
                createdAt:firebase.firestore.FieldValue.serverTimestamp()
              });
            }
          }
          if(fbUser && fbUser.uid){
            // ‚òÖ QUAN TR·ªåNG: C·∫≠p nh·∫≠t uid th·∫≠t ‚Üí data Firestore s·∫Ω ƒë∆∞·ª£c load ƒë√∫ng
            _currentUser.uid = fbUser.uid;
            saveAppSession(_currentUser);
            console.log('[Admin] Firebase UID synced:', fbUser.uid);
          }
        }catch(e){
          console.warn('[Admin] Firebase auth failed, d√πng local uid. L·ªói:', e.code||e.message);
        }
      }

      await _afterLogin();
      return;
    }

    /* ‚ïê‚ïê USER TH∆Ø·ªúNG ‚Äî localStorage tr∆∞·ªõc, Firebase n·∫øu c√≥ ‚ïê‚ïê */

    // Lu√¥n check localStorage tr∆∞·ªõc (offline-first)
    const localUsers = JSON.parse(localStorage.getItem('speakup_users')||'{}');

    if(!_fbOk()){
      // === OFFLINE MODE: ch·ªâ d√πng localStorage ===
      const u = localUsers[username];
      if(!u){
        errEl.textContent='‚ùå T√†i kho·∫£n kh√¥ng t·ªìn t·∫°i. H√£y ƒëƒÉng k√Ω tr∆∞·ªõc.';
        errEl.style.display='block'; return;
      }
      if(u.passwordHash !== _simpleHash(password)){
        errEl.textContent='‚ùå Sai m·∫≠t kh·∫©u.';
        errEl.style.display='block'; return;
      }
      _currentUser={ uid:`local_${username}`, username, displayName:u.displayName||username, role:'user' };
      saveAppSession(_currentUser);
      await _afterLogin();
      return;
    }

    // === FIREBASE MODE ===
    const fbEmail = username + USER_DOMAIN;
    try{
      await _auth.signInWithEmailAndPassword(fbEmail, password);
    }catch(e){
      // N·∫øu Firebase l·ªói config/network ‚Üí fallback localStorage
      if(e.code==='auth/configuration-not-found' || e.code==='auth/network-request-failed' || e.code==='auth/internal-error'){
        const u = localUsers[username];
        if(u && u.passwordHash === _simpleHash(password)){
          _currentUser={ uid:`local_${username}`, username, displayName:u.displayName||username, role:'user' };
          saveAppSession(_currentUser);
          await _afterLogin();
          return;
        }
      }
      const msg = {
        'auth/user-not-found'        : '‚ùå T√†i kho·∫£n kh√¥ng t·ªìn t·∫°i. H√£y ƒëƒÉng k√Ω tr∆∞·ªõc.',
        'auth/wrong-password'        : '‚ùå Sai m·∫≠t kh·∫©u.',
        'auth/invalid-credential'    : '‚ùå T√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng.',
        'auth/invalid-email'         : '‚ùå T√™n ƒëƒÉng nh·∫≠p kh√¥ng h·ª£p l·ªá.',
        'auth/too-many-requests'     : '‚ö†Ô∏è Qu√° nhi·ªÅu l·∫ßn th·ª≠. Vui l√≤ng ch·ªù v√†i ph√∫t.',
        'auth/network-request-failed': '‚ö†Ô∏è M·∫•t k·∫øt n·ªëi m·∫°ng. Vui l√≤ng th·ª≠ l·∫°i.',
        'auth/configuration-not-found': '‚ö†Ô∏è Firebase ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh. Nh·∫•n ‚öôÔ∏è C·∫•u h√¨nh Firebase.',
      }[e.code] || '‚ùå ƒêƒÉng nh·∫≠p th·∫•t b·∫°i. H√£y th·ª≠ l·∫°i.';
      errEl.textContent=msg; errEl.style.display='block'; return;
    }

    const uid=_auth.currentUser.uid;
    let profile={username, displayName:username, role:'user'};
    try{
      const snap=await _db.collection('users').doc(uid).collection('_meta').doc('profile').get();
      if(snap.exists) profile={...profile,...snap.data()};
    }catch(_){}

    _currentUser={ uid, username:profile.username||username, displayName:profile.displayName||username, role:'user' };
    saveAppSession(_currentUser);
    await _afterLogin();

  }catch(e){
    console.error('[Login]',e);
    // Kh√¥ng hi·ªán l·ªói Firebase raw cho user
    errEl.textContent='‚ùå ƒêƒÉng nh·∫≠p th·∫•t b·∫°i. Ki·ªÉm tra l·∫°i th√¥ng tin.';
    errEl.style.display='block';
  }finally{
    btn.disabled=false; btn.textContent='üîê ƒêƒÉng nh·∫≠p';
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   APP REGISTER
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function appRegister(){
  const displayName = document.getElementById('rg-displayname').value.trim();
  const username    = document.getElementById('rg-username').value.trim().toLowerCase();
  const pass        = document.getElementById('rg-pass').value;
  const pass2       = document.getElementById('rg-pass2').value;
  const errEl       = document.getElementById('rg-err');
  const okEl        = document.getElementById('rg-ok');
  const btn         = document.getElementById('rg-btn');

  errEl.style.display='none'; okEl.style.display='none';

  // Validate input
  if(!username){
    errEl.textContent='‚ö†Ô∏è T√™n ƒëƒÉng nh·∫≠p kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.';
    errEl.style.display='block'; return;
  }
  if(!/^[a-zA-Z0-9_]{3,30}$/.test(username)){
    errEl.textContent='‚ö†Ô∏è T√™n ƒëƒÉng nh·∫≠p: ch·ªâ d√πng ch·ªØ c√°i, s·ªë, _ (3-30 k√Ω t·ª±).';
    errEl.style.display='block'; return;
  }
  if(username === ADMIN_USERNAME){
    errEl.textContent='‚ùå T√™n ƒëƒÉng nh·∫≠p n√†y ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng.';
    errEl.style.display='block'; return;
  }
  if(!pass || pass.length < 6){
    errEl.textContent='‚ö†Ô∏è M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±.';
    errEl.style.display='block'; return;
  }
  if(pass !== pass2){
    errEl.textContent='‚ùå X√°c nh·∫≠n m·∫≠t kh·∫©u kh√¥ng kh·ªõp.';
    errEl.style.display='block'; return;
  }

  btn.disabled=true; btn.textContent='‚è≥ ƒêang t·∫°o t√†i kho·∫£n...';

  try{
    /* ‚ïê‚ïê LU√îN l∆∞u v√†o localStorage tr∆∞·ªõc (offline-first) ‚ïê‚ïê */
    const localUsers = JSON.parse(localStorage.getItem('speakup_users')||'{}');
    if(localUsers[username]){
      errEl.textContent='‚ùå T√™n ƒëƒÉng nh·∫≠p ƒë√£ t·ªìn t·∫°i. H√£y ch·ªçn t√™n kh√°c.';
      errEl.style.display='block'; return;
    }

    // L∆∞u local ngay
    const dName = displayName || username;
    localUsers[username]={
      displayName: dName,
      passwordHash: _simpleHash(pass),
      createdAt: Date.now()
    };
    localStorage.setItem('speakup_users', JSON.stringify(localUsers));

    // Uid local ƒë·ªÉ d√πng ngay
    let uid = `local_${username}`;

    /* ‚ïê‚ïê N·∫øu c√≥ Firebase ‚Üí sync l√™n cloud song song ‚ïê‚ïê */
    if(_fbOk()){
      try{
        const fbEmail = username + USER_DOMAIN;
        const cred = await _auth.createUserWithEmailAndPassword(fbEmail, pass);
        uid = cred.user.uid; // d√πng uid th·∫≠t t·ª´ Firebase

        if(dName) await cred.user.updateProfile({displayName: dName}).catch(()=>{});

        await _db.collection('users').doc(uid).collection('_meta').doc('profile').set({
          username, displayName: dName, role:'user',
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      }catch(e){
        // Firebase l·ªói kh√¥ng sao ‚Äî ƒë√£ c√≥ localStorage
        if(e.code==='auth/email-already-in-use'){
          errEl.textContent='‚ùå T√™n ƒëƒÉng nh·∫≠p ƒë√£ t·ªìn t·∫°i tr√™n h·ªá th·ªëng.';
          errEl.style.display='block';
          // Rollback local
          delete localUsers[username];
          localStorage.setItem('speakup_users', JSON.stringify(localUsers));
          return;
        }
        console.warn('[Register] Firebase sync failed (using local):', e.code);
        // Ti·∫øp t·ª•c v·ªõi local uid
      }
    }

    _currentUser = { uid, username, displayName: dName, role:'user' };
    saveAppSession(_currentUser);

    okEl.textContent = 'üéâ T·∫°o t√†i kho·∫£n th√†nh c√¥ng! ƒêang v√†o app...';
    okEl.style.display='block';
    setTimeout(()=>_afterLogin(), 700);

  }catch(e){
    console.error('[Register]',e);
    errEl.textContent='‚ùå C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.';
    errEl.style.display='block';
  }finally{
    btn.disabled=false; btn.textContent='üöÄ T·∫°o t√†i kho·∫£n';
  }
}

/* ‚îÄ‚îÄ Hash ƒë∆°n gi·∫£n (ch·ªâ cho offline mode) ‚îÄ‚îÄ */
function _simpleHash(s){
  let h=0;
  for(let i=0;i<s.length;i++) h=(Math.imul(31,h)+s.charCodeAt(i))|0;
  return h.toString(36);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   AFTER LOGIN ‚Äî load data + update UI
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function _afterLogin(){
  hideLoginWall();
  _renderLoggedInUI(_currentUser);

  // ƒê·∫∑t l·∫°i S v·ªÅ r·ªóng ƒë·ªÉ tr√°nh tr·ªôn data c≈©
  S.vocab=[];S.topics={};S.stats={streak:0,xp:0,lastDate:''};
  S.currentTopic=null; S.study={words:[],idx:0};
  S.quiz={questions:[],current:0,correct:0,wrong:0,lives:3,missed:[],batchIdx:0};

  // ‚îÄ‚îÄ B∆∞·ªõc 1: Load data local NGAY L·∫¨P T·ª®C ‚îÄ‚îÄ
  _loadLocalData(_currentUser.uid);
  updStats(); renderTopics(); renderVocabList(); renderWeekCal();

  // ‚îÄ‚îÄ B∆∞·ªõc 2: Kh√¥i ph·ª•c session h·ªçc d·ªü c·ªßa user n√†y ‚îÄ‚îÄ
  const sessionRestored = _restoreUserSession(_currentUser.uid);
  if(!sessionRestored) showPanel('home');
  showToast('üëã Ch√†o m·ª´ng, '+(_currentUser.displayName||_currentUser.username)+'!');
  setTimeout(renderHomeDashboard, 200);

  // ‚îÄ‚îÄ B∆∞·ªõc 3: Sync Firestore n·ªÅn (kh√¥ng block UI) ‚îÄ‚îÄ
  if(_fbOk()){
    setSyncBadge('busy','‚òÅÔ∏è ƒêang ƒë·ªìng b·ªô...');
    _loadUserDataFromFirestore(_currentUser.uid).then(()=>{
      _startListeners(_currentUser.uid);
      // Sau khi c√≥ data cloud: c·∫≠p nh·∫≠t study.words theo topic hi·ªán t·∫°i
      if(S.currentTopic){
        const updated = S.vocab.filter(v=>v.topic===S.currentTopic);
        if(updated.length) S.study.words = updated;
      }
      // Render l·∫°i dashboard v·ªõi data m·ªõi t·ª´ cloud
      renderHomeDashboard();
      // C·∫≠p nh·∫≠t sync badge ·ªü mob drawer n·∫øu ƒëang m·ªü
      if(typeof updateMobSyncBadge==='function') updateMobSyncBadge();
    }).catch(e=>{
      console.warn('[_afterLogin] Firestore load failed:', e.code||e.message);
      renderHomeDashboard();
      if(typeof updateMobSyncBadge==='function') updateMobSyncBadge();
    });
  } else {
    setSyncBadge('offline','üíæ D·ªØ li·ªáu c·ª•c b·ªô');
    console.log('[_afterLogin] Firebase not ready ‚Äî offline. Words:', S.vocab.length);
    renderHomeDashboard();
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   LOAD / SAVE DATA (per-user isolation)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
/* LocalStorage namespace theo uid */
function _lsKey(uid,name){ return `su41_${uid}_${name}`; }

function _loadLocalData(uid){
  try{
    const d=localStorage.getItem(_lsKey(uid,'data'));
    if(d){
      const p=JSON.parse(d);
      S.vocab  = p.vocab  || [];
      S.topics = p.topics || {};
      S.stats  = p.stats  || S.stats;
    }
  }catch(_){}
}
function _saveLocalData(uid){
  try{
    localStorage.setItem(_lsKey(uid,'data'),JSON.stringify({
      vocab:S.vocab, topics:S.topics, stats:S.stats
    }));
  }catch(_){}
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   RESTORE USER SESSION ‚Äî kh√¥i ph·ª•c v·ªã tr√≠ h·ªçc d·ªü
   ƒê·ªçc t·ª´ key ri√™ng c·ªßa user: speakup_session_v2_{uid}
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function _restoreUserSession(uid){
  try{
    const key = 'speakup_session_v2_' + uid;
    const raw = localStorage.getItem(key);
    if(!raw) return false;
    const sess = JSON.parse(raw);

    if(sess.currentTopic) S.currentTopic = sess.currentTopic;

    // ‚îÄ‚îÄ Kh√¥i ph·ª•c Study ‚îÄ‚îÄ
    if(sess.currentTopic){
      const topicWords = S.vocab.filter(v=>v.topic===sess.currentTopic);
      let studyIdx = Math.min(sess.studyIdx||0, Math.max(topicWords.length-1,0));
      if(sess.studyTab==='speaking' && typeof sess.speakingIdx==='number'){
        studyIdx = Math.min(sess.speakingIdx, Math.max(topicWords.length-1,0));
      }
      S.study = { words: topicWords, idx: studyIdx };

      // ‚îÄ‚îÄ Kh√¥i ph·ª•c Quiz state ‚îÄ‚îÄ
      if(sess.topicQuiz && sess.topicQuiz.questions && sess.topicQuiz.questions.length){
        const tq = sess.topicQuiz;
        const questions = tq.questions.map(sq=>{
          const word = S.vocab.find(v=>String(v.id)===String(sq.word && sq.word.id));
          return word ? Object.assign({},sq,{word}) : null;
        }).filter(Boolean);
        if(questions.length) S.quiz = Object.assign({},tq,{questions});
      }
    }

    // ‚îÄ‚îÄ Kh√¥i ph·ª•c Roadmap Quiz ‚îÄ‚îÄ
    if(sess.rdpSession && sess.rdpSession.wordIds && sess.rdpSession.wordIds.length){
      const rs = sess.rdpSession;
      const words = rs.wordIds.map(id=>S.vocab.find(v=>String(v.id)===String(id))).filter(Boolean);
      if(words.length){
        const questions = (rs.questions||[]).map(sq=>{
          const word = S.vocab.find(v=>String(v.id)===String(sq.wordId));
          return word ? Object.assign({},sq,{word}) : null;
        }).filter(Boolean);
        if(questions.length){
          _rdpSession = {
            words, questions,
            current:rs.current||0, correct:rs.correct||0,
            wrong:rs.wrong||0, lives:(rs.lives!=null?rs.lives:3),
            extraMode:rs.extraMode||false, savedToLog:rs.savedToLog||false,
            missed:(rs.missed||[]).map(m=>({
              word:S.vocab.find(v=>String(v.id)===String(m.wordId)), answer:m.answer
            })).filter(m=>m.word),
          };
        }
      }
    }

    // ‚îÄ‚îÄ Kh√¥i ph·ª•c Review ‚îÄ‚îÄ
    if(sess.reviewSession && sess.reviewSession.questions && sess.reviewSession.questions.length){
      const rv = sess.reviewSession;
      const questions = rv.questions.map(sq=>{
        const word = S.vocab.find(v=>String(v.id)===String(sq.wordId));
        return word ? Object.assign({},sq,{word}) : null;
      }).filter(Boolean);
      if(questions.length){
        _reviewSession = {
          questions, current:rv.current||0, correct:rv.correct||0,
          wrong:rv.wrong||0, total:rv.total||questions.length,
          missed:(rv.missed||[]).map(m=>({
            word:S.vocab.find(v=>String(v.id)===String(m.wordId)), answer:m.answer
          })).filter(m=>m.word),
        };
      }
    }

    // ‚îÄ‚îÄ ƒêi·ªÅu h∆∞·ªõng ƒë√∫ng panel & tab ‚îÄ‚îÄ
    const panel = sess.panel || 'home';
    showPanel(panel);

    if(panel==='study'){
      const tab = sess.studyTab || 'flashcard';
      const tabSel = '#panel-study .tabs .tab-btn[onclick*="\'' + tab + '\'"]';
      const btn = document.querySelector(tabSel);
      switchTab(tab, btn);
    }
    if(panel==='roadmap'){
      const rdpTab = sess.rdpTab || 'plan';
      const tabMap = ['plan','stats','quiz10','review'];
      const tabIdx = tabMap.indexOf(rdpTab);
      const tabBtns = document.querySelectorAll('.rdp-tab');
      const tabBtn = tabBtns[tabIdx>=0?tabIdx:0];
      document.querySelectorAll('.rdp-tab').forEach(b=>b.classList.remove('active'));
      if(tabBtn) tabBtn.classList.add('active');
      tabMap.forEach(t=>{
        const el=document.getElementById('rdp-'+t+'-view');
        if(el) el.style.display=t===rdpTab?'block':'none';
      });
      if(rdpTab==='plan') renderRdpPlan();
      else if(rdpTab==='stats') renderRdpStats();
      else if(rdpTab==='quiz10'){ if(_rdpSession) showRdpQuestion(); else renderRdpQuiz10(); }
      else if(rdpTab==='review'){ if(_reviewSession) showReviewQuestion(); else renderReviewSetup(); }
      renderRdpTopStats();
    }

    console.log('[Session] Restored for uid:', uid, '| panel:', panel, '| tab:', sess.studyTab||'-');
    return true;
  }catch(e){ console.warn('[Session] restore error:',e); return false; }
}

/* ‚îÄ‚îÄ Firestore paths ‚îÄ‚îÄ */
const _col={
  vocab : uid=>_db.collection('users').doc(uid).collection('vocab'),
  meta  : uid=>_db.collection('users').doc(uid).collection('_meta'),
};
const _doc={
  stats  : uid=>_col.meta(uid).doc('stats'),
  topics : uid=>_col.meta(uid).doc('topics'),
  rdp    : uid=>_col.meta(uid).doc('rdpState'),
  profile: uid=>_col.meta(uid).doc('profile'),
};

async function _loadUserDataFromFirestore(uid){
  try{
    const [statsSnap,topicsSnap,vocabSnap]=await Promise.all([
      _doc.stats(uid).get(),
      _doc.topics(uid).get(),
      _col.vocab(uid).orderBy('_createdAt','asc').get(),
    ]);
    const hasCloud=!vocabSnap.empty||statsSnap.exists;
    if(hasCloud){
      if(statsSnap.exists){ const d={...statsSnap.data()}; delete d._updatedAt; delete d._migratedAt; S.stats={...S.stats,...d}; }
      if(topicsSnap.exists) S.topics=topicsSnap.data().topics||{};
      if(!vocabSnap.empty){
        S.vocab=vocabSnap.docs.map(d=>{ const r={id:d.id,...d.data()}; delete r._createdAt; delete r._updatedAt; return r; });
        S.vocab.forEach(v=>{ if(v.topic&&!S.topics[v.topic]) S.topics[v.topic]={desc:''}; });
      }
      updStats(); renderTopics(); renderVocabList(); renderWeekCal();
      _saveLocalData(uid);
      setSyncBadge('ok','‚úÖ ƒê√£ ƒë·ªìng b·ªô ('+S.vocab.length+' t·ª´)');
      console.log('[FB] Loaded',S.vocab.length,'words from Firestore');
    } else {
      // Cloud r·ªóng ‚Äî ki·ªÉm tra xem local c√≥ data kh√¥ng, n·∫øu c√≥ th√¨ upload l√™n
      if(S.vocab.length>0){
        console.log('[FB] Cloud empty but local has',S.vocab.length,'words ‚Äî auto migrating...');
        setSyncBadge('busy','‚¨ÜÔ∏è Upload '+S.vocab.length+' t·ª´ l√™n cloud...');
        await _migrateToCloud(uid);
      } else {
        setSyncBadge('ok','‚úÖ S·∫µn s√†ng');
      }
    }
  }catch(e){
    console.error('[FB] Load error:',e.code||e.message);
    // Ph√¢n lo·∫°i l·ªói ƒë·ªÉ hi·ªÉn th·ªã th√¥ng b√°o h·ªØu √≠ch
    if(e.code==='permission-denied'||e.code==='PERMISSION_DENIED'){
      setSyncBadge('err','üîí L·ªói quy·ªÅn Firestore');
      _showFirestoreRulesError();
    } else if(e.code==='unavailable'||e.code==='UNAVAILABLE'){
      setSyncBadge('offline','üì∂ Offline ‚Äî d√πng cache local');
    } else {
      setSyncBadge('err','‚ùå L·ªói ƒë·ªìng b·ªô: '+(e.code||e.message));
    }
    throw e; // re-throw ƒë·ªÉ caller bi·∫øt c√≥ l·ªói
  }
}

/* Hi·ªÉn th·ªã h∆∞·ªõng d·∫´n fix Firestore Rules */
function _showFirestoreRulesError(){
  const rules = `rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId}/{document=**} {
      allow read, write: if request.auth != null
        && request.auth.uid == userId;
    }
  }
}`;
  const msg = `üîí Firestore b·ªã ch·∫∑n b·ªüi Security Rules!

B·∫°n c·∫ßn c·∫≠p nh·∫≠t Firestore Rules:

1. V√†o Firebase Console ‚Üí Firestore Database ‚Üí Rules
2. X√≥a n·ªôi dung c≈©, d√°n rules sau:

${rules}

3. Nh·∫•n "Publish" ƒë·ªÉ l∆∞u.

Sau ƒë√≥ nh·∫•n OK v√† th·ª≠ ƒëƒÉng nh·∫≠p l·∫°i.`;
  if(confirm(msg)){
    // M·ªü Firebase Console
    const cfg = getFbConfig();
    if(cfg&&cfg.projectId){
      window.open('https://console.firebase.google.com/project/'+cfg.projectId+'/firestore/rules','_blank');
    } else {
      window.open('https://console.firebase.google.com','_blank');
    }
  }
}

async function _cloudSaveMeta(uid){
  if(!_db) return;
  const b=_db.batch();
  b.set(_doc.stats(uid), {...S.stats,_updatedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:true});
  b.set(_doc.topics(uid),{topics:S.topics,_updatedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:true});
  await b.commit();
}

async function _migrateToCloud(uid){
  if(!_db||!uid) return;
  const total=S.vocab.length;

  // L∆∞u meta + vocab song song
  const metaBatch=_db.batch();
  metaBatch.set(_doc.stats(uid),{...S.stats,_migratedAt:firebase.firestore.FieldValue.serverTimestamp()});
  metaBatch.set(_doc.topics(uid),{topics:S.topics});

  const CHUNK=400;
  const vocabBatches=[];
  for(let i=0;i<S.vocab.length;i+=CHUNK){
    const b=_db.batch();
    S.vocab.slice(i,i+CHUNK).forEach(v=>{
      b.set(_col.vocab(uid).doc(String(v.id)),
        {...v,_createdAt:firebase.firestore.FieldValue.serverTimestamp(),_updatedAt:firebase.firestore.FieldValue.serverTimestamp()});
    });
    vocabBatches.push(b);
  }

  // Commit meta + t·∫•t c·∫£ chunks song song
  await Promise.all([
    metaBatch.commit(),
    ...vocabBatches.map(b=>b.commit())
  ]);

  setSyncBadge('ok',`‚úÖ ƒê√£ upload ${total} t·ª´`);
}

/* ‚îÄ‚îÄ‚îÄ Debounced cloud save ‚Äî 3s debounce, kh√¥ng spam Firestore ‚îÄ‚îÄ‚îÄ */
let _lastSavedHash='';
function _dataHash(){ return S.vocab.length+'|'+(S.stats.xp||0)+'|'+(S.stats.streak||0); }

function _scheduleSave(){
  if(!_currentUser) return;
  clearTimeout(_syncTimer);
  // L∆∞u local ngay l·∫≠p t·ª©c (kh√¥ng debounce localStorage)
  _saveLocalData(_currentUser.uid);

  if(!_fbOk()){ setSyncBadge('offline','üíæ L∆∞u local'); return; }

  setSyncBadge('busy','üíæ ƒêang l∆∞u...');
  _syncTimer=setTimeout(async()=>{
    const hash=_dataHash();
    if(hash===_lastSavedHash){ setSyncBadge('ok','‚úÖ ƒê√£ l∆∞u'); return; } // kh√¥ng c√≥ g√¨ thay ƒë·ªïi
    try{
      await _cloudSaveMeta(_currentUser.uid);
      _lastSavedHash=hash;
      setSyncBadge('ok','‚úÖ ƒê√£ l∆∞u');
    }catch(e){ console.error('[FB] save:',e); setSyncBadge('err','‚ö†Ô∏è L·ªói l∆∞u'); }
  },3000); // 3s debounce ‚Äî tr√°nh write storm
}

/* ‚îÄ‚îÄ‚îÄ Realtime listeners ‚îÄ‚îÄ‚îÄ */
function _startListeners(uid){
  _stopListeners();
  _unsubVocab=_col.vocab(uid).orderBy('_createdAt','asc').onSnapshot(snap=>{
    const serverChg=snap.docChanges().filter(c=>!c.doc.metadata.hasPendingWrites&&!c.doc.metadata.fromCache);
    if(serverChg.length){
      S.vocab=snap.docs.map(d=>{ const r={id:d.id,...d.data()}; delete r._createdAt; delete r._updatedAt; return r; });
      updStats(); renderTopics(); renderVocabList();
      setSyncBadge('ok','‚úÖ C·∫≠p nh·∫≠t');
    }
  },e=>{ console.warn('[FB] vocab listener:',e); setSyncBadge('err','‚ö†Ô∏è M·∫•t k·∫øt n·ªëi'); });

  _unsubMeta=_doc.stats(uid).onSnapshot(snap=>{
    if(snap.exists&&!snap.metadata.hasPendingWrites){
      const d={...snap.data()}; delete d._updatedAt;
      S.stats={...S.stats,...d}; updStats();
    }
  },e=>console.warn('[FB] meta listener:',e));
}
function _stopListeners(){
  if(_unsubVocab){ _unsubVocab(); _unsubVocab=null; }
  if(_unsubMeta){  _unsubMeta();  _unsubMeta=null; }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   WORD OPS ‚Äî per-user Firestore
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function _cloudAddWord(v){
  if(!_currentUser||!_db) return;
  try{
    await _col.vocab(_currentUser.uid).doc(String(v.id)).set({
      ...v,_createdAt:firebase.firestore.FieldValue.serverTimestamp(),_updatedAt:firebase.firestore.FieldValue.serverTimestamp()
    });
  }catch(e){ console.error('[FB] addWord:',e); }
}
async function _cloudUpdateWord(v){
  if(!_currentUser||!_db) return;
  try{
    await _col.vocab(_currentUser.uid).doc(String(v.id)).set(
      {...v,_updatedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:true}
    );
  }catch(e){ console.error('[FB] updateWord:',e); }
}
async function _cloudDeleteWord(id){
  if(!_currentUser||!_db) return;
  try{ await _col.vocab(_currentUser.uid).doc(String(id)).delete(); }
  catch(e){ console.error('[FB] delWord:',e); }
}
async function _cloudDeleteWords(ids){
  if(!_currentUser||!_db||!ids.length) return;
  try{
    const CHUNK=400;
    for(let i=0;i<ids.length;i+=CHUNK){
      const b=_db.batch();
      ids.slice(i,i+CHUNK).forEach(id=>b.delete(_col.vocab(_currentUser.uid).doc(String(id))));
      await b.commit();
    }
  }catch(e){ console.error('[FB] delWords:',e); }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SIGN OUT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function appSignOut(){
  _stopListeners();
  clearTimeout(_syncTimer);
  // L∆∞u data + session tr∆∞·ªõc khi logout (d√πng ƒë√∫ng key c·ªßa user n√†y)
  if(_currentUser){
    _saveLocalData(_currentUser.uid);
    saveSession(); // l∆∞u session v·ªõi key ri√™ng c·ªßa user
  }
  clearAppSession();
  _currentUser=null; // ƒë·∫∑t null SAU saveSession ƒë·ªÉ _sessionKey() v·∫´n ƒë√∫ng uid
  if(_fbOk()){ try{ await _auth.signOut(); }catch(_){} }
  // Reset state UI (KH√îNG x√≥a session localStorage ‚Äî gi·ªØ l·∫°i ƒë·ªÉ login l·∫°i kh√¥i ph·ª•c)
  S.vocab=[];S.topics={};S.stats={streak:0,xp:0,lastDate:''};
  S.currentTopic=null; S.study={words:[],idx:0};
  S.quiz={questions:[],current:0,correct:0,wrong:0,lives:3,missed:[],batchIdx:0};
  updStats(); renderTopics(); renderVocabList(); renderWeekCal();
  _renderLoggedOutUI();
  showLoginWall();
  showToast('üëã ƒê√£ ƒëƒÉng xu·∫•t');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MANUAL SYNC
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function fbManualSync(){
  if(!_currentUser){ showToast('‚ö†Ô∏è Ch∆∞a ƒëƒÉng nh·∫≠p','warn'); return; }
  if(!_fbOk()){
    // Firebase ch∆∞a k·∫øt n·ªëi ‚Äî th·ª≠ kh·ªüi t·∫°o l·∫°i t·ª´ config ƒë√£ l∆∞u
    const cfg = getFbConfig();
    if(cfg && cfg.apiKey){
      showToast('‚è≥ ƒêang k·∫øt n·ªëi Firebase...','warn');
      try{
        const ok = await initFirebase(cfg);
        if(!ok){ showToast('‚ö†Ô∏è Firebase ch∆∞a k·∫øt n·ªëi. Ki·ªÉm tra config!','warn'); return; }
      }catch(e){ showToast('‚ö†Ô∏è Firebase ch∆∞a k·∫øt n·ªëi: '+(e.message||e.code),'warn'); return; }
    } else {
      showToast('‚ö†Ô∏è Firebase ch∆∞a c·∫•u h√¨nh. M·ªü T√†i kho·∫£n ‚Üí Firebase ƒë·ªÉ nh·∫≠p config!','warn'); return;
    }
  }
  setSyncBadge('busy','üîÑ ƒêang k√©o d·ªØ li·ªáu...');
  try{
    // PULL t·ª´ cloud v·ªÅ (∆∞u ti√™n cloud data ‚Äî mobile l·∫ßn ƒë·∫ßu local r·ªóng)
    await _loadUserDataFromFirestore(_currentUser.uid);
    _saveLocalData(_currentUser.uid);
    _lastSavedHash = _dataHash();
    setSyncBadge('ok','‚úÖ Sync xong');
    showToast('‚úÖ ƒê√£ ƒë·ªìng b·ªô! ' + S.vocab.length + ' t·ª´ v·ª±ng');
    if(typeof updateMobSyncBadge==='function') updateMobSyncBadge();
    // C·∫≠p nh·∫≠t mob stats n·∫øu drawer ƒëang m·ªü
    const mobStatWords = document.getElementById('mob-stat-words');
    const mobStatStreak = document.getElementById('mob-stat-streak');
    const mobStatXp = document.getElementById('mob-stat-xp');
    if(mobStatWords) mobStatWords.textContent = S.vocab.length;
    if(mobStatStreak) mobStatStreak.textContent = S.stats.streak||0;
    if(mobStatXp) mobStatXp.textContent = S.stats.xp||0;
  }catch(e){
    setSyncBadge('err','‚ùå L·ªói');
    showToast('‚ùå Sync l·ªói: '+(e.code||e.message),'error');
  }
}

// ‚îÄ‚îÄ‚îÄ H√†m ri√™ng: PUSH local l√™n cloud (d√πng khi mu·ªën ghi ƒë√® cloud b·∫±ng local) ‚îÄ‚îÄ‚îÄ
async function fbPushLocalToCloud(){
  if(!_currentUser){ showToast('‚ö†Ô∏è Ch∆∞a ƒëƒÉng nh·∫≠p','warn'); return; }
  if(!_fbOk()){ showToast('‚ö†Ô∏è Firebase ch∆∞a k·∫øt n·ªëi','warn'); return; }
  setSyncBadge('busy','‚¨ÜÔ∏è ƒêang upload...');
  try{
    await _migrateToCloud(_currentUser.uid);
    _saveLocalData(_currentUser.uid);
    _lastSavedHash = _dataHash();
    setSyncBadge('ok','‚úÖ Upload xong');
    showToast('‚úÖ ƒê√£ upload ' + S.vocab.length + ' t·ª´ l√™n cloud!');
  }catch(e){
    setSyncBadge('err','‚ùå L·ªói');
    showToast('‚ùå Upload l·ªói: '+(e.code||e.message),'error');
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MONKEY-PATCH APP FUNCTIONS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
/* save() ‚Äî localStorage ƒë√£ ƒë∆∞·ª£c _scheduleSave lo, ch·ªâ c·∫ßn schedule cloud */
const _origSave=save;
window.save=function(){
  _origSave(); // l∆∞u session state (panel, quiz state...)
  if(_currentUser) _scheduleSave(); // schedule cloud + local data
};

/* addV() ‚Äî batch words thay v√¨ write t·ª´ng c√°i */
let _addVBuffer=[];
let _addVTimer=null;
const _origAddV=addV;
window.addV=function(d){
  _origAddV(d);
  if(!_fbOk()||!_currentUser) return;
  const v=S.vocab[S.vocab.length-1];
  if(!v) return;
  _addVBuffer.push(v);
  clearTimeout(_addVTimer);
  _addVTimer=setTimeout(async()=>{
    const toWrite=[..._addVBuffer];
    _addVBuffer=[];
    if(!toWrite.length) return;
    try{
      if(toWrite.length===1){
        // 1 t·ª´ ‚Üí write tr·ª±c ti·∫øp
        await _cloudAddWord(toWrite[0]);
      } else {
        // Nhi·ªÅu t·ª´ ‚Üí batch write (import scenario)
        const CHUNK=400;
        for(let i=0;i<toWrite.length;i+=CHUNK){
          const b=_db.batch();
          toWrite.slice(i,i+CHUNK).forEach(v=>{
            b.set(_col.vocab(_currentUser.uid).doc(String(v.id)),
              {...v,_createdAt:firebase.firestore.FieldValue.serverTimestamp(),_updatedAt:firebase.firestore.FieldValue.serverTimestamp()});
          });
          await b.commit();
        }
      }
    }catch(e){ console.error('[FB] batch addV:',e); }
  },300); // gom 300ms
};

/* confirmImport ‚Äî addV ƒë√£ batch, ch·ªâ c·∫ßn save meta + ch·ªù buffer flush */
const _origConfirmImport=window.confirmImport;
window.confirmImport=async function(){
  _origConfirmImport&&_origConfirmImport();
  // Lu√¥n l∆∞u local data ngay l·∫≠p t·ª©c (k·ªÉ c·∫£ khi Firebase ch∆∞a s·∫µn s√†ng)
  if(_currentUser){
    _saveLocalData(_currentUser.uid);
  }
  if(_currentUser&&_fbOk()){
    setSyncBadge('busy','‚¨ÜÔ∏è ƒêang upload...');
    // Ch·ªù buffer addV flush xong (500ms) r·ªìi save meta + migrate to√†n b·ªô vocab
    setTimeout(async()=>{
      try{
        // D√πng _migrateToCloud ƒë·ªÉ ƒë·∫£m b·∫£o T·∫§T C·∫¢ vocab ƒë∆∞·ª£c ghi l√™n Firestore
        await _migrateToCloud(_currentUser.uid);
        _saveLocalData(_currentUser.uid);
        _lastSavedHash = _dataHash();
        setSyncBadge('ok','‚úÖ ƒê√£ upload '+S.vocab.length+' t·ª´ l√™n cloud');
        showToast('‚òÅÔ∏è ƒê√£ ƒë·ªìng b·ªô '+S.vocab.length+' t·ª´ l√™n cloud!');
      }catch(e){
        setSyncBadge('err','‚ùå Upload l·ªói');
        console.error('[Import] cloud upload error:', e);
      }
    }, 500);
  } else if(_currentUser && !_fbOk()){
    // Firebase ch∆∞a k·∫øt n·ªëi ‚Äî ghi log ƒë·ªÉ user bi·∫øt c·∫ßn sync th·ªß c√¥ng
    console.log('[Import] Firebase not connected ‚Äî data saved locally only. Words:', S.vocab.length);
    setSyncBadge('offline','üíæ L∆∞u local (ch∆∞a sync cloud)');
    showToast('üíæ ƒê√£ l∆∞u local! Nh·∫•n üîÑ Sync ƒë·ªÉ ƒë·ªìng b·ªô l√™n cloud.', 'warn');
  }
};

/* saveWord (edit) */
const _origSaveWord=window.saveWord;
window.saveWord=function(){
  _origSaveWord&&_origSaveWord();
  const id=document.getElementById('edit-word-id')?.value;
  if(id){ const v=S.vocab.find(x=>String(x.id)===String(id)); if(v) _cloudUpdateWord(v); }
};

/* toggleStar */
['toggleStar','toggleStarDetail'].forEach(fn=>{
  const orig=window[fn];
  window[fn]=function(id){
    orig&&orig(id);
    const v=S.vocab.find(x=>String(x.id)===String(id));
    if(v) _cloudUpdateWord(v);
  };
});

/* confirmDeleteWord */
const _origCDW=window.confirmDeleteWord;
window.confirmDeleteWord=function(id){
  const _oc=window.openConfirm;
  window.openConfirm=function(icon,title,msg,cb){
    _oc(icon,title,msg,async()=>{ await cb(); _cloudDeleteWord(id); _scheduleSave(); });
    window.openConfirm=_oc;
  };
  _origCDW&&_origCDW(id);
};

/* confirmDeleteSelected (bulk) */
const _origCDS=window.confirmDeleteSelected;
window.confirmDeleteSelected=function(){
  const ids=[...document.querySelectorAll('.vocab-check:checked')].map(c=>c.dataset.id);
  const _oc=window.openConfirm;
  window.openConfirm=function(icon,title,msg,cb){
    _oc(icon,title,msg,async()=>{ await cb(); _cloudDeleteWords(ids); });
    window.openConfirm=_oc;
  };
  _origCDS&&_origCDS();
};

/* confirmDeleteTopicByName + confirmDeleteTopic */
['confirmDeleteTopicByName','confirmDeleteTopic'].forEach(fn=>{
  const orig=window[fn];
  window[fn]=function(name){
    const topic=name||S.currentTopic;
    const ids=S.vocab.filter(v=>v.topic===topic).map(v=>v.id);
    const _oc=window.openConfirm;
    window.openConfirm=function(icon,title,msg,cb){
      _oc(icon,title,msg,async()=>{ await cb(); _cloudDeleteWords(ids); _scheduleSave(); });
      window.openConfirm=_oc;
    };
    orig&&orig(name);
  };
});

/* saveTopicModal (rename) */
const _origSTM=window.saveTopicModal;
window.saveTopicModal=function(){
  _origSTM&&_origSTM();
  if(_currentUser&&_fbOk()){
    setTimeout(async()=>{
      try{
        await _cloudSaveMeta(_currentUser.uid);
        const CHUNK=400,uid=_currentUser.uid;
        for(let i=0;i<S.vocab.length;i+=CHUNK){
          const b=_db.batch();
          S.vocab.slice(i,i+CHUNK).forEach(v=>{
            b.set(_col.vocab(uid).doc(String(v.id)),
              {topic:v.topic,_updatedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:true});
          });
          await b.commit();
        }
      }catch(e){ console.error('[FB] rename:',e); }
    },300);
  }
};

/* saveRdpState */
const _origSRdp=window.saveRdpState;
window.saveRdpState=function(state){
  _origSRdp&&_origSRdp(state);
  if(_currentUser&&_db){
    _doc.rdp(_currentUser.uid)
      .set({state,_updatedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:true})
      .catch(e=>console.warn('[FB] rdp:',e));
  }
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   FIREBASE CONFIG MODAL
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function openConfigModal(){
  const cfg=getFbConfig()||{};
  ['apiKey','authDomain','projectId','storageBucket','messagingSenderId','appId'].forEach(k=>{
    const el=document.getElementById('cfg-'+k); if(el) el.value=cfg[k]||'';
  });
  document.getElementById('cfg-err').style.display='none';
  document.getElementById('modal-config').classList.add('open');
}
function closeConfigModal(){ document.getElementById('modal-config').classList.remove('open'); }

/* ‚îÄ‚îÄ Login wall Firebase panel helpers ‚îÄ‚îÄ */
function toggleLoginWallFb(){
  const panel=document.getElementById('login-fb-panel');
  const btn=document.getElementById('login-fb-btn-text');
  if(!panel) return;
  const open=panel.style.display==='none'||!panel.style.display;
  panel.style.display=open?'block':'none';
  if(btn) btn.textContent=open?'Thu g·ªçn c·∫•u h√¨nh Firebase ‚ñ≤':'C·∫•u h√¨nh Firebase (tu·ª≥ ch·ªçn)';
  if(open){
    const cfg=getFbConfig();
    if(cfg){
      ['apiKey','authDomain','projectId','storageBucket','messagingSenderId','appId'].forEach(k=>{
        const el=document.getElementById('lw-cfg-'+k); if(el&&cfg[k]) el.value=cfg[k];
      });
    }
  }
}
async function lwSaveFbConfig(){
  const cfg={};
  ['apiKey','authDomain','projectId','storageBucket','messagingSenderId','appId'].forEach(k=>{
    const el=document.getElementById('lw-cfg-'+k); cfg[k]=el?el.value.trim():'';
  });
  const errEl=document.getElementById('lw-cfg-err');
  if(!cfg.apiKey||!cfg.authDomain||!cfg.projectId){
    if(errEl){errEl.textContent='‚ùå API Key, Auth Domain v√† Project ID l√† b·∫Øt bu·ªôc.';errEl.style.display='block';} return;
  }
  if(errEl) errEl.style.display='none';
  ['apiKey','authDomain','projectId','storageBucket','messagingSenderId','appId'].forEach(k=>{
    const el=document.getElementById('cfg-'+k); if(el) el.value=cfg[k];
  });
  try{
    localStorage.setItem(FB_CFG_KEY,JSON.stringify(cfg));
    const ok=await initFirebase(cfg);
    if(ok){
      const panel=document.getElementById('login-fb-panel');
      if(panel){ const msg=document.createElement('div'); msg.style.cssText='background:var(--teal-light);border-radius:8px;padding:8px 12px;font-size:12px;font-weight:700;color:var(--teal);margin-top:8px;'; msg.textContent='‚úÖ Firebase k·∫øt n·ªëi th√†nh c√¥ng! ƒêƒÉng nh·∫≠p ƒë·ªÉ ƒë·ªìng b·ªô.'; panel.appendChild(msg); }
    } else {
      if(errEl){errEl.textContent='‚ö†Ô∏è K·∫øt n·ªëi th·∫•t b·∫°i. Ki·ªÉm tra l·∫°i config.';errEl.style.display='block';}
    }
  }catch(e){
    if(errEl){errEl.textContent='‚ùå '+e.message;errEl.style.display='block';}
  }
}
async function lwPasteFbConfig(){
  try{
    const text=await navigator.clipboard.readText();
    const m=text.match(/\{[\s\S]*\}/);
    if(!m){alert('Kh√¥ng t√¨m th·∫•y firebaseConfig trong clipboard');return;}
    let cfg;
    try{ cfg=JSON.parse(m[0]); }catch(_){
      const clean=m[0].replace(/(\w+)\s*:/g,'"$1":').replace(/'/g,'"');
      try{cfg=JSON.parse(clean);}catch(e2){alert('Kh√¥ng parse ƒë∆∞·ª£c config. D√°n th·ªß c√¥ng nh√©!');return;}
    }
    ['apiKey','authDomain','projectId','storageBucket','messagingSenderId','appId'].forEach(k=>{
      const el=document.getElementById('lw-cfg-'+k); if(el&&cfg[k]) el.value=cfg[k];
    });
  }catch(e){ alert('Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c clipboard. H√£y d√°n th·ªß c√¥ng t·ª´ng tr∆∞·ªùng.'); }
}

async function saveAndConnectFirebase(){
  const required=['apiKey','authDomain','projectId'];
  const cfg={}; let ok=true;
  ['apiKey','authDomain','projectId','storageBucket','messagingSenderId','appId'].forEach(k=>{
    const v=document.getElementById('cfg-'+k).value.trim(); cfg[k]=v;
    if(required.includes(k)&&!v){ document.getElementById('cfg-'+k).classList.add('err-inp'); ok=false; }
    else document.getElementById('cfg-'+k).classList.remove('err-inp');
  });
  const errEl=document.getElementById('cfg-err');
  if(!ok){ errEl.textContent='‚ùå API Key, Auth Domain v√† Project ID l√† b·∫Øt bu·ªôc.'; errEl.style.display='block'; return; }
  try{
    localStorage.setItem(FB_CFG_KEY,JSON.stringify(cfg));
    closeConfigModal();
    showToast('‚úÖ ƒê√£ l∆∞u config ‚Äî ƒêang k·∫øt n·ªëi...');
    const ok2=await initFirebase(cfg);
    if(ok2) showToast('üî• Firebase k·∫øt n·ªëi th√†nh c√¥ng! H√£y ƒëƒÉng nh·∫≠p.');
    else showToast('‚ö†Ô∏è K·∫øt n·ªëi th·∫•t b·∫°i ‚Äî Ki·ªÉm tra l·∫°i config.','error');
  }catch(e){
    errEl.textContent='‚ùå '+e.message; errEl.style.display='block';
  }
}

function clearFbConfig(){
  localStorage.removeItem(FB_CFG_KEY);
  closeConfigModal();
  showToast('üóë ƒê√£ x√≥a config. T·∫£i l·∫°i trang.','warn');
}

async function pasteFbConfig(){
  try{
    const text=await navigator.clipboard.readText();
    const m=text.match(/\{[^{}]*apiKey[^{}]*\}/s);
    if(!m){ showToast('‚ùå Kh√¥ng t√¨m th·∫•y config trong clipboard','error'); return; }
    const json=m[0].replace(/(\w+)\s*:/g,'"$1":').replace(/'/g,'"');
    const parsed=JSON.parse(json);
    ['apiKey','authDomain','projectId','storageBucket','messagingSenderId','appId'].forEach(k=>{
      const el=document.getElementById('cfg-'+k); if(el&&parsed[k]) el.value=parsed[k];
    });
    showToast('üìã ƒê√£ d√°n config!');
  }catch(e){ showToast('‚ùå Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c clipboard.','error'); }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   LISTENING MODULE ‚Äî SpeakUp v44
   4 modes: fill-blank ¬∑ multiple-choice ¬∑ dialogue ¬∑ dictation
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

let _ltMode = 'mc';
let _ltSession = null; // { questions, current, correct, wrong, score }
let _ltCurrentSpeed = 1.0;
let _ltAudioPlaying = false;

function switchLtTab(mode, el) {
  document.querySelectorAll('#lt-tabs .lt-mode-tab').forEach(b => b.classList.remove('active'));
  if (el) el.classList.add('active');
  _ltMode = mode;
  renderListeningSetup();
}

function renderListeningSetup() {
  const el = document.getElementById('lt-content');
  if (!S.vocab.length) {
    el.innerHTML = `<div class="empty-state"><div class="empty-icon">üì≠</div><div class="empty-title">Ch∆∞a c√≥ t·ª´ v·ª±ng</div><div class="empty-sub">Import Excel ho·∫∑c th√™m t·ª´ tr∆∞·ªõc khi luy·ªán nghe</div><button class="btn btn-primary" onclick="showPanel('import')">üì• Import t·ª´ v·ª±ng</button></div>`;
    return;
  }

  const modeInfo = {
    mc:   { icon:'üÖê', title:'Tr·∫Øc nghi·ªám nghe', desc:'Nghe t·ª´/c√¢u ‚Üí ch·ªçn 1 trong 4 nghƒ©a ƒë√∫ng. Chu·∫©n IELTS Listening Part 1.', tip:'ƒê·ªçc 4 ƒë√°p √°n TR∆Ø·ªöC khi nh·∫•n nghe ƒë·ªÉ bi·∫øt m√¨nh c·∫ßn t√¨m th√¥ng tin g√¨.' },
    dialogue: { icon:'üí¨', title:'Nghe h·ªôi tho·∫°i', desc:'Nghe ƒëo·∫°n h·ªôi tho·∫°i t·ª´ v·ª±ng ƒë√£ h·ªçc ‚Üí tr·∫£ l·ªùi c√¢u h·ªèi comprehension.', tip:'Nghe l·∫ßn 1 ƒë·ªÉ n·∫Øm √Ω ch√≠nh, l·∫ßn 2 ch√∫ √Ω chi ti·∫øt c·ª• th·ªÉ.' },
    fill: { icon:'‚úèÔ∏è', title:'ƒêi·ªÅn t·ª´ v√†o ch·ªó tr·ªëng', desc:'Nghe c√¢u v√≠ d·ª• ‚Üí ƒëi·ªÅn t·ª´ c√≤n thi·∫øu. Luy·ªán li√™n k·∫øt √¢m thanh v·ªõi ch√≠nh t·∫£.', tip:'Nghe 1-2 l·∫ßn tr∆∞·ªõc khi ƒëi·ªÅn, ch√∫ √Ω ng·ªØ ƒëi·ªáu ƒë·ªÉ ƒëo√°n nghƒ©a.' },
    dictation: { icon:'üìù', title:'Ch√≠nh t·∫£ (Dictation)', desc:'Nghe c√¢u v√† g√µ l·∫°i ch√≠nh x√°c t·ª´ng t·ª´. Luy·ªán spelling + listening t·ªïng h·ª£p.', tip:'B·∫Øt ƒë·∫ßu v·ªõi t·ªëc ƒë·ªô 0.75x. Ch√∫ √Ω li√™n √¢m (linking sounds) khi nghe t·ª± nhi√™n.' }
  };
  const m = modeInfo[_ltMode] || modeInfo.mc;
  const topics = [...new Set(S.vocab.map(v => v.topic))].sort();
  const topicOpts = topics.map(t => {
    const r = TOPIC_RULES.find(x => x.name === t);
    return `<option value="${t}">${r?.emoji||'üìå'} ${t} (${S.vocab.filter(v=>v.topic===t).length} t·ª´)</option>`;
  }).join('');

  el.innerHTML = `
    <div class="lt-setup-card">
      <div style="display:flex;align-items:flex-start;gap:14px;margin-bottom:14px;flex-wrap:wrap">
        <div style="width:46px;height:46px;border-radius:12px;background:linear-gradient(135deg,#ecfeff,#cffafe);border:2px solid rgba(8,145,178,.2);display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0">${m.icon}</div>
        <div style="flex:1;min-width:0">
          <div style="font-family:var(--font-d);font-weight:800;font-size:16px;color:var(--ink);margin-bottom:3px">${m.title}</div>
          <div style="font-size:13px;color:var(--ink3);line-height:1.5">${m.desc}</div>
        </div>
      </div>
      <div class="sp-tip"><span class="sp-tip-icon">üí°</span><span>${m.tip}</span></div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end">
        <div style="flex:1;min-width:160px">
          <div style="font-size:11px;font-weight:700;color:var(--ink4);text-transform:uppercase;letter-spacing:.06em;margin-bottom:5px">Ch·ªß ƒë·ªÅ</div>
          <select class="sel-inp" id="lt-topic-sel" style="width:100%">
            <option value="">üé≤ Ng·∫´u nhi√™n t·∫•t c·∫£</option>
            ${topicOpts}
          </select>
        </div>
        <div style="flex:1;min-width:100px">
          <div style="font-size:11px;font-weight:700;color:var(--ink4);text-transform:uppercase;letter-spacing:.06em;margin-bottom:5px">S·ªë c√¢u</div>
          <select class="sel-inp" id="lt-count-sel" style="width:100%">
            <option value="5">5 c√¢u</option>
            <option value="10" selected>10 c√¢u</option>
            <option value="15">15 c√¢u</option>
            <option value="20">20 c√¢u</option>
          </select>
        </div>
        <button class="btn" style="padding:11px 22px;font-size:15px;font-weight:800;background:linear-gradient(135deg,#0891b2,#0d9488);color:#fff;border:none" onclick="startListening()">üéß B·∫Øt ƒë·∫ßu ‚Üí</button>
      </div>
    </div>

    <div class="card">
      <div style="font-family:var(--font-d);font-weight:700;font-size:15px;margin-bottom:12px">üìä Th·ªëng k√™ Listening</div>
      <div id="lt-stats-wrap">${renderLtStats()}</div>
    </div>`;
}

function renderLtStats() {
  try {
    const logs = JSON.parse(localStorage.getItem('speakup_lt_logs') || '[]');
    if (!logs.length) return '<div style="font-size:13px;color:var(--ink4);text-align:center;padding:12px">Ch∆∞a c√≥ l·∫ßn luy·ªán n√†o. H√£y b·∫Øt ƒë·∫ßu!</div>';
    const recent = logs.slice(-5).reverse();
    const avgScore = Math.round(logs.reduce((s,l)=>s+(l.score||0),0)/logs.length);
    return `<div style="display:flex;gap:14px;flex-wrap:wrap;margin-bottom:12px">
      <div style="flex:1;text-align:center;background:var(--teal-light);border-radius:10px;padding:12px;border:1px solid rgba(13,148,136,.2)">
        <div style="font-family:var(--font-d);font-size:26px;font-weight:900;color:var(--teal)">${logs.length}</div>
        <div style="font-size:11px;color:var(--ink4);margin-top:2px">L·∫ßn luy·ªán</div>
      </div>
      <div style="flex:1;text-align:center;background:var(--violet-light);border-radius:10px;padding:12px;border:1px solid rgba(124,58,237,.15)">
        <div style="font-family:var(--font-d);font-size:26px;font-weight:900;color:var(--violet)">${avgScore}%</div>
        <div style="font-size:11px;color:var(--ink4);margin-top:2px">ƒêi·ªÉm TB</div>
      </div>
    </div>
    <div style="font-size:12px;font-weight:700;color:var(--ink4);text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px">G·∫ßn ƒë√¢y</div>
    ${recent.map(l=>`<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border)">
      <span style="font-size:11px;color:var(--ink4);min-width:70px">${new Date(l.ts).toLocaleDateString('vi-VN')}</span>
      <span style="font-size:12px;font-weight:600;flex:1">${{fill:'‚úèÔ∏è ƒêi·ªÅn t·ª´',mc:'üÖê Tr·∫Øc nghi·ªám',dialogue:'üí¨ H·ªôi tho·∫°i',dictation:'üìù Ch√≠nh t·∫£'}[l.mode]||l.mode}</span>
      <span style="font-family:var(--font-d);font-weight:800;color:${l.score>=70?'var(--teal)':l.score>=40?'var(--amber)':'var(--rose)'}">${l.score}%</span>
    </div>`).join('')}`;
  } catch(e) { return ''; }
}

function startListening() {
  const topic = document.getElementById('lt-topic-sel').value;
  const count = parseInt(document.getElementById('lt-count-sel').value) || 10;
  let pool = topic ? S.vocab.filter(v => v.topic === topic) : [...S.vocab];
  if (pool.length < 3) { showToast('C·∫ßn √≠t nh·∫•t 3 t·ª´ v·ª±ng ƒë·ªÉ luy·ªán nghe!', 'error'); return; }

  pool = shuffle(pool).slice(0, Math.min(count, pool.length));

  const questions = pool.map(w => {
    if (_ltMode === 'fill') {
      const sent = w.example || `I use the word ${w.word} every day.`;
      return { word: w, sentence: sent, type: 'fill' };
    } else if (_ltMode === 'mc') {
      const distractors = shuffle(S.vocab.filter(v => v.id !== w.id)).slice(0, 3);
      const opts = shuffle([
        { id: w.id, label: w.meaning },
        ...distractors.map(d => ({ id: d.id, label: d.meaning }))
      ]);
      return { word: w, opts, correct: w.id, type: 'mc' };
    } else if (_ltMode === 'dialogue') {
      return { word: w, type: 'dialogue' };
    } else {
      const sent = w.example || `${w.word} is a very useful English word.`;
      return { word: w, sentence: sent, type: 'dictation' };
    }
  });

  // T·∫°o sessionId duy nh·∫•t ƒë·ªÉ cache dialogue ri√™ng m·ªói session, kh√¥ng b·ªã tr√πng
  const sessionId = Date.now().toString(36);
  _ltSession = { questions, current: 0, correct: 0, wrong: 0, score: 0, mode: _ltMode, topic, sessionId };
  showLtQuestion();
}

function showLtQuestion() {
  const { questions, current } = _ltSession;
  if (current >= questions.length) { showLtResult(); return; }

  const q = questions[current];
  const pct = Math.round(current / questions.length * 100);
  const el = document.getElementById('lt-content');

  let body = '';
  if (q.type === 'fill') body = renderLtFill(q);
  else if (q.type === 'mc') body = renderLtMC(q);
  else if (q.type === 'dialogue') body = renderLtDialogue(q);
  else body = renderLtDictation(q);

  el.innerHTML = `
    <div class="lt-topbar">
      <button class="btn btn-ghost btn-sm" onclick="endLtSession()" style="padding:6px 10px;flex-shrink:0">‚úï</button>
      <div class="lt-pbar-wrap"><div class="lt-pbar-fill" id="lt-pbar" style="width:${pct}%"></div></div>
      <div class="lt-score-badge">‚úì ${_ltSession.correct}</div>
      <span style="font-size:12px;font-weight:700;color:var(--ink4);white-space:nowrap">${current+1}/${questions.length}</span>
    </div>
    ${body}`;

  // Auto-play audio after render (skip for dialogue ‚Äî dialogue handles its own playback)
  if (q.type !== 'dialogue') {
    setTimeout(() => ltPlayAudio(q.word.word, q.word.example || q.word.word), 400);
  }
}

/* ‚îÄ‚îÄ Render: Fill blank ‚îÄ‚îÄ */
function renderLtFill(q) {
  const w = q.word;
  const blankSent = q.sentence.replace(new RegExp('\\b' + w.word + '\\b', 'i'), `<input class="lt-fill-input" id="lt-fill-inp" placeholder="?" autocomplete="off" autocorrect="off" autocapitalize="off" onkeydown="if(event.key==='Enter')checkLtFill()">`);
  return `
    <div class="lt-audio-card">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:14px">
        <span style="background:var(--teal-light);color:var(--teal);border-radius:20px;padding:3px 12px;font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:.07em">‚úèÔ∏è ƒêi·ªÅn t·ª´ c√≤n thi·∫øu</span>
        <span style="font-size:12px;color:var(--ink4)">${w.topic}</span>
      </div>
      ${renderLtPlayer(w)}
      <div style="font-size:13px;color:var(--ink3);margin-bottom:10px;font-weight:600">üí° G·ª£i √Ω: <strong>${w.meaning}</strong> <em style="font-style:italic">${w.ipa||''}</em></div>
      <div class="lt-fill-sentence">${blankSent}</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
        <button class="btn btn-primary" onclick="checkLtFill()">Ki·ªÉm tra ‚úì</button>
        <button class="btn btn-outline btn-sm" onclick="ltPlayAudio('${esc(w.word)}','${esc(q.sentence)}')">üîä Nghe l·∫°i</button>
        <button class="btn btn-ghost btn-sm" onclick="showLtHint()">üí° G·ª£i √Ω ch·ªØ c√°i</button>
      </div>
      <div id="lt-feedback-wrap"></div>
    </div>`;
}

/* ‚îÄ‚îÄ Render: MC ‚îÄ‚îÄ */
function renderLtMC(q) {
  const w = q.word;
  const LETS = ['A','B','C','D'];
  return `
    <div class="lt-audio-card">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:14px">
        <span style="background:var(--violet-light);color:var(--violet);border-radius:20px;padding:3px 12px;font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:.07em">üÖê Ch·ªçn nghƒ©a ƒë√∫ng</span>
      </div>
      ${renderLtPlayer(w)}
      <div style="font-size:14px;color:var(--ink2);margin-bottom:16px;font-weight:600">T·ª´ v·ª´a nghe c√≥ nghƒ©a l√† g√¨?</div>
      <div class="lt-opts" id="lt-opts">
        ${q.opts.map((o,i)=>`
          <div class="lt-opt" onclick="checkLtMC(this,'${o.id}','${q.correct}')">
            <div class="lt-opt-letter">${LETS[i]}</div>
            <div class="lt-opt-text">${o.label}</div>
          </div>`).join('')}
      </div>
      <div id="lt-feedback-wrap"></div>
    </div>`;
}

/* ‚îÄ‚îÄ Render: Dialogue ‚îÄ‚îÄ */
function renderLtDialogue(q) {
  const w = q.word;
  const sid = _ltSession?.sessionId || 'def';
  // Session-scoped cache key: unique per word per session ‚Üí lu√¥n t·∫°o h·ªôi tho·∫°i m·ªõi m·ªói session
  const ltDlgKey = `lt_dlg_${sid}_${w.id}`;

  const LETS = ['A','B','C','D'];
  const compQuestion = `T·ª´ "${w.word}" trong h·ªôi tho·∫°i mang nghƒ©a g√¨?`;
  const distractors = shuffle(S.vocab.filter(v=>v.id!==w.id)).slice(0,3);
  const opts = shuffle([
    {id:w.id, label:w.meaning},
    ...distractors.map(d=>({id:d.id, label:d.meaning}))
  ]);

  // Check session-scoped in-memory cache
  const cachedLines = _ltDlgSessionCache && _ltDlgSessionCache[ltDlgKey];

  // Build placeholder card first, then async fill dialogue
  const optHtml = opts.map((o,i)=>`
    <div class="lt-opt" onclick="checkLtMC(this,'${o.id}','${w.id}')">
      <div class="lt-opt-letter">${LETS[i]}</div>
      <div class="lt-opt-text">${o.label}</div>
    </div>`).join('');

  const buildCard = (lines) => {
    return `
    <div class="lt-audio-card">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:14px">
        <span style="background:var(--amber-light);color:var(--amber);border-radius:20px;padding:3px 12px;font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:.07em">&#x1F4AC; Nghe h&#7897;i tho&#7841;i</span>
        <span style="font-size:12px;color:var(--ink4)">${w.topic}</span>
      </div>
      <div style="background:var(--bg);border-radius:12px;padding:14px;margin-bottom:16px" id="lt-dlg-lines">
        ${lines ? lines.map((ln,i)=>`
          <div class="lt-dlg-line">
            <div class="lt-dlg-avatar ${ln.s==='A'?'a':'b'}">${ln.s==='A'?'&#x1F469;':'&#x1F468;'}</div>
            <div class="lt-dlg-bubble ${ln.s==='A'?'a':'b'}">
              <div class="lt-dlg-text">${ln.t} <button class="lt-dlg-play" onclick="speak('${esc(ln.t)}')">&#x1F50A;</button></div>
              <div class="lt-dlg-vi" id="dlg-vi-${i}" style="display:none">${ln.vi}</div>
            </div>
          </div>`).join('')
        : `<div style="text-align:center;padding:20px;color:var(--ink3)">
             <div style="font-size:22px;margin-bottom:8px">&#x23F3;</div>
             <div style="font-size:13px;font-weight:600">&#x0110;ang t&#7841;o h&#7897;i tho&#7841;i...</div>
           </div>`}
      </div>
      <button class="btn btn-outline btn-sm" onclick="document.querySelectorAll('[id^=dlg-vi]').forEach(e=>e.style.display='block')" style="margin-bottom:14px">&#x1F1FB;&#x1F1F3; Xem d&#7883;ch ngh&#297;a</button>
      ${lines ? `<div style="margin-bottom:14px"><button class="btn btn-outline btn-sm" onclick="ltPlayDialogue(${JSON.stringify(lines).replace(/"/g,'&quot;')})">&#x1F50A; Nghe l&#7841;i h&#7897;i tho&#7841;i</button></div>` : ''}
      <div style="font-size:14px;font-weight:700;color:var(--ink);margin-bottom:12px">&#x2753; ${compQuestion}</div>
      <div class="lt-opts" id="lt-opts">
        ${optHtml}
      </div>
      <div id="lt-feedback-wrap"></div>
    </div>`;
  };

  if (cachedLines) {
    return buildCard(cachedLines);
  }

  // Will render skeleton first, then load async
  // Store opts for async rendering
  q._ltOpts = opts;
  q._ltBuildCard = buildCard;

  // Async load dialogue after render
  setTimeout(async () => {
    const el = document.getElementById('lt-dlg-lines');
    if (!el) return;
    // Build a unique fallback that's different each time (shuffled template variants)
    const lines = await generateLtSessionDialogue(w, sid);
    if (!_ltDlgSessionCache) window._ltDlgSessionCache = {};
    _ltDlgSessionCache[ltDlgKey] = lines;
    if (!el) return;
    // Update dialogue area only (don't re-render whole card to preserve opts state)
    el.innerHTML = lines.map((ln,i)=>`
      <div class="lt-dlg-line">
        <div class="lt-dlg-avatar ${ln.s==='A'?'a':'b'}">${ln.s==='A'?'&#x1F469;':'&#x1F468;'}</div>
        <div class="lt-dlg-bubble ${ln.s==='A'?'a':'b'}">
          <div class="lt-dlg-text">${ln.t} <button class="lt-dlg-play" onclick="speak('${esc(ln.t)}')">&#x1F50A;</button></div>
          <div class="lt-dlg-vi" id="dlg-vi-${i}" style="display:none">${ln.vi}</div>
        </div>
      </div>`).join('');
    // Add play button after lines loaded
    const existingPlayBtn = document.getElementById('lt-dlg-play-btn');
    if (!existingPlayBtn) {
      const playWrap = document.createElement('div');
      playWrap.style.marginBottom = '14px';
      playWrap.innerHTML = `<button id="lt-dlg-play-btn" class="btn btn-outline btn-sm" onclick="ltPlayDialogue(${JSON.stringify(lines).replace(/"/g,'&quot;')})">&#x1F50A; Nghe l&#7841;i h&#7897;i tho&#7841;i</button>`;
      el.parentNode.insertBefore(playWrap, el.nextSibling);
    }
    // Auto-play
    ltPlayDialogue(lines);
  }, 200);

  return buildCard(null);
}

// Session-scoped in-memory cache for lt dialogues
if (typeof _ltDlgSessionCache === 'undefined') window._ltDlgSessionCache = {};

// Generate unique dialogue per word per session (kh√¥ng cache v√†o localStorage ƒë·ªÉ lu√¥n fresh)
async function generateLtSessionDialogue(w, sessionId) {
  const apiKey = getAnthropicKey();

  // Offline fallback: 8 b·ªëi c·∫£nh ƒë·ªùi th·ª±c kh√°c nhau, KH√îNG c√≥ ti·∫øng Vi·ªát trong c√¢u ti·∫øng Anh
  // M·ªói b·ªëi c·∫£nh x√¢y c√¢u t·ª± nhi√™n quanh t·ª´, KH√îNG ƒë·∫∑t c√¢u h·ªèi "what does it mean?"
  const ex = w.example || `It was a ${w.word} moment that I will never forget.`;
  const variantTemplates = [
    // 1. Bu·ªïi s√°ng t·∫°i qu√°n c√† ph√™
    [
      {s:'A', t:`Hey, you look tired. Did something ${w.word} happen last night?`, h:w.word, vi:`N√†y, tr√¥ng b·∫°n c√≥ v·∫ª m·ªát. T·ªëi qua c√≥ chuy·ªán g√¨ ${w.meaning} x·∫£y ra kh√¥ng?`},
      {s:'B', t:`Yeah, it was a pretty ${w.word} situation with my boss at work.`, h:w.word, vi:`·ª™, c√≥ m·ªôt t√¨nh hu·ªëng kh√° ${w.meaning} v·ªõi s·∫øp t√¥i ·ªü ch·ªó l√†m.`},
      {s:'A', t:`Oh no, that sounds stressful. How did you handle it?`, h:'', vi:`·ªí kh√¥ng, nghe c√≥ v·∫ª cƒÉng th·∫≥ng ƒë·∫•y. B·∫°n x·ª≠ l√Ω th·∫ø n√†o?`},
      {s:'B', t:`I just stayed calm. Being ${w.word} about it helped me respond better.`, h:w.word, vi:`T√¥i c·ªë b√¨nh tƒ©nh. Th√°i ƒë·ªô ${w.meaning} gi√∫p t√¥i ph·∫£n ·ª©ng t·ªët h∆°n.`},
    ],
    // 2. T·∫°i si√™u th·ªã
    [
      {s:'A', t:`Excuse me, could you help me find something? I'm a bit ${w.word} today.`, h:w.word, vi:`Xin l·ªói, b·∫°n c√≥ th·ªÉ gi√∫p t√¥i t√¨m th·ª© g√¨ kh√¥ng? H√¥m nay t√¥i h∆°i ${w.meaning}.`},
      {s:'B', t:`Of course! I felt ${w.word} here too on my first visit.`, h:w.word, vi:`T·∫•t nhi√™n! L·∫ßn ƒë·∫ßu ƒë·∫øn ƒë√¢y t√¥i c≈©ng th·∫•y ${w.meaning}.`},
      {s:'A', t:`Thanks, that's reassuring. Where are the fresh vegetables?`, h:'', vi:`C·∫£m ∆°n, v·∫≠y l√† t·ªët r·ªìi. Rau t∆∞∆°i ·ªü ƒë√¢u v·∫≠y?`},
      {s:'B', t:`Just follow me! It's normal to feel ${w.word} in a new place.`, h:w.word, vi:`ƒêi theo t√¥i nh√©! C·∫£m th·∫•y ${w.meaning} ·ªü n∆°i m·ªõi l√† chuy·ªán b√¨nh th∆∞·ªùng.`},
    ],
    // 3. T·∫°i c√¥ng s·ªü
    [
      {s:'A', t:`Did you see the news this morning? I was completely ${w.word}.`, h:w.word, vi:`B·∫°n c√≥ xem tin t·ª©c s√°ng nay kh√¥ng? T√¥i ho√†n to√†n ${w.meaning}.`},
      {s:'B', t:`Yes, the whole team was ${w.word} by the announcement.`, h:w.word, vi:`C√≥, c·∫£ nh√≥m ƒë·ªÅu ${w.meaning} tr∆∞·ªõc th√¥ng b√°o ƒë√≥.`},
      {s:'A', t:`I know, right? Nobody expected that to happen so quickly.`, h:'', vi:`T√¥i bi·∫øt m√†! Kh√¥ng ai nghƒ© chuy·ªán ƒë√≥ x·∫£y ra nhanh nh∆∞ v·∫≠y.`},
      {s:'B', t:`Well, at least the manager seemed less ${w.word} than the rest of us.`, h:w.word, vi:`√çt nh·∫•t th√¨ tr∆∞·ªüng nh√≥m c√≥ v·∫ª √≠t ${w.meaning} h∆°n ch√∫ng ta.`},
    ],
    // 4. Cu·ªëi tu·∫ßn ngo√†i c√¥ng vi√™n
    [
      {s:'A', t:`Wow, this park is so ${w.word}! I didn't expect it to be this beautiful.`, h:w.word, vi:`√îi, c√¥ng vi√™n n√†y th·∫≠t ${w.meaning}! T√¥i kh√¥ng ng·ªù l·∫°i ƒë·∫πp v·∫≠y.`},
      {s:'B', t:`Right? I feel ${w.word} every time I come here after a long week.`, h:w.word, vi:`ƒê√∫ng kh√¥ng? T√¥i lu√¥n c·∫£m th·∫•y ${w.meaning} m·ªói khi ƒë·∫øn ƒë√¢y sau m·ªôt tu·∫ßn d√†i.`},
      {s:'A', t:`Let's sit by the lake. I could use some fresh air.`, h:'', vi:`M√¨nh ng·ªìi c·∫°nh h·ªì ƒëi. T√¥i c·∫ßn h√≠t th·ªü kh√¥ng kh√≠ trong l√†nh.`},
      {s:'B', t:`Great idea. Being here always makes me feel ${w.word} and happy.`, h:w.word, vi:`Hay ƒë·∫•y. ·ªû ƒë√¢y lu√¥n khi·∫øn t√¥i c·∫£m th·∫•y ${w.meaning} v√† vui v·∫ª.`},
    ],
    // 5. Tr√™n xe bu√Ωt / ƒëang ƒëi ƒë∆∞·ªùng
    [
      {s:'A', t:`Oh no, the traffic is so bad. I'm starting to feel ${w.word}.`, h:w.word, vi:`√îi kh√¥ng, k·∫πt xe qu√°. T√¥i b·∫Øt ƒë·∫ßu c·∫£m th·∫•y ${w.meaning} r·ªìi.`},
      {s:'B', t:`I know. Situations like this always make me ${w.word} too.`, h:w.word, vi:`T√¥i bi·∫øt. Nh·ªØng t√¨nh hu·ªëng nh∆∞ n√†y c≈©ng l√†m t√¥i ${w.meaning}.`},
      {s:'A', t:`Let's listen to some music. It might help us relax.`, h:'', vi:`M√¨nh nghe nh·∫°c ƒëi. C√≥ th·ªÉ gi√∫p ch√∫ng ta th∆∞ gi√£n h∆°n.`},
      {s:'B', t:`Good call. I try not to get too ${w.word} over things I can't control.`, h:w.word, vi:`ƒê√∫ng r·ªìi. T√¥i c·ªë kh√¥ng qu√° ${w.meaning} v√¨ nh·ªØng th·ª© kh√¥ng ki·ªÉm so√°t ƒë∆∞·ª£c.`},
    ],
    // 6. T·∫°i nh√† h√†ng, ƒë·∫∑t m√≥n
    [
      {s:'A', t:`The menu here is huge. I'm a little ${w.word} about what to order.`, h:w.word, vi:`Th·ª±c ƒë∆°n ·ªü ƒë√¢y r·∫•t nhi·ªÅu. T√¥i h∆°i ${w.meaning} kh√¥ng bi·∫øt g·ªçi m√≥n g√¨.`},
      {s:'B', t:`Same! Their dishes all look ${w.word}. I want to try everything.`, h:w.word, vi:`T√¥i c≈©ng v·∫≠y! C√°c m√≥n ·ªü ƒë√¢y tr√¥ng ƒë·ªÅu ${w.meaning}. T√¥i mu·ªën th·ª≠ h·∫øt.`},
      {s:'A', t:`Maybe we can share a few dishes and taste more variety.`, h:'', vi:`M√¨nh chia s·∫ª v√†i m√≥n ƒë·ªÉ th·ª≠ nhi·ªÅu h∆°n ƒëi.`},
      {s:'B', t:`Perfect. That way nothing ${w.word} goes to waste either.`, h:w.word, vi:`Tuy·ªát. V·ª´a ${w.meaning} l·∫°i kh√¥ng l√£ng ph√≠.`},
    ],
    // 7. T·∫≠p gym / th·ªÉ d·ª•c
    [
      {s:'A', t:`Man, today's workout was absolutely ${w.word}. I can barely walk.`, h:w.word, vi:`B·∫°n ∆°i, bu·ªïi t·∫≠p h√¥m nay th·∫≠t s·ª± ${w.meaning}. T√¥i g·∫ßn nh∆∞ kh√¥ng ƒëi n·ªïi.`},
      {s:'B', t:`I agree! That new trainer is ${w.word} ‚Äî best session in months.`, h:w.word, vi:`T√¥i ƒë·ªìng √Ω! Hu·∫•n luy·ªán vi√™n m·ªõi th·∫≠t ${w.meaning} ‚Äî bu·ªïi t·∫≠p hay nh·∫•t trong nhi·ªÅu th√°ng.`},
      {s:'A', t:`My legs are going to be sore tomorrow for sure.`, h:'', vi:`Ch√¢n t√¥i ch·∫Øc s·∫Ω ƒëau nh·ª©c ng√†y mai m·∫•t.`},
      {s:'B', t:`Worth it though. Feeling ${w.word} after a hard workout is the best feeling.`, h:w.word, vi:`Nh∆∞ng x·ª©ng ƒë√°ng. C·∫£m gi√°c ${w.meaning} sau bu·ªïi t·∫≠p n·∫∑ng th·∫≠t tuy·ªát.`},
    ],
    // 8. Xem phim / t·ªëi ·ªü nh√†
    [
      {s:'A', t:`That movie ending was so ${w.word}! I did not see it coming at all.`, h:w.word, vi:`C√°i k·∫øt phim ƒë√≥ th·∫≠t ${w.meaning}! T√¥i ho√†n to√†n kh√¥ng ƒëo√°n ƒë∆∞·ª£c.`},
      {s:'B', t:`Same here. The whole story was ${w.word} from the very beginning.`, h:w.word, vi:`T√¥i c≈©ng v·∫≠y. To√†n b·ªô c√¢u chuy·ªán th·∫≠t ${w.meaning} t·ª´ ƒë·∫ßu ƒë·∫øn cu·ªëi.`},
      {s:'A', t:`We should watch the sequel next weekend. Are you free?`, h:'', vi:`Tu·∫ßn sau m√¨nh xem ph·∫ßn ti·∫øp theo nh√©. B·∫°n r·∫£nh kh√¥ng?`},
      {s:'B', t:`Absolutely! Any movie this ${w.word} deserves a follow-up.`, h:w.word, vi:`Nh·∫•t ƒë·ªãnh r·ªìi! B·ªô phim ${w.meaning} nh∆∞ v·∫≠y x·ª©ng ƒë√°ng ƒë∆∞·ª£c xem ti·∫øp.`},
    ],
  ];

  // Ch·ªçn variant d·ª±a tr√™n c·∫£ wordId l·∫´n sessionId ‚Üí m·ªói t·ª´ trong session c√≥ b·ªëi c·∫£nh kh√°c nhau
  const wordHash = String(w.id || w.word).split('').reduce((acc, c) => acc + c.charCodeAt(0), 0);
  const sessHash = sessionId.split('').reduce((acc, c) => acc + c.charCodeAt(0), 0);
  const variantIdx = (wordHash + sessHash) % variantTemplates.length;

  if (!apiKey) {
    // Offline: pick variant based on sessionId hash so different sessions get different dialogues
    return variantTemplates[variantIdx];
  }

  // With API: generate fully unique dialogue with real-life context
  const realLifeContexts = [
    'two friends at a coffee shop on a Monday morning',
    'two coworkers chatting during a lunch break',
    'two neighbors talking outside their apartment',
    'two friends shopping at a supermarket',
    'two gym buddies resting after a workout',
    'two classmates walking home from school',
    'two colleagues discussing weekend plans',
    'a customer and a friendly shop assistant',
    'two friends watching a movie at home',
    'two people sharing a taxi',
  ];
  // Pick a real-life context based on word hash to ensure variety across words
  const wordHash2 = String(w.id || w.word).split('').reduce((acc, c) => acc + c.charCodeAt(0), 0);
  const context = realLifeContexts[wordHash2 % realLifeContexts.length];

  const prompt = `You are writing a short English conversation script for a Vietnamese English-learning app.

WORD TO FEATURE: "${w.word}"
SCENE: ${context}
SESSION SEED: ${sessionId.slice(-6)}

STRICT RULES ‚Äî follow every rule or the output will be rejected:
1. Return ONLY a valid JSON array with exactly 4 objects. No markdown, no explanation, no extra text.
2. Field "t" (spoken text): ENGLISH ONLY ‚Äî absolutely ZERO Vietnamese characters. No meaning in parentheses. No translations inline. Just natural English speech (8-14 words).
3. Field "vi": Vietnamese translation of that English line (this is the ONLY place for Vietnamese).
4. Use "${w.word}" naturally in at least 2 of the 4 turns (mark in "h" field).
5. The scene must feel like a REAL everyday conversation ‚Äî NOT a language class, NOT "what does X mean?", NOT vocabulary discussion.
6. Characters talk about something happening in their lives. The word arises naturally in context.

JSON format (copy exactly):
[{"s":"A","t":"ENGLISH ONLY","h":"","vi":"Vietnamese here"},{"s":"B","t":"ENGLISH ONLY using ${w.word}","h":"${w.word}","vi":"Vietnamese here"},{"s":"A","t":"ENGLISH ONLY","h":"","vi":"Vietnamese here"},{"s":"B","t":"ENGLISH ONLY using ${w.word}","h":"${w.word}","vi":"Vietnamese here"}]
JSON:`;

  try {
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'x-api-key':apiKey,
        'anthropic-version':'2023-06-01',
        'anthropic-dangerous-direct-browser-access':'true'
      },
      body:JSON.stringify({ model:'claude-haiku-4-5-20251001', max_tokens:700, messages:[{role:'user',content:prompt}] })
    });
    if (res.ok) {
      const d = await res.json();
      const raw = (d?.content?.[0]?.text||'').trim();
      const cleaned = raw.replace(/^```(?:json)?\n?/,'').replace(/\n?```$/,'').trim();
      const parsed = JSON.parse(cleaned);
      if (Array.isArray(parsed) && parsed.length >= 4) {
        const lines = parsed.slice(0,4).map(ln => ({
          s: ln.s==='B'?'B':'A',
          t: String(ln.t||''),
          h: String(ln.h||''),
          vi: String(ln.vi||'')
        }));
        // Validate: field "t" must not contain Vietnamese characters (√† √° ·∫£ √£ ·∫° ƒÉ √¢ ƒë √™ √¥ ∆° ∆∞...)
        const vietnameseRegex = /[√†√°·∫£√£·∫°ƒÉ·∫Ø·∫±·∫≥·∫µ·∫∑√¢·∫•·∫ß·∫©·∫´·∫≠√®√©·∫ª·∫Ω·∫π√™·∫ø·ªÅ·ªÉ·ªÖ·ªá√¨√≠·ªâƒ©·ªã√≤√≥·ªè√µ·ªç√¥·ªë·ªì·ªï·ªó·ªô∆°·ªõ·ªù·ªü·ª°·ª£√π√∫·ªß≈©·ª•∆∞·ª©·ª´·ª≠·ªØ·ª±·ª≥√Ω·ª∑·ªπ·ªµƒë]/i;
        const hasVietnamese = lines.some(ln => vietnameseRegex.test(ln.t));
        if (!hasVietnamese) {
          return lines;
        }
        // If Vietnamese leaked into "t" field, strip it and keep the line anyway (best effort)
        return lines.map(ln => ({
          ...ln,
          // Remove anything inside parentheses that looks like Vietnamese translation
          t: ln.t.replace(/\s*[\(\["][^)\]"]*[\)\]"]/g, '').trim()
        }));
      }
    }
  } catch(e) { console.warn('generateLtSessionDialogue error:', e); }

  return variantTemplates[variantIdx];
}

/* ‚îÄ‚îÄ Render: Dictation ‚îÄ‚îÄ */
function renderLtDictation(q) {
  const w = q.word;
  return `
    <div class="lt-audio-card">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:14px">
        <span style="background:var(--rose-light);color:var(--rose);border-radius:20px;padding:3px 12px;font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:.07em">üìù G√µ l·∫°i nh·ªØng g√¨ nghe ƒë∆∞·ª£c</span>
      </div>
      ${renderLtPlayer(w)}
      <div style="font-size:13px;color:var(--ink3);margin-bottom:12px">H√£y g√µ l·∫°i <strong>ch√≠nh x√°c</strong> c√¢u v·ª´a nghe (kh√¥ng ph√¢n bi·ªát hoa th∆∞·ªùng).</div>
      <textarea class="lt-dict-input" id="lt-dict-inp" placeholder="G√µ c√¢u b·∫°n v·ª´a nghe..."></textarea>
      <div id="lt-dict-target" class="lt-dict-target"><strong>ƒê√°p √°n:</strong> ${q.sentence}</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
        <button class="btn btn-primary" onclick="checkLtDictation('${esc(q.sentence)}')">Ki·ªÉm tra ‚úì</button>
        <button class="btn btn-outline btn-sm" onclick="ltPlayAudio('${esc(w.word)}','${esc(q.sentence)}')">üîä Nghe l·∫°i</button>
      </div>
      <div id="lt-feedback-wrap"></div>
    </div>`;
}

/* ‚îÄ‚îÄ Audio player HTML ‚îÄ‚îÄ */
function renderLtPlayer(w) {
  return `
    <div class="lt-audio-player">
      <button class="lt-play-btn" id="lt-play-btn" onclick="ltPlayAudio('${esc(w.word)}','${esc(w.example||w.word)}')">‚ñ∂</button>
      <div class="lt-audio-info">
        <div class="lt-audio-label">Nh·∫•n ‚ñ∂ ƒë·ªÉ nghe</div>
        <div class="lt-audio-wave" id="lt-wave">
          ${[1,2,3,4,5,6,7].map(i=>`<div class="lt-wave-bar" id="wb${i}"></div>`).join('')}
        </div>
      </div>
      <div>
        <div style="font-size:10px;font-weight:700;color:var(--ink4);text-transform:uppercase;margin-bottom:5px">T·ªëc ƒë·ªô</div>
        <div class="lt-speed-row">
          ${[0.75,1,1.25].map(s=>`<button class="lt-speed-btn ${_ltCurrentSpeed===s?'active':''}" onclick="setLtSpeed(${s})">${s}x</button>`).join('')}
        </div>
      </div>
    </div>`;
}

function setLtSpeed(s) {
  _ltCurrentSpeed = s;
  document.querySelectorAll('.lt-speed-btn').forEach(b => {
    b.classList.toggle('active', parseFloat(b.textContent) === s);
  });
}

function ltPlayAudio(word, sentence) {
  if (!window.speechSynthesis) return;
  window.speechSynthesis.cancel();
  const btn = document.getElementById('lt-play-btn');
  const waves = document.querySelectorAll('.lt-wave-bar');
  if (btn) { btn.textContent = '‚èπ'; btn.classList.add('playing'); }
  waves.forEach(w => w.classList.add('active'));

  const text = sentence || word;
  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'en-US'; u.rate = _ltCurrentSpeed;
  const v = getFemaleUSVoice(); if (v) u.voice = v;
  u.onend = u.onerror = () => {
    if (btn) { btn.textContent = '‚ñ∂'; btn.classList.remove('playing'); }
    waves.forEach(w => w.classList.remove('active'));
  };
  window.speechSynthesis.speak(u);
}

function ltPlayDialogue(lines) {
  if (!lines || !lines.length) return;
  let i = 0;
  const playNext = () => {
    if (i >= lines.length) return;
    const u = new SpeechSynthesisUtterance(lines[i].t);
    u.lang = 'en-US'; u.rate = _ltCurrentSpeed;
    const v = getFemaleUSVoice(); if(v) u.voice = v;
    u.pitch = lines[i].s === 'B' ? 0.85 : 1.1;
    u.onend = () => { i++; setTimeout(playNext, 300); };
    window.speechSynthesis.speak(u);
  };
  window.speechSynthesis.cancel();
  setTimeout(playNext, 200);
}

/* ‚îÄ‚îÄ Check answers ‚îÄ‚îÄ */
function checkLtFill() {
  const inp = document.getElementById('lt-fill-inp');
  if (!inp) return;
  const q = _ltSession.questions[_ltSession.current];
  const w = q.word;
  const answer = inp.value.trim().toLowerCase();
  const correct = w.word.toLowerCase();
  const isOk = answer === correct || (correct.startsWith(answer.slice(0,-1)) && answer.length >= correct.length - 1);
  inp.classList.add(isOk ? 'correct' : 'wrong');
  inp.value = isOk ? w.word : inp.value;

  if (isOk) {
    _ltSession.correct++;
    gainXP(15);
    // Lock all action buttons except audio
    document.querySelectorAll('.lt-audio-card button:not(#lt-play-btn):not(.lt-speed-btn)').forEach(b => b.disabled = true);
    inp.disabled = true;
    // Show full result with correct word, meaning, example + Next button
    const wrap = document.getElementById('lt-feedback-wrap');
    if (wrap) {
      const escapedWord = w.word.replace(/'/g,"\\'");
      const escapedEx   = (w.example||'').replace(/'/g,"\\'");
      const exampleHtml = w.example
        ? `<div style="margin-top:8px;padding:10px 12px;background:rgba(255,255,255,.7);border-radius:8px;border-left:3px solid var(--teal)">
             <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:var(--ink4);margin-bottom:4px">&#x1F4AC; C&#226;u v&#237; d&#7909;</div>
             <div style="font-size:14px;color:var(--ink);font-style:italic;">"${esc(w.example)}"</div>
             <button class="btn btn-ghost btn-sm" style="margin-top:6px;font-size:12px;padding:4px 10px" onclick="ltPlayAudio('${escapedWord}','${escapedEx}')">&#x1F50A; Nghe c&#226;u</button>
           </div>`
        : '';
      wrap.innerHTML = `
        <div class="lt-feedback ok">
          <div class="lt-fb-icon">&#x1F389;</div>
          <div class="lt-fb-msg" style="flex:1">
            <div class="lt-fb-title">Ch&#237;nh x&#225;c! &#x1F31F;</div>
            <div style="font-size:13px;color:var(--ink2);margin-top:3px"><strong>${w.word}</strong> ${w.ipa?`<em style="color:var(--ink3)">${w.ipa}</em>`:''} = ${w.meaning}</div>
            ${exampleHtml}
            <div style="margin-top:10px">
              <button class="btn btn-primary btn-sm" style="font-size:13px;padding:8px 18px;font-weight:700" onclick="nextLtQuestion()">Ti&#7871;p theo &#x2192;</button>
            </div>
          </div>
        </div>`;
    }
  } else {
    gainXP(2);
    showLtFeedback(false, w.word, w.meaning);
    // Unlock retry: reset input after short delay
    setTimeout(() => {
      inp.classList.remove('wrong');
      inp.value = '';
      inp.disabled = false;
      inp.focus();
      const wrap = document.getElementById('lt-feedback-wrap');
      if (wrap) wrap.innerHTML = '';
    }, 1800);
  }
}

function checkLtMC(el, selectedId, correctId) {
  if (el.classList.contains('correct') || el.classList.contains('wrong') || el.classList.contains('locked')) return;
  const isOk = selectedId === correctId;
  const q = _ltSession.questions[_ltSession.current];
  const w = q.word;

  if (isOk) {
    // Mark correct & lock all
    document.querySelectorAll('.lt-opt').forEach(o => {
      const oid = o.getAttribute('onclick')?.match(/'([^']+)'/)?.[1];
      if (oid === correctId) o.classList.add('correct');
      o.style.pointerEvents = 'none';
    });
    _ltSession.correct++;
    gainXP(12);
    // Show answer details + example sentence + Next button (no auto-advance)
    const exampleHtml = w.example
      ? `<div style="margin-top:8px;padding:10px 12px;background:rgba(255,255,255,.7);border-radius:8px;border-left:3px solid var(--teal)">
           <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:var(--ink4);margin-bottom:4px">üí¨ C√¢u v√≠ d·ª•</div>
           <div style="font-size:14px;color:var(--ink);font-style:italic;">"${w.example}"</div>
           <button class="btn btn-ghost btn-sm" style="margin-top:6px;font-size:12px;padding:4px 10px" onclick="ltPlayAudio('${esc(w.word)}','${esc(w.example)}')">üîä Nghe c√¢u</button>
         </div>`
      : '';
    const wrap = document.getElementById('lt-feedback-wrap');
    if (wrap) {
      wrap.innerHTML = `
        <div class="lt-feedback ok">
          <div class="lt-fb-icon">üéâ</div>
          <div class="lt-fb-msg" style="flex:1">
            <div class="lt-fb-title">Ch√≠nh x√°c! üåü</div>
            <div style="font-size:13px;color:var(--ink2);margin-top:3px"><strong>${w.word}</strong> = ${w.meaning} <em style="color:var(--ink3)">${w.ipa||''}</em></div>
            ${exampleHtml}
            <div style="margin-top:10px">
              <button class="btn btn-primary btn-sm" style="font-size:13px;padding:8px 18px;font-weight:700" onclick="nextLtQuestion()">Ti·∫øp theo ‚Üí</button>
            </div>
          </div>
        </div>`;
    }
  } else {
    // Only highlight this wrong choice ‚Äî keep others clickable for retry
    el.classList.add('wrong');
    el.style.pointerEvents = 'none';
    gainXP(1);
    showLtFeedback(false, w.word + ' = ' + w.meaning, '‚ùå Sai r·ªìi ‚Äî th·ª≠ l·∫°i ƒë√°p √°n kh√°c!');
    // Shake the wrong option
    el.style.animation = 'shake .35s ease';
    setTimeout(() => el.style.animation = '', 400);
  }
}

function checkLtDictation(correctSent) {
  const inp = document.getElementById('lt-dict-inp');
  if (!inp) return;
  const answer = inp.value.trim().toLowerCase().replace(/[.,!?]/g,'');
  const correct = correctSent.toLowerCase().replace(/[.,!?]/g,'');
  const aWords = answer.split(/\s+/); const cWords = correct.split(/\s+/);
  const matched = cWords.filter((w,i) => aWords[i] && (aWords[i]===w || aWords[i].slice(0,-1)===w.slice(0,-1)));
  const score = Math.round(matched.length / cWords.length * 100);
  const isOk = score >= 75;
  document.getElementById('lt-dict-target').style.display = 'block';

  if (isOk) {
    _ltSession.correct++;
    gainXP(20);
    inp.disabled = true;
    // Disable action buttons
    document.querySelectorAll('.lt-audio-card button:not(#lt-play-btn):not(.lt-speed-btn)').forEach(b => b.disabled = true);
    // Show success feedback + Next button (no auto-advance)
    const wrap = document.getElementById('lt-feedback-wrap');
    if (wrap) {
      wrap.innerHTML = `
        <div class="lt-feedback ok">
          <div class="lt-fb-icon">&#x1F389;</div>
          <div class="lt-fb-msg" style="flex:1">
            <div class="lt-fb-title">Ch&#237;nh x&#225;c! &#x1F31F;</div>
            <div style="font-size:12px;color:var(--ink3);margin-top:3px">&#x0110;&#x1EE9; ch&#237;nh x&#225;c: <strong>${score}%</strong></div>
            <div style="margin-top:10px">
              <button class="btn btn-primary btn-sm" style="font-size:13px;padding:8px 18px;font-weight:700" onclick="nextLtQuestion()">Ti&#7871;p theo &#x2192;</button>
            </div>
          </div>
        </div>`;
    }
  } else {
    gainXP(3);
    showLtFeedback(false, correctSent, `&#x0110;&#x1EE9; ch&#237;nh x&#225;c: ${score}%`);
    // Allow retry: re-enable textarea after showing answer
    setTimeout(() => {
      inp.value = '';
      inp.disabled = false;
      inp.focus();
      document.getElementById('lt-dict-target').style.display = 'none';
      const wrap = document.getElementById('lt-feedback-wrap');
      if (wrap) wrap.innerHTML = '';
    }, 2500);
  }
}

function showLtFeedback(isOk, correctLabel, sub = '') {
  const wrap = document.getElementById('lt-feedback-wrap');
  if (!wrap) return;
  // For wrong MC: show inline tip without skip button (user retries by clicking another option)
  const isMC = _ltMode === 'mc' || _ltMode === 'dialogue';
  const retryNote = (!isOk && isMC)
    ? `<div style="font-size:12px;font-weight:700;color:#9f1239;margin-top:6px">&#x1F446; Nh&#7845;n &#x111;&#225;p &#225;n kh&#225;c &#x111;&#x1EC3; th&#7917; l&#7841;i</div>`
    : (!isOk
      ? `<div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
           <button class="btn btn-outline btn-sm" onclick="retryLtQuestion()" style="font-size:12px">&#x1F504; L&#xE0;m l&#7841;i</button>
           <button class="btn btn-sm" style="background:var(--ink4);color:#fff;border:none;font-size:12px;padding:6px 12px;border-radius:8px;cursor:pointer" onclick="skipLtQuestion()">&#x2192; B&#x1EFD; qua</button>
         </div>`
      : '');

  wrap.innerHTML = `
    <div class="lt-feedback ${isOk?'ok':'err'}">
      <div class="lt-fb-icon">${isOk?'&#x1F389;':'&#x1F4A1;'}</div>
      <div class="lt-fb-msg" style="flex:1">
        <div class="lt-fb-title">${isOk?'Ch&#237;nh x&#225;c! &#x1F31F;':'Ch&#432;a &#x111;&#250;ng!'}</div>
        ${!isOk?`<div class="lt-fb-correct">&#x0110;&#225;p &#225;n &#x111;&#250;ng: <strong>${correctLabel}</strong>${sub?` &mdash; <em>${sub}</em>`:''}</div>`:''}
        ${isOk&&sub?`<div style="font-size:12px;color:var(--ink3);margin-top:3px">${sub}</div>`:''}
        ${retryNote}
      </div>
    </div>`;
}

function retryLtQuestion() {
  // Reset current question without advancing counter
  const wrap = document.getElementById('lt-feedback-wrap');
  if (wrap) wrap.innerHTML = '';

  // Reset fill input
  const fillInp = document.getElementById('lt-fill-inp');
  if (fillInp) {
    fillInp.classList.remove('wrong', 'correct');
    fillInp.disabled = false;
    fillInp.value = '';
    fillInp.focus();
  }
  // Reset dict input
  const dictInp = document.getElementById('lt-dict-inp');
  if (dictInp) {
    dictInp.value = '';
    dictInp.disabled = false;
    dictInp.focus();
    const target = document.getElementById('lt-dict-target');
    if (target) target.style.display = 'none';
  }
  // Re-enable action buttons
  document.querySelectorAll('.lt-audio-card button:not(#lt-play-btn):not(.lt-speed-btn)').forEach(b => b.disabled = false);
  // Auto-replay audio
  const q = _ltSession.questions[_ltSession.current];
  if (q) setTimeout(() => ltPlayAudio(q.word.word, q.word.example || q.word.word), 300);
}

function skipLtQuestion() {
  _ltSession.wrong++;
  nextLtQuestion();
}

function showLtHint() {
  const inp = document.getElementById('lt-fill-inp');
  if (!inp) return;
  const q = _ltSession.questions[_ltSession.current];
  const w = q.word.word;
  inp.classList.remove('wrong');
  inp.value = w[0] + '_'.repeat(w.length - 1);
  inp.focus();
}

function nextLtQuestion() {
  _ltSession.current++;
  showLtQuestion();
}

function endLtSession() {
  _ltSession = null;
  renderListeningSetup();
}

function showLtResult() {
  const { correct, wrong, questions, mode } = _ltSession;
  const total = questions.length;
  const score = Math.round(correct / total * 100);
  _ltSession.score = score;

  // Save log
  try {
    const logs = JSON.parse(localStorage.getItem('speakup_lt_logs') || '[]');
    logs.push({ ts: Date.now(), mode, score, correct, wrong, total });
    if (logs.length > 50) logs.splice(0, logs.length - 50);
    localStorage.setItem('speakup_lt_logs', JSON.stringify(logs));
  } catch(e) {}

  gainXP(score >= 80 ? 50 : score >= 60 ? 30 : 10);

  const emoji = score >= 90?'üèÜ':score >= 70?'üåü':score >= 50?'üëç':'üí™';
  const msg = score >= 90?'Xu·∫•t s·∫Øc!':score >= 70?'T·ªët l·∫Øm!':score >= 50?'Kh√° ·ªïn!':'Luy·ªán th√™m nh√©!';

  document.getElementById('lt-content').innerHTML = `
    <div class="lt-result">
      <span class="lt-result-emoji">${emoji}</span>
      <div class="lt-result-title">${msg}</div>
      <div class="lt-result-sub">Ho√†n th√†nh ${total} c√¢u luy·ªán nghe</div>
      <div class="lt-result-stats">
        <div class="lt-result-stat">
          <span class="lt-result-stat-val" style="color:var(--teal)">${score}%</span>
          <div class="lt-result-stat-lbl">ƒêi·ªÉm s·ªë</div>
        </div>
        <div class="lt-result-stat">
          <span class="lt-result-stat-val" style="color:#059669">${correct}</span>
          <div class="lt-result-stat-lbl">‚úÖ ƒê√∫ng</div>
        </div>
        <div class="lt-result-stat">
          <span class="lt-result-stat-val" style="color:var(--rose)">${wrong}</span>
          <div class="lt-result-stat-lbl">‚ùå Sai</div>
        </div>
      </div>
      <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
        <button class="btn btn-primary" onclick="startListening()">üîÑ Luy·ªán ti·∫øp</button>
        <button class="btn btn-outline" onclick="renderListeningSetup()">‚öôÔ∏è Thay ƒë·ªïi b√†i</button>
        <button class="btn btn-outline" onclick="showPanel('speaking-pro')">üé§ Luy·ªán Speaking ‚Üí</button>
      </div>
    </div>`;
}

// Init listening panel on show
const _origShowPanel = window.showPanel;

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SPEAKING PRO MODULE ‚Äî SpeakUp v44
   4 modes: shadowing ¬∑ pronunciation ¬∑ roleplay ¬∑ read-aloud
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

let _spMode = 'shadow';
let _spSession = null;
let _spRecognition = null;
let _spIsRecording = false;
let _spRoleplayHistory = [];
let _spRoleplayContext = null;
let _spRAWords = [];
let _spRATranscript = '';

function switchSpTab(mode, el) {
  document.querySelectorAll('#sp-tabs .sp-mode-tab').forEach(b => b.classList.remove('active'));
  if (el) el.classList.add('active');
  _spMode = mode;
  renderSpSetup();
}

function renderSpSetup() {
  const el = document.getElementById('sp-content');
  if (!S.vocab.length) {
    el.innerHTML = `<div class="empty-state"><div class="empty-icon">üì≠</div><div class="empty-title">Ch∆∞a c√≥ t·ª´ v·ª±ng</div><button class="btn btn-primary" onclick="showPanel('import')">üì• Import t·ª´ v·ª±ng</button></div>`;
    return;
  }

  const modeInfo = {
    shadow: { icon:'üîÅ', title:'Shadowing', desc:'Nghe native speaker n√≥i, l·∫∑p l·∫°i ngay l·∫≠p t·ª©c c√πng √¢m thanh. K·ªπ thu·∫≠t luy·ªán n√≥i hi·ªáu qu·∫£ nh·∫•t t·ª´ ELSA Speak.' },
    pronunciation: { icon:'üî§', title:'Pronunciation Score', desc:'Ph√°t √¢m t·ª´ng t·ª´/c√¢u, AI ch·∫•m ƒëi·ªÉm t·ª´ng √¢m, ch·ªâ ra √¢m sai c·ª• th·ªÉ.' },
    roleplay: { icon:'üé≠', title:'Roleplay h·ªôi tho·∫°i', desc:'Nh·∫≠p vai trong t√¨nh hu·ªëng th·ª±c t·∫ø v·ªõi AI. Luy·ªán ph·∫£n x·∫° n√≥i t·ª± nhi√™n.' },
    readaloud: { icon:'üìñ', title:'Read Aloud', desc:'ƒê·ªçc to ƒëo·∫°n vƒÉn/c√¢u v√≠ d·ª• t·ª´ v·ª±ng ƒë√£ h·ªçc. Ch·∫•m ƒëi·ªÉm t·ª´ng t·ª´ theo m√†u s·∫Øc.' }
  };
  const m = modeInfo[_spMode];
  const topics = [...new Set(S.vocab.map(v => v.topic))].sort();
  const topicOpts = topics.map(t => `<option value="${t}">${t}</option>`).join('');

  el.innerHTML = `
    <div class="sp-setup-card">
      <div style="display:flex;align-items:flex-start;gap:14px;margin-bottom:16px;flex-wrap:wrap">
        <div style="width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg,var(--violet-light),#ede9fe);border:2px solid rgba(124,58,237,.2);display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0">${m.icon}</div>
        <div style="flex:1;min-width:0">
          <div style="font-family:var(--font-d);font-weight:700;font-size:17px;color:var(--ink);margin-bottom:3px">${m.title}</div>
          <div style="font-size:13px;color:var(--ink3);line-height:1.5">${m.desc}</div>
        </div>
      </div>
      ${_spMode === 'roleplay' ? renderRoleplaySetup() : `
      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end">
        <div style="flex:1;min-width:160px">
          <div style="font-size:11px;font-weight:700;color:var(--ink4);text-transform:uppercase;letter-spacing:.06em;margin-bottom:5px">Ch·ªß ƒë·ªÅ</div>
          <select class="sel-inp" id="sp-topic-sel" style="width:100%">
            <option value="">üé≤ T·∫•t c·∫£ ch·ªß ƒë·ªÅ</option>
            ${topicOpts}
          </select>
        </div>
        <div style="flex:1;min-width:100px">
          <div style="font-size:11px;font-weight:700;color:var(--ink4);text-transform:uppercase;letter-spacing:.06em;margin-bottom:5px">S·ªë t·ª´/c√¢u</div>
          <select class="sel-inp" id="sp-count-sel" style="width:100%">
            <option value="5">5</option>
            <option value="10" selected>10</option>
            <option value="15">15</option>
          </select>
        </div>
        <button class="btn btn-primary" style="padding:11px 22px;font-size:15px;background:linear-gradient(135deg,var(--violet),var(--teal))" onclick="startSpeakingPro()">üé§ B·∫Øt ƒë·∫ßu ‚Üí</button>
      </div>`}
    </div>
    <div id="sp-session-wrap"></div>`;
}

function renderRoleplaySetup() {
  const scenarios = [
    { id:'cafe', icon:'‚òï', title:'G·ªçi ƒë·ªì u·ªëng', sub:'T·∫°i qu√°n c√† ph√™', prompt:'You are a barista at a coffee shop. Help the customer order.' },
    { id:'hotel', icon:'üè®', title:'Check-in kh√°ch s·∫°n', sub:'T·∫°i qu·∫ßy l·ªÖ t√¢n', prompt:'You are a hotel receptionist. Help the guest check in.' },
    { id:'job', icon:'üíº', title:'Ph·ªèng v·∫•n xin vi·ªác', sub:'VƒÉn ph√≤ng c√¥ng ty', prompt:'You are a job interviewer. Ask about experience and skills.' },
    { id:'doctor', icon:'üë®‚Äç‚öïÔ∏è', title:'Kh√°m b·ªánh', sub:'T·∫°i ph√≤ng kh√°m', prompt:'You are a friendly doctor. Ask about symptoms and give advice.' },
    { id:'shop', icon:'üõí', title:'Mua s·∫Øm', sub:'C·ª≠a h√†ng th·ªùi trang', prompt:'You are a shop assistant. Help the customer find clothes.' },
    { id:'direction', icon:'üó∫Ô∏è', title:'H·ªèi ƒë∆∞·ªùng', sub:'Tr√™n ƒë∆∞·ªùng ph·ªë', prompt:'You are a local. Give directions to a tourist who is lost.' },
  ];
  return `
    <div style="font-size:13px;font-weight:700;color:var(--ink2);margin-bottom:12px">Ch·ªçn t√¨nh hu·ªëng luy·ªán t·∫≠p:</div>
    <div class="sp-mode-grid">
      ${scenarios.map(s=>`
        <div class="sp-mode-card" onclick="startRoleplay('${s.id}','${esc(s.prompt)}','${esc(s.title)}')">
          <div class="sp-mode-icon">${s.icon}</div>
          <div class="sp-mode-title">${s.title}</div>
          <div class="sp-mode-sub">${s.sub}</div>
        </div>`).join('')}
    </div>`;
}

function startSpeakingPro() {
  const topic = document.getElementById('sp-topic-sel')?.value || '';
  const count = parseInt(document.getElementById('sp-count-sel')?.value) || 10;
  let pool = topic ? S.vocab.filter(v => v.topic === topic) : [...S.vocab];
  if (!pool.length) { showToast('Kh√¥ng c√≥ t·ª´ v·ª±ng!', 'error'); return; }
  pool = shuffle(pool).slice(0, count);
  _spSession = { words: pool, current: 0, scores: [], mode: _spMode };
  showSpQuestion();
}

function showSpQuestion() {
  const { words, current } = _spSession;
  if (current >= words.length) { showSpResult(); return; }
  const w = words[current];
  const pct = Math.round(current / words.length * 100);
  const el = document.getElementById('sp-session-wrap');

  let body = '';
  if (_spMode === 'shadow') body = renderSpShadow(w, current, words.length, pct);
  else if (_spMode === 'pronunciation') body = renderSpPronunciation(w, current, words.length, pct);
  else body = renderSpReadAloud(w, current, words.length, pct);
  el.innerHTML = body;
  setTimeout(() => speak(w.example || w.word), 600);
}

/* ‚îÄ‚îÄ Shadowing ‚îÄ‚îÄ */
function renderSpShadow(w, cur, total, pct) {
  const sent = w.example || w.word;
  return `
    <div class="sp-topbar">
      <button class="btn btn-ghost btn-sm" onclick="endSpSession()" style="padding:6px 10px">‚úï</button>
      <div class="sp-pbar-wrap"><div class="sp-pbar-fill" style="width:${pct}%"></div></div>
      <span style="font-size:12px;font-weight:700;color:var(--ink4);white-space:nowrap">${cur+1}/${total}</span>
    </div>
    <div class="sp-shadow-card">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:14px">
        <span style="background:var(--violet-light);color:var(--violet);border-radius:20px;padding:3px 12px;font-size:11px;font-weight:800;text-transform:uppercase">üîÅ Shadowing</span>
        <span style="font-size:12px;color:var(--ink4)">${w.topic}</span>
      </div>
      <div class="sp-shadow-text">${sent}</div>
      ${w.ipa ? `<div class="sp-shadow-ipa">${w.word} ${w.ipa}</div>` : ''}
      <div class="sp-shadow-vi">${w.meaning}${w.example?` ‚Äî "${w.example}"`:''}</div>
      <div class="sp-tip">
        <span class="sp-tip-icon">üí°</span>
        <span>Nghe ‚Üí L·∫∑p l·∫°i <strong>ngay l·∫≠p t·ª©c</strong> c√πng l√∫c v·ªõi audio. ƒê·ª´ng ƒë·ª£i ƒë·∫øn khi nghe xong! ƒê√¢y l√† k·ªπ thu·∫≠t shadowing th·∫≠t s·ª±.</span>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:16px">
        <button class="btn btn-outline" onclick="speak('${esc(sent)}')">üîä Nghe g·ªëc</button>
        <button class="btn btn-outline" onclick="spSlowSpeak('${esc(sent)}')">üê¢ Nghe ch·∫≠m (0.7x)</button>
      </div>
      <div class="sp-rec-area">
        <button class="sp-rec-btn idle" id="sp-rec-btn" onclick="toggleSpRec('${esc(sent)}','${esc(w.word)}')">üéôÔ∏è</button>
        <div class="sp-rec-status" id="sp-rec-status">Nh·∫•n ƒë·ªÉ ghi √¢m khi b·∫Øt ch∆∞·ªõc</div>
        <div class="sp-rec-hint">Ghi √¢m trong khi audio ƒëang ph√°t ‚Äî ƒë√≥ l√† shadowing!</div>
      </div>
      <div id="sp-score-wrap"></div>
      <div id="sp-next-wrap"></div>
    </div>`;
}

/* ‚îÄ‚îÄ Pronunciation ‚îÄ‚îÄ */
function renderSpPronunciation(w, cur, total, pct) {
  return `
    <div class="sp-topbar">
      <button class="btn btn-ghost btn-sm" onclick="endSpSession()" style="padding:6px 10px">‚úï</button>
      <div class="sp-pbar-wrap"><div class="sp-pbar-fill" style="width:${pct}%"></div></div>
      <span style="font-size:12px;font-weight:700;color:var(--ink4);white-space:nowrap">${cur+1}/${total}</span>
    </div>
    <div class="sp-shadow-card">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:16px">
        <span style="background:var(--teal-light);color:var(--teal);border-radius:20px;padding:3px 12px;font-size:11px;font-weight:800;text-transform:uppercase">üî§ Ph√°t √¢m</span>
      </div>
      <div style="text-align:center;margin-bottom:20px">
        <div style="font-family:var(--font-d);font-size:40px;font-weight:900;color:var(--ink);margin-bottom:6px">${w.word}</div>
        <div style="font-size:16px;color:var(--ink3);font-style:italic;margin-bottom:8px">${w.ipa||''}</div>
        <div style="font-size:14px;color:var(--ink2);margin-bottom:16px">${w.meaning}</div>
        <button class="btn btn-outline" onclick="speak('${esc(w.word)}')">üîä Nghe m·∫´u</button>
      </div>
      ${w.example ? `<div style="font-size:14px;color:var(--ink3);font-style:italic;text-align:center;margin-bottom:16px;padding:10px;background:var(--bg);border-radius:8px">"${w.example}"</div>` : ''}
      <div class="sp-rec-area">
        <button class="sp-rec-btn idle" id="sp-rec-btn" onclick="toggleSpRec('${esc(w.example||w.word)}','${esc(w.word)}')">üéôÔ∏è</button>
        <div class="sp-rec-status" id="sp-rec-status">Nh·∫•n ƒë·ªÉ ph√°t √¢m t·ª´ "${w.word}"</div>
      </div>
      <div id="sp-score-wrap"></div>
      <div id="sp-next-wrap"></div>
    </div>`;
}

/* ‚îÄ‚îÄ Read Aloud ‚îÄ‚îÄ */
function renderSpReadAloud(w, cur, total, pct) {
  const sent = w.example || `${w.word} is a very useful English word.`;
  _spRAWords = sent.split(' ');
  return `
    <div class="sp-topbar">
      <button class="btn btn-ghost btn-sm" onclick="endSpSession()" style="padding:6px 10px">‚úï</button>
      <div class="sp-pbar-wrap"><div class="sp-pbar-fill" style="width:${pct}%"></div></div>
      <span style="font-size:12px;font-weight:700;color:var(--ink4);white-space:nowrap">${cur+1}/${total}</span>
    </div>
    <div class="sp-shadow-card">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:16px">
        <span style="background:var(--amber-light);color:var(--amber);border-radius:20px;padding:3px 12px;font-size:11px;font-weight:800;text-transform:uppercase">üìñ Read Aloud</span>
      </div>
      <div class="sp-ra-text" id="sp-ra-text">
        ${_spRAWords.map((word,i)=>`<span class="sp-ra-word" id="ra-w-${i}">${word}</span> `).join('')}
      </div>
      <div style="font-size:13px;color:var(--ink3);margin-bottom:16px">ƒê·ªçc to c√¢u tr√™n b·∫±ng ti·∫øng Anh r√µ r√†ng, ch√∫ √Ω t·ª´ ƒë∆∞·ª£c highlight.</div>
      <button class="btn btn-outline btn-sm" onclick="speak('${esc(sent)}')" style="margin-bottom:16px">üîä Nghe m·∫´u tr∆∞·ªõc</button>
      <div class="sp-rec-area">
        <button class="sp-rec-btn idle" id="sp-rec-btn" onclick="toggleSpRec('${esc(sent)}','${esc(w.word)}')">üéôÔ∏è</button>
        <div class="sp-rec-status" id="sp-rec-status">Nh·∫•n ‚Üí ƒê·ªçc to c√¢u tr√™n</div>
      </div>
      <div class="sp-transcript" id="sp-transcript">Transcript s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y...</div>
      <div id="sp-score-wrap"></div>
      <div id="sp-next-wrap"></div>
    </div>`;
}

/* ‚îÄ‚îÄ Recording Logic ‚îÄ‚îÄ */
function spSlowSpeak(text) {
  if (!window.speechSynthesis) return;
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'en-US'; u.rate = 0.7;
  const v = getFemaleUSVoice(); if(v) u.voice = v;
  window.speechSynthesis.speak(u);
}

function toggleSpRec(targetSent, targetWord) {
  if (_spIsRecording) { stopSpRec(); return; }

  const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRec) {
    showToast('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ghi √¢m. D√πng Chrome!', 'error');
    return;
  }

  _spIsRecording = true;
  const btn = document.getElementById('sp-rec-btn');
  const status = document.getElementById('sp-rec-status');
  if (btn) { btn.className = 'sp-rec-btn recording'; btn.textContent = '‚èπ'; }
  if (status) status.textContent = 'üî¥ ƒêang ghi √¢m... Nh·∫•n ƒë·ªÉ d·ª´ng';

  _spRecognition = new SpeechRec();
  _spRecognition.lang = 'en-US';
  _spRecognition.continuous = false;
  _spRecognition.interimResults = true;

  let finalTranscript = '';

  _spRecognition.onresult = (e) => {
    let interim = '';
    for (let i = e.resultIndex; i < e.results.length; i++) {
      if (e.results[i].isFinal) finalTranscript += e.results[i][0].transcript;
      else interim += e.results[i][0].transcript;
    }
    const transcEl = document.getElementById('sp-transcript');
    if (transcEl) { transcEl.textContent = (finalTranscript || interim) || '...'; transcEl.className = 'sp-transcript has-text'; }
  };

  _spRecognition.onend = () => {
    _spIsRecording = false;
    const btn = document.getElementById('sp-rec-btn');
    if (btn) { btn.className = 'sp-rec-btn idle'; btn.textContent = 'üéôÔ∏è'; }
    if (status) status.textContent = 'ƒêang ph√¢n t√≠ch...';
    const wordIpa = _spSession?.words?.[_spSession?.current]?.ipa || '';
    scoreSpSpeechEnhanced(finalTranscript || '', targetSent, targetWord, wordIpa);
  };

  _spRecognition.onerror = (e) => {
    _spIsRecording = false;
    const btn = document.getElementById('sp-rec-btn');
    if (btn) { btn.className = 'sp-rec-btn idle'; btn.textContent = 'üéôÔ∏è'; }
    if (status) status.textContent = 'Kh√¥ng nghe ƒë∆∞·ª£c ‚Äî th·ª≠ l·∫°i!';
  };

  _spRecognition.start();
}

function stopSpRec() {
  if (_spRecognition) _spRecognition.stop();
}

function scoreSpSpeech(transcript, targetSent, targetWord) {
  const status = document.getElementById('sp-rec-status');
  if (!transcript.trim()) {
    if (status) status.textContent = 'Kh√¥ng nghe ƒë∆∞·ª£c r√µ. Th·ª≠ l·∫°i!';
    return;
  }
  if (status) status.textContent = 'Ho√†n t·∫•t!';

  const tWords = targetSent.toLowerCase().replace(/[.,!?]/g,'').split(/\s+/);
  const sWords = transcript.toLowerCase().replace(/[.,!?]/g,'').split(/\s+/);

  // Word-by-word comparison for phoneme approximation
  const wordScores = tWords.map((tw, i) => {
    const sw = sWords[i] || '';
    if (!sw) return { word: tw, score: 0 };
    // Levenshtein-like similarity
    const maxLen = Math.max(tw.length, sw.length);
    let matches = 0;
    for (let j = 0; j < Math.min(tw.length, sw.length); j++) {
      if (tw[j] === sw[j]) matches++;
    }
    return { word: tw, score: Math.round(matches / maxLen * 100) };
  });

  const overallScore = wordScores.length
    ? Math.round(wordScores.reduce((s,w)=>s+w.score,0) / wordScores.length)
    : 0;

  // Highlight read-aloud words
  if (_spMode === 'readaloud') {
    wordScores.forEach((ws, i) => {
      const el = document.getElementById(`ra-w-${i}`);
      if (!el) return;
      el.className = 'sp-ra-word ' + (ws.score >= 80 ? 'done-good' : ws.score >= 50 ? 'done-ok' : 'done-bad');
    });
  }

  _spSession.scores.push(overallScore);
  gainXP(overallScore >= 70 ? 25 : overallScore >= 40 ? 10 : 5);

  showSpScore(overallScore, transcript, wordScores, targetWord);
}

function showSpScore(score, transcript, wordScores, targetWord) {
  const wrap = document.getElementById('sp-score-wrap');
  if (!wrap) return;

  const clr = score >= 70 ? 'var(--teal)' : score >= 40 ? 'var(--amber)' : 'var(--rose)';
  const msg = score >= 90 ? 'üåü Xu·∫•t s·∫Øc! Ph√°t √¢m chu·∫©n!' : score >= 70 ? 'üëç T·ªët! Luy·ªán th√™m nh√©' : score >= 40 ? 'üí™ Kh√° ·ªïn, c·∫£i thi·ªán ƒë∆∞·ª£c!' : 'üîÑ Th·ª≠ l·∫°i, c·∫ßn luy·ªán th√™m';

  // Show phoneme-like breakdown (top 5 words)
  const topWords = wordScores.slice(0, 6);
  const phonemeHTML = topWords.map(ws =>
    `<div class="sp-phoneme ${ws.score>=80?'good':ws.score>=50?'ok':'bad'}">
      <div class="sp-phoneme-sym">${ws.word}</div>
      <div class="sp-phoneme-pct">${ws.score}%</div>
    </div>`
  ).join('');

  wrap.innerHTML = `
    <div style="margin-top:16px;padding:16px;background:var(--surface2);border-radius:14px;border:1.5px solid var(--border)">
      <div style="display:flex;align-items:center;gap:14px;margin-bottom:12px">
        <div class="sp-score-ring">
          <svg width="96" height="96" viewBox="0 0 96 96">
            <circle cx="48" cy="48" r="38" fill="none" stroke="var(--bg2)" stroke-width="8"/>
            <circle cx="48" cy="48" r="38" fill="none" stroke="${clr}" stroke-width="8"
              stroke-dasharray="${2*Math.PI*38}" stroke-dashoffset="${2*Math.PI*38*(1-score/100)}"
              stroke-linecap="round" style="transition:stroke-dashoffset .8s"/>
          </svg>
          <div class="sp-score-ring-val" style="color:${clr}">${score}%</div>
        </div>
        <div style="flex:1">
          <div style="font-weight:800;font-size:15px;color:var(--ink);margin-bottom:4px">${msg}</div>
          <div style="font-size:13px;color:var(--ink3)">B·∫°n n√≥i: "<em>${transcript}</em>"</div>
        </div>
      </div>
      <div style="font-size:12px;font-weight:700;color:var(--ink4);text-transform:uppercase;margin-bottom:8px">T·ª´ng t·ª´:</div>
      <div class="sp-phoneme-row">${phonemeHTML}</div>
    </div>`;

  // Show next button
  const nextWrap = document.getElementById('sp-next-wrap');
  if (nextWrap) {
    nextWrap.innerHTML = `
      <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
        <button class="btn btn-outline btn-sm" onclick="showSpQuestion()">‚Üí Th·ª≠ l·∫°i kh√¥ng t√≠nh ƒëi·ªÉm</button>
        <button class="btn btn-primary" style="flex:1;justify-content:center;background:linear-gradient(135deg,var(--violet),var(--teal))" onclick="advanceSpQuestion()">Ti·∫øp theo ‚Üí</button>
      </div>`;
  }
}

function advanceSpQuestion() {
  _spSession.current++;
  showSpQuestion();
}

function endSpSession() {
  _spSession = null;
  if (_spRecognition) { _spRecognition.stop(); _spRecognition = null; }
  _spIsRecording = false;
  renderSpSetup();
}

function showSpResult() {
  const { scores, words, mode } = _spSession;
  const avg = scores.length ? Math.round(scores.reduce((s,x)=>s+x,0)/scores.length) : 0;
  gainXP(avg >= 80 ? 60 : avg >= 60 ? 40 : 20);

  const emoji = avg>=90?'üèÜ':avg>=70?'üåü':avg>=50?'üëç':'üí™';
  document.getElementById('sp-session-wrap').innerHTML = `
    <div class="lt-result">
      <span class="lt-result-emoji">${emoji}</span>
      <div class="lt-result-title">${avg>=80?'Ph√°t √¢m tuy·ªát v·ªùi!':avg>=60?'Ti·∫øn b·ªô r√µ r·ªát!':'H√£y luy·ªán th√™m!'}</div>
      <div class="lt-result-sub">Ho√†n th√†nh ${words.length} ${mode==='shadow'?'c√¢u Shadowing':mode==='pronunciation'?'t·ª´ Pronunciation':'c√¢u Read Aloud'}</div>
      <div class="lt-result-stats">
        <div class="lt-result-stat"><span class="lt-result-stat-val" style="color:var(--violet)">${avg}%</span><div class="lt-result-stat-lbl">ƒêi·ªÉm TB</div></div>
        <div class="lt-result-stat"><span class="lt-result-stat-val" style="color:#059669">${scores.filter(s=>s>=70).length}</span><div class="lt-result-stat-lbl">‚úÖ T·ªët</div></div>
        <div class="lt-result-stat"><span class="lt-result-stat-val" style="color:var(--rose)">${scores.filter(s=>s<50).length}</span><div class="lt-result-stat-lbl">üîÑ C·∫ßn luy·ªán</div></div>
      </div>
      <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
        <button class="btn btn-primary" style="background:linear-gradient(135deg,var(--violet),var(--teal))" onclick="startSpeakingPro()">üîÑ Luy·ªán ti·∫øp</button>
        <button class="btn btn-outline" onclick="renderSpSetup()">‚öôÔ∏è ƒê·ªïi mode</button>
        <button class="btn btn-outline" onclick="showPanel('listening')">üéß Luy·ªán Listening ‚Üí</button>
      </div>
    </div>`;
}

/* ‚îÄ‚îÄ Roleplay ‚îÄ‚îÄ */
async function startRoleplay(id, prompt, title) {
  _spRoleplayHistory = [];
  _spRoleplayContext = { id, prompt, title };
  const el = document.getElementById('sp-session-wrap');
  el.innerHTML = `
    <div class="sp-shadow-card">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:14px">
        <span style="background:var(--violet-light);color:var(--violet);border-radius:20px;padding:3px 12px;font-size:11px;font-weight:800;text-transform:uppercase">üé≠ ${title}</span>
        <button class="btn btn-ghost btn-sm" onclick="renderSpSetup()" style="margin-left:auto">‚úï K·∫øt th√∫c</button>
      </div>
      <div class="sp-rp-chat" id="sp-rp-chat"></div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="sp-rec-btn idle" id="sp-rp-rec-btn" onclick="toggleRpRec()" style="width:48px;height:48px;font-size:20px;flex-shrink:0">üéôÔ∏è</button>
        <div style="flex:1;display:flex;flex-direction:column;gap:6px">
          <input class="finp" id="sp-rp-inp" placeholder="G√µ ho·∫∑c n√≥i c√¢u tr·∫£ l·ªùi..." onkeydown="if(event.key==='Enter')sendRpMessage()" style="margin:0">
          <div style="display:flex;gap:6px">
            <button class="btn btn-primary btn-sm" style="flex:1;justify-content:center" onclick="sendRpMessage()">G·ª≠i ‚Üí</button>
            <button class="btn btn-outline btn-sm" onclick="getRpHint()">üí° G·ª£i √Ω</button>
          </div>
        </div>
      </div>
      <div id="sp-rp-status" style="font-size:12px;color:var(--ink4);margin-top:8px;text-align:center"></div>
    </div>`;

  // Kick off with AI greeting
  await sendRpAIMessage(`You are starting this roleplay: ${prompt} Greet the user in English in 1-2 short sentences to begin the scenario. Be friendly and natural.`);
}

async function sendRpMessage() {
  const inp = document.getElementById('sp-rp-inp');
  const text = inp?.value?.trim();
  if (!text) return;
  inp.value = '';

  // Score the user's message
  const userScore = scoreRpMessage(text);
  addRpMessage('user', text, userScore);

  _spRoleplayHistory.push({ role: 'user', content: text });

  // Get AI response
  await sendRpAIMessage(null);
}

function scoreRpMessage(text) {
  const words = text.split(/\s+/).length;
  const hasQuestion = /\?$/.test(text.trim());
  const hasPolite = /please|thank|sorry|excuse|would|could/i.test(text);
  let score = Math.min(100, words * 8 + (hasQuestion ? 10 : 0) + (hasPolite ? 15 : 0));
  return Math.max(40, score);
}

async function sendRpAIMessage(overridePrompt) {
  const statusEl = document.getElementById('sp-rp-status');
  if (statusEl) statusEl.textContent = 'ü§î AI ƒëang tr·∫£ l·ªùi...';

  const apiKey = getAnthropicKey();
  let aiText = '';

  if (!apiKey) {
    // Fallback responses
    const fallbacks = [
      "Sure, I'd be happy to help you with that!",
      "That's a great point. What else can I do for you?",
      "Of course! Let me assist you right away.",
      "Excellent choice! Anything else you'd like?",
      "I understand. Please let me know how I can help."
    ];
    aiText = fallbacks[Math.floor(Math.random() * fallbacks.length)];
  } else {
    try {
      const msgs = overridePrompt
        ? [{ role: 'user', content: overridePrompt }]
        : [
          { role: 'user', content: `Roleplay context: ${_spRoleplayContext.prompt}\n\nConversation so far:\n${_spRoleplayHistory.map(m=>`${m.role==='user'?'Customer':'You'}: ${m.content}`).join('\n')}\n\nRespond in 1-2 short natural English sentences as the character. Keep it conversational.` }
        ];
      const res = await fetch('https://api.anthropic.com/v1/messages', {
        method:'POST',
        headers:{'Content-Type':'application/json','x-api-key':apiKey,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},
        body: JSON.stringify({ model:'claude-haiku-4-5-20251001', max_tokens:150, messages: msgs })
      });
      if (res.ok) {
        const d = await res.json();
        aiText = d?.content?.[0]?.text?.trim() || 'Let me help you with that!';
      }
    } catch(e) { aiText = "I'm here to help! What would you like?"; }
  }

  _spRoleplayHistory.push({ role: 'assistant', content: aiText });
  addRpMessage('ai', aiText);
  if (statusEl) statusEl.textContent = 'üé§ ƒê·∫øn l∆∞·ª£t b·∫°n n√≥i';
  speak(aiText);
}

function addRpMessage(role, text, score = null) {
  const chat = document.getElementById('sp-rp-chat');
  if (!chat) return;
  const isUser = role === 'user';
  const scoreHTML = score && isUser
    ? `<div class="sp-rp-score-chip ${score>=80?'good':score>=60?'ok':'bad'}">${score>=80?'üåü':score>=60?'üëç':'üí™'} ${score >= 80?'T·ªët!':score>=60?'·ªîn!':'Luy·ªán th√™m'}</div>`
    : '';
  const div = document.createElement('div');
  div.className = `sp-rp-msg ${isUser?'user':''}`;
  div.innerHTML = `
    <div class="sp-rp-avatar ${isUser?'user':'ai'}">${isUser?'üë§':'ü§ñ'}</div>
    <div>
      <div class="sp-rp-bubble ${isUser?'user':'ai'}">${text}</div>
      ${!isUser?`<button onclick="speak('${esc(text)}')" style="background:none;border:none;cursor:pointer;font-size:13px;color:var(--ink4);margin-top:3px">üîä Nghe l·∫°i</button>`:''}
      ${scoreHTML}
    </div>`;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

function toggleRpRec() {
  if (_spIsRecording) { if (_spRecognition) _spRecognition.stop(); return; }
  const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRec) { showToast('Chrome c·∫ßn thi·∫øt ƒë·ªÉ d√πng ghi √¢m!', 'error'); return; }
  _spIsRecording = true;
  const btn = document.getElementById('sp-rp-rec-btn');
  if (btn) { btn.className = 'sp-rec-btn recording'; btn.style.cssText='width:48px;height:48px;font-size:20px;flex-shrink:0'; btn.textContent = '‚èπ'; }

  _spRecognition = new SpeechRec();
  _spRecognition.lang = 'en-US'; _spRecognition.continuous = false; _spRecognition.interimResults = false;
  _spRecognition.onresult = (e) => {
    const text = e.results[0][0].transcript;
    const inp = document.getElementById('sp-rp-inp');
    if (inp) inp.value = text;
  };
  _spRecognition.onend = () => {
    _spIsRecording = false;
    const btn = document.getElementById('sp-rp-rec-btn');
    if (btn) { btn.className = 'sp-rec-btn idle'; btn.style.cssText='width:48px;height:48px;font-size:20px;flex-shrink:0'; btn.textContent = 'üéôÔ∏è'; }
    const inp = document.getElementById('sp-rp-inp');
    if (inp?.value) sendRpMessage();
  };
  _spRecognition.onerror = () => { _spIsRecording = false; };
  _spRecognition.start();
}

async function getRpHint() {
  const apiKey = getAnthropicKey();
  let hint = '';
  if (!apiKey || !_spRoleplayHistory.length) {
    const h = _spRoleplayHistory;
    hint = h.length ? `B·∫°n c√≥ th·ªÉ n√≥i: "Could you help me with...?" ho·∫∑c "I would like to..."` : 'H√£y ch√†o v√† n√≥i ƒëi·ªÅu b·∫°n mu·ªën!';
  } else {
    try {
      const res = await fetch('https://api.anthropic.com/v1/messages',{
        method:'POST',
        headers:{'Content-Type':'application/json','x-api-key':apiKey,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},
        body:JSON.stringify({model:'claude-haiku-4-5-20251001',max_tokens:80,messages:[{role:'user',content:`Roleplay: ${_spRoleplayContext.prompt}. Last AI said: "${_spRoleplayHistory[_spRoleplayHistory.length-1]?.content}". Give a short Vietnamese hint (1 sentence) for what the learner could say in English.`}]})
      });
      if(res.ok){ const d=await res.json(); hint=d?.content?.[0]?.text?.trim()||''; }
    } catch(e) {}
  }
  showToast('üí° ' + (hint || 'Th·ª≠ n√≥i m·ªôt c√¢u ng·∫Øn!'), 'success');
}

/* ‚îÄ‚îÄ Panel init hooks ‚îÄ‚îÄ */
window.showPanel = function(name) {
  _origShowPanel && _origShowPanel(name);
  if (name === 'listening') {
    setTimeout(renderListeningSetup, 50);
  } else if (name === 'speaking-pro') {
    setTimeout(renderSpSetup, 50);
  } else if (name === 'home') {
    setTimeout(renderHomeDashboard, 50);
  }
  // Mobile UX: scroll to top on panel switch & haptic feedback
  if (window.innerWidth <= 767) {
    window.scrollTo({top:0,behavior:'instant'});
    // Haptic feedback on supported devices
    if (navigator.vibrate) navigator.vibrate(8);
  }
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   HOME DASHBOARD RENDERER
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderHomeDashboard() {
  const isMob = window.innerWidth <= 767;

  // ‚îÄ‚îÄ Hero ‚îÄ‚îÄ
  const heroWrap = document.getElementById('home-hero-wrap');
  if (heroWrap) {
    const h = new Date().getHours();
    const greeting = h < 12 ? 'Ch√†o bu·ªïi s√°ng' : h < 18 ? 'Ch√†o bu·ªïi chi·ªÅu' : 'Ch√†o bu·ªïi t·ªëi';
    const emoji = h < 12 ? '‚òÄÔ∏è' : h < 18 ? 'üå§Ô∏è' : 'üåô';
    const name = (typeof _currentUser !== 'undefined' && _currentUser)
      ? (_currentUser.displayName || _currentUser.username || '') : '';
    const totalWords = S.vocab.length;
    const learnedWords = S.vocab.filter(v => v.learned).length;
    const pct = totalWords ? Math.round(learnedWords / totalWords * 100) : 0;
    const motivate = pct === 0 ? 'B·∫Øt ƒë·∫ßu h√†nh tr√¨nh ngay!' :
      pct < 30 ? 'Ti·∫øp t·ª•c c·ªë l√™n!' : pct < 70 ? 'Tuy·ªát v·ªùi, gi·ªØ ƒë√†!' : 'G·∫ßn ƒë·∫øn ƒë√≠ch r·ªìi! üèÜ';

    heroWrap.innerHTML = `
      <div style="background:linear-gradient(135deg,#0d9488 0%,#0891b2 55%,#7c3aed 100%);border-radius:16px;padding:${isMob?'16px 18px':'22px 26px'};color:#fff;margin-bottom:12px;position:relative;overflow:hidden;">
        <div style="position:absolute;right:${isMob?'14px':'22px'};top:50%;transform:translateY(-50%);font-size:${isMob?'52px':'72px'};opacity:.1;pointer-events:none;line-height:1">üó£Ô∏è</div>
        <div style="font-size:${isMob?'12px':'13px'};opacity:.8;margin-bottom:3px;font-weight:600">${emoji} ${greeting}${name ? ', <strong>'+name+'</strong>' : ''}!</div>
        <div style="font-family:var(--font-d);font-size:${isMob?'20px':'22px'};font-weight:900;margin-bottom:${isMob?'10px':'12px'};letter-spacing:-.3px;line-height:1.2">H·ªçc g√¨ h√¥m nay? üöÄ</div>
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:4px">
          <div style="flex:1;height:7px;background:rgba(255,255,255,.22);border-radius:4px;overflow:hidden">
            <div style="height:100%;width:${pct}%;background:rgba(255,255,255,.88);border-radius:4px;transition:width .6s"></div>
          </div>
          <span style="font-size:12px;font-weight:800;white-space:nowrap;opacity:.95">${learnedWords}/${totalWords} t·ª´</span>
        </div>
        <div style="font-size:11.5px;opacity:.75">${pct}% ‚Äî ${motivate}</div>
      </div>`;
  }

  // ‚îÄ‚îÄ Stats strip (mobile only) ‚îÄ‚îÄ
  if (isMob) {
    const rdp = (typeof getRdpState === 'function') ? getRdpState() : null;
    const todayKey = (typeof getDateKey === 'function') ? getDateKey() : new Date().toISOString().slice(0,10);
    const todayRdp = rdp?.logs?.[todayKey];
    const xp = S.stats?.xp || 0;
    const streak = S.stats?.streak || 0;
    const learnedToday = todayRdp?.results?.filter(r=>r.correct)?.length || 0;
    const totalWords = S.vocab.length;

    const sv = (id, val) => { const el = document.getElementById(id); if(el) el.querySelector('.hss-val').textContent = val; };
    sv('hss-streak', streak ? streak+'üî•' : '0');
    sv('hss-xp', xp ? xp+'‚ú®' : '0');
    sv('hss-words', totalWords);
    sv('hss-today', learnedToday ? learnedToday+'‚úÖ' : '0');
  } else {
    // Desktop: legacy today stats
    const todayEl = document.getElementById('home-today-stats');
    if (todayEl) {
      const ltLogs = JSON.parse(localStorage.getItem('speakup_lt_logs') || '[]');
      const todayStr = new Date().toLocaleDateString('vi-VN');
      const todayLt = ltLogs.filter(l => new Date(l.ts).toLocaleDateString('vi-VN') === todayStr);
      const rdp = (typeof getRdpState === 'function') ? getRdpState() : null;
      const todayKey = (typeof getDateKey === 'function') ? getDateKey() : new Date().toISOString().slice(0,10);
      const todayRdp = rdp?.logs?.[todayKey];
      const xp = S.stats?.xp || 0; const streak = S.stats?.streak || 0;
      todayEl.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border)">
          <span style="font-size:13px;color:var(--ink2)">üî• Streak</span>
          <span style="font-family:var(--font-d);font-weight:800;color:var(--teal)">${streak} ng√†y</span>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border)">
          <span style="font-size:13px;color:var(--ink2)">‚ö° XP h√¥m nay</span>
          <span style="font-family:var(--font-d);font-weight:800;color:var(--violet)">${xp} XP</span>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border)">
          <span style="font-size:13px;color:var(--ink2)">üéß Listening</span>
          <span style="font-size:13px;font-weight:700;color:${todayLt.length?'var(--teal)':'var(--ink4)'}">${todayLt.length ? todayLt.length+' l·∫ßn' : 'Ch∆∞a luy·ªán'}</span>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0">
          <span style="font-size:13px;color:var(--ink2)">üìñ T·ª´ h√¥m nay</span>
          <span style="font-size:13px;font-weight:700;color:${todayRdp?.results?.length?'var(--teal)':'var(--ink4)'}">${todayRdp?.results?.length || 0} t·ª´</span>
        </div>`;
    }
  }

  // ‚îÄ‚îÄ Continue learning ‚îÄ‚îÄ
  const contWrap = document.getElementById('home-continue-wrap');
  if (contWrap && S.currentTopic) {
    const topicWords = S.vocab.filter(v => v.topic === S.currentTopic);
    const learned = topicWords.filter(v => v.learned).length;
    const pct = topicWords.length ? Math.round(learned / topicWords.length * 100) : 0;
    const rule = TOPIC_RULES.find(r => r.name === S.currentTopic);
    if (isMob) {
      contWrap.innerHTML = `
        <div class="home-continue-card">
          <div class="home-continue-emoji">${rule?.emoji||'üìå'}</div>
          <div class="home-continue-info">
            <div class="home-continue-tag">‚ñ∂ Ti·∫øp t·ª•c h·ªçc</div>
            <div class="home-continue-title">${S.currentTopic}</div>
            <div class="home-continue-pbar"><div class="home-continue-pfill" style="width:${pct}%"></div></div>
            <div class="home-continue-meta">${learned}/${topicWords.length} t·ª´ ¬∑ ${pct}%</div>
          </div>
          <div class="home-continue-btns">
            <button class="btn btn-primary btn-sm" onclick="startStudy('${esc(S.currentTopic)}','flashcard')" style="font-size:12px;padding:8px 12px">üÉè H·ªçc</button>
            <button class="btn btn-outline btn-sm" onclick="startStudy('${esc(S.currentTopic)}','quiz')" style="font-size:12px;padding:8px 12px">üß© Quiz</button>
          </div>
        </div>`;
    } else {
      contWrap.innerHTML = `
        <div style="background:var(--surface);border:2px solid var(--teal);border-radius:14px;padding:16px 18px;display:flex;align-items:center;gap:14px;flex-wrap:wrap;box-shadow:0 2px 12px rgba(13,148,136,.12)">
          <div style="font-size:28px">${rule?.emoji||'üìå'}</div>
          <div style="flex:1;min-width:0">
            <div style="font-size:11px;font-weight:700;color:var(--teal);text-transform:uppercase;letter-spacing:.06em;margin-bottom:3px">‚ñ∂ Ti·∫øp t·ª•c h·ªçc</div>
            <div style="font-family:var(--font-d);font-weight:800;font-size:16px;color:var(--ink);margin-bottom:6px">${S.currentTopic}</div>
            <div style="height:5px;background:var(--bg2);border-radius:3px;overflow:hidden;max-width:200px">
              <div style="height:100%;width:${pct}%;background:linear-gradient(90deg,var(--teal),var(--teal-mid));border-radius:3px"></div>
            </div>
            <div style="font-size:11px;color:var(--ink4);margin-top:3px">${learned}/${topicWords.length} t·ª´ ƒë√£ h·ªçc (${pct}%)</div>
          </div>
          <div style="display:flex;gap:7px;flex-wrap:wrap">
            <button class="btn btn-primary btn-sm" onclick="startStudy('${esc(S.currentTopic)}','flashcard')">üÉè Flashcard</button>
            <button class="btn btn-outline btn-sm" onclick="startStudy('${esc(S.currentTopic)}','speaking')">üé§ Speaking</button>
          </div>
        </div>`;
    }
  } else if (contWrap) {
    const emptyMsg = S.vocab.length
      ? `<div style="font-size:13px;color:var(--ink3);margin-bottom:10px">üëÜ Ch·ªçn ch·ªß ƒë·ªÅ ƒë·ªÉ b·∫Øt ƒë·∫ßu h·ªçc</div><button class="btn btn-primary btn-sm" onclick="showPanel('topics')">üìö Xem ch·ªß ƒë·ªÅ ‚Üí</button>`
      : `<div style="font-size:13px;color:var(--ink3);margin-bottom:10px">üì≠ Ch∆∞a c√≥ t·ª´ v·ª±ng. Import ƒë·ªÉ b·∫Øt ƒë·∫ßu!</div><button class="btn btn-primary btn-sm" onclick="showPanel('import')">üì• Import ngay ‚Üí</button>`;
    contWrap.innerHTML = `<div style="background:var(--surface2);border:1.5px dashed var(--border2);border-radius:14px;padding:16px 18px;text-align:center;margin-bottom:14px">${emptyMsg}</div>`;
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PITCH & STRESS ANALYSIS
   Ph√¢n t√≠ch tr·ªçng √¢m t·ª´ d·ª±a tr√™n IPA ho·∫∑c pattern chu·∫©n
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function analyzePitchStress(word, ipa) {
  // Parse syllables from IPA or fall back to vowel-based split
  let syllables = [];

  if (ipa) {
    // Extract syllables from IPA - split on vowel groups
    const ipaClean = ipa.replace(/[\/\[\]]/g, '').trim();
    // Find stress marks: Àà (primary) Àå (secondary)
    const parts = ipaClean.split(/(Àà|Àå)/);
    let stressMap = [];
    let currentStress = 'none';
    let sylIdx = 0;

    for (let i = 0; i < parts.length; i++) {
      if (parts[i] === 'Àà') { currentStress = 'primary'; continue; }
      if (parts[i] === 'Àå') { currentStress = 'secondary'; continue; }
      // Split segment into syllable chunks (rough heuristic)
      const chunks = parts[i].match(/[^aeiou√¶…ë…í…î…ô…õ…ú…™ ä åÀê]+[aeiou√¶…ë…í…î…ô…õ…ú…™ ä åÀê]+[^aeiou√¶…ë…í…î…ô…õ…ú…™ ä åÀê]*/gi) || [parts[i]];
      chunks.forEach((chunk, ci) => {
        if (!chunk.trim()) return;
        stressMap.push({
          sym: chunk,
          stress: (ci === 0 && currentStress !== 'none') ? currentStress : 'none'
        });
        currentStress = 'none';
      });
    }

    if (stressMap.length >= 2) {
      syllables = stressMap.slice(0, 6);
    }
  }

  // Fallback: split word into syllables by vowel pattern
  if (!syllables.length) {
    const vowelPattern = word.match(/[^aeiou]*[aeiou]+(?:[^aeiou]*$|[^aeiou](?=[^aeiou]))?/gi) || [word];
    // Common English stress rules: stress on first syllable for nouns, penultimate for verbs
    syllables = vowelPattern.slice(0, 5).map((syl, i) => ({
      sym: syl,
      stress: i === 0 ? 'primary' : 'none'
    }));
  }

  return syllables;
}

function renderStressVisual(word, ipa) {
  const syllables = analyzePitchStress(word, ipa);
  if (!syllables.length) return '';

  const heights = { primary: 42, secondary: 28, none: 16 };
  const labels = { primary: 'üî¥ Tr·ªçng √¢m ch√≠nh', secondary: 'üü° Tr·ªçng √¢m ph·ª•', none: '' };

  return `
    <div class="sp-stress-wrap">
      <div class="sp-stress-title">üìä Ph√¢n t√≠ch Pitch & Stress ‚Äî <em>${word}</em> ${ipa||''}</div>
      <div class="sp-stress-syllables">
        ${syllables.map(s => `
          <div class="sp-syl">
            <div class="sp-syl-bar ${s.stress !== 'none' ? 'stressed' : ''}"
              style="height:${heights[s.stress]||16}px;
              background:${s.stress==='primary'?'linear-gradient(180deg,#7c3aed,#9333ea)':s.stress==='secondary'?'linear-gradient(180deg,#0891b2,#0d9488)':'var(--bg2)'}">
            </div>
            <div class="sp-syl-text ${s.stress==='primary'?'stressed':''}">${s.sym}</div>
          </div>`).join('')}
      </div>
      <div style="display:flex;gap:12px;margin-top:8px;flex-wrap:wrap">
        <span style="font-size:11px;color:var(--violet);font-weight:700">üî¥ Tr·ªçng √¢m ch√≠nh = nh·∫•n m·∫°nh, cao h∆°n</span>
        <span style="font-size:11px;color:#0891b2;font-weight:700">üîµ Tr·ªçng √¢m ph·ª• = nh·∫π h∆°n m·ªôt ch√∫t</span>
      </div>
    </div>`;
}

/* Enhanced scoreSpSpeech with pitch/stress tips */
function scoreSpSpeechEnhanced(transcript, targetSent, targetWord, wordIpa) {
  const status = document.getElementById('sp-rec-status');
  if (!transcript.trim()) {
    if (status) status.textContent = 'Kh√¥ng nghe ƒë∆∞·ª£c r√µ. Th·ª≠ l·∫°i!';
    return;
  }
  if (status) status.textContent = 'Ho√†n t·∫•t!';

  const tWords = targetSent.toLowerCase().replace(/[.,!?]/g,'').split(/\s+/);
  const sWords = transcript.toLowerCase().replace(/[.,!?]/g,'').split(/\s+/);

  const wordScores = tWords.map((tw, i) => {
    const sw = sWords[i] || '';
    if (!sw) return { word: tw, score: 0 };
    const maxLen = Math.max(tw.length, sw.length);
    let matches = 0;
    for (let j = 0; j < Math.min(tw.length, sw.length); j++) {
      if (tw[j] === sw[j]) matches++;
    }
    // Bonus for correct vowel sounds
    const twVowels = tw.replace(/[^aeiou]/g,'');
    const swVowels = sw.replace(/[^aeiou]/g,'');
    const vowelBonus = twVowels === swVowels ? 10 : 0;
    return { word: tw, score: Math.min(100, Math.round(matches / maxLen * 90 + vowelBonus)) };
  });

  const overallScore = wordScores.length
    ? Math.round(wordScores.reduce((s,w)=>s+w.score,0) / wordScores.length)
    : 0;

  // Highlight read-aloud words
  if (_spMode === 'readaloud') {
    wordScores.forEach((ws, i) => {
      const el = document.getElementById(`ra-w-${i}`);
      if (!el) return;
      el.className = 'sp-ra-word ' + (ws.score >= 80 ? 'done-good' : ws.score >= 50 ? 'done-ok' : 'done-bad');
    });
  }

  _spSession.scores.push(overallScore);
  gainXP(overallScore >= 70 ? 25 : overallScore >= 40 ? 10 : 5);

  showSpScoreEnhanced(overallScore, transcript, wordScores, targetWord, wordIpa);
}

function showSpScoreEnhanced(score, transcript, wordScores, targetWord, wordIpa) {
  const wrap = document.getElementById('sp-score-wrap');
  if (!wrap) return;

  const clr = score >= 70 ? 'var(--teal)' : score >= 40 ? 'var(--amber)' : 'var(--rose)';
  const msg = score >= 90 ? 'üåü Xu·∫•t s·∫Øc! Ph√°t √¢m chu·∫©n b·∫£n x·ª©!' : score >= 70 ? 'üëç T·ªët! G·∫ßn chu·∫©n r·ªìi' : score >= 40 ? 'üí™ ·ªîn, luy·ªán th√™m!' : 'üîÑ Th·ª≠ l·∫°i, t·∫≠p trung tr·ªçng √¢m!';

  const topWords = wordScores.slice(0, 6);
  const phonemeHTML = topWords.map(ws =>
    `<div class="sp-phoneme ${ws.score>=80?'good':ws.score>=50?'ok':'bad'}">
      <div class="sp-phoneme-sym">${ws.word}</div>
      <div class="sp-phoneme-pct">${ws.score}%</div>
    </div>`
  ).join('');

  // Specific feedback on stress
  const stressHTML = (wordIpa && _spMode === 'pronunciation')
    ? renderStressVisual(targetWord, wordIpa) : '';

  // Pitch tips based on score
  const pitchTip = score < 50
    ? '<div class="sp-tip" style="margin-top:10px"><span class="sp-tip-icon">üéµ</span><span><strong>M·∫πo ph√°t √¢m:</strong> Ch√∫ √Ω nh·∫•n m·∫°nh √¢m ti·∫øt in ƒë·∫≠m (tr·ªçng √¢m ch√≠nh). Ti·∫øng Anh d√πng pitch (cao/th·∫•p) v√† length (d√†i/ng·∫Øn) ƒë·ªÉ ph√¢n bi·ªát tr·ªçng √¢m.</span></div>'
    : score < 75
    ? '<div class="sp-tip" style="margin-top:10px"><span class="sp-tip-icon">üéµ</span><span><strong>G·∫ßn chu·∫©n r·ªìi!</strong> Th·ª≠ k√©o d√†i √¢m ti·∫øt c√≥ tr·ªçng √¢m ch√≠nh h∆°n m·ªôt ch√∫t v√† n√¢ng cao gi·ªçng.</span></div>'
    : '';

  wrap.innerHTML = `
    <div style="margin-top:16px;padding:16px 18px;background:var(--surface2);border-radius:14px;border:2px solid ${score>=70?'rgba(13,148,136,.25)':score>=40?'rgba(217,119,6,.25)':'rgba(225,29,72,.25)'}">
      <div style="display:flex;align-items:center;gap:14px;margin-bottom:14px">
        <div class="sp-score-ring">
          <svg width="96" height="96" viewBox="0 0 96 96">
            <circle cx="48" cy="48" r="38" fill="none" stroke="var(--bg2)" stroke-width="8"/>
            <circle cx="48" cy="48" r="38" fill="none" stroke="${clr}" stroke-width="8"
              stroke-dasharray="${2*Math.PI*38}" stroke-dashoffset="${2*Math.PI*38*(1-score/100)}"
              stroke-linecap="round" style="transition:stroke-dashoffset .8s"/>
          </svg>
          <div class="sp-score-ring-val" style="color:${clr}">${score}%</div>
        </div>
        <div style="flex:1">
          <div style="font-weight:800;font-size:15px;color:var(--ink);margin-bottom:5px">${msg}</div>
          <div style="font-size:12px;color:var(--ink3);font-style:italic">"${transcript}"</div>
        </div>
      </div>
      <div style="font-size:12px;font-weight:700;color:var(--ink4);text-transform:uppercase;margin-bottom:8px">T·ª´ng t·ª´:</div>
      <div class="sp-phoneme-row">${phonemeHTML}</div>
      ${stressHTML}
      ${pitchTip}
    </div>`;

  const nextWrap = document.getElementById('sp-next-wrap');
  if (nextWrap) {
    nextWrap.innerHTML = `
      <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
        <button class="btn btn-outline btn-sm" onclick="showSpQuestion()">üîÑ Th·ª≠ l·∫°i</button>
        <button class="btn btn-sm" style="flex:1;justify-content:center;background:linear-gradient(135deg,var(--violet),var(--teal));color:#fff;border:none;font-weight:700" onclick="advanceSpQuestion()">Ti·∫øp theo ‚Üí</button>
      </div>`;
  }
}
</script>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   BOOT SEQUENCE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
(async function boot(){
  // 1. Kh·ªüi t·∫°o app b√¨nh th∆∞·ªùng tr∆∞·ªõc
  init();

  // 2. Init Firebase n·∫øu c√≥ config th·∫≠t
  const cfg=getFbConfig();
  if(isRealConfig(cfg)) await initFirebase(cfg);

  // 3. Ki·ªÉm tra session c√≤n hi·ªáu l·ª±c
  const session=loadAppSession();
  if(session && session.uid){
    const isLocalSession = session.uid.startsWith('local_')
                        || session.uid === 'admin_root';
    const isAdminRole = session.role === 'admin';

    if(_fbOk() && !isLocalSession){
      // Firebase c√≥ ‚Üí x√°c minh token c√≤n h·ª£p l·ªá, timeout 5s ƒë·ªÉ tr√°nh ch·ªù m√£i
      await new Promise(resolve=>{
        let resolved=false;
        const done=(loginOk)=>{
          if(resolved) return; resolved=true;
          if(loginOk){
            _currentUser=session;
            _afterLogin();
          } else {
            clearAppSession();
            showLoginWall();
          }
          resolve();
        };
        // Sau 5 gi√¢y kh√¥ng response (m·∫°ng ch·∫≠m/offline) ‚Üí tin session local
        const timer=setTimeout(()=>done(true), 5000);
        const unsub=_auth.onAuthStateChanged(fbUser=>{
          clearTimeout(timer); unsub();
          if(fbUser && (fbUser.uid===session.uid || isAdminRole)){
            if(isAdminRole && fbUser.uid!==session.uid){
              session.uid=fbUser.uid; saveAppSession(session);
            }
            done(true);
          } else {
            done(false);
          }
        });
      });
    } else {
      // Admin local, offline, ho·∫∑c local session ‚Üí tin t∆∞·ªüng ngay
      _currentUser = session;
      await _afterLogin();
    }
  } else {
    // Ch∆∞a ƒëƒÉng nh·∫≠p ‚Üí show login wall
    showLoginWall();
  }
})();
</script>

</body>
</html>
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIRESTORE RULES GUIDE + SYNC DIAGNOSTICS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

/* Firestore Rules ƒë√∫ng cho SpeakUp */
const FIRESTORE_RULES_CORRECT = `rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId}/{document=**} {
      allow read, write: if request.auth != null
                         && request.auth.uid == userId;
    }
  }
}`;

window.showFirestoreRulesGuide = function(){
  const cfg = typeof getFbConfig==='function' ? getFbConfig() : null;
  const projectId = cfg&&cfg.projectId ? cfg.projectId : 'YOUR_PROJECT_ID';
  const rulesUrl = 'https://console.firebase.google.com/project/'+projectId+'/firestore/rules';

  // T·∫°o modal h∆∞·ªõng d·∫´n
  const existing = document.getElementById('_rules-modal');
  if(existing) existing.remove();

  const modal = document.createElement('div');
  modal.id = '_rules-modal';
  modal.style.cssText = 'position:fixed;inset:0;z-index:99999;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);display:flex;align-items:flex-end;justify-content:center;padding:0;';
  modal.innerHTML = `
    <div style="background:var(--surface);border-radius:20px 20px 0 0;width:100%;max-width:640px;max-height:90dvh;overflow-y:auto;padding:24px 24px calc(24px + env(safe-area-inset-bottom));box-shadow:0 -8px 40px rgba(0,0,0,.25);">
      <div style="width:40px;height:4px;background:var(--border2);border-radius:2px;margin:0 auto 16px;"></div>
      <div style="font-size:22px;font-weight:900;font-family:var(--font-d);margin-bottom:4px;">üî• C·∫•u h√¨nh Firestore Rules</div>
      <div style="font-size:13px;color:var(--ink3);margin-bottom:20px;">B·∫Øt bu·ªôc ƒë·ªÉ d·ªØ li·ªáu ƒë·ªìng b·ªô gi·ªØa c√°c thi·∫øt b·ªã</div>

      <div style="background:#fef3c7;border:1.5px solid #fde68a;border-radius:12px;padding:14px 16px;margin-bottom:16px;">
        <div style="font-size:12px;font-weight:800;color:#92400e;margin-bottom:8px;">‚ö†Ô∏è V·∫•n ƒë·ªÅ th∆∞·ªùng g·∫∑p</div>
        <div style="font-size:12px;color:#92400e;line-height:1.6;">
          Khi t·∫°o Firestore ·ªü <strong>Production mode</strong>, Firebase m·∫∑c ƒë·ªãnh <strong>ch·∫∑n t·∫•t c·∫£</strong> ƒë·ªçc/ghi.
          B·∫°n ph·∫£i c·∫≠p nh·∫≠t Rules ƒë·ªÉ cho ph√©p user ƒë·ªçc/ghi d·ªØ li·ªáu c·ªßa ch√≠nh h·ªç.
        </div>
      </div>

      <div style="font-size:13px;font-weight:800;color:var(--ink);margin-bottom:10px;">üìã 3 b∆∞·ªõc th·ª±c hi·ªán:</div>

      <div style="display:flex;flex-direction:column;gap:10px;margin-bottom:16px;">
        <div style="background:var(--surface2);border:1.5px solid var(--border);border-radius:10px;padding:12px 14px;display:flex;gap:12px;align-items:flex-start;">
          <div style="width:26px;height:26px;border-radius:50%;background:var(--teal);color:#fff;font-size:13px;font-weight:800;display:flex;align-items:center;justify-content:center;flex-shrink:0;">1</div>
          <div>
            <div style="font-size:13px;font-weight:700;margin-bottom:3px;">M·ªü Firebase Console ‚Üí Firestore Rules</div>
            <a href="${rulesUrl}" target="_blank" style="font-size:12px;color:var(--teal);font-weight:600;word-break:break-all;">${rulesUrl}</a>
          </div>
        </div>
        <div style="background:var(--surface2);border:1.5px solid var(--border);border-radius:10px;padding:12px 14px;display:flex;gap:12px;align-items:flex-start;">
          <div style="width:26px;height:26px;border-radius:50%;background:var(--teal);color:#fff;font-size:13px;font-weight:800;display:flex;align-items:center;justify-content:center;flex-shrink:0;">2</div>
          <div style="flex:1;min-width:0;">
            <div style="font-size:13px;font-weight:700;margin-bottom:6px;">Thay to√†n b·ªô n·ªôi dung b·∫±ng rules n√†y:</div>
            <div style="background:#1e1e2e;border-radius:8px;padding:12px;position:relative;">
              <pre id="_rules-code" style="margin:0;font-size:11px;color:#cdd6f4;font-family:monospace;white-space:pre-wrap;word-break:break-all;line-height:1.5;">${FIRESTORE_RULES_CORRECT.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</pre>
              <button onclick="_copyRules()" style="position:absolute;top:8px;right:8px;background:rgba(255,255,255,.15);border:none;border-radius:5px;padding:4px 8px;font-size:11px;color:#cdd6f4;cursor:pointer;font-weight:700;">üìã Copy</button>
            </div>
          </div>
        </div>
        <div style="background:var(--surface2);border:1.5px solid var(--border);border-radius:10px;padding:12px 14px;display:flex;gap:12px;align-items:flex-start;">
          <div style="width:26px;height:26px;border-radius:50%;background:var(--teal);color:#fff;font-size:13px;font-weight:800;display:flex;align-items:center;justify-content:center;flex-shrink:0;">3</div>
          <div>
            <div style="font-size:13px;font-weight:700;margin-bottom:3px;">Nh·∫•n "Publish" ‚Üí quay l·∫°i app ‚Üí nh·∫•n üîÑ Sync</div>
            <div style="font-size:12px;color:var(--ink3);">D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c ƒë·ªìng b·ªô ngay sau khi rules ƒë∆∞·ª£c c·∫≠p nh·∫≠t.</div>
          </div>
        </div>
      </div>

      <div style="display:flex;gap:10px;">
        <a href="${rulesUrl}" target="_blank" style="flex:1;padding:13px;background:var(--teal);color:#fff;border-radius:12px;text-align:center;font-size:14px;font-weight:800;text-decoration:none;display:block;">
          üîó M·ªü Firebase Console
        </a>
        <button onclick="document.getElementById('_rules-modal').remove()" style="flex:1;padding:13px;background:var(--surface2);border:1.5px solid var(--border);border-radius:12px;font-size:14px;font-weight:700;color:var(--ink3);cursor:pointer;font-family:var(--font-b);">
          ƒê√≥ng
        </button>
      </div>
    </div>`;

  modal.addEventListener('click', e=>{ if(e.target===modal) modal.remove(); });
  document.body.appendChild(modal);
};

window._copyRules = function(){
  navigator.clipboard.writeText(FIRESTORE_RULES_CORRECT)
    .then(()=>{ if(typeof showToast==='function') showToast('‚úÖ ƒê√£ copy Firestore Rules!'); })
    .catch(()=>{
      const el = document.getElementById('_rules-code');
      if(el){ const sel=window.getSelection(); sel.selectAllChildren(el); }
    });
};

/* Ch·∫©n ƒëo√°n l·ªói ƒë·ªìng b·ªô ‚Äî ki·ªÉm tra t·ª´ng b∆∞·ªõc */
window.diagnoseSyncIssue = async function(){
  const lines = [];
  const ok = s=>lines.push('‚úÖ '+s);
  const err = s=>lines.push('‚ùå '+s);
  const warn = s=>lines.push('‚ö†Ô∏è  '+s);
  const info = s=>lines.push('‚ÑπÔ∏è  '+s);

  info('B·∫Øt ƒë·∫ßu ch·∫©n ƒëo√°n...');

  // 1. Firebase config
  const cfg = typeof getFbConfig==='function' ? getFbConfig() : null;
  if(cfg&&cfg.apiKey&&cfg.projectId){ ok('Firebase config: '+cfg.projectId); }
  else { err('Ch∆∞a c√≥ Firebase config ‚Äî v√†o ‚öôÔ∏è ƒë·ªÉ ƒëi·ªÅn config'); }

  // 2. Firebase init
  if(typeof _fbOk==='function'&&_fbOk()){ ok('Firebase kh·ªüi t·∫°o th√†nh c√¥ng'); }
  else { err('Firebase ch∆∞a kh·ªüi t·∫°o ho·∫∑c b·ªã l·ªói'); }

  // 3. Auth state
  if(typeof _currentUser!=='undefined'&&_currentUser){
    ok('ƒê√£ ƒëƒÉng nh·∫≠p: '+(_currentUser.displayName||_currentUser.username)+' (uid: '+_currentUser.uid.substring(0,12)+'...)');
    if(_currentUser.uid==='admin_root'){ warn('Admin ƒëang d√πng uid c·ª•c b·ªô ‚Äî Firebase ch∆∞a connect Auth'); }
  } else { err('Ch∆∞a ƒëƒÉng nh·∫≠p'); }

  // 4. Network
  if(navigator.onLine){ ok('C√≥ k·∫øt n·ªëi internet'); }
  else { err('Kh√¥ng c√≥ k·∫øt n·ªëi internet'); }

  // 5. Test Firestore read/write
  if(typeof _fbOk==='function'&&_fbOk()&&typeof _currentUser!=='undefined'&&_currentUser&&_currentUser.uid!=='admin_root'){
    try{
      const testRef = _db.collection('users').doc(_currentUser.uid).collection('_meta').doc('_ping');
      await testRef.set({ ts: firebase.firestore.FieldValue.serverTimestamp(), test:true },{merge:true});
      ok('Firestore WRITE: th√†nh c√¥ng');
      const snap = await testRef.get();
      if(snap.exists){ ok('Firestore READ: th√†nh c√¥ng'); }
      else { err('Firestore READ: kh√¥ng ƒë·ªçc ƒë∆∞·ª£c document v·ª´a write'); }
    }catch(e){
      if(e.code==='permission-denied'){ err('Firestore: B·ªä CH·∫∂N b·ªüi Security Rules! ‚Üí C·∫ßn c·∫≠p nh·∫≠t Rules'); }
      else { err('Firestore error: '+e.code+' ‚Äî '+e.message); }
    }

    // 6. Check vocab count
    try{
      const vocabSnap = await _db.collection('users').doc(_currentUser.uid).collection('vocab').limit(5).get();
      if(!vocabSnap.empty){ ok('Firestore vocab: c√≥ '+vocabSnap.size+'+ t·ª´ tr√™n cloud (UID n√†y)'); }
      else { warn('Firestore vocab: r·ªóng ‚Äî ch∆∞a c√≥ t·ª´ n√†o ƒë∆∞·ª£c upload v·ªõi UID n√†y'); info('‚Üí Th·ª≠ nh·∫•n üîÑ Sync ƒë·ªÉ upload d·ªØ li·ªáu t·ª´ thi·∫øt b·ªã n√†y l√™n'); }
    }catch(e){
      err('Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c vocab: '+(e.code||e.message));
    }
  } else if(typeof _currentUser!=='undefined'&&_currentUser&&_currentUser.uid==='admin_root'){
    warn('Admin uid l√† admin_root ‚Üí kh√¥ng th·ªÉ test Firestore (c·∫ßn Firebase UID th·∫≠t)');
    info('‚Üí ƒêƒÉng xu·∫•t v√† ƒëƒÉng nh·∫≠p l·∫°i sau khi ƒë√£ c·∫•u h√¨nh Firebase');
  }

  // 7. Local data
  const localCount = typeof S!=='undefined'&&S.vocab ? S.vocab.length : 0;
  info('T·ª´ v·ª±ng ƒëang c√≥ trong b·ªô nh·ªõ: '+localCount+' t·ª´');

  // Show result
  const result = lines.join('
');
  const modal = document.createElement('div');
  modal.style.cssText = 'position:fixed;inset:0;z-index:99999;background:rgba(0,0,0,.5);display:flex;align-items:flex-end;justify-content:center;';
  modal.innerHTML = `
    <div style="background:var(--surface);border-radius:20px 20px 0 0;width:100%;max-width:600px;max-height:80dvh;overflow-y:auto;padding:22px 22px calc(22px + env(safe-area-inset-bottom));">
      <div style="font-size:17px;font-weight:800;font-family:var(--font-d);margin-bottom:14px;">üîç K·∫øt qu·∫£ ch·∫©n ƒëo√°n</div>
      <pre style="font-size:12.5px;line-height:1.7;color:var(--ink2);white-space:pre-wrap;font-family:monospace;background:var(--surface2);border-radius:10px;padding:14px;margin-bottom:16px;">${result}</pre>
      <div style="display:flex;gap:8px;">
        <button onclick="showFirestoreRulesGuide()" style="flex:1;padding:11px;background:var(--teal);color:#fff;border:none;border-radius:10px;font-size:13px;font-weight:700;cursor:pointer;font-family:var(--font-b);">üìã Xem h∆∞·ªõng d·∫´n Rules</button>
        <button onclick="this.closest('[style*=fixed]').remove()" style="flex:1;padding:11px;background:var(--surface2);border:1.5px solid var(--border);border-radius:10px;font-size:13px;font-weight:700;color:var(--ink3);cursor:pointer;font-family:var(--font-b);">ƒê√≥ng</button>
      </div>
    </div>`;
  modal.addEventListener('click',e=>{ if(e.target===modal) modal.remove(); });
  document.body.appendChild(modal);
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SIDEBAR FIREBASE SECTION ‚Äî Desktop JS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(function initSbFirebase(){

  /* Toggle collapse */
  window.toggleSbFb = function(){
    const body = document.getElementById('sb-fb-body');
    const chev = document.getElementById('sb-fb-chevron');
    if(!body) return;
    const isOpen = body.classList.toggle('open');
    if(chev) chev.classList.toggle('open', isOpen);
    if(isOpen) sbFbRefreshStatus();
  };

  /* Refresh status display */
  function sbFbRefreshStatus(){
    const cfg = (typeof getFbConfig === 'function') ? getFbConfig() : null;
    const connected = cfg && cfg.apiKey && !cfg.apiKey.startsWith('YOUR_') && cfg.projectId;

    // Dot indicator in header
    const dot = document.getElementById('sb-fb-dot');
    if(dot){
      dot.className = 'sb-fb-status-dot ' + (connected ? 'connected' : 'disconnected');
    }

    // Status cards
    const connCard = document.getElementById('sb-fb-connected-card');
    const discCard = document.getElementById('sb-fb-disconnected-card');
    const projEl   = document.getElementById('sb-fb-proj-name');

    if(connCard) connCard.style.display = connected ? 'flex' : 'none';
    if(discCard) discCard.style.display = connected ? 'none' : 'flex';
    if(projEl && connected) projEl.textContent = cfg.projectId;

    // Pre-fill fields
    if(cfg){
      ['apiKey','authDomain','projectId','storageBucket','messagingSenderId','appId'].forEach(k=>{
        const el = document.getElementById('sb-cfg-'+k);
        if(el && cfg[k]) el.value = cfg[k];
      });
    }
  }

  window.sbFbRefreshStatus = sbFbRefreshStatus;

  /* Save & connect */
  window.sbFbSave = async function(){
    const required = ['apiKey','authDomain','projectId'];
    const cfg = {};
    let valid = true;
    const errEl = document.getElementById('sb-fb-err');

    ['apiKey','authDomain','projectId','storageBucket','messagingSenderId','appId'].forEach(k=>{
      const el = document.getElementById('sb-cfg-'+k);
      const v = el ? el.value.trim() : '';
      cfg[k] = v;
      if(el) el.classList.toggle('err-inp', required.includes(k) && !v);
      if(required.includes(k) && !v) valid = false;
    });

    if(!valid){
      if(errEl){ errEl.textContent = '‚ùå API Key, Auth Domain v√† Project ID l√† b·∫Øt bu·ªôc.'; errEl.style.display='block'; }
      return;
    }
    if(errEl) errEl.style.display = 'none';

    // Sync to main modal fields & save
    ['apiKey','authDomain','projectId','storageBucket','messagingSenderId','appId'].forEach(k=>{
      const el = document.getElementById('cfg-'+k);
      if(el) el.value = cfg[k];
    });

    try{
      localStorage.setItem(typeof FB_CFG_KEY!=='undefined'?FB_CFG_KEY:'speakup_fb_cfg', JSON.stringify(cfg));
      showToast('‚è≥ ƒêang k·∫øt n·ªëi Firebase...');
      const ok = await initFirebase(cfg);
      if(ok){
        showToast('üî• Firebase k·∫øt n·ªëi th√†nh c√¥ng!');
        sbFbRefreshStatus();
      } else {
        if(errEl){ errEl.textContent='‚ö†Ô∏è K·∫øt n·ªëi th·∫•t b·∫°i ‚Äî Ki·ªÉm tra l·∫°i config.'; errEl.style.display='block'; }
      }
    } catch(e){
      if(errEl){ errEl.textContent='‚ùå '+e.message; errEl.style.display='block'; }
    }
  };

  /* Paste JSON from clipboard */
  window.sbFbPaste = async function(){
    try{
      const text = await navigator.clipboard.readText();
      const m = text.match(/\{[^{}]*apiKey[^{}]*\}/s);
      if(!m){ showToast('‚ùå Kh√¥ng t√¨m th·∫•y firebaseConfig trong clipboard','error'); return; }
      const json = m[0].replace(/(\w+)\s*:/g,'"$1":').replace(/'/g,'"');
      const parsed = JSON.parse(json);
      ['apiKey','authDomain','projectId','storageBucket','messagingSenderId','appId'].forEach(k=>{
        const el = document.getElementById('sb-cfg-'+k);
        if(el && parsed[k]) el.value = parsed[k];
      });
      showToast('üìã ƒê√£ d√°n config Firebase!');
    } catch(e){
      showToast('‚ùå Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c clipboard.','error');
    }
  };

  /* Disconnect / clear */
  window.sbFbDisconnect = function(){
    if(typeof clearFbConfig === 'function') clearFbConfig();
    else localStorage.removeItem(typeof FB_CFG_KEY!=='undefined'?FB_CFG_KEY:'speakup_fb_cfg');
    ['sb-cfg-apiKey','sb-cfg-authDomain','sb-cfg-projectId',
     'sb-cfg-storageBucket','sb-cfg-messagingSenderId','sb-cfg-appId']
      .forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
    sbFbRefreshStatus();
    showToast('üóë ƒê√£ x√≥a Firebase config');
  };

  /* Init on page load ‚Äî auto refresh status */
  setTimeout(()=>{
    sbFbRefreshStatus();
  }, 600);

})();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MOBILE ACCOUNT DRAWER ‚Äî JS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

/* Stub s·ªõm ƒë·ªÉ mob-nav onclick kh√¥ng b·ªã l·ªói n·∫øu IIFE ch∆∞a ch·∫°y */
if(typeof window.openMobAccount === 'undefined'){
  window.openMobAccount = function(){
    const overlay = document.getElementById('mob-account-overlay');
    if(overlay){ overlay.classList.add('open'); }
  };
}
if(typeof window.closeMobAccount === 'undefined'){
  window.closeMobAccount = function(e){
    if(e instanceof Event && e.target !== document.getElementById('mob-account-overlay')) return;
    const overlay = document.getElementById('mob-account-overlay');
    if(overlay){ overlay.classList.remove('open'); }
  };
}

(function initMobAccount(){

  // Expose ra global s·ªõm ƒë·ªÉ mob-nav onclick c√≥ th·ªÉ g·ªçi ngay
  window.openMobAccount = function(){
    const overlay = document.getElementById('mob-account-overlay');
    if(!overlay) return;
    overlay.classList.add('open');
    _updateMobFbStatus();
    // X√°c ƒë·ªãnh tr·∫°ng th√°i login: ∆∞u ti√™n _currentUser, fallback localStorage
    let user = (typeof _currentUser !== 'undefined' && _currentUser) || null;
    if(!user){
      try{ user = JSON.parse(localStorage.getItem('speakup_app_session')||'null'); }catch(_){}
    }
    if(user && user.uid){
      _showMobLoggedIn(user);
    } else {
      _showMobLoggedOut();
    }
  };

  window.closeMobAccount = function(e){
    // N·∫øu ƒë∆∞·ª£c g·ªçi t·ª´ click overlay ‚Üí ch·ªâ ƒë√≥ng khi click ƒë√∫ng backdrop (kh√¥ng ph·∫£i sheet b√™n trong)
    // N·∫øu g·ªçi tr·ª±c ti·∫øp (n√∫t ‚úï, mobSignOut...) ‚Üí e l√† undefined ‚Üí lu√¥n ƒë√≥ng
    if(e instanceof Event && e.target !== document.getElementById('mob-account-overlay')) return;
    const overlay = document.getElementById('mob-account-overlay');
    if(!overlay) return;
    const sheet = document.getElementById('mob-account-sheet');
    if(sheet) sheet.style.animation = 'sheetDown .22s cubic-bezier(.4,0,.2,1) forwards';
    setTimeout(()=>{
      overlay.classList.remove('open');
      if(sheet) sheet.style.animation = '';
    }, 220);
  };

  // Add slide-down animation
  const s = document.createElement('style');
  s.textContent = '@keyframes sheetDown{from{transform:translateY(0);opacity:1}to{transform:translateY(100%);opacity:.3}}';
  document.head.appendChild(s);

  /* ‚îÄ‚îÄ Tab switch ‚îÄ‚îÄ */
  window.switchMobLoginTab = function(tab){
    ['login','register'].forEach(t=>{
      const btn = document.getElementById('mob-ltab-'+t);
      const panel = document.getElementById('mob-'+(t==='login'?'login':'register')+'-panel');
      if(btn) btn.classList.toggle('active', t===tab);
      if(panel) panel.style.display = t===tab ? 'block' : 'none';
    });
    // Clear errors
    ['mob-li-err','mob-rg-err','mob-rg-ok'].forEach(id=>{
      const el=document.getElementById(id); if(el){el.style.display='none';el.textContent='';}
    });
  };

  /* ‚îÄ‚îÄ Firebase toggle ‚îÄ‚îÄ */
  window.toggleMobFb = function(){
    ['','2'].forEach(suffix=>{
      const body = document.getElementById('mob-fb-body'+suffix);
      const arrow = document.getElementById('mob-fb-arrow'+suffix);
      if(body){ body.classList.toggle('open'); }
      if(arrow){ arrow.classList.toggle('open', body && body.classList.contains('open')); }
    });
  };

  /* ‚îÄ‚îÄ Firebase status helper ‚îÄ‚îÄ */
  function _updateMobFbStatus(){
    const cfg = typeof getFbConfig === 'function' ? getFbConfig() : null;
    const connected = cfg && cfg.apiKey && !cfg.apiKey.startsWith('YOUR_') && cfg.projectId;
    // Logged-out status
    const st = document.getElementById('mob-fb-status');
    if(st){
      st.className = 'mob-fb-status ' + (connected ? 'connected' : 'disconnected');
      st.textContent = connected ? 'üü¢ ƒê√£ k·∫øt n·ªëi: '+cfg.projectId : 'üî¥ Ch∆∞a k·∫øt n·ªëi Firebase';
    }
    // Logged-in status
    const st2 = document.getElementById('mob-fb-status2');
    const stSub = document.getElementById('mob-fb-status-loggedin');
    if(st2){
      st2.className = 'mob-fb-status ' + (connected ? 'connected' : 'disconnected');
      st2.textContent = connected ? 'üü¢ K·∫øt n·ªëi: '+cfg.projectId : 'üî¥ Ch∆∞a k·∫øt n·ªëi';
    }
    if(stSub) stSub.textContent = connected ? 'üü¢ '+cfg.projectId : 'Ch∆∞a k·∫øt n·ªëi';

    // Pre-fill fields
    if(connected && cfg){
      _setFbField('mob-cfg-apiKey', cfg.apiKey);
      _setFbField('mob-cfg-authDomain', cfg.authDomain);
      _setFbField('mob-cfg-projectId', cfg.projectId);
      _setFbField('mob-cfg-storageBucket', cfg.storageBucket);
      _setFbField('mob-cfg-messagingSenderId', cfg.messagingSenderId);
      _setFbField('mob-cfg-appId', cfg.appId);
    }
  }
  function _setFbField(id, val){ const el=document.getElementById(id); if(el && val) el.value=val; }

  /* ‚îÄ‚îÄ Show logged in / out ‚îÄ‚îÄ */
  function _showMobLoggedIn(u){
    const lo = document.getElementById('mob-ui-loggedout');
    const li = document.getElementById('mob-ui-loggedin');
    if(lo) lo.style.display = 'none';
    if(li) li.style.display = 'block';
    // Avatar
    const av = document.getElementById('mob-user-avatar');
    if(av){
      av.className = 'mob-user-avatar' + (u.role==='admin' ? ' admin' : '');
      av.textContent = u.role==='admin' ? 'üëë' : (u.displayName||u.username||'U')[0].toUpperCase();
    }
    // Name
    const nm = document.getElementById('mob-user-name');
    if(nm) nm.textContent = u.displayName || u.username || '‚Äî';
    // Role badge
    const rl = document.getElementById('mob-user-role');
    if(rl) rl.innerHTML = u.role==='admin'
      ? '<div class="auth-role-badge admin">üëë Admin</div>'
      : '<div class="auth-role-badge user">üë§ Th√†nh vi√™n</div>';
    // Stats
    const setV = (id,v)=>{ const el=document.getElementById(id); if(el) el.textContent=v; };
    const wCount = (typeof S!=='undefined'&&S.vocab?.length)||0;
    setV('mob-stat-streak', (typeof S!=='undefined'&&S.stats?.streak)||0);
    setV('mob-stat-xp', (typeof S!=='undefined'&&S.stats?.xp)||0);
    setV('mob-stat-words', wCount);
    // C·∫≠p nh·∫≠t sync info
    setV('mob-sync-word-count', wCount);
    const fbInfoEl = document.getElementById('mob-sync-fb-info');
    if(fbInfoEl){
      const cfg = typeof getFbConfig==='function' ? getFbConfig() : null;
      const fbConn = cfg && cfg.apiKey && !cfg.apiKey.startsWith('YOUR_') && cfg.projectId;
      fbInfoEl.textContent = fbConn ? ('üü¢ Firebase: '+cfg.projectId) : 'üî¥ Firebase ch∆∞a k·∫øt n·ªëi';
    }
    // Nav icon update
    _updateNavAccountIcon(true, u);
  }

  function _showMobLoggedOut(){
    const lo = document.getElementById('mob-ui-loggedout');
    const li = document.getElementById('mob-ui-loggedin');
    if(lo) lo.style.display = 'block';
    if(li) li.style.display = 'none';
    _updateNavAccountIcon(false, null);
  }

  /* ‚îÄ‚îÄ Update nav account icon ‚îÄ‚îÄ */
  function _updateNavAccountIcon(loggedIn, u){
    const icon = document.getElementById('mob-nav-account-icon');
    const lbl = document.getElementById('mob-nav-account-lbl');
    const badge = document.getElementById('mob-account-badge');
    if(loggedIn && u){
      if(icon) icon.textContent = u.role==='admin' ? 'üëë' : 'üòä';
      if(lbl) lbl.textContent = (u.displayName||u.username||'').split(' ').pop() || 'T√†i kho·∫£n';
      if(badge) badge.style.display = 'block';
    } else {
      if(icon) icon.textContent = 'üë§';
      if(lbl) lbl.textContent = 'T√†i kho·∫£n';
      if(badge) badge.style.display = 'none';
    }
  }

  /* ‚îÄ‚îÄ Login ‚îÄ‚îÄ */
  window.mobLogin = async function(){
    const username = (document.getElementById('mob-li-username')?.value||'').trim();
    const pass = document.getElementById('mob-li-pass')?.value||'';
    const errEl = document.getElementById('mob-li-err');
    const btn = document.getElementById('mob-li-btn');
    const showErr = (msg)=>{ if(errEl){errEl.textContent=msg;errEl.style.display='block';} };
    if(!username||!pass){ showErr('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin.'); return; }
    // Sync to main login fields and call existing appLogin
    const setV = (id,v)=>{ const el=document.getElementById(id); if(el) el.value=v; };
    setV('li-username', username); setV('li-pass', pass);
    if(btn){ btn.disabled=true; btn.textContent='‚è≥ ƒêang ƒëƒÉng nh·∫≠p...'; }
    if(errEl) errEl.style.display='none';
    try{
      await appLogin();
      // If _currentUser set ‚Üí success: close login wall AND drawer
      if(typeof _currentUser !== 'undefined' && _currentUser){
        hideLoginWall();
        closeMobAccount();
      } else {
        // Copy error from main form to mob form
        const mainErr = document.getElementById('li-err');
        if(mainErr && mainErr.style.display !== 'none'){
          showErr(mainErr.textContent);
        }
      }
    } catch(e){ showErr('ƒêƒÉng nh·∫≠p th·∫•t b·∫°i. Ki·ªÉm tra l·∫°i th√¥ng tin.'); }
    finally{ if(btn){ btn.disabled=false; btn.textContent='üîê ƒêƒÉng nh·∫≠p'; } }
  };

  /* ‚îÄ‚îÄ Register ‚îÄ‚îÄ */
  window.mobRegister = async function(){
    const dn = (document.getElementById('mob-rg-displayname')?.value||'').trim();
    const un = (document.getElementById('mob-rg-username')?.value||'').trim();
    const pw = document.getElementById('mob-rg-pass')?.value||'';
    const pw2 = document.getElementById('mob-rg-pass2')?.value||'';
    const errEl = document.getElementById('mob-rg-err');
    const okEl = document.getElementById('mob-rg-ok');
    const btn = document.getElementById('mob-rg-btn');
    const showErr=(m)=>{ if(errEl){errEl.textContent=m;errEl.style.display='block';} };
    if(!un||!pw){ showErr('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin.'); return; }
    if(pw!==pw2){ showErr('M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp.'); return; }
    if(pw.length<6){ showErr('M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±.'); return; }
    // Sync to main register fields
    const setV=(id,v)=>{ const el=document.getElementById(id); if(el) el.value=v; };
    setV('rg-displayname',dn); setV('rg-username',un); setV('rg-pass',pw); setV('rg-pass2',pw2);
    if(btn){ btn.disabled=true; btn.textContent='‚è≥ ƒêang t·∫°o t√†i kho·∫£n...'; }
    if(errEl) errEl.style.display='none';
    try{
      await appRegister();
      // If success, _currentUser is set
      if(typeof _currentUser !== 'undefined' && _currentUser){
        if(okEl){okEl.textContent='üéâ T·∫°o t√†i kho·∫£n th√†nh c√¥ng!';okEl.style.display='block';}
        setTimeout(()=>{ hideLoginWall(); closeMobAccount(); }, 700);
      } else {
        const mainErr = document.getElementById('rg-err');
        if(mainErr && mainErr.style.display !== 'none') showErr(mainErr.textContent);
      }
    } catch(e){ showErr('ƒêƒÉng k√Ω th·∫•t b·∫°i. Th·ª≠ l·∫°i.'); }
    finally{ if(btn){ btn.disabled=false; btn.textContent='üöÄ T·∫°o t√†i kho·∫£n'; } }
  };

  /* ‚îÄ‚îÄ Sign out ‚îÄ‚îÄ */
  window.mobSignOut = async function(){
    await appSignOut();
    closeMobAccount();
  };

  /* ‚îÄ‚îÄ Firebase save ‚îÄ‚îÄ */
  window.mobSaveFirebase = async function(){
    // Sync values to main config modal fields
    const map = {
      'mob-cfg-apiKey':'cfg-apiKey','mob-cfg-authDomain':'cfg-authDomain',
      'mob-cfg-projectId':'cfg-projectId','mob-cfg-storageBucket':'cfg-storageBucket',
      'mob-cfg-messagingSenderId':'cfg-messagingSenderId','mob-cfg-appId':'cfg-appId'
    };
    Object.entries(map).forEach(([src,dst])=>{
      const s=document.getElementById(src), d=document.getElementById(dst);
      if(s&&d) d.value=s.value;
    });
    const errEl = document.getElementById('mob-cfg-err');
    if(errEl) errEl.style.display='none';
    try{
      await saveAndConnectFirebase();
      _updateMobFbStatus();
      if(errEl){ errEl.style.display='none'; }
      showToast('‚úÖ Firebase ƒë√£ k·∫øt n·ªëi th√†nh c√¥ng!');
    } catch(e){
      if(errEl){ errEl.textContent='‚ö†Ô∏è L·ªói k·∫øt n·ªëi. Ki·ªÉm tra l·∫°i config.'; errEl.style.display='block'; }
    }
  };

  window.mobPasteFbConfig = async function(){
    try{
      const text = await navigator.clipboard.readText();
      // Reuse existing pasteFbConfig logic
      const match = text.match(/\{[\s\S]*\}/);
      if(!match) return;
      const cfg = JSON.parse(match[0]);
      const map = {
        apiKey:'mob-cfg-apiKey', authDomain:'mob-cfg-authDomain',
        projectId:'mob-cfg-projectId', storageBucket:'mob-cfg-storageBucket',
        messagingSenderId:'mob-cfg-messagingSenderId', appId:'mob-cfg-appId'
      };
      Object.entries(map).forEach(([k,id])=>{
        const el=document.getElementById(id); if(el&&cfg[k]) el.value=cfg[k];
      });
      showToast('üìã ƒê√£ d√°n config Firebase!');
    } catch(e){ showToast('‚ö†Ô∏è Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c clipboard. D√°n th·ªß c√¥ng nh√©!'); }
  };

  window.mobClearFbConfig = function(){
    clearFbConfig();
    ['mob-cfg-apiKey','mob-cfg-authDomain','mob-cfg-projectId',
     'mob-cfg-storageBucket','mob-cfg-messagingSenderId','mob-cfg-appId']
      .forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
    _updateMobFbStatus();
    showToast('üóë ƒê√£ x√≥a Firebase config');
  };

  /* ‚îÄ‚îÄ Logged-in Firebase edit form ‚îÄ‚îÄ */
  window.toggleMobFbEditForm = function(){
    const form = document.getElementById('mob-fb-edit-form');
    if(!form) return;
    const open = form.style.display === 'none' || !form.style.display;
    form.style.display = open ? 'block' : 'none';
    if(open){
      const cfg = getFbConfig();
      if(cfg){
        ['apiKey','authDomain','projectId','storageBucket','messagingSenderId','appId'].forEach(k=>{
          const el = document.getElementById('mob-cfg2-'+k); if(el&&cfg[k]) el.value=cfg[k];
        });
      }
    }
  };

  window.mobSaveFirebase2 = async function(){
    const map = {
      'mob-cfg2-apiKey':'cfg-apiKey','mob-cfg2-authDomain':'cfg-authDomain',
      'mob-cfg2-projectId':'cfg-projectId','mob-cfg2-storageBucket':'cfg-storageBucket',
      'mob-cfg2-messagingSenderId':'cfg-messagingSenderId','mob-cfg2-appId':'cfg-appId'
    };
    Object.entries(map).forEach(([src,dst])=>{
      const s=document.getElementById(src), d=document.getElementById(dst);
      if(s&&d) d.value=s.value;
    });
    // Also sync to mob-cfg fields
    const map2 = {
      'mob-cfg2-apiKey':'mob-cfg-apiKey','mob-cfg2-authDomain':'mob-cfg-authDomain',
      'mob-cfg2-projectId':'mob-cfg-projectId','mob-cfg2-storageBucket':'mob-cfg-storageBucket',
      'mob-cfg2-messagingSenderId':'mob-cfg-messagingSenderId','mob-cfg2-appId':'mob-cfg-appId'
    };
    Object.entries(map2).forEach(([src,dst])=>{
      const s=document.getElementById(src), d=document.getElementById(dst);
      if(s&&d) d.value=s.value;
    });
    const errEl = document.getElementById('mob-cfg2-err');
    if(errEl) errEl.style.display='none';
    try{
      await saveAndConnectFirebase();
      _updateMobFbStatus();
      showToast('‚úÖ Firebase ƒë√£ k·∫øt n·ªëi th√†nh c√¥ng!');
      // Close form after success
      const form = document.getElementById('mob-fb-edit-form');
      if(form) form.style.display='none';
    }catch(e){
      if(errEl){errEl.textContent='‚ö†Ô∏è L·ªói k·∫øt n·ªëi. Ki·ªÉm tra l·∫°i config.';errEl.style.display='block';}
    }
  };

  window.mobPasteFbConfig2 = async function(){
    try{
      const text = await navigator.clipboard.readText();
      const match = text.match(/\{[\s\S]*\}/);
      if(!match) return;
      let cfg;
      try{ cfg=JSON.parse(match[0]); }catch(_){
        const clean=match[0].replace(/(\w+)\s*:/g,'"$1":').replace(/'/g,'"');
        cfg=JSON.parse(clean);
      }
      ['apiKey','authDomain','projectId','storageBucket','messagingSenderId','appId'].forEach(k=>{
        const el=document.getElementById('mob-cfg2-'+k); if(el&&cfg[k]) el.value=cfg[k];
      });
      showToast('üìã ƒê√£ d√°n config Firebase!');
    }catch(e){ showToast('‚ö†Ô∏è Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c clipboard. D√°n th·ªß c√¥ng nh√©!'); }
  };

  /* ‚îÄ‚îÄ Sync badge mirror ‚îÄ‚îÄ */
  window.updateMobSyncBadge = function(){
    const src = document.getElementById('sync-badge');
    const dst = document.getElementById('mob-sync-badge');
    if(src && dst){
      dst.className = src.className;
      dst.textContent = src.textContent;
    }
    // C·∫≠p nh·∫≠t s·ªë t·ª´
    const wc = document.getElementById('mob-sync-word-count');
    if(wc && typeof S !== 'undefined') wc.textContent = S.vocab?.length||0;
    // C·∫≠p nh·∫≠t stats box
    const setV = (id,v)=>{ const el=document.getElementById(id); if(el) el.textContent=v; };
    if(typeof S !== 'undefined'){
      setV('mob-stat-words', S.vocab?.length||0);
      setV('mob-stat-streak', S.stats?.streak||0);
      setV('mob-stat-xp', S.stats?.xp||0);
    }
  };

  /* ‚îÄ‚îÄ Observe main auth UI changes to mirror in drawer ‚îÄ‚îÄ */
  const _origRenderIn = typeof _renderLoggedInUI !== 'undefined' ? _renderLoggedInUI : null;
  const _origRenderOut = typeof _renderLoggedOutUI !== 'undefined' ? _renderLoggedOutUI : null;

  // Intercept via MutationObserver on ui-logged-in
  const uiIn = document.getElementById('ui-logged-in');
  const uiOut = document.getElementById('ui-logged-out');
  if(uiIn || uiOut){
    const mo = new MutationObserver(()=>{
      const isIn = uiIn && uiIn.style.display !== 'none';
      if(isIn && typeof _currentUser !== 'undefined' && _currentUser){
        _showMobLoggedIn(_currentUser);
        // T·ª± ƒë√≥ng login-wall n·∫øu ƒëang m·ªü (kh√¥ng ƒë√≥ng drawer)
        const wall = document.getElementById('login-wall');
        if(wall && wall.classList.contains('show')){
          wall.classList.remove('show');
        }
      } else {
        _showMobLoggedOut();
      }
    });
    if(uiIn) mo.observe(uiIn, {attributes:true, attributeFilter:['style']});
    if(uiOut) mo.observe(uiOut, {attributes:true, attributeFilter:['style']});
  }

  // Mirror sync badge changes
  const syncBadge = document.getElementById('sync-badge');
  if(syncBadge){
    new MutationObserver(()=>updateMobSyncBadge()).observe(syncBadge, {childList:true, attributes:true, characterData:true, subtree:true});
  }

  // On initial load check session ‚Äî ch·ªù boot sequence xong (1.5s)
  setTimeout(()=>{
    let user = (typeof _currentUser !== 'undefined' && _currentUser) || null;
    if(!user){
      try{ user = JSON.parse(localStorage.getItem('speakup_app_session')||'null'); }catch(_){}
    }
    if(user && user.uid){
      _showMobLoggedIn(user);
    }
  }, 1500);

})();

(function initMobile(){
  if(window.innerWidth > 767) return;

  // 1. Prevent double-tap zoom on interactive elements
  let lastTouch = 0;
  document.addEventListener('touchend', function(e){
    const now = Date.now();
    if(now - lastTouch < 300 && e.target.closest('button,.btn,.mob-item,.tab-btn,.opt,.rate-btn')){
      e.preventDefault();
    }
    lastTouch = now;
  }, {passive:false});

  // 2. Visual touch feedback
  document.addEventListener('touchstart', function(e){
    const el = e.target.closest('.hcard,.topic-card,.lt-mode-tab,.sp-mode-tab,.rdp-day-card');
    if(el){ el.style.transition='transform .1s'; el.style.transform='scale(.97)'; }
  }, {passive:true});
  document.addEventListener('touchend', function(e){
    const el = e.target.closest('.hcard,.topic-card,.lt-mode-tab,.sp-mode-tab,.rdp-day-card');
    if(el){ setTimeout(()=>{ el.style.transform=''; el.style.transition=''; }, 150); }
  }, {passive:true});

  // 3. Mobile drop-zone ‚Äî simplify copy
  setTimeout(function(){
    const sub = document.querySelector('#drop-zone .dz-sub');
    if(sub) sub.textContent = 'Nh·∫•n ƒë·ªÉ ch·ªçn file .xlsx t·ª´ thi·∫øt b·ªã';
    const dz = document.getElementById('drop-zone');
    if(dz) dz.style.minHeight = '120px';
  }, 500);

  // 4. Smooth scroll for study tabs
  document.querySelectorAll('.tabs').forEach(function(t){
    t.style.webkitOverflowScrolling = 'touch';
  });

  // 5. Add touch-scale CSS for nav items
  const s = document.createElement('style');
  s.textContent = '@media(max-width:767px){.mob-item:active{background:rgba(13,148,136,.07);border-radius:8px;}.hcard:active,.topic-card:active{filter:brightness(.96);}}';
  document.head.appendChild(s);
})();
</script>
